---
title: Ограничения ресурсов и оптимизация производительности надстроек Office
description: ''
ms.date: 01/23/2018
ms.openlocfilehash: 57004d5f3b38bfb1c58cefbccf22a2ea0aa0b16f
ms.sourcegitcommit: 4de2a1b62ccaa8e51982e95537fc9f52c0c5e687
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2018
ms.locfileid: "22925390"
---
# <a name="resource-limits-and-performance-optimization-for-office-add-ins"></a>Ограничения ресурсов и оптимизация производительности надстроек Office

Чтобы обеспечить максимальное удобство работы для пользователей, разработчику необходимо убедиться, что Надстройка Office работает в заданных пределах использования ЦП и памяти, что она достаточно надежна, а в случае надстроек Outlook еще и проверить время ответа при оценке регулярных выражений. Эти ограничения на использование ресурсов среды выполнения применяются только к надстройкам, запущенным в клиентах Office для Windows и OS X, но не Office Online, Outlook Web App или OWA для устройств. 

Вы также можете оптимизировать работу надстроек на мобильных устройствах и компьютерах, оптимизировав использование ресурсов в проекте и реализации.

## <a name="resource-usage-limits-for-add-ins"></a>Ограничения на использование ресурсов для надстроек

Ограничения на использование ресурсов применяются ко всем типам надстроек Office. Эти ограничения помогают гарантировать работу и бороться с атаками типа "отказ в обслуживании". Обязательно протестируйте свою надстройку Office в целевом ведущем приложении, применяя ряд возможных данных, и оцените ее работу по следующим критериям:

- **Загрузка ядра ЦП**. Загрузка одного ядра ЦП не должна превышать 90 % (проверяется три раза с интервалом 5 секунд).
    
   По умолчанию ведущий полнофункциональный клиент проверяет использование ядра ЦП каждые 5 секунд. Если ведущее клиентское приложение обнаружит, что использование ядра ЦП надстройкой превышает пороговое значение, то появится сообщение, где спрашивается, желает ли пользователь продолжить работать с надстройкой. Если пользователь продолжит работу, ведущее клиентское приложение больше не будет выводить этот запрос в течение данного сеанса редактирования. С помощью раздела реестра **AlertInterval** администраторы могут повысить пороговое значение, чтобы это сообщение отображалось реже, если пользователи работают с надстройками, требующими больших затрат ресурсов ЦП.
    
- **Использование памяти**. Пороговое значение использования памяти по умолчанию, которое определяется динамически на основе доступной физической памяти устройства.
    
   По умолчанию, когда ведущий полнофункциональный клиент обнаруживает, что на устройстве используется более 80 % доступной физической памяти, он начинает отслеживать использование памяти надстройкой (на уровне документа в случае надстроек области задач и контентных надстроек или на уровне почтового ящика в случае надстроек Outlook). С определенным интервалом (по умолчанию он составляет 5 секунд) клиент предупреждает пользователя, если набор надстроек на уровне документа или почтового ящика использует более 50 % физической памяти. Этот предел использования памяти относится к физической, а не виртуальной памяти, что гарантирует достаточную производительность на устройствах с ограниченным объемом ОЗУ, таких как планшеты. Администраторы могут переопределять этот динамический параметр конкретным значением, используя раздел реестра Windows **MemoryAlertThreshold** как глобальный параметр, или настраивать интервал оповещений, используя раздел **AlertInterval** как глобальный параметр.
    
- **Устойчивость к сбоям**. По умолчанию надстройка должна давать сбой не более четыре раз.
    
   Администраторы могут настраивать предельное количество сбоев с помощью раздела реестра **RestartManagerRetryLimit**.
    
- **Блокирование надстройки**. Отсутствие ответа должно длиться не более 5 секунд.
    
   Это влияет на работу пользователя с надстройкой и ведущим приложением. При продолжительном отсутствии ответа ведущее приложение автоматически перезапускает все активные надстройки для документа или почтового ящика (в зависимости от конкретного случая) и сообщает пользователю, какая надстройка не отвечает. Этот порог может достигаться, если надстройка нерегулярно использует вычислительные ресурсы при выполнении длительных задач. Существуют методики, позволяющие избежать блокировки. Администраторы не могут переопределять это пороговое значение.
    
### <a name="outlook-add-ins"></a>Надстройки Outlook
    
Если какая-либо надстройка Outlook превышает описанные пороговые значения, касающиеся числа сбоев или использования ЦП и памяти, Outlook отключает надстройку. В Центре администрирования Exchange состояние надстройки отображается как "Отключено".

> [!NOTE]
> Хотя только полнофункциональные клиенты Outlook (не Outlook Web App или OWA для устройств) отслеживают использование ресурсов, если полнофункциональный клиент отключит надстройку Outlook, то эта надстройка также будет отключена в Outlook Web App и OWA для устройств.

Помимо правил, связанных с памятью, надежностью и ядром ЦП, надстройки Outlook должны соблюдать при активации следующие правила:

- **Время ответа при оценке регулярных выражений**. По умолчанию Outlook должна оценивать все регулярные выражения в манифесте надстройки Outlook не более 1000 миллисекунд. При превышении этого значения Outlook повторит оценку позже.

    С помощью групповой политики или предназначенного для конкретного приложения параметра в реестре Windows администраторы могут настраивать это пороговое значение (по умолчанию оно составляет 1000 миллисекунд) в параметре **OutlookActivationAlertThreshold**.

- **Повторная оценка регулярного выражения**. По умолчанию Outlook должна повторять оценку всех регулярных выражений в манифесте не более 3 раз. Если выполнить оценку не удается все три раза из-за превышения допустимого порогового значения (равного 1000 миллисекунд по умолчанию либо значению, указанному параметром **OutlookActivationAlertThreshold**, если этот параметр есть в реестре Windows), Outlook отключает надстройку. В Центре администрирования Exchange отображается состояние "Отключено", и надстройку невозможно использовать в полнофункциональном клиенте Outlook, Outlook Web App и OWA для устройств.

    С помощью групповой политики или предназначенного для конкретного приложения параметра в реестре Windows администраторы могут настраивать количество повторных попыток оценки в параметре **OutlookActivationManagerRetryLimit**.

### <a name="task-pane-and-content-add-ins"></a>Надстройки области задач и контентные надстройки
    
Если любая контентная надстройка или надстройка области задач превышает описанные пороговые значения на использование ЦП, использование памяти или допустимое число сбоев, соответствующее ведущее приложение отображает пользователю предупреждение. В этот момент пользователь может сделать одно из следующих действий:

- Перезапустить надстройку.
- Отменить дальнейшие оповещения о превышении заданного порога. В идеальном случае пользователь должен удалить надстройку из документа. Продолжение работы с приложением может вызвать дальнейшие проблемы производительности и стабильности.  

## <a name="verifying-resource-usage-issues-in-the-telemetry-log"></a>Проверка проблем использования ресурсов в журнале телеметрии

Office предоставляет журнал телеметрии, который поддерживает запись определенных событий (загрузку, открытие, закрытие и ошибки) решений Office, работающих на локальном компьютере, включая проблемы использование ресурсов в Надстройка Office. Если настроен журнал телеметрии, можно использовать Excel для открытия его в следующем расположении по умолчанию на локальном диске:

`%Users%\<Current user>\AppData\Local\Microsoft\Office\15.0\Telemetry`

Для каждого события надстройки, которое регистрируется в журнале телеметрии, определяются дата и время возникновения, идентификатор, серьезность, краткий описательный заголовок, понятное имя, уникальный идентификатор надстройки и приложение, внесшее сведения об этом событии в журнал. Вы можете обновить журнал телеметрии, чтобы увидеть текущие отслеживаемые события. В таблице ниже приведены примеры надстроек Outlook, которые отслеживались в журнале телеметрии. 

|**Дата/время**|**Код события**|**Серьезность**|**Название**|**Файл**|**ИД**|**Приложение**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|8.10.2012 17:57:10|7||Манифест надстройки загружен успешно|Кто есть кто|69cc567c-6737-4c49-88dd-123334943a22|Outlook|
|8.10.2012 17:57:01|7||Манифест надстройки загружен успешно|LinkedIn|333bf46d-7dad-4f2b-8cf4-c19ddc78b723|Outlook|

В таблице ниже приведен общий список событий, которые отслеживаются в журнале телеметрии для надстроек Office.

|**Код события**|**Название**|**Серьезность**|**Описание**|
|:-----|:-----|:-----|:-----|
|7|Манифест надстройки загружен успешно||Манифест Надстройка Office был успешно загружен и прочитан ведущим приложением.|
|8|Манифест надстройки не загружен|Критический|Ведущему приложению не удалось загрузить файл манифеста надстройки Office из каталога SharePoint, корпоративного каталога или AppSource.|
|9|Не удается выполнить анализ разметки надстройки|Критическая|Ведущее приложение загрузило манифест приложения Надстройка Office, однако ему не удалось считать HTML-разметку этого приложения.|
|10|Надстройка использует слишком много ресурсов ЦП|Критическая|Приложение Надстройка Office использовало более 90 % ресурсов ЦП за конечный промежуток времени.|
|15|Тайм-аут поиска строки привел к отключению надстройки||Надстройки Outlook выполняют поиск строки темы и основной части электронного сообщения, чтобы определить, требуется ли их отображать с использованием регулярного выражения. Клиент Outlook отключил надстройку Outlook, указанную в столбце **Файл**, из-за многократного превышения времени ожидания при попытке сопоставления регулярного выражения.|
|18|Надстройка успешно закрыта||Ведущему приложению удалось успешно закрыть приложение Надстройка Office.|
|19|Надстройка обнаружила ошибку времени выполнения|Критическая|Приложение Надстройка Office столкнулось с проблемой и завершилось со сбоем. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|
|20|Сбой надстройки при проверке лицензирования|Критическая|Не удалось проверить сведения о лицензировании для приложения Надстройка Office, возможно, срок их действия истек. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|

Дополнительные сведения см. в разделах [Развертывание панели мониторинга телеметрии](https://docs.microsoft.com/previous-versions/office/office-2013-resource-kit/jj219431(v=office.15)) и [Устранение неполадок с файлами Office и пользовательскими решениями с помощью журнала телеметрии](https://docs.microsoft.com/office/client-developer/shared/troubleshooting-office-files-and-custom-solutions-with-the-telemetry-log)


## <a name="design-and-implementation-techniques"></a>Методы проектирования и реализации

Хотя ресурсные ограничения на использование ЦП и памяти, число сбоев и время ответа пользовательского интерфейса применяются только к Надстройки Office, работающим только на клиентах с расширенными возможностями, оптимизация использования этих ресурсов и батареи должна быть приоритетной задачей, если требуется удовлетворительная работа надстройки на всех поддерживаемых клиентах и устройствах. Оптимизация особенно важна, если надстройка выполняет длительные операции или обрабатывает большие наборы данных. В следующем списке приводятся рекомендации по методам разделения операций, требовательных к ЦП или памяти, на блоки меньшего размера, чтобы надстройка могла избежать избыточного потребления ресурсов, а ведущее приложение могло отвечать на запросы:

- В сценарии, где надстройке требуется читать большой объем из неограниченного набора данных, можно применить разбиение на страницы во время чтения данных из таблицы или уменьшить размер данных в каждой небольшой операции чтения вместо попыток выполнить чтение за одну операцию. 
    
   Для примера, JavaScript and кода jQuery, который показывает разрывa потенциально долговременных и интенсивно использующих CPU-серий, операций ввода и вывода на неограниченные данные, см. [ак я могу вернуть управление (кратковременно) в браузер при интенсивной обработке JavaScript?](http://stackoverflow.com/questions/210821/how-can-i-give-control-back-briefly-to-the-browser-during-intensive-javascript). В этом примере используется  [метод глобального объекта setTimeout](https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout)для ограничения длительности ввода и вывода. Он также обрабатывает данные в определенных кусках вместо беспорядочно неограниченных данных.
    
- Если надстройка использует требовательный к ресурсам ЦП алгоритм для обработки большого объема данных, вы можете использовать рабочие веб-процессы для выполнения длительной задачи в фоновом режиме, при этом на переднем плане выполняя отдельный скрипт, который, например, отображает ход выполнения в пользовательском интерфейсе. Рабочие веб-процессы не блокируют действия пользователя и позволяют HTML-странице отвечать на запросы. Пример рабочих веб-процессов можно посмотреть в статье [Основные сведения о рабочих веб-процессах](https://www.html5rocks.com/en/tutorials/workers/basics/). Дополнительные сведения об API рабочих веб-процессов в Internet Explorer изложены в статье [Рабочие веб-процессы](https://developer.mozilla.org/docs/Web/API/Web_Workers_API).
    
- Если надстройка использует требовательный к ресурсам ЦП алгоритм, но вы можете разделить входные или выходные данные на небольшие наборы, рассмотрите возможность создать веб-службу и передать туда данные, чтобы разгрузить ЦП, и подождите асинхронный обратный вызов.
    
- Протестируйте надстройку с самым большим ожидаемым объемом данных и запретите обработку большего объема.
    

## <a name="see-also"></a>См. также

- [Конфиденциальность и безопасность надстроек Office](../concepts/privacy-and-security.md)
- [Ограничения активации и API JavaScript для надстроек Outlook](https://docs.microsoft.com/outlook/add-ins/limits-for-activation-and-javascript-api-for-outlook-add-ins)
    
