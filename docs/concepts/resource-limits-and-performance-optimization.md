---
title: Ограничения ресурсов и оптимизация производительности надстроек Office
description: Сведения об ограничениях ресурсов платформы надстройки Office, включая ЦП и память.
ms.date: 07/18/2022
ms.localizationpriority: medium
ms.openlocfilehash: 8465eb654795b538182e01d33b2fc57ddb35eaa0
ms.sourcegitcommit: 05be1086deb2527c6c6ff3eafcef9d7ed90922ec
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2022
ms.locfileid: "68092905"
---
# <a name="resource-limits-and-performance-optimization-for-office-add-ins"></a>Ограничения ресурсов и оптимизация производительности надстроек Office

To create the best experience for your users, ensure that your Office Add-in performs within specific limits for CPU core and memory usage, reliability, and, for Outlook add-ins, the response time for evaluating regular expressions. These run-time resource usage limits apply to add-ins running in Office clients on Windows and OS X, but not on mobile apps or in a browser.

Вы также можете оптимизировать работу надстроек на мобильных устройствах и компьютерах, оптимизировав использование ресурсов в проекте и реализации.

## <a name="resource-usage-limits-for-add-ins"></a>Ограничения на использование ресурсов для надстроек

Ограничения на использование ресурсов во время выполнения применяются ко всем типам надстроек Office. Эти ограничения помогают обеспечить производительность пользователей и снизить число атак типа "отказ в обслуживании". Обязательно протестируйте надстройку Office в целевом приложении Office, используя диапазон возможных данных, и измерите ее производительность по следующим ограничениям использования во время выполнения.

- **Загрузка ядра ЦП**. Загрузка одного ядра ЦП не должна превышать 90 % (проверяется три раза с интервалом 5 секунд).

   Интервал по умолчанию для проверки использования ядра ЦП клиентом Office — каждые 5 секунд. Если клиент Office обнаруживает, что использование ядра ЦП надстройки превышает пороговое значение, отображается сообщение с вопросом о том, хочет ли пользователь продолжить работу надстройки. Если пользователь решили продолжить, клиент Office больше не запрашивает его во время этого сеанса редактирования. С помощью раздела реестра **AlertInterval** администраторы могут повысить пороговое значение, чтобы это сообщение отображалось реже, если пользователи работают с надстройками, требующими больших затрат ресурсов ЦП.

- **Использование памяти**. Пороговое значение использования памяти по умолчанию, которое определяется динамически на основе доступной физической памяти устройства.

   По умолчанию, когда клиент Office обнаруживает, что объем физической памяти на устройстве превышает 80 % доступной памяти, клиент начинает наблюдение за использованием памяти надстройки на уровне документа для надстроек содержимого и области задач, а также на уровне почтовых ящиков для надстроек Outlook. Через 5 секунд по умолчанию клиент предупреждает пользователя, если объем физической памяти для набора надстроек на уровне документа или почтового ящика превышает 50 %. Этот предел использования памяти рассчитан для физической, а не виртуальной памяти, и позволяет обеспечить производительность на устройствах с ограниченной оперативной памятью, таких как планшеты. Администраторы могут переопределить этот динамический параметр явным ограничением, используя раздел реестра **Windows MemoryAlertThreshold** в качестве глобального параметра, ir измените интервал оповещения, используя ключ **AlertInterval** в качестве глобального параметра.

- **Устойчивость к сбоям**. По умолчанию надстройка должна давать сбой не более четыре раз.

   Администраторы могут настраивать предельное количество сбоев с помощью раздела реестра **RestartManagerRetryLimit**.

- **Блокирование надстройки**. Отсутствие ответа должно длиться не более 5 секунд.

   Это влияет на работу надстройки и приложения Office. В этом случае приложение Office автоматически перезапускает все активные надстройки для документа или почтового ящика (если это применимо) и предупреждает пользователя о том, какая надстройка перестала отвечать. Этот порог может достигаться, если надстройка нерегулярно использует вычислительные ресурсы при выполнении длительных задач. Существуют методики, позволяющие избежать блокировки. Администраторы не могут переопределять это пороговое значение.

### <a name="outlook-add-ins"></a>Надстройки Outlook

If any Outlook add-in exceeds the preceding thresholds for CPU core or memory usage, or tolerance limit for crashes, Outlook disables the add-in. The Exchange Admin Center displays the disabled status of the app.

> [!NOTE]
> Хотя только полнофункциональные клиенты Outlook (не Outlook в Интернете или для мобильных устройств) отслеживают использование ресурсов, если полнофункциональный клиент отключит надстройку Outlook, эта надстройка также будет отключена в Outlook в Интернете и для мобильных устройств.

Помимо правил ядра ЦП, памяти и надежности надстройки Outlook должны соблюдать следующие правила активации.

- **Regular expressions response time** - A default threshold of 1,000 milliseconds for Outlook to evaluate all regular expressions in the manifest of an Outlook add-in. Exceeding the threshold causes Outlook to retry evaluation at a later time.

    С помощью групповой политики или параметров приложения в реестре Windows администраторы могут настроить это пороговое значение по умолчанию в 1000 миллисекунд с помощью параметра **OutlookActivationAlertThreshold**.

- **Повторное вычисление** регулярных выражений — ограничение по умолчанию в три раза для outlook для повторной оценки всех регулярных выражений в манифесте. Если оценка завершается сбоем все три раза путем превышения применимого порогового значения (которое является значением по умолчанию 1000 миллисекунд или значением, указанным **OutlookActivationAlertThreshold**, если этот параметр существует в реестре Windows), Outlook отключает надстройку Outlook. В Центре Администратор Exchange отображается состояние отключения, а надстройка отключена для использования в полнофункциональных клиентах Outlook, Outlook в Интернете и мобильных устройствах.

    С помощью групповой политики или параметра приложения в реестре Windows администраторы могут настроить это число попыток оценки, используя параметр **OutlookActivationManagerRetryLimit**.

### <a name="excel-add-ins"></a>Надстройки Excel

При создании надстройки Excel учитывайте следующие ограничения размера при взаимодействии с книгой.

- В Excel в Интернете действует ограничение в 5 МБ на размер полезных данных запросов и откликов. При превышении этого ограничения возникает ошибка `RichAPI.Error`.
- Диапазон ограничен пятью миллионами ячеек для операций получения.

Если вы ожидаете, что входные данные пользователя превысят эти ограничения, обязательно проверьте данные перед вызовом `context.sync()`. При необходимости разбиение операции на части меньшего размера. Обязательно вызовите каждую `context.sync()` вложенную операцию, чтобы избежать повторной пакетной обработки этих операций.

Эти ограничения обычно превышаются большими диапазонами. Надстройка может использовать [RangeAreas](/javascript/api/excel/excel.rangeareas) для стратегического обновления ячеек в большем диапазоне. Дополнительные сведения о работе с надстройки `RangeAreas`Excel см. в статье "Работа с несколькими диапазонами [одновременно"](../excel/excel-add-ins-multiple-ranges.md). Дополнительные сведения об оптимизации размера полезных данных в Excel см. в рекомендациях по ограничению размера [полезных данных](../excel/performance.md#payload-size-limit-best-practices).

### <a name="task-pane-and-content-add-ins"></a>Надстройки области задач и контентные надстройки

Если какой-либо контент или надстройка области задач превышает предыдущие пороговые значения для ядра ЦП или использования памяти, или ограничение допустимости при сбоях, соответствующее приложение Office отображает предупреждение для пользователя. В этот момент пользователь может сделать одно из следующих действий:

- Перезапустить надстройку.
- Cancel further alerts about exceeding that threshold. Ideally, the user should then delete the add-in from the document; continuing the add-in would risk further performance and stability issues.  

## <a name="verify-resource-usage-issues-in-the-telemetry-log"></a>Проверка проблем с использованием ресурсов в журнале телеметрии

Office предоставляет журнал телеметрии, который поддерживает запись определенных событий (загрузку, открытие, закрытие и ошибки) решений Office, работающих на локальном компьютере, включая проблемы использование ресурсов в Надстройка Office. Если у вас настроен журнал телеметрии, с помощью Excel можно открыть журнал телеметрии в следующем расположении по умолчанию на локальном диске.

`%Users%\<Current user>\AppData\Local\Microsoft\Office\15.0\Telemetry`

For each event that the Telemetry Log tracks for an add-in, there is a date/time of the occurrence, event ID, severity, and short descriptive title for the event, the friendly name and unique ID of the add-in, and the application that logged the event. You can refresh the Telemetry Log to see the current tracked events. The following table shows examples of Outlook add-ins that were tracked in the Telemetry log.

|Дата и время|Идентификатор события|Severity|Название|File|Идентификатор|Application|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|8.10.2012 17:57:10|7 |*Не применимо*|Манифест надстройки загружен успешно|Who's Who|69cc567c-6737-4c49-88dd-123334943a22|Outlook|
|8.10.2012 17:57:01|7 |*Не применимо*|Манифест надстройки загружен успешно|LinkedIn|333bf46d-7dad-4f2b-8cf4-c19ddc78b723|Outlook|

В таблице ниже приведен общий список событий, которые отслеживаются в журнале телеметрии для надстроек Office.

|Идентификатор события|Название|Severity|Описание|
|:-----|:-----|:-----|:-----|
|7 |Манифест надстройки загружен успешно|*Не применимо*|Манифест надстройки Office успешно загружен и считано приложением Office.|
|8 |Манифест надстройки не загружен|Критический|Приложению Office не удалось загрузить файл манифеста для надстройки Office из каталога SharePoint, корпоративного каталога или AppSource.|
|9 |Не удается выполнить анализ разметки надстройки|Критическая|Приложение Office загрузит манифест надстройки Office, но не сможет прочитать HTML-разметку приложения.|
|10|Надстройка использует слишком много ресурсов ЦП|Критическая|Приложение Надстройка Office использовало более 90 % ресурсов ЦП за конечный промежуток времени.|
|15|Тайм-аут поиска строки привел к отключению надстройки|*Не применимо*|Outlook add-ins search the subject line and message of an e-mail to determine whether they should be displayed by using a regular expression. The Outlook add-in listed in the **File** column was disabled by Outlook because it timed out repeatedly while trying to match a regular expression.|
|18 |Надстройка успешно закрыта|*Не применимо*|Приложению Office удалось успешно закрыть надстройку Office.|
|19|Надстройка обнаружила ошибку времени выполнения|Критическая|Приложение Надстройка Office столкнулось с проблемой и завершилось со сбоем. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|
|20|Сбой надстройки при проверке лицензирования|Критическая|Не удалось проверить сведения о лицензировании для приложения Надстройка Office, возможно, срок их действия истек. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|

Дополнительные сведения см. в разделах [Развертывание панели мониторинга телеметрии](/previous-versions/office/office-2013-resource-kit/jj219431(v=office.15)) и [Устранение неполадок с файлами Office и пользовательскими решениями с помощью журнала телеметрии](/office/client-developer/shared/troubleshooting-office-files-and-custom-solutions-with-the-telemetry-log)

## <a name="design-and-implementation-techniques"></a>Методы проектирования и реализации

Хотя ресурсные ограничения на использование ЦП и памяти, число сбоев и время ответа пользовательского интерфейса применяются только к Надстройки Office, работающим только на клиентах с расширенными возможностями, оптимизация использования этих ресурсов и батареи должна быть приоритетной задачей, если требуется удовлетворительная работа надстройки на всех поддерживаемых клиентах и устройствах. Оптимизация особенно важна, если надстройка выполняет длительные операции или обрабатывает большие наборы данных. В следующем списке предлагаются некоторые методы размыкания операций с ресурсоемкими ресурсами ЦП или данных на более мелкие блоки, чтобы надстройка избегала чрезмерного потребления ресурсов и приложение Office оставалась гибкой.

- В сценарии, где надстройке требуется читать большой объем из неограниченного набора данных, можно применить разбиение на страницы во время чтения данных из таблицы или уменьшить размер данных в каждой небольшой операции чтения вместо попыток выполнить чтение за одну операцию. Это можно сделать с помощью метода [setTimeout](https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout) глобального объекта, чтобы ограничить длительность входных и выходных данных. It also handles the data in defined chunks instead of randomly unbounded data. Другой вариант — использовать [асинхронную](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/async_function) обработку обещаний.

- If your add-in uses a CPU-intensive algorithm to process a large volume of data, you can use web workers to perform the long-running task in the background while running a separate script in the foreground, such as displaying progress in the user interface. Web workers do not block user activities and allow the HTML page to remain responsive. For an example of web workers, see [The Basics of Web Workers](https://www.html5rocks.com/tutorials/workers/basics/). See [Web Workers](https://developer.mozilla.org/docs/Web/API/Web_Workers_API) for more information about the Web Workers API.

- Если надстройка использует требовательный к ресурсам ЦП алгоритм, но вы можете разделить входные или выходные данные на небольшие наборы, рассмотрите возможность создать веб-службу и передать туда данные, чтобы разгрузить ЦП, и подождите асинхронный обратный вызов.

- Протестируйте надстройку с самым большим ожидаемым объемом данных и запретите обработку большего объема.

### <a name="performance-improvements-with-the-application-specific-apis"></a>Повышение производительности с помощью API для конкретного приложения

Советы по повышению производительности при использовании модели API для конкретного приложения предоставляют рекомендации по использованию [API](../develop/application-specific-api-model.md) для excel, OneNote, Visio и Word. В целом, вам следует:

- [Загружаются только необходимые свойства](../develop/application-specific-api-model.md#calling-load-without-parameters-not-recommended).
- [Сведите к минимуму количество вызовов sync().](../develop/application-specific-api-model.md#performance-tip-minimize-the-number-of-sync-calls) [Прочитайте избегайте использования метода context.sync в](correlated-objects-pattern.md) циклах, чтобы получить дополнительные сведения об управлении `sync` вызовами в коде.
- [Сведите к минимуму количество созданных прокси-объектов](../develop/application-specific-api-model.md#performance-tip-minimize-the-number-of-proxy-objects-created). Можно также отменить поиск прокси-объектов, как описано в следующем разделе.

#### <a name="untrack-unneeded-proxy-objects"></a>Ненужные прокси-объекты

[Прокси-объекты](../develop/application-specific-api-model.md#proxy-objects) сохраняются в памяти до `RequestContext.sync()` вызова. Операции с большими пакетами могут создавать много прокси-объектов, необходимых надстройке лишь один раз, которые можно удалить из памяти до выполнения пакетных действий.

Метод `untrack()` освобождает объект из памяти. Этот метод реализуется во многих прокси-объектах API для конкретного приложения. Вызов `untrack()` после завершения работы надстройки с объектом должен обеспечить заметное преимущество производительности при использовании большого количества прокси-объектов.

> [!NOTE]
> `Range.untrack()` — это ярлык для [ClientRequestContext.trackedObjects.remove(thisRange)](/javascript/api/office/officeextension.trackedobjects#office-officeextension-trackedobjects-remove-member(1)). Отслеживание любого прокси-объекта можно прекратить, удалив его из списка отслеживаемых объектов в контексте.

В следующем примере кода Excel выбранный диапазон заполняется данными по одной ячейке за раз. После добавления значения в ячейку, диапазон отображает, что отслеживание ячейки прекращено. Выполните этот код с выбранным диапазоном от 10 000 до 20 000 ячеек сначала со строкой `cell.untrack()`, а затем без нее. Вы должны заметить, что код выполняется с использованием строки `cell.untrack()` быстрее, чем без нее. Вы также можете заметить уменьшение времени отклика впоследствии, так как этап очистки занимает меньше времени.

```js
Excel.run(async (context) => {
    const largeRange = context.workbook.getSelectedRange();
    largeRange.load(["rowCount", "columnCount"]);
    await context.sync();

    for (let i = 0; i < largeRange.rowCount; i++) {
        for (let j = 0; j < largeRange.columnCount; j++) {
            let cell = largeRange.getCell(i, j);
            cell.values = [[i *j]];

            // Call untrack() to release the range from memory.
            cell.untrack();
        }
    }

    await context.sync();
});
```

Обратите внимание, что необходимость отслежить объекты становится важной только при работе с тысячами объектов. Большинству надстроек не нужно управлять отслеживанием прокси-объектов.

## <a name="see-also"></a>См. также

- [Конфиденциальность и безопасность надстроек Office](../concepts/privacy-and-security.md)
- [Ограничения активации и API JavaScript для надстроек Outlook](../outlook/limits-for-activation-and-javascript-api-for-outlook-add-ins.md)
- [Оптимизация производительности с использованием API JavaScript для Excel](../excel/performance.md)
