---
title: Ограничения ресурсов и оптимизация производительности надстроек Office
description: Сведения об ограничении ресурсов платформы надстройки Office, в том числе ЦП и памяти.
ms.date: 07/29/2020
localization_priority: Normal
ms.openlocfilehash: 8c64e5a836d6b998ccd7022e71f595bb331bba8c
ms.sourcegitcommit: 9609bd5b4982cdaa2ea7637709a78a45835ffb19
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "47293333"
---
# <a name="resource-limits-and-performance-optimization-for-office-add-ins"></a>Ограничения ресурсов и оптимизация производительности надстроек Office

Чтобы обеспечить максимальное удобство работы для пользователей, разработчику необходимо убедиться, что надстройка Office работает в заданных пределах использования ЦП и памяти, что она достаточно надежна, а в случае надстроек Outlook еще и проверить время ответа при оценке регулярных выражений. Эти ограничения на использование ресурсов среды выполнения применяются только к надстройкам, запущенным в клиентах Office для Windows и OS X, но не в мобильных приложениях или браузере.

Вы также можете оптимизировать работу надстроек на мобильных устройствах и компьютерах, оптимизировав использование ресурсов в проекте и реализации.

## <a name="resource-usage-limits-for-add-ins"></a>Ограничения на использование ресурсов для надстроек

Пределы использования ресурсов во время выполнения применяются ко всем типам надстроек Office. Эти пределы помогают обеспечить производительность пользователей и устранять атаки типа "отказ в обслуживании". Обязательно протестируйте надстройку Office в целевом приложении Office, используя диапазон возможных данных, и Измерьте производительность с учетом следующих пределов использования во время выполнения:

- **Загрузка ядра ЦП**. Загрузка одного ядра ЦП не должна превышать 90 % (проверяется три раза с интервалом 5 секунд).

   Интервал по умолчанию для проверки использования ЦП для клиента Office составляет каждые 5 секунд. Если клиент Office обнаружит, что использование ядра ЦП для надстройки превышает пороговое значение, отображается сообщение о том, что пользователю нужно продолжить выполнение надстройки. Если пользователь решит продолжить, клиент Office не будет спрашивать этого пользователя в течение этого сеанса редактирования. С помощью раздела реестра **AlertInterval** администраторы могут повысить пороговое значение, чтобы это сообщение отображалось реже, если пользователи работают с надстройками, требующими больших затрат ресурсов ЦП.

- **Использование памяти**. Пороговое значение использования памяти по умолчанию, которое определяется динамически на основе доступной физической памяти устройства.

   По умолчанию, когда клиент Office обнаружит, что использование физической памяти на устройстве превышает 80% доступной памяти, клиент начинает мониторинг использования памяти надстройки на уровне документа для контентных надстроек и надстроек области задач, а также на уровне почтового ящика для надстроек Outlook. С интервалом по умолчанию, равным 5 секунд, клиент предупреждает пользователя, если использование физической памяти для набора надстроек на уровне документа или почтового ящика превышает 50%. Этот предел использования памяти рассчитан для физической, а не виртуальной памяти, и позволяет обеспечить производительность на устройствах с ограниченной оперативной памятью, таких как планшеты. Администраторы могут переопределить этот динамический параметр с явным пределом, используя раздел реестра **абсолютные memoryalertthreshold** Windows в качестве глобального параметра, ИК-связи настройте интервал оповещений, используя ключ **алертинтервал** в качестве глобального параметра.

- **Устойчивость к сбоям**. По умолчанию надстройка должна давать сбой не более четыре раз.

   Администраторы могут настраивать предельное количество сбоев с помощью раздела реестра **RestartManagerRetryLimit**.

- **Блокирование надстройки**. Отсутствие ответа должно длиться не более 5 секунд.

   Это влияет на взаимодействие пользователя с надстройкой и приложением Office. В этом случае приложение Office автоматически перезапускает все активные надстройки для документа или почтового ящика (если это необходимо) и предупреждает пользователя о том, что надстройка перестала отвечать на запросы. Этот порог может достигаться, если надстройка нерегулярно использует вычислительные ресурсы при выполнении длительных задач. Существуют методики, позволяющие избежать блокировки. Администраторы не могут переопределять это пороговое значение.

### <a name="outlook-add-ins"></a>Надстройки Outlook

Если какая-либо надстройка Outlook превышает описанные пороговые значения, касающиеся числа сбоев или использования ЦП и памяти, Outlook отключает надстройку. В Центре администрирования Exchange состояние надстройки отображается как "Отключено".

> [!NOTE]
> Хотя только полнофункциональные клиенты Outlook (не Outlook в Интернете или для мобильных устройств) отслеживают использование ресурсов, если полнофункциональный клиент отключит надстройку Outlook, эта надстройка также будет отключена в Outlook в Интернете и для мобильных устройств.

Помимо правил, связанных с памятью, надежностью и ядром ЦП, надстройки Outlook должны соблюдать при активации следующие правила:

- **Время ответа при оценке регулярных выражений**. По умолчанию Outlook должна оценивать все регулярные выражения в манифесте надстройки Outlook не более 1000 миллисекунд. При превышении этого значения Outlook повторит оценку позже.

    С помощью групповой политики или параметров приложения в реестре Windows администраторы могут настроить это пороговое значение по умолчанию в 1000 миллисекунд с помощью параметра **OutlookActivationAlertThreshold**.

- **Повторное вычисление регулярных выражений** — значение по умолчанию, равное трем значениям, по умолчанию для повторного вычисления всех регулярных выражений в манифесте. Если при вычислении произошел сбой из-за превышения указанного порогового значения (значение по умолчанию — 1 000 миллисекунд или значение, заданное параметром **OutlookActivationAlertThreshold**, если этот параметр существует в реестре Windows), Outlook отключает надстройку Outlook. В центре администрирования Exchange отображается состояние disabled, и надстройка отключена для использования в расширенных клиентах Outlook, а также в Outlook в Интернете и на мобильных устройствах.

    С помощью групповой политики или параметра приложения в реестре Windows администраторы могут настроить это число попыток оценки, используя параметр **OutlookActivationManagerRetryLimit**.

### <a name="excel-add-ins"></a>Надстройки Excel

При создании надстройки Excel учитывайте следующие ограничения размера при взаимодействии с книгой:

- В Excel в Интернете действует ограничение в 5 МБ на размер полезных данных запросов и откликов. При превышении этого ограничения возникает ошибка `RichAPI.Error`.
- Диапазон ограничен 5 000 000 ячейками для операций Get.

Если ожидается, что вводимые пользователем данные превышают эти ограничения, обязательно проверьте данные перед вызовом `context.sync()` . При необходимости разделите операцию на небольшие части. Не забудьте позвонить `context.sync()` по каждой подоперации, чтобы избежать повторного пакетной операции.

Эти ограничения обычно превышаются с помощью больших диапазонов. Надстройка может использовать [RangeAreas](/javascript/api/excel/excel.rangeareas) для стратегических обновлений ячеек в пределах большого диапазона. Для получения дополнительных сведений просмотрите [работу с несколькими диапазонами в](../excel/excel-add-ins-multiple-ranges.md) надстройках Excel.

### <a name="task-pane-and-content-add-ins"></a>Надстройки области задач и контентные надстройки

Если любое содержимое или надстройка области задач превышает предшествующие пороговые значения для ядра ЦП или использования памяти или ограничение допуска для сбоев, соответствующее приложение Office отображает предупреждение для пользователя. В этот момент пользователь может сделать одно из следующих действий:

- Перезапустить надстройку.
- Отменить дальнейшие оповещения о превышении заданного порога. В идеальном случае пользователь должен удалить надстройку из документа. Продолжение работы с приложением может вызвать дальнейшие проблемы производительности и стабильности.  

## <a name="verifying-resource-usage-issues-in-the-telemetry-log"></a>Проверка проблем использования ресурсов в журнале телеметрии

Office предоставляет журнал телеметрии, который поддерживает запись определенных событий (загрузку, открытие, закрытие и ошибки) решений Office, работающих на локальном компьютере, включая проблемы использование ресурсов в Надстройка Office. Если настроен журнал телеметрии, можно использовать Excel для открытия его в следующем расположении по умолчанию на локальном диске:

`%Users%\<Current user>\AppData\Local\Microsoft\Office\15.0\Telemetry`

Для каждого события надстройки, которое регистрируется в журнале телеметрии, определяются дата и время возникновения, идентификатор, серьезность, краткий описательный заголовок, понятное имя, уникальный идентификатор надстройки и приложение, внесшее сведения об этом событии в журнал. Вы можете обновить журнал телеметрии, чтобы увидеть текущие отслеживаемые события. В таблице ниже приведены примеры надстроек Outlook, которые отслеживались в журнале телеметрии.

|**Дата/время**|**Код события**|**Серьезность**|**Название**|**Файл**|**ИД**|**Приложение**|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|8.10.2012 17:57:10|7 ||Манифест надстройки загружен успешно|Who's Who|69cc567c-6737-4c49-88dd-123334943a22|Outlook|
|8.10.2012 17:57:01|7 ||Манифест надстройки загружен успешно|LinkedIn|333bf46d-7dad-4f2b-8cf4-c19ddc78b723|Outlook|

В таблице ниже приведен общий список событий, которые отслеживаются в журнале телеметрии для надстроек Office.

|**Код события**|**Название**|**Серьезность**|**Описание**|
|:-----|:-----|:-----|:-----|
|7 |Манифест надстройки загружен успешно||Манифест надстройки Office был успешно загружен и прочитан приложением Office.|
|8 |Манифест надстройки не загружен|Критический|Приложению Office не удалось загрузить файл манифеста для надстройки Office из каталога SharePoint, корпоративного каталога или AppSource.|
|9 |Не удается выполнить анализ разметки надстройки|Критическая|Приложение Office загрузило манифест надстройка Office, но ему не удалось прочитать разметку HTML приложения.|
|10 |Надстройка использует слишком много ресурсов ЦП|Критическая|Приложение Надстройка Office использовало более 90 % ресурсов ЦП за конечный промежуток времени.|
|15 |Тайм-аут поиска строки привел к отключению надстройки||Надстройки Outlook выполняют поиск строки темы и основной части электронного сообщения, чтобы определить, требуется ли их отображать с использованием регулярного выражения. Клиент Outlook отключил надстройку Outlook, указанную в столбце **Файл**, из-за многократного превышения времени ожидания при попытке сопоставления регулярного выражения.|
|18 |Надстройка успешно закрыта||Приложению Office удалось успешно закрыть надстройку Office.|
|19|Надстройка обнаружила ошибку времени выполнения|Критический|Приложение Надстройка Office столкнулось с проблемой и завершилось со сбоем. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|
|двадцать|Сбой надстройки при проверке лицензирования|Критический|Не удалось проверить сведения о лицензировании для приложения Надстройка Office, возможно, срок их действия истек. Для получения дополнительных сведений просмотрите **журнал оповещений Microsoft Office** с помощью средства просмотра событий Windows на том компьютере, где возникла ошибка.|

Дополнительные сведения см. в разделах [Развертывание панели мониторинга телеметрии](/previous-versions/office/office-2013-resource-kit/jj219431(v=office.15)) и [Устранение неполадок с файлами Office и пользовательскими решениями с помощью журнала телеметрии](/office/client-developer/shared/troubleshooting-office-files-and-custom-solutions-with-the-telemetry-log)

## <a name="design-and-implementation-techniques"></a>Методы проектирования и реализации

Хотя ресурсные ограничения на использование ЦП и памяти, число сбоев и время ответа пользовательского интерфейса применяются только к Надстройки Office, работающим только на клиентах с расширенными возможностями, оптимизация использования этих ресурсов и батареи должна быть приоритетной задачей, если требуется удовлетворительная работа надстройки на всех поддерживаемых клиентах и устройствах. Оптимизация особенно важна, если надстройка выполняет длительные операции или обрабатывает большие наборы данных. В приведенном ниже списке предлагаются некоторые способы переноса ресурсоемких и ресурсоемких операций в небольшие блоки, чтобы надстройка могла избежать чрезмерного потребления ресурсов, а приложение Office может оставаться недостаточным.

- В сценарии, где надстройке требуется читать большой объем из неограниченного набора данных, можно применить разбиение на страницы во время чтения данных из таблицы или уменьшить размер данных в каждой небольшой операции чтения вместо попыток выполнить чтение за одну операцию. Это можно сделать с помощью метода [сеттимеаут](https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout) глобального объекта, чтобы ограничить продолжительность ввода и вывода. It also handles the data in defined chunks instead of randomly unbounded data. Кроме того, можно использовать [Async](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/async_function) для решения ваших обещаний.

- Если надстройка использует требовательный к ресурсам ЦП алгоритм для обработки большого объема данных, вы можете использовать рабочие веб-процессы для выполнения длительной задачи в фоновом режиме и при этом на переднем плане выполнять отдельный скрипт, например, для отображения хода выполнения в пользовательском интерфейсе. Рабочие веб-процессы не блокируют действия пользователя и позволяют HTML-странице отвечать на запросы. Пример рабочих веб-процессов приводится в статье [Основные сведения о рабочих веб-процессах](https://www.html5rocks.com/tutorials/workers/basics/). Дополнительные сведения об API рабочих веб-процессов см. в статье [Рабочие веб-процессы](https://developer.mozilla.org/docs/Web/API/Web_Workers_API).

- Если надстройка использует требовательный к ресурсам ЦП алгоритм, но вы можете разделить входные или выходные данные на небольшие наборы, рассмотрите возможность создать веб-службу и передать туда данные, чтобы разгрузить ЦП, и подождите асинхронный обратный вызов.

- Протестируйте надстройку с самым большим ожидаемым объемом данных и запретите обработку большего объема.

### <a name="performance-improvements-with-the-application-specific-apis"></a>Улучшения производительности при использовании API для конкретных приложений

Советы по повышению производительности при [использовании модели API](../develop/application-specific-api-model.md) , зависящей от приложения, предоставляют рекомендации по использованию API для приложений для Excel, OneNote, Visio и Word. В сводке необходимо:

- [Загружайте только необходимые свойства](../develop/application-specific-api-model.md#calling-load-without-parameters-not-recommended).
- [Минимизируйте число вызовов Sync ()](../develop/application-specific-api-model.md#performance-tip-minimize-the-number-of-sync-calls). Прочтите статью [Избегайте использования метода Context. Sync в циклах](correlated-objects-pattern.md) для получения дополнительных сведений об управлении `sync` вызовами в вашем коде.
- [Минимизируйте количество созданных прокси-объектов](../develop/application-specific-api-model.md#performance-tip-minimize-the-number-of-proxy-objects-created). Кроме того, вы можете отследить прокси-объекты, как описано в следующем разделе.

#### <a name="untrack-unneeded-proxy-objects"></a>Отследить ненужные прокси-объекты

[Прокси-объекты](../develop/application-specific-api-model.md#proxy-objects) хранятся в памяти до тех пор `RequestContext.sync()` , пока не будет вызван. Операции с большими пакетами могут создавать много прокси-объектов, необходимых надстройке лишь один раз, которые можно удалить из памяти до выполнения пакетных действий.

`untrack()`Метод освобождает объект из памяти. Этот метод реализован на множестве прокси-объектов API, характерных для приложений. Вызов `untrack()` после выполнения надстройки объект должен получить заметное преимущество в производительности при использовании большого числа прокси-объектов.

> [!NOTE]
> `Range.untrack()` — это ярлык для [ClientRequestContext.trackedObjects.remove(thisRange)](/javascript/api/office/officeextension.trackedobjects#remove-object-). Отслеживание любого прокси-объекта можно прекратить, удалив его из списка отслеживаемых объектов в контексте.

В приведенном ниже примере кода Excel выделенный диапазон заполняется данными по одной ячейке за раз. После добавления значения в ячейку, диапазон отображает, что отслеживание ячейки прекращено. Выполните этот код с выбранным диапазоном от 10 000 до 20 000 ячеек сначала со строкой `cell.untrack()`, а затем без нее. Вы должны заметить, что код выполняется с использованием строки `cell.untrack()` быстрее, чем без нее. Вы также можете заметить уменьшение времени отклика впоследствии, так как этап очистки занимает меньше времени.

```js
Excel.run(async (context) => {
    var largeRange = context.workbook.getSelectedRange();
    largeRange.load(["rowCount", "columnCount"]);
    await context.sync();

    for (var i = 0; i < largeRange.rowCount; i++) {
        for (var j = 0; j < largeRange.columnCount; j++) {
            var cell = largeRange.getCell(i, j);
            cell.values = [[i *j]];

            // Call untrack() to release the range from memory.
            cell.untrack();
        }
    }

    await context.sync();
});
```

Обратите внимание, что необходимость в отслеживании объектов становится важной только при работе с тысячами. Большинству надстроек не требуется управлять отслеживанием объектов прокси-сервера.

## <a name="see-also"></a>См. также

- [Конфиденциальность и безопасность надстроек Office](../concepts/privacy-and-security.md)
- [Ограничения активации и API JavaScript для надстроек Outlook](../outlook/limits-for-activation-and-javascript-api-for-outlook-add-ins.md)
- [Оптимизация производительности с использованием API JavaScript для Excel](../excel/performance.md)
