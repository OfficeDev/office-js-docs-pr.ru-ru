---
title: Руководство по пользовательским функциям в Excel
description: Из этого руководства вы узнаете, как создать надстройку, Excel, содержащую пользовательские функции, которые могут выполнять вычисления, запрашивать или передавать веб-данные.
ms.date: 05/08/2019
ms.prod: excel
ms.topic: tutorial
localization_priority: Normal
ms.openlocfilehash: ed9f16bdb330aa3f092e7d437ccfad6e056e07d4
ms.sourcegitcommit: a99be9c4771c45f3e07e781646e0e649aa47213f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2019
ms.locfileid: "33952196"
---
# <a name="tutorial-create-custom-functions-in-excel"></a>Руководство: создание пользовательских функций в Excel

Пользовательские функции позволяют добавлять новые функции в Excel путем определения этих функций в JavaScript как части надстройки. Пользователи в Excel могут получить доступ к пользовательским функциям так же, как и к любой встроенной функции в Excel, например `SUM()`. Вы можете создавать пользовательские функции, которые будут выполнять простые задачи, такие как вычисления, или более сложные задачи, такие как потоковая передача данных в режиме реального времени из Интернета на лист.

В этом руководстве описан порядок выполнения перечисленных ниже задач.
> [!div class="checklist"]
> * Создание надстройки пользовательской функции с помощью [генератора Yeoman для надстроек Office](https://www.npmjs.com/package/generator-office). 
> * Использование готовой пользовательской функции для выполнения простых вычислений
> * Создание пользовательской функции, которая получает данные из сети Интернет.
> * Создание пользовательской функции, которая осуществляет потоковую передачу данных в реальном времени из сети Интернет

## <a name="prerequisites"></a>Необходимые компоненты

[!include[Yeoman generator prerequisites](../includes/quickstart-yo-prerequisites.md)]

* Excel в Windows (64-разрядная версия 1810 или более поздняя) или Excel Online

* Присоединитесь к [Программе предварительной оценки Office](https://products.office.com/office-insider) (уровень **Участник**; ранее "Предварительная оценка — ранний доступ")

## <a name="create-a-custom-functions-project"></a>Создание проекта пользовательских функций

 Чтобы начать, вам необходимо создать проект кода для разработки надстройки пользовательской функции. [Генератор Yeoman для надстроек Office](https://www.npmjs.com/package/generator-office) настроит проект с помощью некоторых предварительно созданных настраиваемых функций, которые можно испытать. Если вы уже запустили функцию быстрого запуска пользовательских функций и создали проект, продолжайте использовать этот проект и переходите к [этому шагу](#create-a-custom-function-that-requests-data-from-the-web) .

1. Выполните указанную ниже команду и ответьте на вопросы, как показано ниже.
    
    ```command&nbsp;line
    yo office
    ```
    
    * **Выберите тип проекта:** `Excel Custom Functions Add-in project (...)`
    * **Выберите тип сценария:** `JavaScript`
    * **Как вы хотите назвать надстройку?** `stock-ticker`

    ![Генератор Yeoman для надстройки Office, приглашающий к созданию пользовательских функций](../images/yo-office-excel-cf.png)
    
    Генератор Yeoman создаст файлы проекта и установит вспомогательные компоненты Node.

2. Перейдите к корневой папке проекта.
    
    ```command&nbsp;line
    cd stock-ticker
    ```

3. Выполните сборку проекта.
    
    ```command&nbsp;line
    npm run build
    ```

4. Запустите локальный веб-сервер, работающий на Node.js. Вы можете испытать надстройку настраиваемой функции в Excel для Windows или Excel Online.

# <a name="excel-on-windowstabexcel-windows"></a>[Excel в Windows](#tab/excel-windows)

Чтобы протестировать надстройку в Excel в Windows, выполните следующую команду. При выполнении этой команды локальный веб-сервер запустится и откроется приложение Excel в Windows с загруженной надстройкой.

```command&nbsp;line
npm run start:desktop
```

> [!NOTE]
> Надстройки Office должны использовать HTTPS, а не HTTP, даже в случае разработки. Если вам будет предложено установить сертификат после того, как вы запустите `npm run start:desktop`, примите предложение установить сертификат от генератора Yeoman.

# <a name="excel-onlinetabexcel-online"></a>[Excel Online](#tab/excel-online)

Чтобы протестировать надстройку в Excel Online, выполните следующую команду. После выполнения этой команды запустится локальный веб-сервер.

```command&nbsp;line
npm run start:web
```

> [!NOTE]
> Надстройки Office должны использовать HTTPS, а не HTTP, даже в случае разработки. Если вам будет предложено установить сертификат после того, как вы запустите `npm run start:web`, примите предложение установить сертификат от генератора Yeoman.

Чтобы использовать надстройку с пользовательскими функциями, откройте новую книгу в Excel Online. В этой книге выполните следующие действия, чтобы Загрузка неопубликованных надстройку.

1. В Excel Online на вкладке **Вставка** выберите пункт **Надстройки**.

   ![Вставка ленты в Excel Online с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)
   
2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

4. Выберите файл **manifest.xml** и нажмите кнопку **Открыть**, затем нажмите кнопку **Отправить**.

--- 
    
## <a name="try-out-a-prebuilt-custom-function"></a>Проверка работы готовой пользовательской функции

Созданный проект пользовательских функций содержит некоторые предварительно созданные пользовательские функции, определенные в файле **./СРК/функтионс/функтионс.ЖС** . Файл **./manifest.xml** указывает, что все пользовательские функции принадлежат пространству имен `CONTOSO`. Вы будете использовать пространство имен CONTOSO для доступа к пользовательским функциям в Excel.

Затем вы проверите пользовательскую функцию `ADD`, выполнив описанные ниже действия:

1. В Excel перейдите в любую ячейку и введите `=CONTOSO`. Обратите внимание на то, что в меню автозаполнения содержится список всех функций в пространстве имен `CONTOSO`.

2. Выполните запуск функции `CONTOSO.ADD` с числами `10` и `200` в качестве входных параметров, введя значение `=CONTOSO.ADD(10,200)` в ячейке и нажав клавишу ВВОД.

Пользовательская функция `ADD` вычисляет сумму двух чисел, которые вы указываете и возвращает результат **210**.

## <a name="create-a-custom-function-that-requests-data-from-the-web"></a>Создание пользовательской функции, которая запрашивает данные из сети Интернет

Интеграция данных из Интернета — отличный способ расширения функционала Excel через пользовательские функции. Далее необходимо создать пользовательскую функцию под именем `stockPrice`, которая получает котировки акций из Web API и возвращает результат в ячейку на листе. Вы будете использовать API IEX Trading, который предоставляется бесплатно и не требует проверки подлинности.

1. В проекте **Stocks —** найдите файл **./СРК/функтионс/функтионс.ЖС** и откройте его в редакторе кода.

2. В файле Function **. js**нахождение `increment` функции и добавление следующего кода после этой функции.

    ```js
    /**
    * Fetches current stock price
    * @customfunction 
    * @param {string} ticker Stock symbol
    * @returns {number} The current stock price.
    */
    function stockPrice(ticker) {
        var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
        return fetch(url)
            .then(function(response) {
                return response.text();
            })
            .then(function(text) {
                return parseFloat(text);
            });

        // Note: in case of an error, the returned rejected Promise
        //    will be bubbled up to Excel to indicate an error.
    }
    CustomFunctions.associate("STOCKPRICE", stockPrice);
    ```

    Код `CustomFunctions.associate` сопоставляет `id` функции с адресом функции `stockPrice` в JavaScript, чтобы Excel мог вызвать вашу функцию.

3. Выполните указанную ниже команду, чтобы повторно собрать проект.

    ```command&nbsp;line
    npm run build
    ```

4. Выполните следующие действия (для Excel в Windows или Excel Online), чтобы повторно зарегистрировать надстройку в Excel. Прежде чем новая функция станет доступна, необходимо выполнить указанные ниже действия. 

# <a name="excel-on-windowstabexcel-windows"></a>[Excel в Windows](#tab/excel-windows)

1. Закройте Excel, а затем откройте Excel повторно.

2. В Excel перейдите на вкладку **Вставка** , а затем щелкните стрелку вниз, расположенную справа от **моих надстроек**.  ![Вставка ленты в Excel в Windows с выделенной стрелкой "Мои надстройки"](../images/select-insert.png)

3. В списке доступных надстроек найдите раздел **Надстройки разработчика** и выберите надстройку **stock-ticker**, чтобы зарегистрировать ее.
    ![Вставка ленты в Excel в Windows с выделенной надстройкой "пользовательские функции Excel" в списке "Мои надстройки"](../images/list-stock-ticker-red.png)

# <a name="excel-onlinetabexcel-online"></a>[Excel Online](#tab/excel-online)

1. В Excel Online выберите вкладку **Вставка**, а затем выберите **Надстройки**. ![Вставьте ленту в Excel Online с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**. 

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman. 

4. Выберите файл **manifest.xml** и нажмите **Открыть**, затем нажмите кнопку **Отправить**.

---

<ol start="5">
<li> Теперь давайте оценим, как работает новая функция. В ячейке <strong>B1</strong> введите нужный текст <strong>= CONTOSO. STOCKPRICE("MSFT")</strong> и нажмите ВВОД. Вы должны увидеть, что результат в ячейке <strong>B1</strong> является текущей ценой одной акции корпорации Майкрософт.</li>
</ol>

## <a name="create-a-streaming-asynchronous-custom-function"></a>Создание потоковой асинхронной пользовательской функции

Функция `stockPrice` возвращает цену акции в конкретный момент времени, однако цены на акции всегда меняются. Далее вы создадите пользовательскую функцию с именем `stockPriceStream`, которая получает цену акции каждые 1000 милисекунд.

1. В проекте **Stocks – Tick** добавьте следующий код в файл **./СРК/функтионс/функтионс.ЖС** и сохраните его.

    ```js
    /**
    * Streams real time stock price
    * @customfunction 
    * @param {string} ticker Stock symbol
    * @param {CustomFunctions.StreamingInvocation<number>} invocation
    */
    function stockPriceStream(ticker, invocation) {
        var updateFrequency = 1000 /* milliseconds*/;
        var isPending = false;

        var timer = setInterval(function() {
            // If there is already a pending request, skip this iteration:
            if (isPending) {
                return;
            }

            var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
            isPending = true;

            fetch(url)
                .then(function(response) {
                    return response.text();
                })
                .then(function(text) {
                    invocation.setResult(parseFloat(text));
                })
                .catch(function(error) {
                    invocation.setResult(error);
                })
                .then(function() {
                    isPending = false;
                });
        }, updateFrequency);

        invocation.onCanceled = () => {
            clearInterval(timer);
        };
    }
    CustomFunctions.associate("STOCKPRICESTREAM", stockPriceStream);
    ```
    
    Код `CustomFunctions.associate` сопоставляет `id` функции с адресом функции `stockPriceStream` в JavaScript, чтобы Excel мог вызвать вашу функцию.
    
2. Выполните указанную ниже команду, чтобы повторно собрать проект.

    ```command&nbsp;line
    npm run build
    ```

3. Выполните следующие действия (для Excel в Windows или Excel Online), чтобы повторно зарегистрировать надстройку в Excel. Прежде чем новая функция станет доступна, необходимо выполнить указанные ниже действия. 

# <a name="excel-on-windowstabexcel-windows"></a>[Excel в Windows](#tab/excel-windows)

1. Закройте Excel, а затем откройте Excel повторно.

2. В Excel перейдите на вкладку **Вставка** , а затем щелкните стрелку вниз, расположенную справа от **моих надстроек**.  ![Вставка ленты в Excel в Windows с выделенной стрелкой "Мои надстройки"](../images/select-insert.png)

3. В списке доступных надстроек найдите раздел **Надстройки разработчика** и выберите надстройку **stock-ticker**, чтобы зарегистрировать ее.
    ![Вставка ленты в Excel в Windows с выделенной надстройкой "пользовательские функции Excel" в списке "Мои надстройки"](../images/list-stock-ticker-red.png)

# <a name="excel-onlinetabexcel-online"></a>[Excel Online](#tab/excel-online)

1. В Excel Online выберите вкладку **Вставка**, а затем выберите **Надстройки**. ![Вставьте ленту в Excel Online с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

4. Выберите файл **manifest.xml** и нажмите **Открыть**, затем нажмите кнопку **Отправить**.

--- 

<ol start="4">
<li>Теперь давайте оценим, как работает новая функция. В ячейке <strong>C1</strong> введите нужный текст <strong>=CONTOSO.STOCKPRICESTREAM("MSFT")</strong> и нажмите ВВОД. Если рынок ценных бумаг открыт, вы увидите, что результат в ячейке <strong>C1</strong> постоянно обновляется, отражая в режиме реального времени цену одной акции корпорации Майкрософт.</li>
</ol>

## <a name="next-steps"></a>Дальнейшие действия

Поздравляем! Вы создали новый проект пользовательских функций, попробовали, как работает готовая функция, создали пользовательскую функцию, которая запрашивает данные из Интернета, а также создали пользовательскую функцию, которая осуществляет потоковую передачу данных в реальном времени из сети Интернет. Вы также можете попробовать выполнить отладку этой функции [, используя инструкции по отладке пользовательских функций](../excel/custom-functions-debugging.md). Чтобы узнать больше о пользовательских функции в Excel, перейдите к следующей статье:

> [!div class="nextstepaction"]
> [Создание пользовательских функций в Excel](../excel/custom-functions-overview.md)

### <a name="legal-information"></a>Юридические сведения

Данные предоставлены бесплатно компанией [IEX](https://iextrading.com/developer/). Ознакомьтесь с [Условиями использования IEX](https://iextrading.com/api-exhibit-a/). Корпорация Майкрософт использует API компании IEX в этом руководстве исключительно в ознакомительных целях.
