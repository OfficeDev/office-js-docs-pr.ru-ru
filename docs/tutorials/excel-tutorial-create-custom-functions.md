---
title: Руководство по пользовательским функциям в Excel
description: Из этого руководства вы узнаете, как создать надстройку, Excel, содержащую пользовательские функции, которые могут выполнять вычисления, запрашивать или передавать веб-данные.
ms.date: 07/09/2019
ms.prod: excel
localization_priority: Normal
ms.openlocfilehash: 2832df467f7e155ed026fe7f04837f18a4d2309d
ms.sourcegitcommit: 49af31060aa56c1e1ec1e08682914d3cbefc3f1c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2019
ms.locfileid: "36672875"
---
# <a name="tutorial-create-custom-functions-in-excel"></a>Руководство: создание пользовательских функций в Excel

Пользовательские функции позволяют добавлять новые функции в Excel путем определения этих функций в JavaScript как части надстройки. Пользователи в Excel могут получить доступ к пользовательским функциям так же, как и к любой встроенной функции в Excel, например `SUM()`. Вы можете создавать пользовательские функции, которые будут выполнять простые задачи, такие как вычисления, или более сложные задачи, такие как потоковая передача данных в режиме реального времени из Интернета на лист.

В этом руководстве описан порядок выполнения перечисленных ниже задач.
> [!div class="checklist"]
> * Создание надстройки пользовательской функции с помощью [генератора Yeoman для надстроек Office](https://www.npmjs.com/package/generator-office). 
> * Использование готовой пользовательской функции для выполнения простых вычислений
> * Создание пользовательской функции, которая получает данные из сети Интернет.
> * Создание пользовательской функции, которая осуществляет потоковую передачу данных в реальном времени из сети Интернет

## <a name="prerequisites"></a>Необходимые компоненты

[!include[Yeoman generator prerequisites](../includes/quickstart-yo-prerequisites.md)]

* Excel в Windows (версия 1904 или более поздняя версия, подключенная к подписке на Office 365) или в Интернете

## <a name="create-a-custom-functions-project"></a>Создание проекта пользовательских функций

 Чтобы начать, вам необходимо создать проект кода для разработки надстройки пользовательской функции. [Генератор Yeoman для надстроек Office](https://www.npmjs.com/package/generator-office) настроит проект с помощью некоторых предварительно созданных настраиваемых функций, которые можно испытать. Если вы уже запустили функцию быстрого запуска пользовательских функций и создали проект, продолжайте использовать этот проект и переходите к [этому шагу](#create-a-custom-function-that-requests-data-from-the-web) .

[!include[note about Yeoman generator bug](../includes/note-yeoman-generator-bug-201908.md)]

1. Выполните указанную ниже команду и ответьте на вопросы, как показано ниже.
    
    ```command&nbsp;line
    yo office
    ```
    
    * **Выберите тип проекта:** `Excel Custom Functions Add-in project`
    * **Выберите тип сценария:** `JavaScript`
    * **Как вы хотите назвать надстройку?** `starcount`

    ![Генератор Yeoman для надстройки Office, приглашающий к созданию пользовательских функций](../images/starcountPrompt.png)
    
    Генератор Yeoman создаст файлы проекта и установит вспомогательные компоненты Node.

2. Перейдите к корневой папке проекта.
    
    ```command&nbsp;line
    cd starcount
    ```

3. Выполните построение проекта.
    
    ```command&nbsp;line
    npm run build
    ```

    > [!NOTE]
    > Надстройки Office должны использовать HTTPS, а не HTTP, даже в случае разработки. Если вам будет предложено установить сертификат после того, как вы запустите `npm run build`, примите предложение установить сертификат от генератора Yeoman.

4. Запустите локальный веб-сервер, работающий на Node.js. Вы можете испытать надстройку настраиваемой функции в Excel в Интернете или в Windows.

# <a name="excel-on-windows-or-mactabexcel-windows"></a>[Excel в Windows или Mac](#tab/excel-windows)

Чтобы протестировать надстройку в Excel для Windows или Mac, выполните следующую команду. При выполнении этой команды запустится локальный веб-сервер, и откроется приложение Excel с загруженной надстройкой.

```command&nbsp;line
npm run start:desktop
```

# <a name="excel-on-the-webtabexcel-online"></a>[Excel в Интернете](#tab/excel-online)

Чтобы протестировать надстройку в Excel в браузере, выполните следующую команду. После выполнения этой команды запустится локальный веб-сервер.

```command&nbsp;line
npm run start:web
```

Чтобы использовать надстройку с пользовательскими функциями, откройте новую книгу в Excel в Интернете. В этой книге выполните следующие действия, чтобы Загрузка неопубликованных надстройку.

1. В Excel перейдите на вкладку **Вставка** , а затем выберите **** пункт надстройки.

   ![Вставка ленты в Excel в Интернете с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)
   
2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

4. Выберите файл **manifest.xml** и нажмите кнопку **Открыть**, затем нажмите кнопку **Отправить**.

--- 
    
## <a name="try-out-a-prebuilt-custom-function"></a>Проверка работы готовой пользовательской функции

Созданный проект пользовательских функций содержит некоторые предварительно созданные пользовательские функции, определенные в файле **./СРК/функтионс/функтионс.ЖС** . Файл **./manifest.xml** указывает, что все пользовательские функции принадлежат пространству имен `CONTOSO`. Вы будете использовать пространство имен CONTOSO для доступа к пользовательским функциям в Excel.

Затем вы проверите пользовательскую функцию `ADD`, выполнив описанные ниже действия:

1. В Excel перейдите в любую ячейку и введите `=CONTOSO`. Обратите внимание на то, что в меню автозаполнения содержится список всех функций в пространстве имен `CONTOSO`.

2. Выполните запуск функции `CONTOSO.ADD` с числами `10` и `200` в качестве входных параметров, введя значение `=CONTOSO.ADD(10,200)` в ячейке и нажав клавишу ВВОД.

Пользовательская функция `ADD` вычисляет сумму двух чисел, которые вы указываете и возвращает результат **210**.

## <a name="create-a-custom-function-that-requests-data-from-the-web"></a>Создание пользовательской функции, которая запрашивает данные из сети Интернет

Интеграция данных из Интернета — отличный способ расширения функционала Excel через пользовательские функции. Далее вы создадите пользовательскую функцию с именем `getStarCount` , которая показывает количество звезд, которыми обладает данный репозиторий GitHub.

1. В проекте **старкаунт** найдите файл **./СРК/функтионс/функтионс.ЖС** и откройте его в редакторе кода. 

2. В файле **Function. js**добавьте следующий код: 

```JS
/**
  * Gets the star count for a given Github repository.
  * @customfunction 
  * @param {string} userName string name of Github user or organization.
  * @param {string} repoName string name of the Github repository.
  * @return {number} number of stars given to a Github repository.
  */
  async function getStarCount(userName, repoName) {
    try {
      //You can change this URL to any web request you want to work with.
      const url = "https://api.github.com/repos/" + userName + "/" + repoName;
      const response = await fetch(url);
      //Expect that status code is in 200-299 range
      if (!response.ok) {
        throw new Error(response.statusText)
      }
        const jsonResponse = await response.json();
        return jsonResponse.watchers_count;
    }
    catch (error) {
      return error;
    }
  }
```

3. Выполните указанную ниже команду, чтобы повторно собрать проект.

    ```command&nbsp;line
    npm run build
    ```

4. Выполните следующие действия (для Excel в Интернете, Windows или Mac), чтобы повторно зарегистрировать надстройку в Excel. Прежде чем новая функция станет доступна, необходимо выполнить указанные ниже действия.

### <a name="excel-on-windows-or-mactabexcel-windows"></a>[Excel в Windows или Mac](#tab/excel-windows)

1. Закройте Excel, а затем откройте Excel повторно.

2. В Excel перейдите на вкладку **Вставка** , а затем щелкните стрелку вниз, расположенную справа от **моих надстроек**.  ![Вставка ленты в Excel в Windows с выделенной стрелкой "Мои надстройки"](../images/select-insert.png)

3. В списке доступных надстроек найдите раздел надстройки для **разработчиков** и выберите надстройку **старкаунт** , чтобы зарегистрировать ее.
    ![Вставка ленты в Excel в Windows с выделенной надстройкой "пользовательские функции Excel" в списке "Мои надстройки"](../images/list-starcount.png)


# <a name="excel-on-the-webtabexcel-online"></a>[Excel в Интернете](#tab/excel-online)

1. В Excel перейдите на вкладку **Вставка** , а затем выберите **** пункт надстройки.  ![Вставка ленты в Excel в Интернете с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

4. Выберите файл **manifest.xml** и нажмите **Открыть**, затем нажмите кнопку **Отправить**.

---

<ol start="5">
<li> Теперь давайте оценим, как работает новая функция. В ячейке <strong>B1</strong>введите текст <strong>= contoso. ЖЕТСТАРКАУНТ ("OfficeDev", "Excel-Custom-functions")</strong> и нажмите клавишу ВВОД. Вы увидите, что в ячейке <strong>B1</strong> получено текущее число звезд, заданное репозиторием [GitHub Excel-Custom-functions](https://github.com/OfficeDev/Excel-Custom-Functions).</li>
</ol>

## <a name="create-a-streaming-asynchronous-custom-function"></a>Создание потоковой асинхронной пользовательской функции

`getStarCount` Функция возвращает число звезд, которые репозиторий содержит в определенный момент времени. Пользовательские функции также могут возвращать непрерывно изменяемые данные. Эти функции называются потоковыми функциями. Они должны включать `invocation` параметр, который ссылается на ячейку, в которой была вызвана функция. `invocation` Параметр используется для обновления содержимого ячейки в любое время.  

В приведенном ниже примере кода обратите внимание, что существуют две функции `currentTime` и. `clock` `currentTime` Функция — это статическая функция, которая не использует потоковую передачу. Он возвращает дату в виде строки. `clock` Функция использует `currentTime` функцию, чтобы указать новое время каждую секунду для ячейки в Excel. Он используется `invocation.setResult` для доставки времени в ячейку Excel и `invocation.onCanceled` обработки действий, выполняемых при отмене функции.

1. В проекте **старкаунт** добавьте следующий код в файл **./СРК/функтионс/функтионс.ЖС** и сохраните его.

```JS
/**
 * Returns the current time
 * @returns {string} String with the current time formatted for the current locale.
 */
function currentTime() {
  return new Date().toLocaleTimeString();
}

 /**
 * Displays the current time once a second
 * @customfunction
 * @param {CustomFunctions.StreamingInvocation<string>} invocation Custom function invocation
 */
function clock(invocation) {
  const timer = setInterval(() => {
    const time = currentTime();
    invocation.setResult(time);
  }, 1000);

  invocation.onCanceled = () => {
    clearInterval(timer);
  };
}
```

2. Выполните указанную ниже команду, чтобы повторно собрать проект.

    ```command&nbsp;line
    npm run build
    ```

3. Выполните следующие действия (для Excel в Интернете, Windows или Mac), чтобы повторно зарегистрировать надстройку в Excel. Прежде чем новая функция станет доступна, необходимо выполнить указанные ниже действия. 

# <a name="excel-on-windows-or-mactabexcel-windows"></a>[Excel в Windows или Mac](#tab/excel-windows)

1. Закройте Excel, а затем откройте Excel повторно.

2. В Excel перейдите на вкладку **Вставка** , а затем щелкните стрелку вниз, расположенную справа от **моих надстроек**.  ![Вставка ленты в Excel в Windows с выделенной стрелкой "Мои надстройки"](../images/select-insert.png)

3. В списке доступных надстроек найдите раздел надстройки для **разработчиков** и выберите надстройку **старкаунт** , чтобы зарегистрировать ее.
    ![Вставка ленты в Excel в Windows с выделенной надстройкой "пользовательские функции Excel" в списке "Мои надстройки"](../images/list-starcount.png)

# <a name="excel-on-the-webtabexcel-online"></a>[Excel в Интернете](#tab/excel-online)

1. В Excel перейдите на вкладку **Вставка** , а затем выберите **** пункт надстройки.  ![Вставка ленты в Excel в Интернете с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

4. Выберите файл **manifest.xml** и нажмите **Открыть**, затем нажмите кнопку **Отправить**.

--- 

<ol start="4">
<li>Теперь давайте оценим, как работает новая функция. В ячейке <strong>C1</strong>введите текст <strong>= contoso. CLOCK ())</strong> и нажмите клавишу ВВОД. Должна отобразиться текущая дата, которая пересылает обновление каждую секунду. Несмотря на то, что часы находятся только в цикле, вы можете использовать ту же идею задания таймера для более сложных функций, которые делают веб-запросы для данных в режиме реального времени.</li>
</ol>

## <a name="next-steps"></a>Дальнейшие действия

Поздравляем! Вы создали новый проект пользовательских функций, выполнили предварительно составленную функцию, создал пользовательскую функцию, которая запрашивает данные из веб-сайта, и создала пользовательскую функцию, которая пересылает данные. Вы также можете попробовать выполнить отладку этой функции [, используя инструкции по отладке пользовательских функций](../excel/custom-functions-debugging.md). Чтобы узнать больше о пользовательских функции в Excel, перейдите к следующей статье:

> [!div class="nextstepaction"]
> [Создание пользовательских функций в Excel](../excel/custom-functions-overview.md)
