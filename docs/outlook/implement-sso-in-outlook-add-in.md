---
title: 'Сценарий: реализация единого входа для службы'
description: Узнайте, как реализовать единый вход в службе с помощью маркера единого входа и маркера удостоверения Exchange, предоставляемых надстройкой Outlook.
ms.date: 02/09/2021
localization_priority: Normal
ms.openlocfilehash: 44a1ee10af3f49a3738526b0ee7daf6cada3774b
ms.sourcegitcommit: fefc279b85e37463413b6b0e84c880d9ed5d7ac3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2021
ms.locfileid: "50234235"
---
# <a name="scenario-implement-single-sign-on-to-your-service-in-an-outlook-add-in"></a><span data-ttu-id="ae83b-103">Сценарий: реализация единого входа для службы в надстройке Outlook</span><span class="sxs-lookup"><span data-stu-id="ae83b-103">Scenario: Implement single sign-on to your service in an Outlook add-in</span></span>

<span data-ttu-id="ae83b-104">В этой статье мы рассмотрим рекомендуемый способ совместного применения [маркера доступа для единого входа](authenticate-a-user-with-an-sso-token.md) и [маркера удостоверения Exchange](authenticate-a-user-with-an-identity-token.md) для обеспечения единого входа во внутренней службе.</span><span class="sxs-lookup"><span data-stu-id="ae83b-104">In this article we'll explore a recommended method of using the [single sign-on access token](authenticate-a-user-with-an-sso-token.md) and the [Exchange identity token](authenticate-a-user-with-an-identity-token.md) together to provide a single-sign on implementation to your own backend service.</span></span> <span data-ttu-id="ae83b-105">Применяя эти маркеры вместе, вы можете воспользоваться преимуществами маркера доступа для единого входа, если этот токен доступен, при этом обеспечив работу надстройки даже при отсутствии такого маркера (например, когда пользователь переходит на клиент, не поддерживающий подобные маркеры, или почтовый ящик пользователя находится на локальном сервере Exchange Server).</span><span class="sxs-lookup"><span data-stu-id="ae83b-105">By using both tokens together, you can take advantage of the benefits of the SSO access token when it is available, while ensuring that your add-in will work when it is not, such as when the user switches to a client that does not support them, or if the user's mailbox is on an on-premises Exchange server.</span></span>

<span data-ttu-id="ae83b-106">Пример надстройки, которая реализует идеи из этой статьи, см. в статье Об [SSO надстройки Outlook.](https://github.com/OfficeDev/Outlook-Add-in-SSO)</span><span class="sxs-lookup"><span data-stu-id="ae83b-106">For a sample add-in that implements the ideas in this article, see [Outlook Add-in SSO](https://github.com/OfficeDev/Outlook-Add-in-SSO).</span></span>


> [!NOTE]
> <span data-ttu-id="ae83b-107">API единого входа в настоящее время поддерживается для Word, Excel, Outlook и PowerPoint.</span><span class="sxs-lookup"><span data-stu-id="ae83b-107">The Single Sign-on API is currently supported for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="ae83b-108">Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).</span><span class="sxs-lookup"><span data-stu-id="ae83b-108">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> <span data-ttu-id="ae83b-109">Если вы работаете с надстройкой Outlook, обязательно включите современную проверку подлинности для клиента Microsoft 365.</span><span class="sxs-lookup"><span data-stu-id="ae83b-109">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Microsoft 365 tenancy.</span></span> <span data-ttu-id="ae83b-110">Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span><span class="sxs-lookup"><span data-stu-id="ae83b-110">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>


## <a name="why-use-the-sso-access-token"></a><span data-ttu-id="ae83b-111">Зачем использовать маркер доступа с единым входом?</span><span class="sxs-lookup"><span data-stu-id="ae83b-111">Why use the SSO access token?</span></span>

<span data-ttu-id="ae83b-112">Маркер удостоверения Exchange доступен во всех наборах обязательных элементов для API надстроек, поэтому легко прийти к выводу, что можно использовать только этот токен, игнорируя маркер единого входа.</span><span class="sxs-lookup"><span data-stu-id="ae83b-112">The Exchange identity token is available in all requirement sets of the add-in APIs, so it may be tempting to just rely on this token and ignore the SSO token altogether.</span></span> <span data-ttu-id="ae83b-113">Однако маркер единого входа обладает некоторыми преимуществами по сравнению с маркером удостоверения Exchange, поэтому рекомендуется использовать такие маркеры по мере возможности.</span><span class="sxs-lookup"><span data-stu-id="ae83b-113">However, the SSO token offers some advantages over the Exchange identity token which make it the recommended method to use when it is available.</span></span>

- <span data-ttu-id="ae83b-114">Маркер единого входа представлен в стандартном формате OpenID и выдается службой Azure.</span><span class="sxs-lookup"><span data-stu-id="ae83b-114">The SSO token uses a standard OpenID format and is issued by Azure.</span></span> <span data-ttu-id="ae83b-115">Это значительно упрощает проверку таких маркеров.</span><span class="sxs-lookup"><span data-stu-id="ae83b-115">This greatly simplifies the process of validating these tokens.</span></span> <span data-ttu-id="ae83b-116">С другой стороны, для маркеров удостоверений Exchange используется специальный формат, основанный на стандарте JSON Web Token, поэтому для проверки маркера требуются дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="ae83b-116">In comparison, Exchange identity tokens use a custom format based on the JSON Web Token standard, requiring custom work to validate the token.</span></span>
- <span data-ttu-id="ae83b-117">Маркер единого входа можно использовать во внутренней службе для получения маркера доступа к Microsoft Graph. При этом пользователю не требуется выполнять дополнительных действий для входа.</span><span class="sxs-lookup"><span data-stu-id="ae83b-117">The SSO token can be used by your backend to retrieve an access token for Microsoft Graph without the user having to do any additional sign in action.</span></span>
- <span data-ttu-id="ae83b-118">Маркер единого входа предоставляет больше сведений об удостоверении, например отображаемое имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="ae83b-118">The SSO token provides richer identity information, such as the user's display name.</span></span>

## <a name="add-in-scenario"></a><span data-ttu-id="ae83b-119">Сценарий надстройки</span><span class="sxs-lookup"><span data-stu-id="ae83b-119">Add-in scenario</span></span>

<span data-ttu-id="ae83b-120">В этом примере рассматривается надстройка, состоящая из пользовательского интерфейса и скриптов (HTML и JavaScript), а также внутреннего веб-API, вызываемого надстройкой.</span><span class="sxs-lookup"><span data-stu-id="ae83b-120">For the purposes of this example, consider an add-in that consists of both the add-in UI and scripts (HTML + JavaScript) and a backend Web API that is called by the add-in.</span></span> <span data-ttu-id="ae83b-121">Внутренний веб-API вызывает как [API Microsoft Graph](/graph/overview), так и API данных Contoso — вымышленный API от стороннего разработчика.</span><span class="sxs-lookup"><span data-stu-id="ae83b-121">The backend Web API makes calls both to the [Microsoft Graph API](/graph/overview) and the Contoso Data API, a fictional API created by a third party.</span></span> <span data-ttu-id="ae83b-122">Как и API Microsoft Graph, API данных Contoso требует проверку подлинности OAuth.</span><span class="sxs-lookup"><span data-stu-id="ae83b-122">Like the Microsoft Graph API, the Contoso Data API requires OAuth authentication.</span></span> <span data-ttu-id="ae83b-123">Необходимо, чтобы внутренний веб-API мог вызывать оба API, не запрашивая учетные данные пользователя каждый раз, когда истекает срок действия маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="ae83b-123">The requirement is that the backend Web API should be able to call both APIs without having to prompt the user for their credentials every time an access token expires.</span></span>

<span data-ttu-id="ae83b-124">Для этого внутренний API создает надежную базу данных пользователей.</span><span class="sxs-lookup"><span data-stu-id="ae83b-124">To do this, the backend API creates a secure database of users.</span></span> <span data-ttu-id="ae83b-125">Каждому пользователю соответствует запись в базе данных, где внутренняя служба может хранить долговечные маркеры обновления для API Microsoft Graph и API данных Contoso.</span><span class="sxs-lookup"><span data-stu-id="ae83b-125">Each user will get an entry in the database where the backend can store long-lived refresh tokens for both the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="ae83b-126">Приведенная ниже разметка JSON представляет запись пользователя в базе данных.</span><span class="sxs-lookup"><span data-stu-id="ae83b-126">The following JSON markup represents a user's entry in the database.</span></span>

```JSON
{
  "userDisplayName": "...",
  "ssoId": "...",
  "exchangeId": "...",
  "graphRefreshToken": "...",
  "contosoRefreshToken": "..."
}
```

<span data-ttu-id="ae83b-127">Надстройка включает маркер доступа для единого входа (если этот токен доступен) или маркер удостоверения Exchange (если маркер единого входа недоступен) при каждом вызове внутреннего веб-API.</span><span class="sxs-lookup"><span data-stu-id="ae83b-127">The add-in includes either the SSO access token (if it is available) or the Exchange identity token (if the SSO token is not available) with every call it makes to the backend Web API.</span></span>

### <a name="add-in-startup"></a><span data-ttu-id="ae83b-128">Запуск надстройки</span><span class="sxs-lookup"><span data-stu-id="ae83b-128">Add-in startup</span></span>

1. <span data-ttu-id="ae83b-129">При запуске надстройка отправляет запрос внутреннему веб-API, чтобы определить, зарегистрирован ли пользователь (т. е. связана ли с ним запись в базе данных пользователей) и есть ли в API маркеры обновления для Graph и Contoso.</span><span class="sxs-lookup"><span data-stu-id="ae83b-129">When the add-in starts, it sends a request to the backend Web API to determine if the user is registered (i.e. has an associated record in the user database) and that the API has refresh tokens for both Graph and Contoso.</span></span> <span data-ttu-id="ae83b-130">В данные этого вызова надстройка включает как маркер единого входа (если этот токен доступен), так и маркер удостоверения.</span><span class="sxs-lookup"><span data-stu-id="ae83b-130">In this call, the add-in includes both the SSO token (if available) and the identity token.</span></span>

1. <span data-ttu-id="ae83b-131">Веб-API использует методы из статей [Проверка подлинности пользователя с помощью маркера единого входа в надстройке Outlook](authenticate-a-user-with-an-sso-token.md) и [Проверка подлинности пользователя с помощью маркера удостоверения для Exchange](authenticate-a-user-with-an-identity-token.md) для проверки и создания уникального идентификатора из обоих маркеров.</span><span class="sxs-lookup"><span data-stu-id="ae83b-131">The Web API uses the methods in [Authenticate a user with an single-sign-on token in an Outlook add-in](authenticate-a-user-with-an-sso-token.md) and [Authenticate a user with an identity token for Exchange](authenticate-a-user-with-an-identity-token.md) to validate and generate a unique identifier from both tokens.</span></span>

1. <span data-ttu-id="ae83b-132">Если маркер единого входа предоставлен, веб-API отправляет в базу данных пользователей запрос записи, где значение `ssoId` совпадает с уникальным идентификатором, созданным из маркера единого входа.</span><span class="sxs-lookup"><span data-stu-id="ae83b-132">If an SSO token was provided, the Web API then queries the user database for an entry that has an `ssoId` value that matches the unique identifier generated from the SSO token.</span></span>
   - <span data-ttu-id="ae83b-133">Если такая запись не существует, надстройка переходит к следующему этапу.</span><span class="sxs-lookup"><span data-stu-id="ae83b-133">If an entry did not exist, continue to the next step.</span></span>
   - <span data-ttu-id="ae83b-134">Если запись существует, надстройка переходит к этапу 5.</span><span class="sxs-lookup"><span data-stu-id="ae83b-134">If an entry exists, proceed to step 5.</span></span>

1. <span data-ttu-id="ae83b-135">Веб-API запрашивает из базы данных запись, где значение `exchangeId` совпадает с уникальным идентификатором, созданным из маркера удостоверения Exchange.</span><span class="sxs-lookup"><span data-stu-id="ae83b-135">The Web API queries the database for an entry that has an `exchangeId` value that matches the unique identifier generated from the Exchange identity token.</span></span>
   - <span data-ttu-id="ae83b-136">Если такая запись существует и маркер единого входа был предоставлен, запись пользователя в базе данных обновляется — свойству `ssoId` присваивается значение уникального идентификатора, созданного из маркера единого входа, после чего надстройка переходит к этапу 5.</span><span class="sxs-lookup"><span data-stu-id="ae83b-136">If an entry exists and an SSO token was provided, update the user's record in the database to set the `ssoId` value to the unique identifier generated from the SSO token and proceed to step 5.</span></span>
   - <span data-ttu-id="ae83b-137">Если запись существует, а маркер единого входа не предоставлен, надстройка переходит к этапу 5.</span><span class="sxs-lookup"><span data-stu-id="ae83b-137">If an entry exists and no SSO token was provided, proceed to step 5.</span></span>
   - <span data-ttu-id="ae83b-138">Если запись не существует, создается новая запись.</span><span class="sxs-lookup"><span data-stu-id="ae83b-138">If no entry exists, create a new entry.</span></span> <span data-ttu-id="ae83b-139">Свойству `ssoId` присваивается значение уникального идентификатора на основе маркера единого входа (если этот токен доступен), а свойству `exchangeId` — значение уникального идентификатора на основе маркера удостоверения Exchange.</span><span class="sxs-lookup"><span data-stu-id="ae83b-139">Set `ssoId` to the unique identifier generated from the SSO token (if available), and set `exchangeId` to the unique identifier generated from the Exchange identity token.</span></span>

1. <span data-ttu-id="ae83b-140">В значении `graphRefreshToken` выполняется поиск действительного маркера обновления.</span><span class="sxs-lookup"><span data-stu-id="ae83b-140">Check for a valid refresh token in the user's `graphRefreshToken` value.</span></span>
   - <span data-ttu-id="ae83b-141">Если значение отсутствует или не является действительным, а маркер единого входа был предоставлен, используется [поток "от имени" OAuth2](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) для получения маркеров доступа и обновления для Graph.</span><span class="sxs-lookup"><span data-stu-id="ae83b-141">If the value is missing or invalid and an SSO token was provided, use the [OAuth2 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) to obtain an access token and refresh token for Graph.</span></span> <span data-ttu-id="ae83b-142">Маркер обновления сохраняется в значении `graphRefreshToken` для пользователя.</span><span class="sxs-lookup"><span data-stu-id="ae83b-142">Save the refresh token in the `graphRefreshToken` value for the user.</span></span>

1. <span data-ttu-id="ae83b-143">Проверяется наличие действительных маркеров обновления в `graphRefreshToken` и `contosoRefreshToken`.</span><span class="sxs-lookup"><span data-stu-id="ae83b-143">Check for valid refresh tokens in both `graphRefreshToken` and `contosoRefreshToken`.</span></span>
   - <span data-ttu-id="ae83b-144">Если оба значения действительны, надстройке возвращается отклик о том, что пользователь уже зарегистрирован и настроен.</span><span class="sxs-lookup"><span data-stu-id="ae83b-144">If both values are valid, respond to the add-in to indicate that the user is already registered and configured.</span></span>
   - <span data-ttu-id="ae83b-145">Если какое-либо из этих значений недействительно, надстройке возвращается отклик о том, что требуется настройка пользователя, где также указаны службы (Graph или Contoso), которые требуется настроить.</span><span class="sxs-lookup"><span data-stu-id="ae83b-145">If either value is invalid, respond to the add-in to indicate that user setup is required, along with which services (Graph or Contoso) need to be configured.</span></span>

1. <span data-ttu-id="ae83b-146">Надстройка проверяет отклик.</span><span class="sxs-lookup"><span data-stu-id="ae83b-146">The add-in checks the response.</span></span>
   - <span data-ttu-id="ae83b-147">Если пользователь уже зарегистрирован и настроен, то надстройка возобновляет работу в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="ae83b-147">If the user is already registered and configured, the add-in continues with normal operation.</span></span>
   - <span data-ttu-id="ae83b-148">В противном случае надстройка переходит в режим "настройки" и предлагает пользователю пройти авторизацию.</span><span class="sxs-lookup"><span data-stu-id="ae83b-148">If user setup is required, the add-in enters "setup" mode and prompts the user to authorize the add-in.</span></span>

### <a name="authorize-the-backend-web-api"></a><span data-ttu-id="ae83b-149">Авторизация внутреннего веб-API</span><span class="sxs-lookup"><span data-stu-id="ae83b-149">Authorize the backend Web API</span></span>

<span data-ttu-id="ae83b-150">В идеале процедура авторизации внутреннего веб-API для вызова API Microsoft Graph и API данных Contoso должна выполняться только один раз, после чего пользователю не будет предлагаться войти.</span><span class="sxs-lookup"><span data-stu-id="ae83b-150">The procedure for authorizing the backend Web API to call the Microsoft Graph API and Contoso Data API should ideally only have to happen once, to minimize having to prompt the user for sign-in.</span></span>

<span data-ttu-id="ae83b-151">В зависимости от того, каков отклик от внутреннего веб-API, надстройке может потребоваться авторизовать пользователя для API Microsoft Graph, API данных Contoso или обоих интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="ae83b-151">Based on the response from the backend Web API, the add-in may need to authorize the user for the Microsoft Graph API, the Contoso Data API, or both.</span></span> <span data-ttu-id="ae83b-152">Так как оба API используют проверку подлинности OAuth2, для них используются похожие способы.</span><span class="sxs-lookup"><span data-stu-id="ae83b-152">Since both APIs use OAuth2 authentication, the method is similar for both.</span></span>

1. <span data-ttu-id="ae83b-153">Надстройка сообщает пользователю, что ему необходимо пройти авторизацию для использования API, и предлагает перейти по ссылке или нажать кнопку для начала процесса.</span><span class="sxs-lookup"><span data-stu-id="ae83b-153">The add-in notifies the user that it needs them to authorize their use of the API and asks them to click a link or button to start the process.</span></span>

    > [!NOTE]
    > <span data-ttu-id="ae83b-154">В примере надстройки в службе [SSO](https://github.com/OfficeDev/Outlook-Add-in-SSO) надстройки Outlook показано, как использовать [Dialog API](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) и библиотеку [office-js-helpers](https://github.com/OfficeDev/office-js-helpers) в качестве параметров для запуска потока кода авторизации [OAuth2](/azure/active-directory/develop/active-directory-protocols-oauth-code) для API.</span><span class="sxs-lookup"><span data-stu-id="ae83b-154">The example add-in at [Outlook Add-in SSO](https://github.com/OfficeDev/Outlook-Add-in-SSO) shows how to use the [Dialog API](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) and the [office-js-helpers library](https://github.com/OfficeDev/office-js-helpers) as options to start the [OAuth2 Authorization Code flow](/azure/active-directory/develop/active-directory-protocols-oauth-code) for the API.</span></span>

1. <span data-ttu-id="ae83b-155">По завершении потока надстройка отправляет маркер обновления внутреннему веб-API, включив маркер единого входа (если этот токен доступен) или маркер удостоверения Exchange.</span><span class="sxs-lookup"><span data-stu-id="ae83b-155">Once the flow completes, the add-in sends the refresh token to the backend Web API and includes the SSO token (if available) or the Exchange identity token.</span></span>

1. <span data-ttu-id="ae83b-156">Внутренний веб-API находит пользователя в базе данных и обновляет соответствующий маркер обновления.</span><span class="sxs-lookup"><span data-stu-id="ae83b-156">The backend Web API locates the user in the database and updates the appropriate refresh token.</span></span>

1. <span data-ttu-id="ae83b-157">Надстройка возобновляет работу в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="ae83b-157">The add-in continues with normal operation.</span></span>

### <a name="normal-operation"></a><span data-ttu-id="ae83b-158">Обычная работа</span><span class="sxs-lookup"><span data-stu-id="ae83b-158">Normal operation</span></span>

<span data-ttu-id="ae83b-159">Каждый раз, когда надстройка вызывает внутренний веб-API, она включает в вызов либо маркер единого входа, либо маркер удостоверения Exchange.</span><span class="sxs-lookup"><span data-stu-id="ae83b-159">Whenever the add-in calls the backend Web API, it includes either the SSO token or the Exchange identity token.</span></span> <span data-ttu-id="ae83b-160">Внутренний веб-API находит пользователя по этому токену, а затем использует сохраненные маркеры обновления, чтобы получить маркеры доступа для API Microsoft Graph и API данных Contoso.</span><span class="sxs-lookup"><span data-stu-id="ae83b-160">The backend Web API locates the user by this token, then uses the stored refresh tokens to obtain access tokens for the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="ae83b-161">Пока маркеры обновления действительны, пользователю не придется повторно выполнять вход.</span><span class="sxs-lookup"><span data-stu-id="ae83b-161">As long as the refresh tokens are valid, the user will not have to sign in again.</span></span>
