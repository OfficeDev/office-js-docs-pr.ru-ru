---
title: Проверка подлинности пользователя с помощью маркера удостоверения в надстройке
description: Узнайте, как реализовать единый вход в службе с помощью маркера удостоверения, предоставленного надстройкой Outlook.
ms.date: 10/31/2019
ms.localizationpriority: medium
ms.openlocfilehash: ff51cd4759d4b6e59fd18d6a613a4e6a85f2e152
ms.sourcegitcommit: 1306faba8694dea203373972b6ff2e852429a119
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2021
ms.locfileid: "59154235"
---
# <a name="authenticate-a-user-with-an-identity-token-for-exchange"></a>Проверка подлинности пользователя с помощью маркера удостоверения для Exchange

Маркеры удостоверений Exchange позволяют надстройке однозначно определять пользователей.
 Устанавливая удостоверение пользователя, вы можете реализовать единую схему проверки подлинности входов (SSO) для вашей задней службы, которая позволяет клиентам, использующим Outlook надстройки, подключаться к службе без регистрации. Дополнительные сведения о том, в каких случаях следует использовать такие токены, см. в разделе [Маркер удостоверения пользователя Exchange](authentication.md#exchange-user-identity-token). В этой статье мы рассмотрим простой способ проверки подлинности пользователя во внутренней службе с помощью маркера удостоверения Exchange.

> [!IMPORTANT]
> Это лишь простой пример реализации единого входа. Как всегда, при работе с удостоверениями и проверкой подлинности необходимо убедиться, что код соответствует требованиям к безопасности в вашей организации.

## <a name="send-the-id-token-with-each-request"></a>Отправка маркера удостоверения с каждым запросом

Для начала надстройка должна получить маркер удостоверения пользователя Exchange с сервера при помощи метода [getUserIdentityTokenAsync](../reference/objectmodel/preview-requirement-set/office.context.mailbox.md#methods). Затем надстройка отправляет этот маркер с каждым запросом ко внутренней службе. Он может быть включен в заголовок или текст запроса.

## <a name="validate-the-token"></a>Проверка маркера

Внутренняя служба ДОЛЖНА проверить маркер, прежде чем принимать его. Очень важно убедиться, что маркер был выдан сервером Exchange Server пользователя. Сведения о проверке маркеров удостоверений Exchange см. в статье [Проверка маркера удостоверения Exchange](validate-an-identity-token.md).

После проверки и декодирования нагрузка маркера выглядит следующим образом:

```json
{ 
    "aud" : "https://mailhost.contoso.com/IdentityTest.html",
    "iss" : "00000002-0000-0ff1-ce00-000000000000@mailhost.contoso.com",
    "nbf" : "1505749527",
    "exp" : "1505778327",
    "appctxsender":"00000002-0000-0ff1-ce00-000000000000@mailhost.context.com",
    "isbrowserhostedapp":"true",
    "appctx" : {
        "msexchuid" : "53e925fa-76ba-45e1-be0f-4ef08b59d389",
        "version" : "ExIdTok.V1",
        "amurl" : "https://mailhost.contoso.com:443/autodiscover/metadata/json/1"
    }
}
```

## <a name="map-the-token-to-a-user-in-your-backend"></a>Сопоставление маркера с пользователем во внутренней службе

Внутренняя служба может определить уникальный ИД пользователя на основе маркера и сопоставить его с пользователем во внутренней системе. Например, если для хранения пользователей используется база данных, вы можете добавить уникальный ИД к записи пользователя в ней.

### <a name="generate-a-unique-id"></a>Создание уникального идентификатора

Рекомендуем использовать сочетание свойств `msexchuid` и `amurl`. Например, вы можете сцепить эти два значения и создать строку в кодировке Base64. Это значение всегда можно получить из маркера, поэтому вы можете сопоставить маркер удостоверения пользователя Exchange с пользователем в системе.

### <a name="check-the-user"></a>Проверка пользователя

Создав уникальный идентификатор, необходимо проверить наличие в системе пользователя с этим ИД.

- Если пользователь найден, внутренняя служба рассматривает запрос как прошедший проверку подлинности и разрешает продолжить его выполнение.

- Если же пользователь не найден, внутренняя служба возвращает ошибку, указывающую на то, что пользователь должен выполнить вход. Затем надстройка предлагает пользователю войти во внутреннюю службу, используя имеющийся способ проверки подлинности. После проверки подлинности пользователя маркер удостоверения Exchange отправляется вместе с другими данными проверки подлинности.
 Затем внутренняя служба может добавить уникальный идентификатор к записи пользователя в системе.
