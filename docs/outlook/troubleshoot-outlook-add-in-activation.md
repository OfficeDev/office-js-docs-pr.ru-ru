---
title: Устранение неполадок при активации контекстных надстроек Outlook
description: Возможные причины, по которым надстройка не активируется должным образом.
ms.date: 08/09/2022
ms.localizationpriority: medium
ms.openlocfilehash: c0034eccc1143e3af9867702cdf7cefa6f6a8c53
ms.sourcegitcommit: 57258dd38507f791bbb39cbb01d6bbd5a9d226b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/12/2022
ms.locfileid: "67318888"
---
# <a name="troubleshoot-outlook-add-in-activation"></a>Устранение неполадок при активации надстроек Outlook

Активация контекстной надстройки Outlook основана на правилах активации в манифесте надстройки. Если условия для выбранного элемента удовлетворяют правилам активации надстройки, приложение активируется и отображает кнопку надстройки в пользовательском интерфейсе Outlook (область выбора надстроек для создания надстроек, панель надстроек для чтения). Если надстройка не активируется должным образом, возможные причины могут быть связаны с указанными ниже факторами.

## <a name="is-user-mailbox-on-a-version-of-exchange-server-that-is-at-least-exchange-2013"></a>Размещен ли почтовый ящик пользователя в Exchange Server версии не ниже Exchange 2013?

В первую очередь убедитесь, что тестируемая учетная запись пользователя находится в Exchange Server версии не ниже Exchange 2013. Если вы используете какие-либо функции, выпущенные после Exchange 2013, убедитесь, что учетная запись пользователя размещена в соответствующей версии Exchange.

Версию Exchange 2013 можно проверить одним из следующих способов.

- Уточнить у администратора Exchange Server.

- Если вы тестируете надстройку в Outlook в Интернете или на мобильных устройствах, в отладчике сценариев (например, в отладчике JScript Debugger, который поставляется с Internet Explorer) найдите атрибут **src** тега **script**, указывающий расположение, из которого выполняется загрузка сценариев. Этот путь должен содержать подстроку **owa/15.0.516.x/owa2/...**, где **15.0.516.x** — это версия Exchange Server, например **15.0.516.2**.

- Кроме того, вы можете проверить версию с помощью свойства [Office.context.mailbox.diagnostics.hostVersion](/javascript/api/outlook/office.diagnostics#outlook-office-diagnostics-hostversion-member). В Outlook в Интернете и на мобильных устройствах это свойство возвращает сведения о версии Exchange Server.

- Если вы можете протестировать надстройку в Outlook, можно использовать следующий простой способ отладки, использующий объектную модель Outlook и редактор Visual Basic.

    1. Во-первых, убедитесь, что включены макросы для Outlook. Выберите элементы **Файл** > **Параметры** > **Центр управления безопасностью** > **Параметры центра управления безопасностью** > **Параметры макросов**. Убедитесь, что в центре управления безопасностью выбрано значение **Уведомления для всех макросов**. Кроме того, при запуске Outlook необходимо выбрать элемент **Включить макросы**.

    1. На вкладке **Разработчик** ленты выберите **Visual Basic**.

       > [!NOTE]
       > Не отображается вкладка **Разработчик**? Сведения о том, как ее включить, см. в статье [ Отображение вкладки "Разработчик" на ленте](/visualstudio/vsto/how-to-show-the-developer-tab-on-the-ribbon).

    1. В редакторе Visual Basic выберите **Вид** > **Окно интерпретации**.

    1. Для отображения версии Exchange Server ввести в окне интерпретации следующее (основной номер версии в возвращаемом значении должен быть не ниже 15).

       - Если в профиле пользователя только одна учетная запись Exchange:

       ```vb
        ?Session.ExchangeMailboxServerVersion
       ```

       - Если в профиле пользователя несколько учетных записей Exchange (`emailAddress` представляет строку, содержащую основной SMTP-адрес пользователя):

       ```vb
        ?Session.Accounts.Item(emailAddress).ExchangeMailboxServerVersion
       ```

## <a name="is-the-add-in-disabled"></a>Не отключена ли надстройка?

Любой из полнофункциональных клиентов Outlook может отключать надстройку в целях повышения производительности, учитывая превышение порога использования ядра ЦП или памяти, устойчивость при сбоях и продолжительность обработки всех регулярных выражений для надстройки. Когда это происходит, полнофункциональный клиент Outlook выводит уведомление, что надстройка отключается.

> [!NOTE]
> Только полнофункциональные клиенты Outlook отслеживают использование ресурсов. При отключении надстройки в полнофункциональном клиенте Outlook она также отключается в Outlook в Интернете и на мобильных устройствах.

Используйте один из следующих подходов, чтобы проверить, отключена ли надстройка.

- В Outlook в Интернете войдите непосредственно в учетную запись электронной почты, а затем выберите "Получить **надстройки"** на ленте.

- В Outlook для Windows **на ленте** выберите "Другие приложения", а затем нажмите кнопку **"Получить надстройки"**.

- В Outlook для Mac нажмите кнопку с многоточием (`...`) на ленте, а затем выберите "Получить **надстройки"**.

## <a name="does-the-tested-item-support-outlook-add-ins-is-the-selected-item-delivered-by-a-version-of-exchange-server-that-is-at-least-exchange-2013"></a>Поддерживает ли тестируемый элемент надстройки Outlook? Предоставлен ли выбранный элемент Exchange Server версии не ниже Exchange 2013?

Если ваша надстройка Outlook является надстройкой чтения, которая должна активироваться, когда пользователь просматривает сообщение (включая письма, приглашения на собрания, а также ответы и отмены) или встречу, хотя в целом эти элементы поддерживают надстройки, существуют исключения. Проверьте, является ли выбранный элемент одним из перечисленных, где надстройки [Outlook не активируются](outlook-add-ins-overview.md#mailbox-items-available-to-add-ins).

Кроме того, поскольку встречи всегда сохраняются в формате формата RTF, правило [ItemHasRegularExpressionMatch](/javascript/api/manifest/rule#itemhasregularexpressionmatch-rule) , указывающее значение **PropertyName** **bodyAsHTML** , не активирует надстройку для встречи или сообщения, сохраненных в виде обычного текста или формата формата форматированного текста.

Даже если почтовый элемент не является одним из указанных выше типов, если элемент не был доставлен версией Exchange Server, которая является по крайней мере Exchange 2013, известные сущности и свойства, такие как SMTP-адрес отправителя, не будут определены в элементе. Все правила активации, использующие эти сущности или свойства, не будут удовлетворены, и надстройка не будет активирована.

Если надстройка активируется в Outlook на клиентах, кроме Windows, когда пользователь создает сообщение или приглашение на собрание, убедитесь, что элемент не защищен службой управления правами на доступ к данным (IRM).

[!INCLUDE [outlook-irm-add-in-activation](../includes/outlook-irm-add-in-activation.md)]

## <a name="is-the-add-in-manifest-installed-properly-and-does-outlook-have-a-cached-copy"></a>Установлен ли манифест надстройки должным образом, и есть ли Outlook кэшированная копия?

Этот сценарий применяется только к Outlook в Windows. Обычно при установке надстройки Outlook для почтового ящика Exchange Server копирует манифест надстройки из указанного вами расположения в почтовый ящик в Exchange Server. При каждом запуске Outlook считывает все манифесты, установленные для этого почтового ящика, во временный кэш в следующем расположении.

```text
%LocalAppData%\Microsoft\Office\16.0\WEF
```

Например, для пользователя John кэш может быть расположен по адресу C:\Users\john\AppData\Local\Microsoft\Office\16.0\WEF.

> [!IMPORTANT]
> Для Outlook 2013 в Windows используйте 15.0 вместо 16.0, чтобы расположение было следующим:
>
> ```text
> %LocalAppData%\Microsoft\Office\15.0\WEF
> ```

Если надстройка не активируется для каких-либо элементов, возможно, манифест неправильно установлен в Exchange Server или Outlook не прочитал этот манифест должным образом при запуске. С помощью Центра администрирования Exchange убедитесь, что надстройка установлена и включена для этого почтового ящика, и при необходимости перезагрузите Exchange Server.

На рисунке 1 показана сводка действий, которые необходимо выполнить, чтобы проверить правильность версии манифеста в Outlook.

**Рис. 1. Блок-схема действий по проверке правильности кэширования манифеста в Outlook**

![Блок-схема для проверки манифеста.](../images/troubleshoot-manifest-flow.png)

В следующей процедуре подробно описываются эти действия.

1. Если вы изменили манифест, не закрывая Outlook, и для разработки надстройки не используете Visual Studio 2012 или более поздней версии, то следует удалить надстройку и установить ее еще раз с помощью Центра администрирования Exchange.

1. Перезапустите Outlook и проверьте, активирует ли Outlook надстройку теперь.

1. Если Outlook не активирует надстройку, проверьте, есть ли у Outlook кэшированная копия манифеста надстройки. Просмотрите следующий путь.

    ```text
    %LocalAppData%\Microsoft\Office\16.0\WEF
    ```

    Манифест можно найти в следующей вложенной папке.

    ```text
    \<insert your guid>\<insert base 64 hash>\Manifests\<ManifestID>_<ManifestVersion>
    ```

    > [!NOTE]
    > Ниже приведен пример пути к манифесту, установленного для почтового ящика пользователя John.
    >
    > ```text
    > C:\Users\john\appdata\Local\Microsoft\Office\16.0\WEF\{8D8445A4-80E4-4D6B-B7AC-D4E6AF594E73}\GoRshCWa7vW8+jhKmyiDhA==\Manifests\b3d7d9d5-6f57-437d-9830-94e2aaccef16_1.2
    > ```

    Проверьте, есть ли манифест тестируемой надстройки в кэше.

1. Если манифест есть в кэше, пропустите остальную часть этого раздела и рассмотрите другие возможные причины ниже.

1. Если манифест в кэше отсутствует, проверьте, действительно ли Outlook успешно считал этот манифест в Exchange Server. Для этого воспользуйтесь средством просмотра событий Windows.

    1. В разделе **Журналы Windows** выберите **Приложение**.

    1. Найдите достаточно недавнее событие, идентификатор которого равен 63, что представляет загрузку Outlook манифеста из Exchange Server.

    1. Если Outlook успешно считывает манифест, зарегистрированное событие должно иметь следующее описание.

        ```text
        The Exchange web service request GetAppManifests succeeded.
        ```

        В этом случае пропустите остальную часть этого раздела и рассмотрите другие возможные причины ниже.

1. Если вы не видите успешное событие, закройте Outlook и удалите все манифесты по следующему пути.

    ```text
    %LocalAppData%\Microsoft\Office\16.0\WEF\<insert your guid>\<insert base 64 hash>\Manifests\
    ```

    Запустите Outlook и проверьте, активирует ли Outlook надстройку.

1. Если Outlook по-прежнему не активирует надстройку, вернитесь к шагу 3 и еще раз проверьте, прочитал ли Outlook манифест.

## <a name="is-the-add-in-manifest-valid"></a>Действителен ли манифест надстройки?

Сведения об устранении проблем, связанных с манифестом надстройки, см. в статье [Проверка манифеста и устранение связанных с ним неполадок](../testing/troubleshoot-manifest.md).

## <a name="are-you-using-the-appropriate-activation-rules"></a>Используются ли необходимые правила активации?

Начиная со схемы манифеста для надстроек Office версии 1.1, вы можете создавать надстройки, которые активируются, когда пользователь работает в форме создания (надстройке создания) или форме чтения (надстройке чтения). Обязательно укажите необходимые правила активации для каждого типа формы, в котором должна активироваться надстройка. Например, надстройки создания можно активировать только с помощью правил [ItemIs](/javascript/api/manifest/rule#itemis-rule), в которых атрибут **FormType** которых имеет значение **Edit** или **ReadOrEdit**. При этом вам не удастся использовать другие типы правил, например [ItemHasKnownEntity](/javascript/api/manifest/rule#itemhasknownentity-rule) и [ItemHasRegularExpressionMatch](/javascript/api/manifest/rule#itemhasregularexpressionmatch-rule) для надстроек создания. Дополнительные сведения см. в статье [Правила активации для надстроек Outlook](activation-rules.md).

## <a name="if-you-use-a-regular-expression-is-it-properly-specified"></a>Если используется регулярное выражение, указано ли оно должным образом?

Поскольку регулярные выражения в правилах активации являются частью XML-файла манифеста надстройки чтения, при использовании в регулярных выражениях определенных символов убедитесь, что используется соответствующая escape-последовательность, которую поддерживают XML-процессоры. В таблице 1 приведены эти особые символы.

**Таблица 1. Escape-последовательности для регулярных выражений**

|**Символ**|**Описание**|**Используемая escape-последовательность**|
|:-----|:-----|:-----|
|`"`|Двойная кавычка|&amp;quot;|
|`&`|Амперсанд|&amp;amp;|
|`'`|Апостроф|&amp;apos;|
|`<`|Знак "меньше"|&amp;lt;|
|`>`|Знак "больше"|&amp;gt;|

## <a name="if-you-use-a-regular-expression-is-the-read-add-in-activating-in-outlook-on-the-web-or-mobile-devices-but-not-in-any-of-the-outlook-rich-clients"></a>Если вы используете регулярное выражение, надстройка чтения активируется в Outlook в Интернете или на мобильных устройствах, но не активируется ни в одном из полнофункциональных клиентов Outlook?

В полнофункциональных клиентах Outlook используется не такой обработчик регулярных выражений, как в Outlook в Интернете и на мобильных устройствах. В полнофункциональных клиентах Outlook используется обработчик регулярных выражений C++, который предоставляется в составе библиотеки стандартных шаблонов Visual Studio. Этот обработчик выполняет компиляцию в соответствии со стандартами ECMAScript 5. Outlook в Интернете и на мобильных устройствах использует компонент оценки регулярных выражений, который входит в состав JavaScript, предоставляется браузером и поддерживает расширенный набор стандартов ECMAScript 5.

Хотя в большинстве случаев эти клиенты Outlook находят одинаковые совпадения для одного и того же регулярного выражения в правиле активации, существуют исключения. Например, если регулярное выражение содержит пользовательский класс символов, основанный на предопределенных классах символов, полнофункциональный клиент Outlook может возвращать результаты, не Outlook в Интернете и мобильные устройства. Например, классы символов, содержащие классы стенографических символов `[\d\w]`, будут возвращать разные результаты. В этом случае, чтобы избежать различных результатов в разных приложениях, используйте `(\d|\w)` вместо этого.

Тщательно протестируйте регулярное выражение. Если оно возвращает разные результаты, перепишите выражение для совместимости с обоими обработчиками. Чтобы проверить результаты оценки в полнофункциональном клиенте Outlook, напишите небольшую программу на C++, применяющую регулярное выражение к образцу сопоставляемого текста. Эта тестовая программа на C++ работает в Visual Studio и использует стандартную библиотеку шаблонов, имитируя поведение полнофункционального клиента Outlook при выполнении такого же регулярного выражения. Чтобы проверить результаты проверки в Outlook в Интернете или на мобильных устройствах, используйте любое средство проверки регулярных выражений JavaScript.

## <a name="if-you-use-an-itemis-itemhasattachment-or-itemhasregularexpressionmatch-rule-have-you-verified-the-related-item-property"></a>Если используется правило ItemIs, ItemHasAttachment или ItemHasRegularExpressionMatch, проверено ли соответствующее свойство элемента?

Если вы используете правило активации **ItemHasRegularExpressionMatch**, проверьте, соответствует ли значение атрибута **PropertyName** предполагаемому значению для выбранного элемента. Ниже приведены некоторые советы по отладке соответствующих свойств.

- Если выбранный элемент представляет собой сообщение, и в атрибуте **PropertyName** вы указываете значение **BodyAsHTML**, откройте это сообщение и выберите **Просмотреть код**, чтобы проверить текст сообщения в HTML-представлении этого элемента.

- Если выбранный элемент представляет собой встречу или если правило активации задает **BodyAsPlaintext** в атрибуте **PropertyName**, вы можете использовать объектную модель Outlook и редактор Visual Basic в Outlook для Windows.

    1. Убедитесь, что макросы включены и на ленте Outlook отображается вкладка **Разработчик**.

    1. В редакторе Visual Basic выберите **Вид** > **Окно интерпретации**.

    1. Для отображения разных свойств в зависимости от сценария введите следующее.

        - Для HTML-текста элемента сообщения или встречи, выбранного в обозревателе Outlook:

        ```vb
        ?ActiveExplorer.Selection.Item(1).HTMLBody
        ```
        - Для простого текста элемента сообщения или встречи, выбранного в обозревателе Outlook:

        ```vb
        ?ActiveExplorer.Selection.Item(1).Body
        ```
        - Для HTML-текста элемента сообщения или встречи, выбранного в инспекторе Outlook:

        ```vb
        ?ActiveInspector.CurrentItem.HTMLBody
        ```
        - Для простого текста элемента сообщения или встречи, выбранного в инспекторе Outlook:

        ```vb
        ?ActiveInspector.CurrentItem.Body
        ```

Если правило активации **ItemHasRegularExpressionMatch** указывает **Subject** либо **SenderSMTPAddress** или если вы используете правило **ItemIs** либо **ItemHasAttachment**, и вы умеете работать с MAPI или хотите его использовать, то для проверки значения в таблице 2, от которого зависит ваше правило, можно воспользоваться [MFCMAPI](https://github.com/stephenegriffin/mfcmapi).

**Таблица 2. Правила активации и соответствующие свойства MAPI**

|Тип правила|Свойство MAPI для проверки|
|:-----|:-----|
|Правило **ItemHasRegularExpressionMatch** с **Subject**|[PidTagSubject](/office/client-developer/outlook/mapi/pidtagsubject-canonical-property)|
|Правило **ItemHasRegularExpressionMatch** с **SenderSMTPAddress**|[PidTagSenderSmtpAddress](/office/client-developer/outlook/mapi/pidtagsendersmtpaddress-canonical-property) и [PidTagSentRepresentingSmtpAddress](/office/client-developer/outlook/mapi/pidtagsentrepresentingsmtpaddress-canonical-property)|
|**ItemIs**|[PidTagMessageClass](/office/client-developer/outlook/mapi/pidtagmessageclass-canonical-property)|
|**ItemHasAttachment**|[PidTagHasAttachments](/office/client-developer/outlook/mapi/pidtaghasattachments-canonical-property)|

После проверки значения свойства можно с помощью средства оценки регулярных выражений проверить, находит ли регулярное выражение соответствие в этом значении.

## <a name="does-outlook-apply-all-the-regular-expressions-to-the-portion-of-the-item-body-as-you-expect"></a>Применяет ли Outlook все регулярные выражения к части текста элемента должным образом?

Этот раздел относится ко всем правилам активации, в которых используются регулярные выражения, в частности, к тем правилам, которые применяются к основному тексту элемента, который может иметь большой размер и для которого может потребоваться больше времени на оценку соответствий. Следует помнить, что даже если свойство элемента, от которого зависит правило активации, имеет нужное значение, Outlook может не оценить все регулярные выражения по всему значению свойства элемента. Чтобы обеспечить достаточную производительность и контролировать чрезмерное использование ресурсов надстройки для чтения, Outlook соблюдает следующие ограничения на обработку регулярных выражений в правилах активации во время выполнения.

- Размер вычисляемого текста элемента. Существуют ограничения на часть текста элемента, для которой Outlook вычисляет регулярное выражение. Эти ограничения зависят от клиента Outlook, форм-фактора и формата текста элемента. Дополнительные сведения см. в таблице 2 в разделе "Ограничения для активации" и [API JavaScript для надстроек Outlook](limits-for-activation-and-javascript-api-for-outlook-add-ins.md).

- Количество соответствий регулярному выражению: полнофункциональные клиенты Outlook, Outlook в Интернете и на мобильных устройствах возвращают до 50 соответствий регулярным выражениям. Эти соответствия уникальны, и ограничение не распространяется на повторения. Не рассчитывайте, что соответствия будут возвращаться в определенном порядке и что порядок результатов в полнофункциональном клиенте Outlook будет таким же, как в Outlook в Интернете и на мобильных устройствах. Если ожидается, что найдется много соответствий регулярным выражениям из правил активации, и какого-то соответствия не хватает, это может быть связано с данным ограничением.

- Длина соответствия регулярному выражению — существуют ограничения на длину соответствия регулярного выражения, которое будет возвращать приложение Outlook. Outlook не включает соответствие выше ограничения и не отображает предупреждающее сообщение. Вы можете проверить ваше регулярное выражение с помощью других средств оценки регулярных выражений или автономной тестовой программы на C++, чтобы проверить, имеются ли соответствия, превышающие ограничения. В таблице 3 приведены эти ограничения. Дополнительные сведения см. в таблице 3 в разделе "Ограничения для активации" и [API JavaScript](limits-for-activation-and-javascript-api-for-outlook-add-ins.md) для надстроек Outlook.

    **Таблица 3. Ограничения длины для результатов, соответствующих регулярным выражениям**

    |Ограничение длины для результата, соответствующего регулярному выражению|Полнофункциональные клиенты Outlook|Outlook в Интернете или на мобильных устройствах|
    |:-----|:-----|:-----|
    |Основной текст элемента в виде простого текста|1,5 КБ|3 КБ|
    |Основной текст элемента в виде HTML-кода|3 КБ|3 КБ|

- Время, затрачиваемое на оценку всех регулярных выражений в надстройке чтения — для расширенного клиента Outlook. По умолчанию для каждой почтовой надстройки для Outlook должен завершить оценку всех регулярных выражений в правилах активации за 1 секунду. В противном случае Outlook повторяет попытку до трех раз и отключает приложение, если не может завершить оценку. Outlook отображает в панели уведомлений сообщение, что надстройка отключается. Количество времени на оценку регулярных выражений можно изменить в групповой политике или в разделе реестра. 

   > [!NOTE]
   > Если полнофункциональный клиент Outlook отключит надстройку для чтения, она станет недоступна для использования с данным почтовым ящиком в полнофункциональном клиенте Outlook, Outlook в Интернете и на мобильных устройствах.

## <a name="see-also"></a>См. также

- [Развертывание и установка надстроек Outlook для тестирования](testing-and-tips.md)
- [Правила активации для надстроек Outlook](activation-rules.md)
- [Использование правил активации на основе регулярных выражений для отображения надстройки Outlook](use-regular-expressions-to-show-an-outlook-add-in.md)
- [Ограничения для активации и API JavaScript для надстроек Outlook](limits-for-activation-and-javascript-api-for-outlook-add-ins.md)
- [Проверка манифеста и устранение связанных с ним неполадок](../testing/troubleshoot-manifest.md)
