---
title: Проверка подлинности и авторизация с помощью Dialog API для Office
description: Узнайте, как использовать диалоговый API-интерфейс Office, чтобы пользователи могли входить в Google, Facebook, Microsoft 365 и другие службы, защищенные платформой Microsoft Identity.
ms.date: 07/19/2021
localization_priority: Priority
ms.openlocfilehash: 270a6214c9dbb268a19a1aee3e08c07da693ab87
ms.sourcegitcommit: f46e4aeb9c31f674380dd804fd72957998b3a532
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2021
ms.locfileid: "53536055"
---
# <a name="authenticate-and-authorize-with-the-office-dialog-api"></a>Проверка подлинности и авторизация с помощью Dialog API для Office

Многие удостоверяющие центры, которые также называются службами маркеров безопасности (STS), не разрешают открывать свою страницу входа в элементе iframe. К ним относятся Google, Facebook и службы, защищенные платформой удостоверений Майкрософт (прежнее название — Azure AD 2.0), например учетная запись Майкрософт, Microsoft 365 для образования или рабочая учетная запись. При этом возникает проблема с надстройками Office, потому что при работе с надстройкой в **Office в Интернете** область задач является элементом iframe. Пользователи надстройки могут войти только в одну из этих служб, если она открывает полностью отдельный экземпляр браузера. Вот почему Office предоставляет [Dialog API для Office](dialog-api-in-office-add-ins.md), а именно метод [displayDialogAsync](/javascript/api/office/office.ui).

> [!NOTE]
> В данной статье предполагается, что вы знакомы с [использованием Dialog API для Office в надстройках Office](dialog-api-in-office-add-ins.md).

Диалоговое окно, открытое с помощью этого API, имеет указанные ниже характеристики.

- Оно [не модальное](https://en.wikipedia.org/wiki/Dialog_box).
- Это полностью отдельный экземпляр браузера в области задач. Это означает следующее:
  - В нем есть собственная среда выполнения JavaScript, объект окна и глобальные переменные.
  - Не существует общей среды выполнения с областью задач.
  - Оно не использует то же хранилище сеанса (свойство [Window.sessionStorage](https://developer.mozilla.org/docs/Web/API/Window/sessionStorage)), что и область задач.
- Первая страница, открытая в диалоговом окне, должна размещаться в том же домене, что и область задач, включая протокол, поддомены и порт, если есть.
- Из диалогового окна информация может направляться обратно в область задач с помощью метода [messageParent](/javascript/api/office/office.ui#messageparent-message-). (Рекомендуется вызывать этот метод только на странице, размещенной в том же домене, что и область задач, включая протокол, поддомены и порт. В противном случае с вызовом метода и обработкой сообщения сопряжены сложности. Дополнительные сведения см. в разделе [Междоменные сообщения в основной среде выполнения](dialog-api-in-office-add-ins.md#cross-domain-messaging-to-the-host-runtime).)

Если диалоговое окно не является элементом iframe (оно не является им по умолчанию), оно позволяет открыть страницу входа поставщика удостоверений. Как показано ниже, характеристики диалогового окна Office определяют, каким образом вы используете библиотеки проверки подлинности и авторизации, такие как MSAL и Passport.

> [!NOTE]
> Вы можете настроить открытие диалогового окна в плавающем iframe. Для этого просто передайте параметр `displayInIframe: true` во время вызова `displayDialogAsync`. *Не* делайте этого, если для входа используется Dialog API для Office.

## <a name="authentication-flow-with-the-office-dialog-box"></a>Поток проверки подлинности с помощью диалогового окна Office

Ниже описан простой типичный поток проверки подлинности. Подробные сведения приведены после схемы.

![Схема, показывающая взаимосвязь между процессами области задач и браузера в диалоговом окне.](../images/taskpane-dialog-processes.gif)

1. Сначала в диалоговом окне открывается локальная страница или другой ресурс, размещенный в домене надстройки (то есть в том же домене, что и окно области задач). На этой странице может быть простая надпись "Подождите, мы перенаправляем вас на страницу, где вы сможете войти в учетную запись *ИМЯ_ПОСТАВЩИКА*". Код на этой странице создает URL-адрес страницы входа поставщика удостоверений, используя данные, передаваемые диалоговому окну, как описано в разделе [Передача данных диалоговому окну](dialog-api-in-office-add-ins.md#pass-information-to-the-dialog-box), или жестко заданные в файле конфигурации надстройки, например в файле web.config.
2. Затем диалоговое окно перенаправляет пользователя на страницу входа. URL-адрес включает параметр запроса, который дает указание поставщику удостоверений после входа пользователя перенаправить диалоговое окно на определенную страницу. В этой статье мы назовем эту страницу **redirectPage.html**. *Рекомендуется использовать страницу в том же домене, что и основное окно*. На этой странице результаты попытки входа можно передать в область задач с помощью вызова `messageParent`.
3. Служба поставщика удостоверений обрабатывает входящий запрос GET, поступивший из диалогового окна. Если пользователь уже вошел в систему, она немедленно перенаправляет его на страницу **redirectPage.html** и включает пользовательские данные в параметр запроса. Если пользователь еще не вошел, в окне появляется страница поставщика для входа. Если пользователю не удается войти, большинство поставщиков показывают в диалоговом окне страницу с сообщением об ошибке и не перенаправляют его на страницу **redirectPage.html**. Пользователь должен закрыть это окно, нажав кнопку **X** в углу. Если пользователь успешно входит, диалоговое окно перенаправляется на страницу **redirectPage.html**, а пользовательские данные добавляются в параметр запроса.
4. Когда открывается страница **redirectPage.html**, она вызывает функцию `messageParent`, чтобы сообщить о результате в область панели задач, а также сообщить пользовательские данные или данные об ошибке. Она также может передавать маркер доступа или сообщать в область задач, что маркер находится в хранилище.
5. На странице области задач запускается событие `DialogMessageReceived`, и его обработчик закрывает диалоговое окно и может дальше обрабатывать сообщение.

#### <a name="support-multiple-identity-providers"></a>Поддержка нескольких поставщиков удостоверений

Если пользователь может выбрать поставщика для входа в надстройку, например учетную запись Майкрософт, Google или Facebook, первой должна открываться локальная страница со списком поставщиков (см. предыдущий раздел). После выбора поставщика происходит создание URL-адреса входа и перенаправление на него.

#### <a name="authorization-of-the-add-in-to-an-external-resource"></a>Авторизация надстройки через внешний ресурс

В современном Интернете пользователи и веб-приложения — это субъекты безопасности. У приложения есть свое удостоверение и разрешения для онлайн-ресурсов, таких как Microsoft 365, Google+, Facebook и LinkedIn. Перед развертыванием приложение регистрируется у поставщика ресурса. Регистрация включает:

- Список разрешений, которые нужны приложению.
- URL-адрес, на который служба ресурса должна возвращать маркер доступа, когда приложение получает доступ к службе.  

Когда пользователь вызывает функцию в приложении, которое получает доступ к его данным в службе ресурса, пользователю будет предложено войти в службу, а затем предоставить приложению необходимые разрешения. Служба затем перенаправляет пользователя на зарегистрированный URL-адрес и передает маркер доступа. Приложение использует маркер доступа для доступа к ресурсам пользователя.

Вы можете управлять этим процессом с помощью API диалогового окна Office, используя поток, похожий на тот, который обеспечивает возможность входа пользователей. Единственные отличия:

- Если пользователь не предоставил приложению необходимые разрешения, ему будет предложено сделать это в диалоговом окне после входа.
- Диалоговое окно отправляет маркер доступа в главное окно, преобразовывая его в строку с помощью функции `messageParent` или сохраняя его там, откуда главное окно сможет его извлечь (и с помощью `messageParent` сообщает в главное окно о доступности маркера). Пока срок действия этого маркера не истек, главное окно может использовать его для прямого доступа к ресурсам пользователя без дополнительных запросов.

Примеры проверки подлинности в надстройках, использующих Dialog API для Office, приводятся в разделе [Примеры](#samples).

## <a name="using-authentication-libraries-with-the-dialog-box"></a>Использование библиотек проверки подлинности с помощью диалогового окна

Диалоговые окна Office и область задач находятся в разных экземплярах браузера и среды выполнения JavaScript, поэтому использование многих библиотек проверки подлинности и авторизации отличается от того, как они используются при выполнении проверки подлинности и авторизации в одном окне. В следующих разделах описывается, как *можно* использовать эти библиотеки и какие способы неприменимы. 

### <a name="you-usually-cannot-use-the-librarys-internal-cache-to-store-tokens"></a>Как правило, для хранения маркеров нельзя использовать внутренний кэш библиотеки.

Обычно библиотеки проверки подлинности хранят маркер доступа в кэше в памяти.  При последующих обращениях к поставщику ресурсов (например, Google, Microsoft Graph, Facebook и т. д.) библиотека сначала проверит, действителен ли маркер в кэше. Если срок его действия не истек, библиотека возвращает кэшированный маркер и не совершает повторно круговой путь в STS за новым маркером. Этот шаблон не поддерживается в надстройках Office. Так как вход выполняется в экземпляре браузера в диалоговом окне Office, кэш маркера находится в этом экземпляре.

Кроме того, библиотека обычно предоставляет как интерактивные, так и автоматические методы для получения маркера. Если вы выполняете проверку подлинности и звонки для передачи данных в ресурс в одном экземпляре браузера, код вызывает автоматический метод, чтобы получить маркер непосредственно перед добавлением его в звонок для передачи данных. Автоматический метод проверяет, есть ли в кэше действительный маркер, и возвращает его. В противном случае автоматический метод вызывает интерактивный метод, который перенаправляет на вход в STS. После входа в систему интерактивный метод возвращает маркер, а также кэширует его в памяти. Но если используется Dialog API для Office, вызовы данных из ресурса, которые должны вызывать автоматический метод, находятся в экземпляре браузера в области задач. Кэш маркеров библиотеки не существует в этом экземпляре.

В качестве альтернативы экземпляр браузера в диалоговом окне надстройки может напрямую вызывать интерактивный метод работы библиотеки. Если этот метод возвращает маркер, код должен явным образом сохранить маркер в определенном расположении, таком как локальное хранилище\* или база данных на стороне сервера, откуда экземпляр браузера в области задач может извлечь его. Кроме того, можно передать маркер в область задач, используя `messageParent` метод. Это можно сделать только в том случае, если интерактивный метод сохранил маркер доступа в таком расположении, в котором код может прочитать его. Иногда интерактивный метод работы библиотеки сохраняет маркер в частном свойстве объекта, недоступном для вашего кода.

> [!NOTE]
> \* Существует ошибка, влияющая на вашу стратегию обработки маркеров. Если надстройка работает в **Office в Интернете** с использованием браузера Safari или Microsoft Edge, у диалогового окна и области задач нет одного общего локального хранилища, поэтому его нельзя использовать для связи между ними.

### <a name="you-usually-cannot-use-the-librarys-auth-context-object"></a>Как правило, невозможно использовать объект библиотеки в контексте проверки подлинности.

Часто библиотека проверки подлинности использует метод, позволяющий получить маркер в интерактивном режиме, а также создать объект в контексте проверки подлинности, возвращаемый методом. Маркер — это свойство объекта (которое может быть частным и недоступным непосредственно из кода). У этого объекта есть методы получения данных из ресурса. Они включают маркер в HTTP-запросах, которые они выполняют к поставщику ресурсов (например, Google, Microsoft Graph, Facebook и т. д.).

Такие объекты в контексте проверки подлинности и методы их создания не поддерживаются в надстройках Office. Так как вход выполняется в экземпляре браузера в диалоговом окне Office, там же должен быть создан и объект. Но данные, поступающие в ресурс, находятся в экземпляре браузера в области задач, и вам не удастся передать объект из одного экземпляра в другой. Например, невозможно передать объект методом `messageParent`, так как `messageParent` может передавать только строковые значения. Объект JavaScript, содержащий методы, нельзя надежно преобразовать в строку.

### <a name="how-you-can-use-libraries-with-the-office-dialog-api"></a>Использование библиотек с помощью Dialog API для Office

Большинство библиотек в дополнение к монолитным объектам в контексте проверки подлинности или вместо них обеспечивает API более низкого уровня абстракции, разрешая коду создавать менее монолитные вспомогательные объекты. Например, [MSAL.NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki#conceptual-documentation) версии 3.x.x имеет API для создания URL-адреса входа и еще один API, который создает объект AuthResult, содержащий маркер доступа в свойстве, доступном для вашего кода. Примеры MSAL.NET в надстройке Office см. в статьях [Надстройка Office в Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET) и [Надстройка Outlook в Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET). Пример использования [msal.js](https://github.com/AzureAD/microsoft-authentication-library-for-js) в надстройке см. в статье [Надстройка Office в Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React).

Дополнительные сведения о библиотеках проверки подлинности и авторизации см. в статье[Microsoft Graph — Рекомендуемые библиотеки](authorize-to-microsoft-graph-without-sso.md#recommended-libraries-and-samples) и [Другие внешние службы: библиотеки](auth-external-add-ins.md#libraries).

## <a name="samples"></a>Примеры

- [Надстройка Office в Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET) — это надстройка на основе ASP.NET (Excel, Word или PowerPoint), использующая библиотеку MSAL.NET и поток кода авторизации для входа и получения маркера доступа к данным Microsoft Graph.
- [Надстройка Outlook в Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET) — это такая же надстройка, как описано выше, но относящаяся к приложению Outlook.
- [Надстройка Office в Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React) — это надстройка на основе NodeJS (Excel, Word или PowerPoint), использующая библиотеку msal.js и неявный поток для входа и получения маркера доступа к данным Microsoft Graph.


Дополнительные сведения см. в указанных ниже статьях.
- [Авторизация внешних служб в надстройке Office](auth-external-add-ins.md)
- [Использование Dialog API для Office в надстройках Office](dialog-api-in-office-add-ins.md)
