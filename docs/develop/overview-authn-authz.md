---
title: Обзор проверки подлинности и авторизации в надстройках Office
description: ''
ms.date: 08/09/2019
localization_priority: Priority
ms.openlocfilehash: dab5eec14a95aea9c27e1d26151b121ac2ed82ac
ms.sourcegitcommit: 24303ca235ebd7144a1d913511d8e4fb7c0e8c0d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "36838510"
---
# <a name="overview-of-authentication-and-authorization-in-office-add-ins"></a>Обзор проверки подлинности и авторизации в надстройках Office

Веб-приложения и, следовательно, надстройки Office по умолчанию поддерживают анонимный доступ, но вы можете требовать проверку подлинности пользователей с помощью входа. Например, вы можете требовать, чтобы пользователи выполняли вход с помощью учетной записи Майкрософт, рабочей или учебной учетной записи Office 365 либо другой распространенной учетной записи. Эта задача называется проверкой подлинности пользователей, так как она позволяет надстройке определить пользователя.

Ваша надстройка также может получать согласие пользователя на доступ к данным Microsoft Graph (например, к профилю Office 365, файлам OneDrive и данным SharePoint) или данным в других внешних источниках, таких как Google, Facebook, LinkedIn, SalesForce и GitHub. Эта задача называется авторизацией надстройки (или приложения), так как выполняется авторизация *надстройки*, а не пользователя.

Можно выбрать один из двух способов выполнения этих проверок подлинности.

- **Единый вход (SSO) Office** — система, *в настоящий момент доступная в предварительной версии*, позволяющая использовать вход пользователя в Office в качестве входа в надстройку. При необходимости надстройка также может использовать учетные данные пользователя Office для своей авторизации в Microsoft Graph. (Источники, отличные от Майкрософт, не поддерживаются в этой системе.)
- **Проверка подлинности и авторизация веб-приложения с помощью Azure Active Directory**. Это не новое решение, а просто способ, которым надстройка Office (и другие веб-приложения) проверяла подлинность пользователей и авторизовала приложения до появления системы единого входа Office. Он по-прежнему используется в сценариях, не поддерживающих единый вход.

На следующей блок-схеме показаны решения, которые нужно принять разработчику надстройки. Подробные сведения см. далее в этой статье.

![Изображение с блок-схемой решений для включения проверки подлинности и авторизации в надстройках Office](../images/auth-decisions-flowchart.gif)

## <a name="user-authentication-without-sso"></a>Проверка подлинности пользователей без единого входа

Вы можете проверить подлинность пользователя в надстройке Office с помощью Azure Active Directory (AAD), как и в любом другом веб-приложении с одним исключением: служба AAD не разрешает открывать свою страницу входа в элементе iframe. При работе с надстройкой Office в *Office в Интернете* область задач является элементом iframe. Это означает, что вам потребуется открыть экран входа в AAD в диалоговом окне, вызванном с помощью Dialog API для Office. Это влияет на способ использования библиотек помощника проверки подлинности. Дополнительные сведения см. в статье [Проверка подлинности с помощью Dialog API для Office](auth-with-office-dialog-api.md).

Сведения о программной проверке подлинности с помощью AAD см. в статье [Общие сведения о платформе удостоверений Майкрософт (версии 2.0)](/azure/active-directory/develop/v2-overview). В этом наборе документов содержится много руководств и инструкций, а также ссылки на соответствующие примеры и библиотеки. Как описано в статье [Проверка подлинности с помощью Dialog API для Office ](auth-with-office-dialog-api.md), вам может потребоваться изменить код из примеров, чтобы запустить его в диалоговом окне Office.

## <a name="access-to-microsoft-graph-without-sso"></a>Доступ к Microsoft Graph без единого входа

Вы можете получить для надстройки разрешение на доступ к данным Microsoft Graph, получив маркер доступа к Graph из Azure Active Directory (AAD). Это можно сделать без использования единого входа Office. Дополнительные сведения об этом см. в статье [Доступ к Microsoft Graph без единого входа](authorize-to-microsoft-graph-without-sso.md), содержащей подробности и ссылки на примеры.

## <a name="user-authentication-with-sso"></a>Проверка подлинности пользователей с помощью единого входа

Чтобы использовать единый вход для проверки подлинности пользователей, код в области задач или файл функции вызывает метод [getAccessTokenAsync](/javascript/api/office/office.auth#getaccesstokenasync-options--callback-). Если пользователь не вошел в Office, откроется диалоговое окно и будет выполнен переход к странице входа в Azure Active Directory. После входа пользователя метод возвращает маркер доступа, являющийся маркером начальной загрузки в потоке **От имени**. (См. раздел [Доступ к Microsoft Graph с помощью единого входа](#access-to-microsoft-graph-with-sso).) Однако его также можно использовать в качестве маркера идентификации, так как он содержит несколько утверждений, уникальных для текущего пользователя, включая `preferred_username`, `name`, `sub` и `oid`. Инструкции о том, какое свойство использовать в качестве конечного идентификатора пользователя, см. в статье [Маркеры доступа платформы удостоверений Майкрософт](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/access-tokens#payload-claims). Пример одного из этих маркеров см. в статье с [примером маркера доступа](sso-in-office-add-ins.md#example-access-token).

После извлечения кодом нужного утверждения из маркера он использует это значение для поиска пользователя в таблице пользователей или вашей базе данных пользователей. Используйте базу данных для хранения сведений, относящихся к пользователям, например параметров пользователя или состояния учетной записи пользователя. Так как вы используете единый вход, пользователи не входят отдельно в вашу надстройку, поэтому вам не нужно хранить пароли для пользователей.

Перед началом внедрения проверки подлинности пользователей с помощью единого входа внимательно ознакомьтесь со статьей [Включение единого входа для надстроек Office](sso-in-office-add-ins.md). Также обратите внимание на следующие примеры:

- [Единый вход с использованием NodeJS для надстройки Office](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO), особенно на файл [auth.ts](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/src/auth.ts), использующий библиотеку [jswebtoken](https://github.com/auth0/node-jsonwebtoken) для декодирования и анализа маркера. (Однако в этом примере маркер не используется в качестве маркера идентификации. Он используется для получения доступа к Microsoft Graph с потоком **От имени**.)
- [Единый вход с использованием ASP.NET для надстройки Office](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO), особенно на файл [ValuesController.ts](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Controllers/ValuesController.cs), использующий класс [System.Security.Claims.ClaimsPrincipal](https://docs.microsoft.com/dotnet/api/system.security.claims.claimsprincipal) библиотеки для извлечения утверждений из маркера. (Однако в этом примере маркер не используется в качестве маркера идентификации. Он извлекает утверждение `scope` из маркера и использует его для получения доступа к Microsoft Graph с потоком **От имени**.)

## <a name="access-to-microsoft-graph-with-sso"></a>Доступ к Microsoft Graph с помощью единого входа

Чтобы использовать единый вход для получения доступа к Microsoft Graph, ваша надстройка в области задач или файл функции вызывает метод [getAccessTokenAsync](/javascript/api/office/office.auth#getaccesstokenasync-options--callback-). Если пользователь не вошел в Office, откроется диалоговое окно и будет выполнен переход к странице входа в Azure Active Directory. После входа пользователя метод возвращает маркер доступа, являющийся маркером начальной загрузки в потоке **От имени**. В частности он содержит утверждение `scope` со значением `access_as_user`. Руководство по утверждениям в маркере см. в статье [Маркеры доступа платформы удостоверений Майкрософт](https://docs.microsoft.com/ru-RU/azure/active-directory/develop/access-tokens#payload-claims). Пример одного из этих маркеров см. в статье с [примером маркера доступа](sso-in-office-add-ins.md#example-access-token).

После получения маркера кодом он используется в потоке **От имени**, чтобы получить второй маркер: маркер доступа к Microsoft Graph.

Перед началом внедрения единого входа Office внимательно ознакомьтесь со следующими двумя статьями:

- [Включение единого входа для надстроек Office](sso-in-office-add-ins.md)
- [Авторизация в Microsoft Graph с помощью единого входа](authorize-to-microsoft-graph.md)

Вам также следует ознакомиться хотя бы с одним руководством, указанным здесь. Даже если вы не выполняете описанные действия, они содержат важную информацию о реализации единого входа Office и потока **От имени**. 

- [Создание надстройки Office на платформе ASP.NET с использованием единого входа](create-sso-office-add-ins-aspnet.md)
- [Создание надстройки Office на платформе Node.js с использованием единого входа](create-sso-office-add-ins-nodejs.md)

Также обратите внимание на следующие примеры:

- [Единый вход с использованием NodeJS для надстройки Office](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)
- [Единый вход с использованием ASP.NET для надстройки Office](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)

## <a name="access-to-non-microsoft-data-sources"></a>Доступ к сторонним источникам данных (отличным от Майкрософт)

С помощью популярных веб-служб, в том числе Google, Facebook, LinkedIn, SalesForce и GitHub, разработчики могут предоставлять пользователям доступ к их учетным записям в других приложениях. Благодаря этому вы можете включать эти службы в свои надстройки Office. Обзор способов, доступных вашей надстройке для выполнения этих действий, см. в статье [Авторизация внешних служб в надстройке Office](auth-external-add-ins.md).

> [!IMPORTANT]
> Перед началом создания кода выясните, позволяет ли источник данных открывать экран входа в элементе iFrame. При работе с надстройкой Office в *Office в Интернете* область задач является элементом iFrame. Если источник данных не позволяет открывать экран входа в элементе iFrame, вам потребуется открыть экран входа в диалоговом окне, вызываемом с помощью Dialog API для Office. Дополнительные сведения см. в статье [Проверка подлинности с помощью Dialog API для Office](auth-with-office-dialog-api.md).

