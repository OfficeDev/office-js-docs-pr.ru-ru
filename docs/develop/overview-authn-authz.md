---
title: Обзор проверки подлинности и авторизации в надстройках Office
description: Узнайте, как работает проверка подлинности и авторизация в надстройках Office.
ms.date: 01/25/2022
ms.localizationpriority: high
ms.openlocfilehash: ba7f55a0b8ca163b994bcfb91879c675b777a7c9
ms.sourcegitcommit: b66ba72aee8ccb2916cd6012e66316df2130f640
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2022
ms.locfileid: "64483640"
---
# <a name="overview-of-authentication-and-authorization-in-office-add-ins"></a>Обзор проверки подлинности и авторизации в надстройках Office

Надстройки Office по умолчанию разрешают анонимный доступ, но вы можете потребовать, чтобы пользователи входили в систему для того, чтобы использовать вашу надстройку с помощью учетной записи Microsoft, Microsoft 365 для образования или рабочей либо другой общей учетной записи. Эта задача называется проверкой подлинности пользователей, так как она позволяет надстройке определить пользователя.

Ваша надстройка также может получать согласие пользователя на доступ к данным Microsoft Graph (например, к профилю Microsoft 365, файлам OneDrive и данным SharePoint) или данным в других внешних источниках, таких как Google, Facebook, LinkedIn, SalesForce и GitHub. Эта задача называется авторизацией надстройки (или приложения), так как выполняется авторизация *надстройки*, а не пользователя.

## <a name="key-resources-for-authentication-and-authorization"></a>Ключевые ресурсы для проверки подлинности и авторизации

В этой документации объясняется, как создавать и настраивать надстройки Office для успешной реализации проверки подлинности и авторизации. Однако многие упомянутые концепции и технологии безопасности не являются частью этой документации. Например, здесь не объясняются общие концепции безопасности, такие как потоки OAuth, кэширование токенов или управление удостоверениями. Эта документация также не содержит ничего, что относится к Microsoft Azure или платформе удостоверений Майкрософт. Мы рекомендуем использовать следующие ресурсы, если вам нужно больше информации в этих областях.

- [Платформа удостоверений Майкрософт](/azure/active-directory/develop)
- [Поддержка и справка по платформе удостоверений Майкрософт для разработчиков](/azure/active-directory/develop/developer-support-help-options)
- [Протоколы OAuth 2.0 и OpenID Connect на платформе удостоверений Майкрософт](/azure/active-directory/develop/active-directory-v2-protocols)

## <a name="sso-scenarios"></a>Сценарии единого входа

Использование единого входа (SSO) удобно для пользователей, поскольку им нужно войти в Office только один раз. Им не нужно отдельно входить в вашу надстройку. Система единого входа поддерживается не во всех версиях Office, поэтому вам все равно потребуется реализовать альтернативный метод входа [с помощью платформы удостоверений Майкрософт](#authenticate-with-the-microsoft-identity-platform). Дополнительные сведения о поддерживаемых версиях Office см. в статье [Наборы требований API удостоверений](/javascript/api/requirement-sets/identity-api-requirement-sets)

### <a name="get-the-users-identity-through-sso"></a>Получение удостоверений пользователя с помощью единого входа

Часто надстройка требует только удостоверение пользователя. Например, можно просто персонализировать надстройку и отобразить имя пользователя в области задач. Или может потребоваться уникальный ИД, чтобы сопоставить пользователя с его данными в базе данных. Для этого достаточно получить маркер доступа для пользователя из Office.

Чтобы получить удостоверение пользователя с помощью единого входа, вызовите метод [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)). Метод возвращает маркер доступа, который также является маркером удостоверения, содержащим несколько утверждений, уникальных для текущего пользователя, выполнившего вход, в том числе `preferred_username`, `name`, `sub` и `oid`. Дополнительные сведения об этих свойствах см. в статье [Маркеры ИД платформы удостоверений Майкрософт](/azure/active-directory/develop/id-tokens). Пример маркера, возвращаемого методом [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)), см. в статье [Пример маркера доступа](sso-in-office-add-ins.md#example-access-token).

Если пользователь не вошел в систему, Office откроет диалоговое окно и использует платформу удостоверений Майкрософт, чтобы запросить пользователя выполнить вход. Затем метод возвращает маркер доступа или выдает ошибку, если пользователь не может войти в систему.

В случае, когда вам необходимо хранить данные для пользователя, см. статью [Маркеры ИД платформы удостоверений Майкрософт](/azure/active-directory/develop/id-tokens), чтобы ознакомиться с дополнительными сведениями о том, как получить значение из маркера для уникальной идентификации пользователя. Используйте это значение для поиска пользователя в таблице или базе данных пользователей, которую вы поддерживаете. Используйте базу данных для хранения сведений, относящихся к пользователям, например параметров пользователя или состояния учетной записи пользователя. Так как вы используете единый вход, пользователи не входят отдельно в вашу надстройку, поэтому вам не нужно хранить пароли для пользователей.

Перед началом внедрения проверки подлинности пользователей с помощью единого входа внимательно ознакомьтесь со статьей [Включение единого входа для надстроек Office](sso-in-office-add-ins.md)

### <a name="access-your-web-apis-through-sso"></a>Доступ к веб-API с помощью единого входа

Если в надстройке есть серверные API, требующие авторизованных пользователей, вызовите метод [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)), чтобы получить маркер доступа. Маркер доступа предоставляет доступ к вашему веб-серверу (настроенному посредством [регистрации приложения Microsoft Azure](register-sso-add-in-aad-v2.md)). Когда вы вызываете API на своем веб-сервере, вы также передаете маркер доступа для авторизации пользователя.

Следующий код показывает, как создать HTTPS-запрос GET к API веб-сервера надстройки для получения некоторых данных. Код выполняется на стороне клиента, например в области задач. Сначала он получает маркер доступа, вызывая `getAccessToken`. Затем создается вызов AJAX с правильным заголовком авторизации и URL-адресом для серверного API.

```javascript
function getOneDriveFileNames() {

    let accessToken = await Office.auth.getAccessToken();

    $.ajax({
        url: "/api/data",
        headers: { "Authorization": "Bearer " + accessToken },
        type: "GET"
    })
        .done(function (result) {
            //... work with data from the result...
        });
}
```

В следующем коде показан пример обработчика /api/data для вызова REST из предыдущего примера кода. Код представляет собой код ASP.NET, запущенный на веб-сервере. Атрибут `[Authorize]` требует, чтобы от клиента был передан действительный маркер доступа, или он возвращает клиенту ошибку.

```csharp
    [Authorize]
    // GET api/data
    public async Task<HttpResponseMessage> Get()
    {
        //... obtain and return data to the client-side code...
    }
```

### <a name="access-microsoft-graph-through-sso"></a>Доступ к Microsoft Graph с помощью единого входа

В некоторых сценариях требуется не только удостоверение пользователя, но и доступ к ресурсам [Microsoft Graph](/graph) от имени пользователя. Например, вам может потребоваться отправить электронное сообщение или создать чат в Teams от имени пользователя. Эти и другие действия можно выполнять с помощью Microsoft Graph. Выполните следующие действия:

1. Получите маркер доступа для текущего пользователя с помощью единого входа, вызвав метод [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)). Если пользователь не вошел в систему, Office откроет диалоговое окно и выполнит вход для пользователя с помощью платформы удостоверений Майкрософт. После входа пользователя метод возвращает маркер доступа,
1. Передайте маркер доступа в код на стороне сервера.
1. На стороне сервера используйте [поток On-Behalf-Of OAuth 2.0](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow), чтобы обменять маркер доступа на новый, содержащий необходимое делегированное удостоверение пользователя и разрешения для вызова Microsoft Graph.

> [!NOTE]
> Для обеспечения наилучшей безопасности во избежание утечки маркера доступа, всегда запускайте поток OBO на стороне сервера. Вызовите API Microsoft Graph со своего сервера, а не клиента. Не возвращайте маркер доступа коду на стороне клиента.

Прежде чем приступить к реализации единого входа для доступа к Microsoft Graph в надстройке, убедитесь, что вы ознакомились со следующими статьями.

- [Включение единого входа для надстроек Office](sso-in-office-add-ins.md)
- [Авторизация в Microsoft Graph с помощью единого входа](authorize-to-microsoft-graph.md)

Вам также следует прочитать хотя бы одну из следующих статей, в которых рассказывается о создании надстройки Office для использования единого входа и доступа к Microsoft Graph. Даже если вы не выполняете описанные действия, они содержат важную информацию о реализации единого входа и потока OBO.

- [Создание надстройки Office ASP.NET, использующей единый вход](create-sso-office-add-ins-aspnet.md), в которой рассказывается о примере на странице [Единого входа надстройки Office ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/main/Samples/auth/Office-Add-in-ASPNET-SSO).
- [Создание надстройки Office Node.js, использующей единый вход](create-sso-office-add-ins-nodejs.md), в которой рассказывается о примере на странице [Единого входа надстройки Office Node.js](https://github.com/OfficeDev/PnP-OfficeAddins/tree/main/Samples/auth/Office-Add-in-NodeJS-SSO).

## <a name="non-sso-scenarios"></a>Сценарии без единого входа

В некоторых случаях может не требоваться использовать единый вход. Например, может потребоваться проверка подлинности с помощью другого поставщика удостоверений, а не с помощью платформы удостоверений Майкрософт. Кроме того, единый вход поддерживается не во всех сценариях. Например, более старые версии Office не поддерживают единый вход. В этом случае потребуется вернуться к альтернативной системе проверки подлинности для надстройки.

### <a name="authenticate-with-the-microsoft-identity-platform"></a>Проверка подлинности на платформе удостоверений Майкрософт

Ваша надстройка может выполнять вход для пользователей с помощью [платформы удостоверений Майкрософт](/azure/active-directory/develop) в качестве поставщика проверки подлинности. После входа пользователя в систему вы можете использовать платформу удостоверений Майкрософт для авторизации надстройки в [Microsoft Graph](/graph) или других службах, управляемых корпорацией Майкрософт. Используйте этот метод входа в качестве альтернативного, если единый вход через Office недоступен. Кроме того, существуют сценарии, в которых вам может требоваться отдельный вход пользователей в вашу надстройку даже при доступности единого входа. Например, если вы хотите, чтобы у них была возможность входа в надстройку с помощью другого идентификатора, отличающегося от текущего входа в Office.

Важно отметить, что платформа удостоверений Майкрософт не позволяет открывать страницу входа в iframe. При работе с надстройкой Office в *Office в Интернете* область задач является элементом iframe. Это означает, что вам потребуется открыть страницу входа, используя диалоговое окно, открытое с помощью Dialog API для Office. Это влияет на способ использования библиотек помощника проверки подлинности. Дополнительные сведения см. в статье [Проверка подлинности с помощью Dialog API для Office](auth-with-office-dialog-api.md).

Сведения о реализации проверки подлинности с помощью платформы удостоверений Майкрософт см. в статье [Общие сведения о платформе удостоверений Майкрософт версии 2.0](/azure/active-directory/develop/v2-overview). Документация содержит множество учебных пособий и руководств, а также ссылки на соответствующие примеры и библиотеки. Как описано в статье [Проверка подлинности с помощью Dialog API для Office](auth-with-office-dialog-api.md), вам может потребоваться изменить код из примеров, чтобы запустить его в диалоговом окне Office.

### <a name="access-to-microsoft-graph-without-sso"></a>Доступ к Microsoft Graph без единого входа

Вы можете получить для надстройки разрешение на доступ к данным Microsoft Graph, получив маркер доступа к Microsoft Graph из платформы удостоверений Майкрософт. Это можно сделать, не используя единый вход через Office (или если произошел сбой единого входа либо он не поддерживается). Дополнительные сведения см. в статье [Доступ к Microsoft Graph без единого входа](authorize-to-microsoft-graph-without-sso.md), содержащей подробности и ссылки на примеры.

### <a name="access-to-non-microsoft-data-sources"></a>Доступ к сторонним источникам данных (отличным от Майкрософт)

С помощью популярных веб-служб, в том числе Google, Facebook, LinkedIn, SalesForce и GitHub, разработчики могут предоставлять пользователям доступ к их учетным записям в других приложениях. Благодаря этому вы можете включать эти службы в свои надстройки Office. Обзор способов, доступных вашей надстройке для выполнения этих действий, см. в статье [Авторизация внешних служб в надстройке Office](auth-external-add-ins.md).

> [!IMPORTANT]
> Перед началом создания кода выясните, позволяет ли источник данных открываться странице входа в iframe. При работе с надстройкой Office в *Office в Интернете* область задач является элементом iframe. Если источник данных не позволяет странице входа открываться в iframe, вам потребуется открыть страницу входа в диалоговом окне, вызываемом с помощью Dialog API для Office. Дополнительные сведения см. в статье [Проверка подлинности с помощью Dialog API для Office](auth-with-office-dialog-api.md).

## <a name="see-also"></a>См. также

- [Документация по платформе удостоверений Майкрософт](/azure/active-directory/develop/)
- [Маркеры доступа платформы удостоверений Майкрософт](/azure/active-directory/develop/access-tokens)
- [Протоколы OAuth 2.0 и OpenID Connect на платформе удостоверений Майкрософт](/azure/active-directory/develop/active-directory-v2-protocols)
- [Платформа удостоверений Майкрософт и поток OBO OAuth 2.0](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow)
- [JSON Web Token (JWT)](https://en.wikipedia.org/wiki/JSON_Web_Token)
- [Средство просмотра JSON Web Token](https://jwt.ms/)
