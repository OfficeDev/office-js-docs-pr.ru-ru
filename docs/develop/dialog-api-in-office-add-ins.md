---
title: Использование Dialog API в надстройках Office
description: ''
ms.date: 12/04/2017
ms.openlocfilehash: b026c3c5871372c52d0b44e36c01fc44a3d2bf04
ms.sourcegitcommit: c72c35e8389c47a795afbac1b2bcf98c8e216d82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/23/2018
ms.locfileid: "19437957"
---
# <a name="use-the-dialog-api-in-your-office-add-ins"></a>Использование Dialog API в надстройках Office

Вы можете использовать [Dialog API](https://dev.office.com/reference/add-ins/shared/officeui), чтобы открывать диалоговые окна в надстройке Office. Эта статья содержит рекомендации по использованию Dialog API в надстройке Office.

> [!NOTE]
> Сведения о поддержке Dialog API см. в статье [Наборы обязательных элементов Dialog API](https://dev.office.com/reference/add-ins/requirement-sets/dialog-api-requirement-sets). В настоящее время Dialog API поддерживается для Word, Excel, PowerPoint и Outlook.

> Основной сценарий использования Dialog API — обеспечение проверки подлинности с использованием таких ресурсов, как Google или Facebook. Если вашей надстройке требуются данные о пользователе Office или ресурсах, доступных ему посредством Microsoft Graph (например, Office 365 или OneDrive), рекомендуем по возможности использовать API единого входа. Если вы используете API для единого входа, Dialog API не требуется. Дополнительные сведения см. в статье [Включение единого входа для надстроек Office](sso-in-office-add-ins.md).

Возможность открытия диалогового окна с помощью области задач, контентной надстройки или [команды надстройки](../design/add-in-commands.md) может позволить следующее:

- отобразить страницу входа, которую невозможно открыть непосредственно в области задач;
- предоставить больше места на экране (или даже весь экран) для некоторых задач в надстройке;
- показать видео, которое будет слишком маленьким в области задач.

> [!NOTE]
> Так как пользователей раздражают элементы интерфейса, перекрывающие основное содержимое, не допускайте открытия диалогового окна из области задач, если этого не требует сценарий. При планировании контактной зоны помните, что в области задач можно использовать вкладки. Например, как в [надстройке SalesTracker на JavaScript для Excel](https://github.com/OfficeDev/Excel-Add-in-JavaScript-SalesTracker).

На приведенном ниже изображении показан пример диалогового окна.

![Команды надстроек](../images/auth-o-dialog-open.png)

Обратите внимание на то, что диалоговое окно всегда открывается в центре экрана. Пользователь может перемещать его и изменять его размер. Окно *не модальное*: пользователь может продолжать работать и с документом в ведущем приложении Office, и с главной страницей в области задач.

## <a name="dialog-api-scenarios"></a>Сценарии с Dialog API

Интерфейсы API JavaScript для Office поддерживают указанные ниже сценарии с объектом [Dialog](https://dev.office.com/reference/add-ins/shared/officeui.dialog) и две функции в [пространстве имен Office.context.ui](https://dev.office.com/reference/add-ins/shared/officeui).

### <a name="open-a-dialog-box"></a>Открытие диалогового окна

Чтобы открыть диалоговое окно, код в области задач вызывает метод [displayDialogAsync](https://dev.office.com/reference/add-ins/shared/officeui.displaydialogasync) и передает ему URL-адрес ресурса, который нужно открыть. Таким ресурсом обычно является страница, но может быть и метод контроллера в приложении MVC, метод веб-службы, маршрута или любой другой ресурс. В этой статье термин "страница" или "веб-сайт" означает ресурс в диалоговом окне. Ниже приведен простой пример кода.

```js
Office.context.ui.displayDialogAsync('https://myAddinDomain/myDialog.html');
```

> [!NOTE]
> - В случае URL-адреса используется протокол HTTP**S**, обязательный для всех страниц, загружаемых в диалоговом окне, а не только для первой страницы.
> - Домен совпадает с доменом главной страницы, которая может быть страницей в области задач или [файлом функций](https://dev.office.com/reference/add-ins/manifest/functionfile) для команды надстройки. Страница, метод контроллера или другой ресурс, переданный в метод `displayDialogAsync`, должен быть в том же домене, что и главная страница.

После загрузки первой страницы (или другого ресурса) пользователь может перейти к любому веб-сайту (или другому ресурсу), который использует HTTPS. Первая страница также может сразу перенаправлять пользователя на другой сайт.

По умолчанию диалоговое окно занимает 80 % высоты и ширины экрана устройства, но вы можете установить другие соотношения путем передачи объекта конфигурации в метод, как показано в приведенном ниже примере.

```js
Office.context.ui.displayDialogAsync('https://myDomain/myDialog.html', {height: 30, width: 20});
```

Подобная надстройка приведена в статье [Пример надстройки Office с Dialog API](https://github.com/OfficeDev/Office-Add-in-Dialog-API-Simple-Example).

Установите оба значения равными 100 %, чтобы надстройка открывалась во весь экран. (На самом деле, максимальное значение составляет 99,5 %, возможность перемещать окно и изменять его размер сохраняется.)

> [!NOTE]
> Из главного окна можно открыть только одно диалоговое окно. При попытке открыть еще одно диалоговое окно произойдет ошибка. Поэтому если пользователь, например, откроет диалоговое окно из области задач, он не сможет открыть второе диалоговое окно на другой странице в области задач. Но при открытии диалогового окна с помощью [команды надстройки](../design/add-in-commands.md) каждый раз открывается новый (невидимый) HTML-файл. При этом создается новое (невидимое) главное окно, которое может запускать собственное диалоговое окно. Дополнительные сведения см. в разделе [Ошибки метода displayDialogAsync](#errors-from-displaydialogasync).

### <a name="take-advantage-of-a-performance-option-in-office-online"></a>Использование параметра производительности в Office Online

— дополнительное свойство в объекте конфигурации, которое можно передать `displayDialogAsync`. Когда этому свойству присвоено значение `true`, а надстройка запущена для документа в Office Online, диалоговое окно будет открываться быстрее, потому что будет выступать как плавающий фрейм iframe. Ниже приведен пример.`displayInIframe`

```js
Office.context.ui.displayDialogAsync('https://myDomain/myDialog.html', {height: 30, width: 20, displayInIframe: true});
```

Значение по умолчанию: `false`. Его использование равнозначно пропуску всего свойства. Если надстройка не работает в Office Online, `displayInIframe` игнорируется.

> [!NOTE]
> **Не** следует использовать `displayInIframe: true`, если диалоговое окно будет выполнять перенаправление на страницу, которую невозможно открыть в элементе iframe. Например, страницы входа многих популярных веб-служб (который выполняется, например, с помощью учетной записи Майкрософт или Google), невозможно открыть в элементе iframe.

### <a name="send-information-from-the-dialog-box-to-the-host-page"></a>Отправка сведений из диалогового окна главной странице

Диалоговое окно может взаимодействовать с главной страницей в области задач, если:

- Текущая страница в диалоговом окне не находится в том же домене, что и главная страница.
- Библиотека JavaScript для Office не загружена на странице. (Как и любая страница, которая использует библиотеку JavaScript для Office, сценарий для страницы должен назначить метод свойству `Office.initialize`. Метод может быть пустой. Дополнительные сведения см. в разделе [Инициализация надстройки](understanding-the-javascript-api-for-office.md#initializing-your-add-in).)

Код в диалоговом окне использует функцию `messageParent` для отправки логического значения или строки на главную страницу. Строка может быть словом, предложением, большим двоичным объектом XML, строковым представлением JSON или любым другим объектом, который можно сериализовать, представив в виде строки. Ниже приведен пример.

```js
if (loginSuccess) {
    Office.context.ui.messageParent(true);
}
```

> [!NOTE]
> - Функция `messageParent` — это один из *двух* API Office, которые можно вызывать в диалоговом окне. Другой — `Office.context.requirements.isSetSupported`. Дополнительные сведения см. в статье [Указание ведущих приложений Office и требований к API](specify-office-hosts-and-api-requirements.md).
> - Функцию `messageParent` можно вызывать только на странице, которая относится к тому же домену (включая протокол и порт), что и главная страница.

В следующем примере `googleProfile` — это строковое представление профиля Google пользователя.

```js
if (loginSuccess) {
    Office.context.ui.messageParent(googleProfile);
}
```

Чтобы главная страница получила сообщение, ее необходимо настроить. Для этого добавьте параметр обратного вызова в исходный вызов `displayDialogAsync`. Обратный вызов назначает событию `DialogMessageReceived` обработчик. Ниже приведен пример.

```js
var dialog;
Office.context.ui.displayDialogAsync('https://myDomain/myDialog.html', {height: 30, width: 20},
    function (asyncResult) {
        dialog = asyncResult.value;
        dialog.addEventHandler(Office.EventType.DialogMessageReceived, processMessage);
    }
);
```

> [!NOTE]
> - Office передает объект [AsyncResult](https://dev.office.com/reference/add-ins/shared/asyncresult) в функцию обратного вызова. Он представляет собой результат попытки открыть диалоговое окно, но не результат событий в диалоговом окне. Дополнительные сведения об этой особенности см. в разделе [Обработка ошибок и событий](#handle-errors-and-events).
> - Для свойства `value` объекта `asyncResult` задан объект [Dialog](https://dev.office.com/reference/add-ins/shared/officeui.dialog), который существует на главной странице, а не в контексте выполнения диалогового окна.
> - — это функция, которая обрабатывает событие. Вы можете присвоить ей любое имя.`processMessage`
> - Переменная `dialog` объявляется в более широком контексте, чем обратный вызов, так как на нее также ссылается `processMessage`.

Ниже приведен простой пример обработчика для события `DialogMessageReceived`.

```js
function processMessage(arg) {
    var messageFromDialog = JSON.parse(arg.message);
    showUserName(messageFromDialog.name);
}
```

> [!NOTE]
> - Office передает объект `arg` в обработчик. Его свойство `message` — это логическое значение или строка, отправляемая при вызове `messageParent` в диалоговом окне. В данном примере это профиль пользователя из учетной записи Майкрософт, Google или другой службы, представленный в виде строки, поэтому он десериализируется обратно в объект с помощью метода `JSON.parse`.
> - Функция `showUserName` не показана. Она может отображать персонализированное приветствие в области задач.

Когда взаимодействие пользователя с диалоговым окном закончится, обработчик сообщений должен закрыть диалоговое окно, как показано в этом примере.

```js
function processMessage(arg) {
    dialog.close();
    // message processing code goes here;
}
```

> [!NOTE]
> - Объект `dialog` должен быть таким же, как объект, который возвращается при вызове `displayDialogAsync`.
> - Вызов метода `dialog.close` дает указание Office немедленно закрыть диалоговое окно.

Пример надстройки, в которой используются эти методы, см. в статье [Пример надстройки Office с Dialog API](https://github.com/OfficeDev/Office-Add-in-Dialog-API-Simple-Example).

Если надстройка должна открыть другую страницу области задач после получения сообщения, можно использовать метод `window.location.replace` (или `window.location.href`) в последней строке обработчика. Ниже приведен пример.

```js
function processMessage(arg) {
    // message processing code goes here;
    window.location.replace("/newPage.html");
    // Alternatively ...
    // window.location.href = "/newPage.html";
}
```

Пример подобной надстройки см. в статье [Вставка диаграмм Excel с помощью Microsoft Graph в надстройке PowerPoint](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart).

#### <a name="conditional-messaging"></a>Условные сообщения
Так как из диалогового окна можно отправить несколько вызовов `messageParent`, но на главной странице есть только один обработчик для события `DialogMessageReceived`, обработчику необходимо использовать условную логику, чтобы различать сообщения. Например, если диалоговое окно предлагает пользователю войти в учетную запись Майкрософт, Google или другого поставщика удостоверений, оно отправляет профиль пользователя в виде сообщения. Если выполнить аутентификацию не удается, диалоговое окно отправляет сведения об ошибке на главную страницу, как показано в приведенном ниже примере.

```js
if (loginSuccess) {
    var userProfile = getProfile();
    var messageObject = {messageType: "signinSuccess", profile: userProfile};            
    var jsonMessage = JSON.stringify(messageObject);
    Office.context.ui.messageParent(jsonMessage);
} else {
    var errorDetails = getError();
    var messageObject = {messageType: "signinFailure", error: errorDetails};            
    var jsonMessage = JSON.stringify(messageObject);
    Office.context.ui.messageParent(jsonMessage);
}
```

> [!NOTE]
> - Переменная `loginSuccess` будет инициализирована после считывания отклика HTTP от поставщика удостоверений.
> - Реализация функций `getProfile` и `getError` не показана. Они получают данные из параметра запроса или ответа HTTP.
> - В зависимости от того, удалось ли выполнить вход, отправляются анонимные объекты различных типов. Оба содержат свойство `messageType`, но один содержит свойство `profile`, а другой — свойство `error`.

Примеры использования условных сообщений см. в таких статьях:
- [Использование службы Auth0 в надстройках Office для упрощения входа через социальные сети](https://github.com/OfficeDev/Office-Add-in-Auth0)
- [Использование службы OAuth.io в надстройках Office для упрощения доступа к популярным веб-службам](https://github.com/OfficeDev/Office-Add-in-OAuth.io)

Код обработчика на главной странице использует значение свойства `messageType` для разветвления, как показано в приведенном ниже примере. Обратите внимание на то, что здесь используется та же функция `showUserName`, что и в примере выше, а функция `showNotification` отображает сообщение об ошибке в элементе пользовательского интерфейса на главной странице.

```js
function processMessage(arg) {
    var messageFromDialog = JSON.parse(arg.message);
    if (messageFromDialog.messageType === "signinSuccess") {
        dialog.close();
        showUserName(messageFromDialog.profile.name);
        window.location.replace("/newPage.html");
    } else {
        dialog.close();
        showNotification("Unable to authenticate user: " + messageFromDialog.error);
    }
}
```

### <a name="closing-the-dialog-box"></a>Закрытие диалогового окна

Вы можете добавить в диалоговое окно кнопку, которая будет его закрывать. Для этого обработчик событий кнопки должен использовать `messageParent`, чтобы сообщить главной странице, что кнопка нажата. Ниже приведен пример.

```js
function closeButtonClick() {
    var messageObject = {messageType: "dialogClosed"};            
    var jsonMessage = JSON.stringify(messageObject);
    Office.context.ui.messageParent(jsonMessage);
}
```

Обработчик главной страницы для `DialogMessageReceived` вызовет `dialog.close`, как показано в этом примере. (Примеры инициализации объекта dialog см. выше в этой статье.)


```js
function processMessage(arg) {
    var messageFromDialog = JSON.parse(arg.message);
    if (messageFromDialog.messageType === "dialogClosed") {
       dialog.close();
    }
}
```

[Конструктивный шаблон обеспечения навигации для диалогового окна](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code/tree/master/templates/dialog/navigation), в случае которого используется эта техника, см. в репозитории [конструктивных шаблонов для пользовательского интерфейса надстроек Office](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code).

Даже если у вас нет собственной кнопки для закрытия диалогового окна, пользователь сможет закрыть его, нажав кнопку **X** в правом верхнем углу. Это действие запускает событие `DialogEventReceived`. Чтобы главная область могла реагировать на это событие, для нее должен быть объявлен обработчик этого события. Подробнее: [Ошибки и события в диалоговом окне](#errors-and-events-in-the-dialog-window).

## <a name="handle-errors-and-events"></a>Обработка ошибок и событий

Код должен обрабатывать две категории событий:

- Ошибки, возвращаемые при вызове метода `displayDialogAsync`, так как не удается создать диалоговое окно.
- Ошибки и другие события в диалоговом окне.

### <a name="errors-from-displaydialogasync"></a>Ошибки метода displayDialogAsync

Кроме общих ошибок платформы и системы, при вызове метода `displayDialogAsync` возникают указанные ниже ошибки.

|Цифровой код|Значение|
|:-----|:-----|
|12004|Домен URL-адреса, передаваемого в метод `displayDialogAsync`, не является доверенным. Домен должен быть таким же, как и для главной страницы (а также протокол и номер порта).|
|12005|URL-адрес, передаваемый в метод `displayDialogAsync`, использует протокол HTTP. Необходим протокол HTTPS. (В некоторых версиях Office сообщение об ошибке 12005 совпадает с сообщением 12004.)|
|<span id="12007">12007</span>|Диалоговое окно уже открыто из этого главного окна. Для главного окна, например области задач, невозможно открыть сразу несколько диалоговых окон.|

При вызове метода `displayDialogAsync` он всегда передает объект [AsyncResult](https://dev.office.com/reference/add-ins/shared/asyncresult) в функцию обратного вызова. Если метод вызван, т. е. диалоговое окно открыто, свойство `value` объекта `AsyncResult` приравнивается к объекту [Dialog](https://dev.office.com/reference/add-ins/shared/officeui.dialog). См. пример в разделе [Отправка сведений из диалогового окна главной странице](#send-information-from-the-dialog-box-to-the-host-page). Если вызвать `displayDialogAsync` не удается, то окно не создается, свойству `status` объекта `AsyncResult` присваивается значение "ошибка", а также заполняется свойство `error` объекта. У вас всегда должна быть функция обратного вызова, которая проверяет `status` и сообщает об ошибке. Ниже приведен пример, в котором просто сообщается об ошибке, независимо от ее кода.

```js
var dialog;
Office.context.ui.displayDialogAsync('https://myDomain/myDialog.html',
function (asyncResult) {
    if (asyncResult.status === "failed") {
        showNotification(asynceResult.error.code = ": " + asyncResult.error.message);
    } else {
        dialog = asyncResult.value;
        dialog.addEventHandler(Office.EventType.DialogMessageReceived, processMessage);
    }
});
```

### <a name="errors-and-events-in-the-dialog-window"></a>Ошибки и события в диалоговом окне

Три ошибки и события, известных по цифровым кодам, в диалоговом окне вызывают событие `DialogEventReceived` на главной странице.

|Цифровой код|Значение|
|:-----|:-----|
|12002|Одно из следующих:<br> – По URL-адресу, переданному в `displayDialogAsync`, не существует страницы.<br> – Страница, переданная в метод `displayDialogAsync`, загружена, но выполнена попытка открыть из диалогового окна страницу, которую не удается найти или загрузить, или для которой указан URL-адрес с недопустимым синтаксисом.|
|12003|Выполнена попытка открыть из диалогового окна страницу, для URL-адреса которой используется протокол HTTP. Необходим протокол HTTPS.|
|12006|Диалоговое окно закрыто. Скорее всего, пользователь нажал кнопку **X**.|

Код может назначить обработчик для события `DialogEventReceived` при вызове `displayDialogAsync`. Ниже приведен простой пример.

```js
var dialog;
Office.context.ui.displayDialogAsync('https://myDomain/myDialog.html',
    function (result) {
        dialog = result.value;
        dialog.addEventHandler(Office.EventType.DialogEventReceived, processDialogEvent);
    }
);
```

Ниже приведен пример обработчика для события `DialogEventReceived`, который создает особые сообщения об ошибках для каждого кода ошибки.

```js
function processDialogEvent(arg) {
    switch (arg.error) {
        case 12002:
            showNotification("The dialog box has been directed to a page that it cannot find or load, or the URL syntax is invalid.");
            break;
        case 12003:
            showNotification("The dialog box has been directed to a URL with the HTTP protocol. HTTPS is required.");            break;
        case 12006:
            showNotification("Dialog closed.");
            break;
        default:
            showNotification("Unknown error in dialog box.");
            break;
    }
}
```

Надстройку с такой обработкой ошибок см. в статье [Пример надстройки Office с Dialog API](https://github.com/OfficeDev/Office-Add-in-Dialog-API-Simple-Example).


## <a name="pass-information-to-the-dialog-box"></a>Передача данных диалоговому окну

Иногда главной странице нужно передать данные в диалоговое окно. Есть два основных способа обеспечить эту возможность:

- Добавьте параметры запроса в URL-адрес, который передается в метод `displayDialogAsync`.
- Храните информацию в месте, доступном как для главного, так и для диалогового окна. У всех окон есть отдельное хранилище сеанса, но *если для них используется один домен* (включая номер порта), у них общее [локальное хранилище](http://www.w3schools.com/html/html5_webstorage.asp).

### <a name="use-local-storage"></a>Использование локального хранилища

Чтобы использовать локальное хранилище, код вызывает метод `setItem` объекта `window.localStorage` на главной странице перед вызовом `displayDialogAsync`, как показано в приведенном ниже примере.

```js
localStorage.setItem("clientID", "15963ac5-314f-4d9b-b5a1-ccb2f1aea248");
```

Код в диалоговом окне считывает элемент, когда это необходимо, как показано в приведенном ниже примере.

```js
var clientID = localStorage.getItem("clientID");
// You can also use property syntax:
// var clientID = localStorage.clientID;
```

Примеры подобного использования локального хранилища надстройками см. в таких статьях:

- [Использование службы Auth0 в надстройках Office для упрощения входа через социальные сети](https://github.com/OfficeDev/Office-Add-in-Auth0)
- [Использование службы OAuth.io в надстройках Office для упрощения доступа к популярным веб-службам](https://github.com/OfficeDev/Office-Add-in-OAuth.io)

### <a name="use-query-parameters"></a>Использование параметров запроса

В приведенном ниже примере показано, как передавать данные с помощью параметра запроса.

```js
Office.context.ui.displayDialogAsync('https://myAddinDomain/myDialog.html?clientID=15963ac5-314f-4d9b-b5a1-ccb2f1aea248');
```

Пример, в котором используется эта техника, см. в статье [Вставка диаграмм Excel с помощью Microsoft Graph в надстройке PowerPoint](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart).

Код в диалоговом окне может проанализировать URL-адрес и считать значение параметра.

> [!NOTE]
> Office автоматически добавляет параметр запроса `_host_info` в URL-адрес, который передается `displayDialogAsync`. (Этот параметр добавляется после пользовательских параметров запроса, если они есть. Он не добавляется в последующие URL-адреса, которые открываются в диалоговом окне.) Корпорация Майкрософт может изменить содержимое этого значения или удалить его полностью, поэтому ваш код не должен его считывать. То же значение добавляется в хранилище сеанса диалогового окна. *Ваш код не должен ни считывать это значение, ни записывать в него данные*.

## <a name="use-the-dialog-apis-to-show-a-video"></a>Использование Dialog API для показа видео

Чтобы показать видео в диалоговом окне:

1.  Создайте страницу с единственным содержимым — элементом iframe. Атрибут `src` этого элемента указывает на видео из Интернета. В URL-адресе видео должен быть указан протокол HTTP**S**. В этой статье мы назовем эту страницу "video.dialogbox.html". Ниже приведен пример кода.

    ```HTML
    <iframe class="ms-firstrun-video__player"  width="640" height="360"
        src="https://www.youtube.com/embed/XVfOe5mFbAE?rel=0&autoplay=1"
        frameborder="0" allowfullscreen>
    </iframe>
    ```

2.  Страница video.dialogbox.html должна находиться в том же домене, что и главная страница.
3.  Используйте вызов `displayDialogAsync` на главной странице, чтобы открыть страницу video.dialogbox.html.
4.  Если надстройке необходимо знать, когда пользователь закрывает диалоговое окно, зарегистрируйте обработчик для события `DialogEventReceived` и обработайте событие 12006. Дополнительные сведения см. в разделе [Ошибки и события в диалоговом окне](#errors-and-events-in-the-dialog-window).

[Конструктивный шаблон размещения видео](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code/tree/master/templates/first-run/video-placemat) в диалоговом окне вы найдете в репозитории [конструктивных шаблонов для пользовательского интерфейса надстроек Office](https://github.com/OfficeDev/Office-Add-in-UX-Design-Patterns-Code).

![Снимок экрана: видео в диалоговом окне надстройки](../images/video-placemats-dialog-open.png)

## <a name="use-the-dialog-apis-in-an-authentication-flow"></a>Использование Dialog API в потоке аутентификации

Основной сценарий для Dialog API — обеспечить аутентификацию с помощью ресурса или поставщика удостоверений, который не разрешает открытие страницы входа в окне Iframe, такого как учетная запись Майкрософт, Office 365, Google или Facebook.

> [!NOTE]
> Когда вы используете Dialog API для этого сценария, *не* применяйте параметр `displayInIframe: true` при вызове `displayDialogAsync`. Сведения об этом параметре приведены выше, в разделе [Использование параметра производительности в Office Online](#take-advantage-of-a-performance-option-in-office-online).

Ниже показан простой и типичный поток аутентификации.

1. Сначала в диалоговом окне открывается локальная страница или другой ресурс, размещенный в домене надстройки (то есть в домене главного окна). На этой странице может быть простая надпись "Подождите, мы перенаправляем вас на страницу, где вы сможете войти в учетную запись *ИМЯ_ПОСТАВЩИКА*". Код на этой странице создает URL-адрес страницы входа поставщика удостоверений, используя данные, передаваемые в диалоговое окно, как описано в разделе [Передача данных диалоговому окну](#pass-information-to-the-dialog-box).
2. Затем диалоговое окно перенаправляет пользователя на страницу входа. URL-адрес включает параметр запроса, который дает указание поставщику удостоверений после входа пользователя перенаправить последнего на определенную страницу. В этой статье мы назовем эту страницу "redirectPage.html". *Эта страница должна находиться в том же домене, что и главное окно*, так как диалоговое окно может передавать результаты попытки входа только с помощью вызова метода `messageParent`, а вызвать его можно только на такой странице.
2. Служба поставщика удостоверений обрабатывает входящий запрос GET, поступивший из диалогового окна. Если пользователь уже вошел в систему, она немедленно перенаправляет его на страницу redirectPage.html и включает пользовательские данные в параметр запроса. Если пользователь еще не вошел, в окне появляется страница поставщика для входа. Если пользователю не удается войти, большинство поставщиков показывают в диалоговом окне страницу с сообщением об ошибке и не перенаправляют его на страницу redirectPage.html. Пользователь должен закрыть это окно, нажав кнопку **X** в углу. Если пользователь успешно входит, он перенаправляется на страницу redirectPage.html, а пользовательские данные добавляются в параметр запроса.
3. Когда открывается страница redirectPage.html, она вызывает функцию `messageParent`, чтобы сообщить о результате главной странице, а также сообщить пользовательские данные или данные об ошибке.
4. На главной странице запускается событие `DialogMessageReceived`, и его обработчик закрывает диалоговое окно и (при необходимости) обрабатывает сообщение.

Примеры надстроек, в которых используется этот шаблон, см. в следующих статьях:

- [Вставка диаграмм Excel с помощью Microsoft Graph в надстройке PowerPoint](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart). Ресурс, который изначально открывается в диалоговом окне, — метод контроллера, не имеющий своего представления. Он перенаправляет пользователя на страницу входа в Office 365.
- [Проверка подлинности клиента Office 365 для надстройки Office с помощью AngularJS](https://github.com/OfficeDev/Word-Add-in-AngularJS-Client-OAuth). Ресурс, который изначально открывается в диалоговом окне, — это страница.

#### <a name="support-multiple-identity-providers"></a>Поддержка нескольких поставщиков удостоверений

Если пользователь может выбрать поставщика для входа в надстройку, например учетную запись Майкрософт, Google или Facebook, первой должна открываться локальная страница со списком поставщиков (см. предыдущий раздел). После выбора поставщика происходит создание URL-адреса входа и перенаправление на него.

Пример, в котором используется этот шаблон, см. в статье [Использование службы Auth0 в надстройках Office для упрощения входа через социальные сети](https://github.com/OfficeDev/Office-Add-in-Auth0).

#### <a name="authorization-of-the-add-in-to-an-external-resource"></a>Авторизация надстройки через внешний ресурс

В современном Интернете веб-приложения — это такие же субъекты безопасности, как пользователи, у них есть свои удостоверения и разрешения для онлайн-ресурсов, таких как Office 365, Google+, Facebook и LinkedIn. Перед развертыванием приложение регистрируется у поставщика ресурса. Регистрация включает:

- Список разрешений на доступ к ресурсам пользователя, которые нужны приложению.
- URL-адрес, на который служба ресурса должна возвращать маркер доступа, когда приложение получает доступ к службе.  

Когда пользователь вызывает функцию в приложении, которое получает доступ к его данным в службе ресурса, пользователю будет предложено войти в службу, а затем предоставить приложению необходимые разрешения. Служба затем перенаправляет пользователя на зарегистрированный URL-адрес и передает маркер доступа. Приложение использует маркер доступа для доступа к ресурсам пользователя.

Вы можете управлять этим процессом с помощью Dialog API, используя поток, похожий на тот, который обеспечивает возможность входа пользователей. В чем заключаются отличия:

- Если пользователь не предоставил приложению необходимые разрешения, ему будет предложено сделать это в диалоговом окне после входа.
- Диалоговое окно отправляет маркер доступа в главное окно, преобразовывая его в строку с помощью функции `messageParent` или сохраняя его там, откуда главное окно сможет его извлечь. Пока срок действия этого маркера не истек, главное окно может использовать его для прямого доступа к ресурсам пользователя без дополнительных запросов.

Dialog API используется для этой цели в следующих примерах:
- [Вставка диаграмм Excel с помощью Microsoft Graph в надстройке PowerPoint](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart) (маркер доступа хранится в базе данных).
- [Использование службы OAuth.io в надстройках Office для упрощения доступа к популярным веб-службам](https://github.com/OfficeDev/Office-Add-in-OAuth.io)

Дополнительные сведения об аутентификации и авторизации в надстройках см. в статьях:
- [Авторизация внешних служб в надстройке Office](auth-external-add-ins.md)
- [Библиотека вспомогательных приложений API JavaScript для Office](https://github.com/OfficeDev/office-js-helpers)


## <a name="use-the-office-dialog-api-with-single-page-applications-and-client-side-routing"></a>Использование Dialog API для Office с одностраничными приложениями и клиентской маршрутизацией

Если надстройка использует клиентскую маршрутизацию подобно тому, как это делает одностраничное приложение, вы можете передавать в метод [displayDialogAsync](http://dev.office.com/reference/add-ins/shared/officeui.displaydialogasync) не URL-адрес отдельной HTML-страницы, а URL-адрес маршрута.

> [!IMPORTANT]
>Диалоговое окно — это новое окно с собственным контекстом выполнения. Если вы передаете маршрут, базовая страница со всем ее кодом инициализации и начальной загрузки запускается снова в этом новом контексте, а возможным переменным присваиваются первоначальные значения в диалоговом окне. Такой способ приводит к запуску второго экземпляра приложения в диалоговом окне. Код, меняющий переменные в диалоговом окне, не меняет версию области задач этих переменных. Для диалогового окна предусмотрено отдельное хранилище сеанса, недоступное из кода в области задач.
