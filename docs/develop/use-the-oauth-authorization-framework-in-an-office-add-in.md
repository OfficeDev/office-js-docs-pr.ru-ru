---
title: Использование платформы авторизации OAuth в надстройке Office
description: ''
ms.date: 12/04/2017
---


# <a name="use-the-oauth-authorization-framework-in-an-office-add-in"></a>Использование платформы авторизации OAuth в надстройке Office

OAuth — это открытый стандарт авторизации, который используется в Office 365, Facebook, Google, SalesForce, LinkedIn и других интернет-службах для проверки подлинности пользователей. Протокол авторизации OAuth используется по умолчанию в Azure и Office 365. Платформа авторизации OAuth используется как в корпоративных, так и частных решениях.

Поставщики интернет-служб могут предоставлять общедоступные API через протокол REST. Разработчики могут использовать эти общедоступные API в надстройках Office для чтения или записи данных в интернет-службе. Интегрируя данные из интернет-служб в надстройку, вы повышаете ее ценность и привлекаете больше пользователей. При использовании этих API в надстройке требуется проверка подлинности с помощью платформы авторизации OAuth.

В этой статье рассказывается, как реализовать проверку подлинности в надстройке. Используемые в статье сегменты кода взяты из примера [Office-Add-in-NodeJS-ServerAuth](https://github.com/OfficeDev/Office-Add-in-NodeJS-ServerAuth).

> [!NOTE]
> Из соображений безопасности браузеры не могут отображать страницы входа в IFrame. В зависимости от версий Office, которые используют ваши клиенты, особенно веб-версий, надстройка может отображаться в IFrame. Поэтому существуют специальные рекомендации по управлению потоком проверки подлинности.  

На следующей схеме показаны необходимые компоненты и поток событий, происходящих при реализации проверки подлинности в надстройке.

![Выполнение проверки подлинности OAuth в надстройке Office](../images/oauth-in-office-add-in.png)

На схеме показано, как используются необходимые компоненты:


- Office запускает надстройку области задач на компьютере пользователя. Надстройка открывает всплывающее окно для проверки подлинности. Надстройки не могут запускать проверку подлинности напрямую, так как, в зависимости от используемой платформы, они могут выполняться в IFRAME. Из соображений безопасности страницы входа OAuth не могут отображаться в IFRAME. 
    
- На веб-сервере размещается код надстройки. В этом примере кода для хранения маркера доступа пользователя используется сервер базы данных, запущенный на веб-сервере. Сохранение маркера доступа необходимо, чтобы после проверки подлинности с помощью всплывающего окна главные страницы надстройки могли использовать те же маркеры для доступа к данным интернет-службы. Сохранение маркеров на стороне сервера необходимо, так как сведения, передаваемые из надстройки или всплывающего окна, не надежны.
    
- Поставщик OAuth 2.0 выполняет проверку подлинности пользователя.
    

    
> [!IMPORTANT]
> Маркеры доступа невозможно возвратить на панель задач, но их можно использовать на сервере. В этом примере кода маркеры доступа хранятся в базе данных в течение 2 минут. Через 2 минуты маркеры удаляются из базы данных, и пользователям предлагается повторить проверку подлинности. Прежде чем менять этот период времени в своей реализации, изучите риски для безопасности, связанные с хранением маркеров доступа в базе данных дольше 2 минут.


## <a name="step-1---start-socket-and-open-a-pop-up-window"></a>Этап 1. Запуск сокета и открытие всплывающего окна

После запуска кода из этого примера в Office отображается надстройка области задач. Когда пользователь выбирает поставщика OAuth для входа, надстройка прежде всего создает сокет. В этом примере применен сокет, чтобы обеспечить удобство работы с надстройкой для пользователя. С помощью сокета надстройка сообщает пользователю об успешной проверке подлинности или ошибке. С помощью сокета состояние проверки подлинности обновляется на главной странице надстройки без опроса пользователя или его вмешательства. В указанном ниже сегменте кода, взятом из файла routes/connect.js, показано, как запустить сокет. В имени сокета используется идентификатор сеанса надстройки **decodedNodeCookie**. В этом примере кода показано, как создать сокет с помощью [socket.io](http://socket.io/).


```js
io.on('connection', function (socket) {
  console.log('Socket connection established');
  var jsonCookie =
    cookie.parse(socket
      .handshake
      .headers
      .cookie);
  var decodedNodeCookie =
    cookieParser
      .signedCookie(jsonCookie.nodecookie, '<Insert a random string>');
  console.log('Decoded cookie: ' + decodedNodeCookie);
  // The session ID becomes the room name for this session.
  socket.join(decodedNodeCookie);
  io.to(decodedNodeCookie).emit('init', 'Private socket session established');
});

```

Затем надстройка подключается к сокету. Следующий код можно найти в файле /public/javascripts/client.js.




```js
var socket = io.connect('https://localhost:3001', { secure: true });
```

Затем надстройка открывает всплывающее окно на компьютере пользователя с помощью команды **window.open**. При запуске команды **window.open** убедитесь, что в URL-адресе передаются универсальный код ресурса (URI) перенаправления и идентификатор сеанса надстройки. Последний определяет, какой сокет необходимо использовать при отправке сведений о состоянии проверки подлинности в пользовательский интерфейс надстройки. Указанны ниже фрагмент кода можно найти в файле views/index.jade.




```js
onclick="window.open('/connect/azure/#{sessionID}', 'AuthPopup', 'width=500,height=500,centerscreen=1,menubar=0,toolbar=0,location=0,personalbar=0,status=0,titlebar=0,dialog=1')")
```


## <a name="steps-2-amp-3---start-the-authentication-flow-and-show-the-sign-in-page"></a>Этапы 2 и 3. Запуск потока проверки подлинности и отображение страницы входа

Надстройка должна запустить проверку подлинности. В приведенном ниже сегменте кода используется библиотека Passport OAuth. При запуске проверки подлинности убедитесь, что передается URL-адрес авторизации поставщика OAuth и идентификатор сеанса надстройки. Последний необходимо передавать в параметре состояния. Теперь во всплывающем окне отображается страница поставщика OAuth для входа пользователей.


```js
router.get('/azure/:sessionID', function(req, res, next) { 
   passport.authenticate( 
     'azure',  
     { state: req.params.sessionID }, 

```


## <a name="steps-4-5-amp-6---user-signs-in-and-web-server-receives-tokens"></a>Этапы 4, 5 и 6. Пользователь входит в систему, а веб-сервер получает маркеры

 После успешного входа в надстройку возвращаются маркер доступа, маркер обновления и параметр состояния. Последний содержит идентификатор сеанса, который используется для отправки сведений о состоянии проверки подлинности в сокет в действии 7. В указанном ниже сегменте кода, взятом из файла app.js, показано, как сохранить маркер доступа в базе данных.


```js
  dbHelperInstance.insertDoc(userData, null, 
         function (err, body) { 
           if (!err) { 
             console.log("Inserted session entry [" + userData.sessid + "] id: " + body.id); 
           } 
           done(err, userData); 
         }); 

```


## <a name="step-7---show-authentication-information-in-the-add-ins-ui"></a>Этап 7. Отображение сведений о проверке подлинности в пользовательском интерфейсе надстройки

В указанном ниже сегменте кода, взятом из файла connect.js, показано, как обновить сведения о состоянии проверки подлинности в пользовательском интерфейсе надстройки. Пользовательский интерфейс надстройки обновляется с помощью сокета, созданного в действии 1.


```js
  
       io.to(user.sessid).emit('auth_success', providers); 
       next(); 

```


## <a name="see-also"></a>См. также

- [Пример проверки подлинности на сервере в надстройке Office для Node.js](https://github.com/OfficeDev/Office-Add-in-Nodejs-ServerAuth/blob/master/README.md)
    
