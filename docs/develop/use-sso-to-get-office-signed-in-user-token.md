---
title: Использование единого входа для получения удостоверения пользователя, выполнившего вход
description: Вызовите API getAccessToken, чтобы получить маркер идентификатора с именем, электронной почтой и дополнительными сведениями о вошедом пользователе.
ms.date: 02/16/2022
localization_priority: Normal
ms.openlocfilehash: 5416c469a15d7eda9333f511c61e2cff1a901018
ms.sourcegitcommit: 4ba5f750358c139c93eb2170ff2c97322dfb50df
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2022
ms.locfileid: "66660069"
---
# <a name="use-sso-to-get-the-identity-of-the-signed-in-user"></a>Использование единого входа для получения удостоверения пользователя, выполнившего вход

`getAccessToken` Используйте API для получения маркера доступа, содержащего удостоверение текущего пользователя, вошедщего в Office. Маркер доступа также является маркером идентификатора, так как он содержит утверждения удостоверения о вошедом пользователе, например его имя и адрес электронной почты. Маркер идентификатора также можно использовать для идентификации пользователя при вызове собственных веб-служб. Чтобы позвонить `getAccessToken` , необходимо настроить надстройку Office для использования единого входа с Office.

В этой статье вы создадите надстройку Office, которая получает маркер идентификатора и отображает имя пользователя, адрес электронной почты и уникальный идентификатор в области задач.

> [!NOTE]
> Единый вход с Office и `getAccessToken` API работают не во всех сценариях. Всегда реализуйте резервный диалог для входа пользователя, если единый вход недоступен. Дополнительные сведения см. в разделе ["Аутентификация и авторизация с помощью API диалогового окна Office"](auth-with-office-dialog-api.md).

## <a name="create-an-app-registration"></a>Создание регистрации приложения

Чтобы использовать единый вход с Office, необходимо создать регистрацию приложения в портал Azure, чтобы платформа удостоверений Майкрософт могли предоставлять службы проверки подлинности и авторизации для надстройки Office и ее пользователей.

1. Чтобы зарегистрировать приложение, перейдите на страницу [портал Azure - Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908).

1. Войдите **_в клиент Microsoft_** 365 с учетными данными администратора. Пример: MyName@contoso.onmicrosoft.com.

1. Выберите **Новая регистрация**. На странице **Зарегистрировать приложение** задайте необходимые значения следующим образом.

   - Введите **имя** `Office-Add-in-SSO`.
   - Для параметра **Поддерживаемые типы учетных записей** укажите вариант **Учетные записи в любом каталоге организации и личные учетные записи Майкрософт (например, Skype, Xbox, Outlook.com)**.
   - Задайте тип приложения **"Интернет"**, а затем **задайте URI перенаправления**`https://localhost:[port]/dialog.html`. Замените `[port]` его правильным номером порта для веб-приложения. Если вы создали надстройку с помощью yo office, номер порта обычно 3000 и находится в файле package.json. Если вы создали надстройку в Visual Studio 2019, порт будет найден в свойстве **URL-адреса SSL** веб-проекта.
   - Нажмите кнопку **Зарегистрировать**.

1. На странице **Office-Add-in-SSO** скопируйте и сохраните значения идентификатора приложения **(клиента)** и идентификатора **каталога (клиента**). Они понадобятся вам позже.

   > [!NOTE]
   > Этот **идентификатор приложения (клиента)** является значением аудитории, когда другие приложения, такие как клиентское приложение Office (например, PowerPoint, Word, Excel), ищут авторизованный доступ к приложению. Кроме того, он используется как идентификатор клиента, когда приложение, в свою очередь, пытается получить авторизованный доступ к Microsoft Graph.

1. Выберите **Проверка подлинности** в разделе **Управление**. В разделе **"Неявное предоставление** " включите флажки для маркера **доступа** и **маркера идентификатора**.

1. Щелкните **Сохранить** в верхней части формы.

1. Выберите пункт **Предоставление API** в разделе **Управление**. Щелкните **ссылку "Задать** ". При этом будет создан URI идентификатора приложения в форме `api://[app-id-guid]`, `[app-id-guid]` где находится идентификатор приложения **(клиента**).

1. В созданном идентификаторе вставьте (обратите внимание на косую черту "/", `localhost:[port]/` добавленную к концу) между двойной косой чертой и GUID. Замените `[port]` его правильным номером порта для веб-приложения. Если вы создали надстройку с помощью yo office, номер порта обычно 3000 и находится в файле package.json. Если вы создали надстройку в Visual Studio 2019, порт будет найден в свойстве **URL-адреса SSL** веб-проекта.
   По завершении весь идентификатор должен иметь форму `api://localhost:[port]/[app-id-guid]`, например `api://localhost:44355/c6c1f32b-5e55-4997-881a-753cc1d563b7`.

1. Нажмите кнопку **Добавить область**. На открываемой панели введите `access_as_user` имя **\<Scope\>** .

1. Для параметра **Кто может давать согласие?** установите вариант **Администраторы и пользователи**.

1. `access_as_user` Заполните поля для настройки запросов согласия администратора и пользователя значениями, подходящими для области, которая позволяет клиентским приложениям Office использовать веб-API надстройки с правами текущего пользователя. Предложения:

   - **Администратор отображаемое имя** согласия: Office может выступать в качестве пользователя.
   - **Описание согласия администратора**. Позволяет Office вызывать веб-API надстройки с такими же правами, как у текущего пользователя.
   - **Отображаемое имя согласия пользователя**: Office может действовать от имени пользователя.
   - **Описание согласия пользователя**: разрешить Office вызывать веб-API надстройки с тем же правами, что и у вас.

1. Убедитесь, что параметру **Состояние** присвоено значение **Включено**.

1. Нажмите кнопку **Добавить область**.

   > [!NOTE]
   > Доменная часть **\<Scope\>** имени, отображаемая сразу под текстовым полем, должна автоматически соответствовать заданным ранее URI идентификатора приложения с `/access_as_user` добавлением к концу, `api://localhost:6789/c6c1f32b-5e55-4997-881a-753cc1d563b7/access_as_user`например .

1. В разделе **"Авторизованные** клиентские приложения" введите следующий идентификатор, чтобы предварительно авторизовать все конечные точки приложений Microsoft Office.

   - `ea5a67f6-b6f3-4338-b240-c655ddc3cc8e` (Все конечные точки приложения Microsoft Office)

    > [!NOTE]
    > Идентификатор `ea5a67f6-b6f3-4338-b240-c655ddc3cc8e` предварительно авторизует Office на всех следующих платформах. Кроме того, можно ввести соответствующее подмножество следующих идентификаторов, если по какой-либо причине вы хотите запретить авторизацию в Office на некоторых платформах. Просто оставьте идентификаторы платформ, с которых требуется отостановить авторизацию. Пользователи надстройки на этих платформах не смогут вызывать веб-API, но другие функции надстройки по-прежнему будут работать.
    >
    > - `d3590ed6-52b3-4102-aeff-aad2292ab01c` (Microsoft Office).
    > - `93d53678-613d-4013-afc1-62e9e444a0a5` (Office в Интернете).
    > - `bc59ab01-8403-45c6-8796-ac3ef710b3e3` (Outlook в Интернете).

1. Нажмите **кнопку "** Добавить клиентское приложение", `[app-id-guid]` а затем на открываемой панели задайте идентификатор приложения (клиента) и установите флажок `api://localhost:44355/[app-id-guid]/access_as_user`.

1. Нажмите кнопку **Добавить приложение**.

1. Выберите пункт **Разрешения API** в разделе **Управление** и нажмите кнопку **Добавить разрешение**. В открывшейся панели выберите **Microsoft Graph** и щелкните **Делегированные разрешения**.

1. Используйте поле поиска **Выбрать разрешения**, чтобы найти нужные разрешения для надстройки. Найдите и выберите **разрешение** профиля. Это `profile` разрешение требуется приложению Office для получения маркера для веб-приложения надстройки.

   - profile

   > [!NOTE]
   > Разрешение `User.Read` может быть уже указано по умолчанию. Незачем запрашивать ненужные разрешения, поэтому рекомендуем снять флажок рядом с разрешением, которое не требуется вашей надстройке.

1. Нажмите кнопку **Добавить разрешения** в нижней части панели.

1. На той же странице нажмите  кнопку **\<tenant-name\>** "Предоставить согласие администратора" и выберите "Да", чтобы отобразить подтверждение.

## <a name="create-the-office-add-in"></a>Создание надстройки Office

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. Запустите Visual Studio 2019 и выберите **"Создать новый проект"**.
1. Найдите и выберите шаблон проекта **веб-надстройки** Excel. Затем нажмите кнопку **Далее**. Примечание. Единый вход работает с любым приложением Office, но для этой статьи будет работать с Excel.
1. Введите имя проекта, например **sso-display-user-info** , и нажмите кнопку **"Создать"**. Другие поля можно оставить со значениями по умолчанию.
1. В **диалоговом** окне "Выбор типа надстройки" выберите "Добавить новые функции **в Excel**" и нажмите кнопку **"Готово"**.

Проект создается и будет содержать два проекта в решении.

- **sso-display-user-info**: содержит манифест и сведения о загрузке неопубликоваемой надстройки в Excel.
- **sso-display-user-infoWeb**: ASP.NET, в котором размещаются веб-страницы надстройки.

# <a name="yo-office"></a>[yo office](#tab/yooffice)

Убедитесь, что [вы настроили среду разработки](../overview/set-up-your-dev-environment.md).

1. Чтобы создать проект, введите указанную ниже команду.

   ```command line
   yo office --projectType taskpane --name 'sso-display-user-info' --host excel --js true
   ```

Проект создается в новой папке с именем **sso-display-user-info**.

---

## <a name="configure-the-manifest"></a>Настройка манифеста

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. В **Обозреватель решений** **sso-display-user-info > sso-display-user-infoManifest > sso-display-user-info.xml**

# <a name="yo-office"></a>[yo office](#tab/yooffice)

1. В Visual Studio Code **откройтеmanifest.xmlфайла** .

---

1. В нижней части манифеста находится закрывающий `</Resources>` элемент. Вставьте следующий XML-код под элементом `</Resources>` , но перед закрывающим элементом `</VersionOverrides>` . Для приложений Office, отличных от Outlook, добавьте разметку в конец `<VersionOverrides ... xsi:type="VersionOverridesV1_0">` раздела. Для Outlook добавьте разметку в конец раздела `<VersionOverrides ... xsi:type="VersionOverridesV1_1">`.

   ```xml
   <WebApplicationInfo>
       <Id>[application-id]</Id>
       <Resource>api://localhost:[port]/[application-id]</Resource>
       <Scopes>
           <Scope>openid</Scope>
           <Scope>user.read</Scope>
           <Scope>profile</Scope>
       </Scopes>
   </WebApplicationInfo>
   ```

1. Замените `[port]` правильный номер порта для проекта. Если вы создали надстройку с помощью yo office, номер порта обычно 3000 и находится в файле package.json. Если вы создали надстройку в Visual Studio 2019, порт будет найден в свойстве **URL-адреса SSL** веб-проекта.
1. Замените оба `[application-id]` заполнителя фактическим идентификатором приложения из регистрации приложения.
1. Сохраните файл.

Вставленный XML-код содержит следующие элементы и сведения.

- **\<WebApplicationInfo\>** — родительский элемент следующих элементов.
- **\<Id\>** — Идентификатор клиента надстройки . Это идентификатор приложения, который вы получите при регистрации надстройки. См. [Регистрация надстройки Office, использующей единый вход с конечной точкой Microsoft Azure AD версии 2.0](register-sso-add-in-aad-v2.md).
- **\<Resource\>** — URL-адрес надстройки. Это тот же URI (включая протокол `api:`), который вы использовали при регистрации надстройки и в AAD. Часть домена этого URI должна соответствовать домену, включая любые поддомены, используемые в URL-адресах **\<Resources\>** в разделе манифеста надстройки, а URI **\<Id\>** должен быть указан идентификатором клиента в .
- **\<Scopes\>** — родительский элемент одного или нескольких **\<Scope\>** элементов.
- **\<Scope\>** — указывает разрешение, необходимое надстройке для AAD. Разрешения `profile` и `openID` требуются во всех случаях и они могут быть единственными необходимыми разрешениями, если ваша надстройка не имеет доступа к Microsoft Graph. Если это так, вам также **\<Scope\>** потребуются элементы для необходимых разрешений Microsoft Graph, `User.Read`например , . `Mail.Read` Библиотеки, которые вы используете в коде, чтобы получить доступ к Microsoft Graph, могут потребовать дополнительные разрешения. Например, библиотека проверки подлинности Microsoft (MSAL) для .NET требует разрешения `offline_access`. Дополнительные сведения см. в статье [Авторизация в Microsoft Graph для надстройки Office](authorize-to-microsoft-graph.md).

## <a name="add-the-jwt-decode-package"></a>Добавление пакета jwt-decode

Вы можете вызвать `getAccessToken` API, чтобы получить маркер идентификатора из Office. Сначала можно добавить пакет jwt-decode, чтобы упростить декодирование и просмотр маркера идентификатора.

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. Откройте решение Visual Studio.
1. В меню выберите "Сервис" **> диспетчера пакетов NuGet > консоли диспетчера пакетов**.
1. Введите следующую команду в **консоли диспетчера пакетов**.

   `Install-Package jwt-decode -Projectname sso-display-user-infoWeb`

# <a name="yo-office"></a>[yo office](#tab/yooffice)

1. В окне терминала или консоли перейдите в корневую папку проекта надстройки.
1. Введите следующую команду:

   `npm install jwt-decode`

---

## <a name="add-ui-to-the-task-pane"></a>Добавление пользовательского интерфейса в область задач

Нам нужно изменить область задач, чтобы она отображала сведения о пользователе, которые мы будем получать из маркера идентификатора.

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. Откройте Home.html файла.
1. Добавьте следующий тег скрипта в `<head>` раздел страницы. Это будет пакет jwt-decode, добавленный ранее.

   ```html
   <script src="Scripts/jwt-decode-2.2.0.js" type="text/javascript"></script>
   ```

1. Замените `<body>` раздел следующим КОДОМ HTML.

   ```html
   <body>
     <h1>Welcome</h1>
     <p>
       Sign in to Office, then choose the <b>Get ID Token</b> button to see your
       ID token information.
     </p>
     <button id="getIDToken">Get ID Token</button>
     <div>
       <span id="userInfo"></span>
     </div>
   </body>
   ```

# <a name="yo-office"></a>[yo office](#tab/yooffice)

1. Откройте **файл src/taskpane/taskpane.html** .
1. Замените `<body>` раздел следующим КОДОМ HTML.

   ```html
   <body>
     <h1>Welcome</h1>
     <p>
       Sign in to Office, then choose the <b>Get ID Token</b> button to see your
       ID token information.
     </p>
     <button id="getIDToken">Get ID Token</button>
     <div>
       <span id="userInfo"></span>
     </div>
   </body>
   ```

---

## <a name="call-the-getaccesstoken-api"></a>Вызов API getAccessToken

Последним шагом является получение маркера идентификатора путем вызова `getAccessToken`.

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. Откройте **Home.jsфайла** .
1. Замените все содержимое файла указанным ниже кодом.

   ```javascript
   (function () {
     "use strict";

     // The initialize function must be run each time a new page is loaded.
     Office.initialize = function (reason) {
       $(document).ready(function () {
         $("#getIDToken").click(getIDToken);
       });
     };

     async function getIDToken() {
       try {
         let userTokenEncoded = await OfficeRuntime.auth.getAccessToken({
           allowSignInPrompt: true,
         });
         let userToken = jwt_decode(userTokenEncoded);
         document.getElementById("userInfo").innerHTML =
           "name: " +
           userToken.name +
           "<br>email: " +
           userToken.preferred_username +
           "<br>id: " +
           userToken.oid;
         console.log(userToken);
       } catch (error) {
         document.getElementById("userInfo").innerHTML =
           "An error occurred. <br>Name: " +
           error.name +
           "<br>Code: " +
           error.code +
           "<br>Message: " +
           error.message;
         console.log(error);
       }
     }
   })();
   ```

1. Сохраните файл.

# <a name="yo-office"></a>[yo office](#tab/yooffice)

1. Откройте **файл src/taskpane/taskpane.js** .
1. Замените все содержимое файла указанным ниже кодом.

   ```javascript
   import jwt_decode from "jwt-decode";

   Office.onReady((info) => {
     if (info.host === Office.HostType.Excel) {
       document.getElementById("getIDToken").onclick = getIDToken;
     }
   });

   async function getIDToken() {
     try {
       let userTokenEncoded = await OfficeRuntime.auth.getAccessToken({
         allowSignInPrompt: true,
       });
       let userToken = jwt_decode(userTokenEncoded);
       document.getElementById("userInfo").innerHTML =
         "name: " +
         userToken.name +
         "<br>email: " +
         userToken.preferred_username +
         "<br>id: " +
         userToken.oid;
       console.log(userToken);
     } catch (error) {
       document.getElementById("userInfo").innerHTML =
         "An error occurred. <br>Name: " +
         error.name +
         "<br>Code: " +
         error.code +
         "<br>Message: " +
         error.message;
       console.log(error);
     }
   }
   ```

1. Сохраните файл.

---

## <a name="run-the-add-in"></a>Запуск надстройки

# <a name="visual-studio-2019"></a>[Visual Studio 2019](#tab/vs2019)

1. Выберите **"Отладка> начать отладку**, или нажмите **клавишу F5**.

# <a name="yo-office"></a>[yo office](#tab/yooffice)

Выполните `npm start` команду из командной строки.

---

1. При запуске Excel войдите в Office с помощью той же учетной записи клиента, которая использовалась для создания регистрации приложения.
1. На **ленте "** Главная" выберите **"Показать область задач** ", чтобы открыть надстройку.
1. В области задач надстройки выберите "Получить **маркер идентификатора"**.

Надстройка отобразит имя, адрес электронной почты и идентификатор учетной записи, с помощью которую вы вошли.

> [!NOTE]
> При возникновении ошибок просмотрите шаги регистрации, описанные в этой статье, для регистрации приложения. Отсутствие подробных данных при настройке регистрации приложения является распространенной причиной проблем с единым входом. Если вы по-прежнему не можете успешно запустить надстройку, см. раздел "Устранение неполадок с сообщениями об ошибках при едином входе [(SSO)"](troubleshoot-sso-in-office-add-ins.md).

## <a name="see-also"></a>См. также

[Использование утверждений для надежной идентификации пользователя (субъект и идентификатор объекта)](/azure/active-directory/develop/id-tokens#using-claims-to-reliably-identify-a-user-subject-and-object-id)

