---
title: Устранение ошибок единого входа
description: ''
ms.date: 12/08/2017
ms.openlocfilehash: 8906a168db7be938ecc572ad41a9feec2500c189
ms.sourcegitcommit: 4de2a1b62ccaa8e51982e95537fc9f52c0c5e687
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2018
ms.locfileid: "22925502"
---
# <a name="troubleshoot-error-messages-for-single-sign-on-sso-preview"></a><span data-ttu-id="8c2a3-102">Устранение ошибок единого входа (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="8c2a3-102">Troubleshoot error messages for single sign-on (SSO) (preview)</span></span>

<span data-ttu-id="8c2a3-103">В этой статье представлено руководство по обеспечению надежной обработки специальных условий и ошибок в надстройках Office, поддерживающих единый вход, а также устранению связанных с единым входом проблем в таких надстройках.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-103">This article provides some guidance about how to troubleshoot problems with single sign-on (SSO) in Office Add-ins, and how to make your SSO-enabled add-in robustly handle special conditions or errors.</span></span>

## <a name="debugging-tools"></a><span data-ttu-id="8c2a3-104">Средства отладки</span><span class="sxs-lookup"><span data-stu-id="8c2a3-104">Debugging tools</span></span>

<span data-ttu-id="8c2a3-p101">Настоятельно рекомендуем использовать во время разработки средство, которое может перехватывать и отображать HTTP-запросы от веб-службы надстройки и отклики для нее. Из них наиболее популярны следующие средства:</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p101">We strongly recommend that you use a tool that can intercept and display the HTTP Requests from, and Responses to, your add-in's web service when you are developing. Two of the most popular are:</span></span> 

- <span data-ttu-id="8c2a3-107">[Fiddler](http://www.telerik.com/fiddler), предоставляемое бесплатно ([документация](http://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler));</span><span class="sxs-lookup"><span data-stu-id="8c2a3-107">[Fiddler](http://www.telerik.com/fiddler): Free ([Documentation](http://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler))</span></span>
- <span data-ttu-id="8c2a3-p102">[Charles](https://www.charlesproxy.com/), предоставляемое бесплатно в течение 30 дней ([документация](https://www.charlesproxy.com/documentation/)).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p102">[Charles](https://www.charlesproxy.com/): Free for 30 days. ([Documenation](https://www.charlesproxy.com/documentation/))</span></span>

<span data-ttu-id="8c2a3-110">При разработке API службы вы также можете попробовать следующее:</span><span class="sxs-lookup"><span data-stu-id="8c2a3-110">When developing your service API, you may also want to try:</span></span>

- <span data-ttu-id="8c2a3-111">[Postman](http://www.getpostman.com/postman), бесплатное средство ([документация](https://www.getpostman.com/docs/)).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-111">[Postman](http://www.getpostman.com/postman): Free ([Documentation](https://www.getpostman.com/docs/))</span></span>

## <a name="causes-and-handling-of-errors-from-getaccesstokenasync"></a><span data-ttu-id="8c2a3-112">Причины и обработка ошибок в методе getAccessTokenAsync</span><span class="sxs-lookup"><span data-stu-id="8c2a3-112">Causes and handling of errors from getAccessTokenAsync</span></span>

<span data-ttu-id="8c2a3-113">Примеры обработки ошибок, рассматриваемых в этом разделе:</span><span class="sxs-lookup"><span data-stu-id="8c2a3-113">For examples of the error handling described in this section, see:</span></span>
- [<span data-ttu-id="8c2a3-114">Home.js в Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="8c2a3-114">Home.js in Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/Home.js)
- [<span data-ttu-id="8c2a3-115">program.js в Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="8c2a3-115">program.js in Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/public/program.js)

> [!NOTE]
> <span data-ttu-id="8c2a3-116">Помимо предложений, сделанных в этом разделе, надстройка Outlook имеет дополнительный способ ответить на любую из 13*ошибок nnn*.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-116">Besides the suggestions made in this section, an Outlook add-in has an additional way to respond to any 13*nnn* error.</span></span> <span data-ttu-id="8c2a3-117">Подробнее см. в статьях [Сценарий: внедрение единого входа в службу надстройки Outlook](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in) и [Пример надстройки AttachmentsDemo](https://github.com/OfficeDev/outlook-add-in-attachments-demo).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-117">For more details, see [Scenario: Implement single sign-on to your service in an Outlook Add-in](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in).</span></span> 

### <a name="13000"></a><span data-ttu-id="8c2a3-118">13 000</span><span class="sxs-lookup"><span data-stu-id="8c2a3-118">13000</span></span>

<span data-ttu-id="8c2a3-119">Надстройка или версия Office не поддерживает API [getAccessTokenAsync](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-119">The [getAccessTokenAsync](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync) API is not supported by the add-in or the Office version.</span></span> 

- <span data-ttu-id="8c2a3-p104">Эта версия Office не поддерживает единый вход. Необходимо установить Office 2016 версии 1710 (сборка 8629.nnnn) или выше (эту версию подписки на Office 365 иногда называют "нажми и работай"). Чтобы скачать эту версию, вам может потребоваться принять участие в программе предварительной оценки Office. Дополнительные сведения см. в статье [Примите участие в программе предварительной оценки Office](https://products.office.com/office-insider?tab=tab-1).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p104">The version of Office does not support SSO. The required version is Office 2016, Version 1710, build 8629.nnnn or later (the Office 365 subscription version, sometimes called “Click to Run”). You might need to be an Office Insider to get this version. For more information, see [Be an Office Insider](https://products.office.com/office-insider?tab=tab-1).</span></span> 
- <span data-ttu-id="8c2a3-124">В манифесте надстройки отсутствует подходящий раздел [WebApplicationInfo](https://dev.office.com/reference/add-ins/manifest/webapplicationinfo).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-124">The add-in manifest is missing the proper [WebApplicationInfo](https://dev.office.com/reference/add-ins/manifest/webapplicationinfo) section.</span></span>

### <a name="13001"></a><span data-ttu-id="8c2a3-125">13001</span><span class="sxs-lookup"><span data-stu-id="8c2a3-125">13001</span></span>

<span data-ttu-id="8c2a3-126">Пользователь не вошел в Office.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-126">The user is not signed into Office.</span></span> <span data-ttu-id="8c2a3-127">Код должен повторно вызвать метод `getAccessTokenAsync` и передать значение `forceAddAccount: true` параметру [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-127">Your code should recall the `getAccessTokenAsync` method and pass the option `forceAddAccount: true` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="8c2a3-128">Но не делайте этого более одного раза.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-128">But don't do this more than once.</span></span> <span data-ttu-id="8c2a3-129">Пользователь, возможно, решил не входить в систему.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-129">The user may have decided not to sign-in.</span></span>

<span data-ttu-id="8c2a3-130">Эта ошибка никогда не возникает в Office Online.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-130">This error is never seen in Office Online.</span></span> <span data-ttu-id="8c2a3-131">Если срок действия cookie-файла пользователя истек, Office Online возвращает ошибку 13006.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-131">If the user's cookie expires, Office Online returns error 13006.</span></span> 

### <a name="13002"></a><span data-ttu-id="8c2a3-132">13002</span><span class="sxs-lookup"><span data-stu-id="8c2a3-132">13002</span></span>

<span data-ttu-id="8c2a3-133">Пользователь прервал вход или согласие; например, путем выбора **Отмена** в диалоговом окне согласия.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-133">The user aborted sign in or consent; for example, by choosing **Cancel** on the consent dialog.</span></span> 
- <span data-ttu-id="8c2a3-134">Если ваша надстройка предоставляет функции, не требующие входа пользователя (или предоставления согласия), то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-134">If your add-in provides functions that don't require the user to be signed in (or to have granted consent), then your code should catch this error and allow the add-in to stay running.</span></span>
- <span data-ttu-id="8c2a3-135">Если надстройке необходимо, чтобы пользователь выполнил вход и дал согласие, то код должен предлагать пользователю повторить операцию, но не более одного раза.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-135">If the add-in requires a signed-in user who has granted consent, your code should ask the user to repeat the operation, but not more than once.</span></span> 

### <a name="13003"></a><span data-ttu-id="8c2a3-136">13003</span><span class="sxs-lookup"><span data-stu-id="8c2a3-136">13003</span></span>

<span data-ttu-id="8c2a3-137">Тип пользователя не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-137">User Type not supported.</span></span> <span data-ttu-id="8c2a3-138">Пользователь не вошел в Office с помощью действительной учетной записи Майкрософт либо рабочей или учебной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-138">The user isn't signed into Office with a valid Microsoft Account or Work or School account.</span></span> <span data-ttu-id="8c2a3-139">Например, это может произойти, если Office работает с учетной записью локального домена.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-139">This may happen if Office runs with an on-premises domain account, for example.</span></span> <span data-ttu-id="8c2a3-140">Код должен предлагать пользователю войти в Office.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-140">Your code should ask the user to sign in to Office.</span></span>

### <a name="13004"></a><span data-ttu-id="8c2a3-141">13004</span><span class="sxs-lookup"><span data-stu-id="8c2a3-141">13004</span></span>

<span data-ttu-id="8c2a3-142">Недопустимый ресурс.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-142">Invalid Resource.</span></span> <span data-ttu-id="8c2a3-143">Манифест надстройки неправильно настроен.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-143">The add-in manifest hasn’t been configured correctly.</span></span> <span data-ttu-id="8c2a3-144">Обновите манифест.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-144">Update the manifest.</span></span> <span data-ttu-id="8c2a3-145">Дополнительные сведения см. в статье [Проверка манифеста и устранение связанных с ним неполадок](../testing/troubleshoot-manifest.md).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-145">For more information, see [Validate and troubleshoot issues with your manifest](../testing/troubleshoot-manifest.md).</span></span> <span data-ttu-id="8c2a3-146">Самая большая проблема заключается в том, что элемент **Ресурс**(в элементе **WebApplicationInfo** ) имеет домен, который не соответствует домену надстройки.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-146">The most commmon problem is that the **Resource** element (in the **WebApplicationInfo** element) has a domain that does not match the domain of the add-in.</span></span> <span data-ttu-id="8c2a3-147">Хотя часть протокола значения ресурса должна быть «api», а не «https»; все остальные части имени домена (включая порт, если они есть) должны быть такими же, как для надстройки.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-147">Although the protocol part of the Resource value should be "api" not "https"; all other parts of the domain name (including port, if any) should be the same as for the add-in.</span></span>

### <a name="13005"></a><span data-ttu-id="8c2a3-148">13005</span><span class="sxs-lookup"><span data-stu-id="8c2a3-148">13005</span></span>

<span data-ttu-id="8c2a3-149">Недопустимое разрешение.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-149">Invalid Grant.</span></span> <span data-ttu-id="8c2a3-150">Как правило, это означает, что приложение Office не получило предварительные разрешения для веб-службы надстройки.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-150">This usually means that Office has not been pre-authorized to the add-in's web service.</span></span> <span data-ttu-id="8c2a3-151">Дополнительные сведения см. в разделе [Создание приложения службы](sso-in-office-add-ins.md#create-the-service-application) и статье [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) или [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-151">For more information, see [Create the service application](sso-in-office-add-ins.md#create-the-service-application) and [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS).</span></span> <span data-ttu-id="8c2a3-152">Это также может произойти, если пользователь не предоставил приложению службы разрешения на доступ к своему ресурсу `profile`.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-152">This also may happen if the user has not granted your service application permissions to his or her `profile`.</span></span>

### <a name="13006"></a><span data-ttu-id="8c2a3-153">13006</span><span class="sxs-lookup"><span data-stu-id="8c2a3-153">13006</span></span>

<span data-ttu-id="8c2a3-p110">Ошибка клиента. Код должен предлагать пользователю выйти и перезапустить Office либо перезапустить сеанс Office Online.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p110">Client Error. Your code should suggest that the user sign out and restart Office, or restart the Office Online session.</span></span>

### <a name="13007"></a><span data-ttu-id="8c2a3-156">13007</span><span class="sxs-lookup"><span data-stu-id="8c2a3-156">13007</span></span>

<span data-ttu-id="8c2a3-157">Ведущему приложению Office не удалось получить маркер доступа к веб-службе надстройки.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-157">The Office host was unable to get an access token to the add-in's web service.</span></span>
- <span data-ttu-id="8c2a3-158">Если эта ошибка возникает во время разработки, убедитесь, что в ваших регистрации надстройки и манифесте надстройки `openid` указаны `profile` разрешения.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-158">If this error occurs during development, be sure that your add-in registration and add-in manifest specify the `openid` and `profile` permissions.</span></span> <span data-ttu-id="8c2a3-159">Дополнительные сведения см. в статьях [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) или [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS) и [Конфигурация надстройки](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) или [Конфигурация надстройки](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-159">For more information, see [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS), and [Configure the add-in](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) or [Configure the add-in](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span></span>
- <span data-ttu-id="8c2a3-160">В производстве есть несколько вещей, которые могут вызвать эту ошибку.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-160">In production, there are several things that can cause this error.</span></span> <span data-ttu-id="8c2a3-161">Вот некоторые из них:</span><span class="sxs-lookup"><span data-stu-id="8c2a3-161">Some of them are:</span></span>
    - <span data-ttu-id="8c2a3-162">Пользователь аннулировал согласие, предварительно предоставив его.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-162">The user has revoked consent, after previously granting it.</span></span> <span data-ttu-id="8c2a3-163">Ваш код должен вызывать `getAccessTokenAsync` метод с опцией `forceConsent: true`, но не более одного раза.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-163">Your code should recall the `getAccessTokenAsync` method with the option `forceConsent: true`, but no more than once.</span></span>
    - <span data-ttu-id="8c2a3-164">У пользователя есть идентификатор учетной записи Microsoft (MSA).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-164">The user is has an Microsoft Account (MSA) identity.</span></span> <span data-ttu-id="8c2a3-165">В некоторых ситуациях, вызвавших одну из ошибок 13nnn с учетной записью Work или School, вы получите 13007 при использовании MSA.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-165">Some situations that would cause one of the other 13nnn errors with a Work or School account, will cause a 13007 when a MSA is used.</span></span> 

  <span data-ttu-id="8c2a3-166">Для всех этих случаев, если вы уже пробовали опцию `forceConsent` один раз, то ваш код может предположить, что пользователь повторит операцию позже.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-166">For all of these cases, if you have already tried the `forceConsent` option once, then your code could suggest that the user retry the operation later.</span></span>

### <a name="13008"></a><span data-ttu-id="8c2a3-167">13008</span><span class="sxs-lookup"><span data-stu-id="8c2a3-167">13008</span></span>

<span data-ttu-id="8c2a3-168">Пользователь запустил операцию, которая вызывает метод `getAccessTokenAsync`, до завершения предыдущего вызова метода `getAccessTokenAsync`.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-168">The user triggered an operation that calls `getAccessTokenAsync` before a previous call of `getAccessTokenAsync` completed.</span></span> <span data-ttu-id="8c2a3-169">Код должен предлагать пользователю повторить операцию после завершения предыдущей операции.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-169">Your code should ask the user to repeat the operation after the previous operation has completed.</span></span>

### <a name="13009"></a><span data-ttu-id="8c2a3-170">13009</span><span class="sxs-lookup"><span data-stu-id="8c2a3-170">13009</span></span>

<span data-ttu-id="8c2a3-171">Надстройка вызвала метод `getAccessTokenAsync` с параметром `forceConsent: true`, но ее манифест развернут в каталоге, не поддерживающем принудительное согласие.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-171">The add-in called the `getAccessTokenAsync` method with the option `forceConsent: true`, but the add-in's manifest is deployed to a type of catalog that does not support forcing consent.</span></span> <span data-ttu-id="8c2a3-172">Код должен повторно вызвать метод `getAccessTokenAsync` и передать значение `forceConsent: false` в параметре [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-172">Your code should recall the `getAccessTokenAsync` method and pass the option `forceConsent: false` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="8c2a3-173">Однако вызов метода `getAccessTokenAsync` с параметром `forceConsent: true` мог сам по себе быть автоматической реакцией на неудачный вызов метода `getAccessTokenAsync` с параметром `forceConsent: false`, поэтому в коде следует отслеживать, был ли уже вызван метод `getAccessTokenAsync` с параметром `forceConsent: false`.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-173">However, the call of  `getAccessTokenAsync`  with `forceConsent: true` might itself have been an automatic response to a failed call of `getAccessTokenAsync` with `forceConsent: false`, so your code should keep track of whether `getAccessTokenAsync` with `forceConsent: false` has already been called.</span></span> <span data-ttu-id="8c2a3-174">Если это так, код должен сообщать пользователю, что следует выйти из Office и повторить вход.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-174">If it has, your code should tell the user to sign out of Office and sign-in again.</span></span>

> [!NOTE]
> <span data-ttu-id="8c2a3-175">Корпорация Майкрософт не обязательно применяет это ограничение к каким-либо типам каталогов надстроек.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-175">Microsoft will not necessarilly impose this restriction on any types of add-in catalogs.</span></span> <span data-ttu-id="8c2a3-176">Если ограничение отсутствует, то такая ошибка никогда не возникнет.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-176">If it doesn't, then this error will never be seen.</span></span>

### <a name="13010"></a><span data-ttu-id="8c2a3-177">13010</span><span class="sxs-lookup"><span data-stu-id="8c2a3-177">13010</span></span>

<span data-ttu-id="8c2a3-178">Пользователь запустил надстройку в Office Online и использует Edge или Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-178">The user is running the add-in on Office Online and is using Edge or Internet Explorer.</span></span> <span data-ttu-id="8c2a3-179">Домен Office 365 пользователя и домен login.microsoftonline.com находятся в разных зонах безопасности в настройках браузера.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-179">The user’s Office 365 domain, and the login.microsoftonline.com domain, are in a different security zones in the browser settings.</span></span> <span data-ttu-id="8c2a3-180">Если возвращается эта ошибка, то пользователь уже видел сообщение с соответствующим пояснением и ссылкой на инструкции по изменению конфигурации зон.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-180">If this error is returned, the user will have already seen an error explaining this and linking to a page about how to change the zone configuration.</span></span> <span data-ttu-id="8c2a3-181">Если ваша надстройка предоставляет функции, не требующие входа пользователя, то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-181">If your add-in provides functions that don't require the user to be signed in, then your code should catch this error and allow the add-in to stay running.</span></span>

### <a name="50001"></a><span data-ttu-id="8c2a3-182">50001</span><span class="sxs-lookup"><span data-stu-id="8c2a3-182">50001</span></span>

<span data-ttu-id="8c2a3-183">Эта ошибка (которая не является специфической для `getAccessTokenAsync`) может указывать на то, что браузер обналичил старую копию файлов office.js.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-183">This error (which is not specific to `getAccessTokenAsync`) may indicate that the browser has cashed an old copy of the office.js files.</span></span> <span data-ttu-id="8c2a3-184">Очистите кэш браузера.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-184">Clear the Office cache</span></span> <span data-ttu-id="8c2a3-185">Другая возможность заключается в том, что версия Office недостаточно последняя для поддержки единого входа.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-185">Another possibility is that the version of Office is not recent enough to support SSO.</span></span> <span data-ttu-id="8c2a3-186">См.статью [Компоненты](create-sso-office-add-ins-aspnet.md#prerequisites).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-186">See [Prerequisites](create-sso-office-add-ins-aspnet.md#prerequisites).</span></span>

## <a name="errors-on-the-server-side-from-azure-active-directory"></a><span data-ttu-id="8c2a3-187">Ошибки на стороне сервера из Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="8c2a3-187">Errors on the server-side from Azure Active Directory</span></span>

<span data-ttu-id="8c2a3-188">Примеры обработки ошибок, рассматриваемых в этом разделе:</span><span class="sxs-lookup"><span data-stu-id="8c2a3-188">For samples of the error-handling described in this section, see:</span></span>
- [<span data-ttu-id="8c2a3-189">Надстройка Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="8c2a3-189">Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)
- [<span data-ttu-id="8c2a3-190">Надстройка Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="8c2a3-190">Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)


### <a name="conditional-access--multifactor-authentication-errors"></a><span data-ttu-id="8c2a3-191">Ошибки условного доступа и многофакторной проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="8c2a3-191">Conditional access / Multifactor authentication errors</span></span>
 
<span data-ttu-id="8c2a3-192">При использовании некоторых конфигураций удостоверений в AAD и Office 365 некоторым ресурсам, доступным через Microsoft Graph, может потребоваться многофакторная проверка подлинности (MFA), даже если она не требуется клиенту Office 365.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-192">In certain configurations of identity in AAD and Office 365, it is possible for some resources that are accessible with Microsoft Graph to require multifactor authentication (MFA), even when the user's Office 365 tenancy does not.</span></span> <span data-ttu-id="8c2a3-193">Когда служба AAD получает запрос на получение токена для доступа к защищенному с помощью MFA ресурсу, через поток выполнения от имени другого субъекта она возвращает веб-службе надстройки сообщение JSON, содержащее свойство `claims`.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-193">When AAD receives a request for a token to the MFA-protected resource, via the on-behalf-of flow, it returns to your add-in's web service a JSON message that contains a `claims` property.</span></span> <span data-ttu-id="8c2a3-194">Свойство claims содержит сведения о том, какие еще факторы проверки подлинности требуются.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-194">The claims property has information about what further authentication factors are needed.</span></span> 

<span data-ttu-id="8c2a3-195">Код на стороне сервера должен проверить это сообщение и ретранслировать значение свойства claims клиентскому коду.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-195">Your server-side code should test for this message and relay the claims value to your client-side code.</span></span> <span data-ttu-id="8c2a3-196">Эти сведения необходимы клиенту, так как Office обрабатывает проверку подлинности для надстроек с единым входом. Сообщение для клиента может быть кодом ошибки (например, `500 Server Error` или `401 Unauthorized`) либо находиться в тексте отклика об успешном выполнении (например, `200 OK`).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-196">You need this information in the client because Office handles authentication for SSO add-ins. The message to the client can be either an error (such as `500 Server Error` or `401 Unauthorized`) or in the body of a success response (such as `200 OK`).</span></span> <span data-ttu-id="8c2a3-197">В обоих случаях функция обратного вызова для клиентского AJAX-вызова веб-API надстройки должна проверять этот отклик.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-197">In either case, the (failure or success) callback of your code's client-side AJAX call to your add-in's web API should test for this response.</span></span> <span data-ttu-id="8c2a3-198">Если значение свойства claims было ретранслировано, то код должен повторно вызвать метод `getAccessTokenAsync` и передать значение `authChallenge: CLAIMS-STRING-HERE` в параметре [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-198">If the claims value has been relayed, your code should recall `getAccessTokenAsync` and pass the option `authChallenge: CLAIMS-STRING-HERE` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="8c2a3-199">Когда служба AAD обнаруживает эту строку, она предлагает пользователю указать дополнительные факторы, а затем возвращает новый маркер доступа, который будет принят в потоке выполнения от имени другого субъекта.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-199">When AAD sees this string, it prompts the user for the additional factor(s) and then returns a new access token which will be accepted in the on-behalf-of flow.</span></span>

### <a name="consent-missing-errors"></a><span data-ttu-id="8c2a3-200">Ошибки, вызванные отсутствием согласия</span><span class="sxs-lookup"><span data-stu-id="8c2a3-200">Consent missing errors</span></span>

<span data-ttu-id="8c2a3-201">Если в службе AAD нет записи о том, что пользователь или администратор клиента согласился предоставить надстройке доступ к ресурсу Microsoft Graph, то AAD отправит вашей веб-службе сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-201">If AAD has no record that consent (to the Microsoft Graph resource) was granted to the add-in by the user (or tenant administrator), AAD will send an error message to your web service.</span></span> <span data-ttu-id="8c2a3-202">Код должен сообщить клиенту (например, в тексте отклика `403 Forbidden`), что нужно заново вызвать метод `getAccessTokenAsync` с параметром `forceConsent: true`.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-202">Your code must tell the client (in the body of a `403 Forbidden` response, for example) to recall `getAccessTokenAsync` with the `forceConsent: true` option.</span></span>

### <a name="invalid-or-missing-scope-permission-errors"></a><span data-ttu-id="8c2a3-203">Ошибки, вызванные недействительными или отсутствующими областями (разрешениями)</span><span class="sxs-lookup"><span data-stu-id="8c2a3-203">Invalid or missing scope (permission) errors</span></span>

- <span data-ttu-id="8c2a3-p123">Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, а тот должен показать пользователю понятное сообщение. При возможности также следует записать ошибку в консоли или журнале.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p123">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user. If possible, log the error to the console or record it in a log.</span></span>
- <span data-ttu-id="8c2a3-206">Убедитесь, что в разделе [Scopes](https://dev.office.com/reference/add-ins/manifest/scopes) манифеста надстройки указаны все необходимые разрешения.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-206">Be sure your add-in manifest [Scopes](https://dev.office.com/reference/add-ins/manifest/scopes)  section specifies all needed permissions.</span></span> <span data-ttu-id="8c2a3-207">Кроме того, убедитесь, что в регистрационных данных веб-службы надстройки указаны те же разрешения.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-207">And be sure your registration of the add-in's web service specifies the same permissions.</span></span> <span data-ttu-id="8c2a3-208">Кроме того, проверьте наличие ошибок правописания.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-208">Check for spelling mistakes too.</span></span> <span data-ttu-id="8c2a3-209">Дополнительные сведения см. в статьях [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) или [Регистрация надстройки в конечной точке Azure AD версии 2.0](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS) и [Конфигурация надстройки](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) или [Конфигурация надстройки](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-209">For more information, see [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS), and [Configure the add-in](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) or [Configure the add-in](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span></span>

### <a name="expired-or-invalid-token-errors-when-calling-microsoft-graph"></a><span data-ttu-id="8c2a3-210">Ошибки, вызванные просроченным или недействительным токеном при вызове Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="8c2a3-210">Expired or invalid token errors when calling Microsoft Graph</span></span>

<span data-ttu-id="8c2a3-211">Некоторые библиотеки проверки подлинности и авторизации, включая MSAL, предотвращают ошибки, связанные с просроченными токенами, по мере необходимости используя кэшированный маркер обновления.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-211">Some authentication and authorization libraries, including MSAL, prevent expired token errors by using a cached refresh token whenever necessary.</span></span> <span data-ttu-id="8c2a3-212">Вы также можете написать собственную систему кэширования токенов.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-212">You can also code your own token caching system.</span></span> <span data-ttu-id="8c2a3-213">Пример такой надстройки см. в статье [Единый вход с использованием NodeJS для надстройки Office](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO). Обратите внимание на файл [auth.ts](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/src/auth.ts).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-213">For a sample that does this, see [Office Add-in NodeJS SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO), especially the file [auth.ts](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/src/auth.ts).</span></span>

<span data-ttu-id="8c2a3-214">Но если возникает ошибка, связанная с просроченным или недействительным токеном, код должен сообщить клиенту (например, в тексте отклика `401 Unauthorized`), что нужно повторно вызвать метод `getAccessTokenAsync` и повторить вызов конечной точки веб-API надстройки. При этом будет повторен поток выполнения от имени другого субъекта, чтобы получить новый токен для Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-214">But if you get an expired token or invalid token error, your code must tell the client (in the body of a `401 Unauthorized` response, for example) to recall `getAccessTokenAsync` and repeat the call to the endpoint of your add-in's web API, which will repeat the on-behalf-of flow to obtain a new token for Microsoft Graph.</span></span> 

### <a name="invalid-token-error-when-calling-microsoft-graph"></a><span data-ttu-id="8c2a3-215">Ошибка, вызванная недействительным токеном при вызове Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="8c2a3-215">Invalid token error when calling Microsoft Graph</span></span>

<span data-ttu-id="8c2a3-p126">Эту ошибку необходимо обрабатывать так же, как и ошибку с просроченным токеном. См. предыдущий раздел.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-p126">Handle this error the same as an expired token error. See previous section.</span></span>

### <a name="invalid-audience-error"></a><span data-ttu-id="8c2a3-218">Ошибка, вызванная недействительной аудиторией</span><span class="sxs-lookup"><span data-stu-id="8c2a3-218">Invalid audience error</span></span>

<span data-ttu-id="8c2a3-219">Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, а тот должен показать пользователю понятное сообщение и, возможно, также записать ошибку в консоли или журнале.</span><span class="sxs-lookup"><span data-stu-id="8c2a3-219">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user and possibly also log the error to the console or record it in a log.</span></span>

<span data-ttu-id="8c2a3-220">Дополнительные сведения о добавлении поддержки мультитенантности для проверки токенов см. в [примере мультитенантности в Azure](https://github.com/Azure-Samples/active-directory-dotnet-webapp-webapi-multitenant-openidconnect).</span><span class="sxs-lookup"><span data-stu-id="8c2a3-220">For more on adding multitenant support for token validation, see the [Azure Multitenant Sample](https://github.com/Azure-Samples/active-directory-dotnet-webapp-webapi-multitenant-openidconnect).</span></span>
