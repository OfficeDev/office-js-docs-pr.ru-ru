---
title: Устранение ошибок единого входа
description: ''
ms.date: 02/20/2020
localization_priority: Normal
ms.openlocfilehash: a29efa4a501ee10b185cb2bbc72cb8e8e5e8b098
ms.sourcegitcommit: 7464eac3b54a6a6b65e27549a3ad603af6ee1011
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "42315874"
---
# <a name="troubleshoot-error-messages-for-single-sign-on-sso-preview"></a><span data-ttu-id="66ec6-102">Устранение ошибок единого входа (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="66ec6-102">Troubleshoot error messages for single sign-on (SSO) (preview)</span></span>

<span data-ttu-id="66ec6-103">В этой статье представлено руководство по обеспечению надежной обработки специальных условий и ошибок в надстройках Office, поддерживающих единый вход, а также устранению связанных с единым входом проблем в таких надстройках.</span><span class="sxs-lookup"><span data-stu-id="66ec6-103">This article provides some guidance about how to troubleshoot problems with single sign-on (SSO) in Office Add-ins, and how to make your SSO-enabled add-in robustly handle special conditions or errors.</span></span>

> [!NOTE]
> <span data-ttu-id="66ec6-104">В настоящее время API единого входа поддерживается для Word, Excel, Outlook и PowerPoint в тестовом режиме.</span><span class="sxs-lookup"><span data-stu-id="66ec6-104">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="66ec6-105">Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).</span><span class="sxs-lookup"><span data-stu-id="66ec6-105">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> [!INCLUDE [Information about using preview APIs](../includes/using-excel-preview-apis.md)]
> <span data-ttu-id="66ec6-106">Если вы работаете с надстройкой Outlook, обязательно включите современную проверку подлинности для клиента Office 365.</span><span class="sxs-lookup"><span data-stu-id="66ec6-106">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy.</span></span> <span data-ttu-id="66ec6-107">Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span><span class="sxs-lookup"><span data-stu-id="66ec6-107">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="debugging-tools"></a><span data-ttu-id="66ec6-108">Средства отладки</span><span class="sxs-lookup"><span data-stu-id="66ec6-108">Debugging tools</span></span>

<span data-ttu-id="66ec6-p103">Настоятельно рекомендуем использовать во время разработки средство, которое может перехватывать и отображать HTTP-запросы от веб-службы надстройки и отклики для нее. Из них наиболее популярны следующие средства:</span><span class="sxs-lookup"><span data-stu-id="66ec6-p103">We strongly recommend that you use a tool that can intercept and display the HTTP Requests from, and Responses to, your add-in's web service when you are developing. Two of the most popular are:</span></span>

- <span data-ttu-id="66ec6-111">[Fiddler](https://www.telerik.com/fiddler), предоставляемое бесплатно ([документация](https://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler));</span><span class="sxs-lookup"><span data-stu-id="66ec6-111">[Fiddler](https://www.telerik.com/fiddler): Free ([Documentation](https://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler))</span></span>
- <span data-ttu-id="66ec6-112">[Charles](https://www.charlesproxy.com), предоставляемое бесплатно в течение 30 дней</span><span class="sxs-lookup"><span data-stu-id="66ec6-112">[Charles](https://www.charlesproxy.com): Free for 30 days.</span></span> <span data-ttu-id="66ec6-113">([документация](https://www.charlesproxy.com/documentation/)).</span><span class="sxs-lookup"><span data-stu-id="66ec6-113">([Documentation](https://www.charlesproxy.com/documentation/))</span></span>

## <a name="causes-and-handling-of-errors-from-getaccesstoken"></a><span data-ttu-id="66ec6-114">Причины и обработка ошибок в методе getAccessToken</span><span class="sxs-lookup"><span data-stu-id="66ec6-114">Causes and handling of errors from getAccessToken</span></span>

<span data-ttu-id="66ec6-115">Примеры обработки ошибок, рассматриваемых в этом разделе:</span><span class="sxs-lookup"><span data-stu-id="66ec6-115">For examples of the error handling described in this section, see:</span></span>
- [<span data-ttu-id="66ec6-116">HomeES6.js in Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="66ec6-116">HomeES6.js in Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/src/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js)
- [<span data-ttu-id="66ec6-117">ssoAuthES6.js in Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="66ec6-117">ssoAuthES6.js in Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/src/public/javascripts/ssoAuthES6.js)

### <a name="13000"></a><span data-ttu-id="66ec6-118">13000</span><span class="sxs-lookup"><span data-stu-id="66ec6-118">13000</span></span>

<span data-ttu-id="66ec6-119">Надстройка или версия Office не поддерживает API [getAccessToken](/office/dev/add-ins/develop/sso-in-office-add-ins#sso-api-reference).</span><span class="sxs-lookup"><span data-stu-id="66ec6-119">The [getAccessToken](/office/dev/add-ins/develop/sso-in-office-add-ins#sso-api-reference) API is not supported by the add-in or the Office version.</span></span>

- <span data-ttu-id="66ec6-120">Эта версия Office не поддерживает единый вход.</span><span class="sxs-lookup"><span data-stu-id="66ec6-120">The version of Office does not support SSO.</span></span> <span data-ttu-id="66ec6-121">Требуемая версия — Office 365 (версия Office, распространяемая по подписке), в любом ежемесячном канале.</span><span class="sxs-lookup"><span data-stu-id="66ec6-121">The required version is Office 365 (the subscription version of Office), in any monthly channel.</span></span> 
- <span data-ttu-id="66ec6-122">В манифесте надстройки отсутствует подходящий раздел [WebApplicationInfo](/office/dev/add-ins/reference/manifest/webapplicationinfo).</span><span class="sxs-lookup"><span data-stu-id="66ec6-122">The add-in manifest is missing the proper [WebApplicationInfo](/office/dev/add-ins/reference/manifest/webapplicationinfo) section.</span></span>

<span data-ttu-id="66ec6-123">Ваша надстройка должна отреагировать на эту ошибку, переключившись на альтернативную систему проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-123">Your add-in should respond to this error by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="66ec6-124">Дополнительные сведения см. в разделе [Требования и рекомендации](/office/dev/add-ins/develop/sso-in-office-add-ins#requirements-and-best-practices).</span><span class="sxs-lookup"><span data-stu-id="66ec6-124">For more information, see [Requirements and Best Practices](/office/dev/add-ins/develop/sso-in-office-add-ins#requirements-and-best-practices).</span></span>

### <a name="13001"></a><span data-ttu-id="66ec6-125">13001</span><span class="sxs-lookup"><span data-stu-id="66ec6-125">13001</span></span>

<span data-ttu-id="66ec6-126">Пользователь не вошел в Office.</span><span class="sxs-lookup"><span data-stu-id="66ec6-126">The user is not signed into Office.</span></span> <span data-ttu-id="66ec6-127">В большинстве сценариев эту ошибку следует предотвращать, не допуская ее повторения, путем передачи элемента `allowSignInPrompt: true` в параметре `AuthOptions`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-127">In most scenarios, you should prevent this error from ever being seen by passing the option `allowSignInPrompt: true` in the `AuthOptions` parameter.</span></span>

<span data-ttu-id="66ec6-128">Но могут быть исключения.</span><span class="sxs-lookup"><span data-stu-id="66ec6-128">But there may be exceptions.</span></span> <span data-ttu-id="66ec6-129">Например, вы хотите, чтобы надстройка открывалась с функциями, для которых требуется вход пользователя в систему, но *только в том случае, если* пользователь *уже* вошел в Office.</span><span class="sxs-lookup"><span data-stu-id="66ec6-129">For example, you want the add-in to open with features that require a logged in user; but *only if* the user is *already* logged into Office.</span></span> <span data-ttu-id="66ec6-130">В противном случае надстройку следует открыть с помощью альтернативного набора функций, которые не требуют входа пользователя в систему.</span><span class="sxs-lookup"><span data-stu-id="66ec6-130">If the user is not, you want the add-in to open with an alternate set of features that do not require that the user is signed in.</span></span> <span data-ttu-id="66ec6-131">В этом случае логика выполняется при запуске надстройкой вызовов `getAccessToken` без `allowSignInPrompt: true`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-131">In this case, logic which runs when the add-in launches calls `getAccessToken` without `allowSignInPrompt: true`.</span></span> <span data-ttu-id="66ec6-132">Используйте ошибку 13001 в качестве пометки, чтобы указать надстройке представить альтернативный набор функций.</span><span class="sxs-lookup"><span data-stu-id="66ec6-132">Use the 13001 error as the flag to tell the add-in to present the alternate set of features.</span></span>

<span data-ttu-id="66ec6-133">Другая возможность — реагирование на ошибку 13001, с переключением на альтернативную систему проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-133">Another option is to respond to 13001 by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="66ec6-134">Это обеспечит вход пользователя в AAD, но не вход пользователя в Office.</span><span class="sxs-lookup"><span data-stu-id="66ec6-134">This will sign the user into AAD, but not sign the user into Office.</span></span>

<span data-ttu-id="66ec6-135">Эта ошибка никогда не возникает в **Office в Интернете**.</span><span class="sxs-lookup"><span data-stu-id="66ec6-135">This error is never seen in **Office on the web**.</span></span> <span data-ttu-id="66ec6-136">Если срок действия cookie-файла пользователя истек, **Office в Интернете** возвращает ошибку 13006.</span><span class="sxs-lookup"><span data-stu-id="66ec6-136">If the user's cookie expires, **Office on the web** returns error 13006.</span></span>

### <a name="13002"></a><span data-ttu-id="66ec6-137">13002</span><span class="sxs-lookup"><span data-stu-id="66ec6-137">13002</span></span>

<span data-ttu-id="66ec6-138">Пользователь прервал вход или отменил свое согласие (например, выбрав **Отмена** в диалоговом окне согласия).</span><span class="sxs-lookup"><span data-stu-id="66ec6-138">The user aborted sign in or consent; for example, by choosing **Cancel** on the consent dialog.</span></span>

- <span data-ttu-id="66ec6-139">Если ваша надстройка предоставляет функции, не требующие входа пользователя (или предоставления согласия), то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="66ec6-139">If your add-in provides functions that don't require the user to be signed in (or to have granted consent), then your code should catch this error and allow the add-in to stay running.</span></span>
- <span data-ttu-id="66ec6-140">Если для надстройки требуется пользователь, который вошел в систему и получил согласие, в вашем коде должна появиться кнопка входа в систему.</span><span class="sxs-lookup"><span data-stu-id="66ec6-140">If the add-in requires a signed-in user who has granted consent, your code should have a sign-in button appear.</span></span>

### <a name="13003"></a><span data-ttu-id="66ec6-141">13003</span><span class="sxs-lookup"><span data-stu-id="66ec6-141">13003</span></span>

<span data-ttu-id="66ec6-142">Тип пользователя не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="66ec6-142">User Type not supported.</span></span> <span data-ttu-id="66ec6-143">Пользователь не вошел в Office с помощью действительной учетной записи Майкрософт или Office 365 (рабочей или учебной учетной записи).</span><span class="sxs-lookup"><span data-stu-id="66ec6-143">The user isn't signed into Office with a valid Microsoft Account or Office 365 ("Work or School") account.</span></span> <span data-ttu-id="66ec6-144">Например, это может произойти, если Office работает с учетной записью локального домена.</span><span class="sxs-lookup"><span data-stu-id="66ec6-144">This may happen if Office runs with an on-premises domain account, for example.</span></span> <span data-ttu-id="66ec6-145">Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-145">Your code should fall back to an alternate system of user authentication.</span></span> <span data-ttu-id="66ec6-146">Дополнительные сведения см. в разделе [Требования и рекомендации](/office/dev/add-ins/develop/sso-in-office-add-ins##requirements-and-best-practices).</span><span class="sxs-lookup"><span data-stu-id="66ec6-146">For more information, see [Requirements and Best Practices](/office/dev/add-ins/develop/sso-in-office-add-ins##requirements-and-best-practices).</span></span>

### <a name="13004"></a><span data-ttu-id="66ec6-147">13004</span><span class="sxs-lookup"><span data-stu-id="66ec6-147">13004</span></span>

<span data-ttu-id="66ec6-148">Недопустимый ресурс.</span><span class="sxs-lookup"><span data-stu-id="66ec6-148">Invalid Resource.</span></span> <span data-ttu-id="66ec6-149">(Эта ошибка может наблюдаться только в процессе разработки.) Манифест надстройки не настроен должным образом.</span><span class="sxs-lookup"><span data-stu-id="66ec6-149">(This error should only be seen in development.) The add-in manifest hasn’t been configured correctly.</span></span> <span data-ttu-id="66ec6-150">Обновите манифест.</span><span class="sxs-lookup"><span data-stu-id="66ec6-150">Update the manifest.</span></span> <span data-ttu-id="66ec6-151">Дополнительные сведения см. в статье [Проверка манифеста надстройки Office](../testing/troubleshoot-manifest.md).</span><span class="sxs-lookup"><span data-stu-id="66ec6-151">For more information, see [Validate an Office Add-in's manifest](../testing/troubleshoot-manifest.md).</span></span> <span data-ttu-id="66ec6-152">Самая распространенная проблема заключается в том, что в элементе **Resource** (который входит в элемент **WebApplicationInfo**) указан домен, не соответствующий домену надстройки.</span><span class="sxs-lookup"><span data-stu-id="66ec6-152">The most common problem is that the **Resource** element (in the **WebApplicationInfo** element) has a domain that does not match the domain of the add-in.</span></span> <span data-ttu-id="66ec6-153">Хотя часть протокола значения ресурса должна быть "api", а не "https", все остальные части доменного имени (включая порт, если таковой имеется) должны быть такими же, как и для надстройки.</span><span class="sxs-lookup"><span data-stu-id="66ec6-153">Although the protocol part of the Resource value should be "api" not "https"; all other parts of the domain name (including port, if any) should be the same as for the add-in.</span></span>

### <a name="13005"></a><span data-ttu-id="66ec6-154">13005</span><span class="sxs-lookup"><span data-stu-id="66ec6-154">13005</span></span>

<span data-ttu-id="66ec6-155">Недопустимое разрешение.</span><span class="sxs-lookup"><span data-stu-id="66ec6-155">Invalid Grant.</span></span> <span data-ttu-id="66ec6-156">Как правило, это означает, что приложение Office не получило предварительные разрешения для веб-службы надстройки.</span><span class="sxs-lookup"><span data-stu-id="66ec6-156">This usually means that Office has not been pre-authorized to the add-in's web service.</span></span> <span data-ttu-id="66ec6-157">Дополнительные сведения см. в разделе [Создание приложения службы](sso-in-office-add-ins.md#create-the-service-application) и статье [Регистрация надстройки в конечной точке Azure AD версии 2.0](register-sso-add-in-aad-v2.md).</span><span class="sxs-lookup"><span data-stu-id="66ec6-157">For more information, see [Create the service application](sso-in-office-add-ins.md#create-the-service-application) and [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span> <span data-ttu-id="66ec6-158">Это также может произойти, если пользователь не предоставил приложению службы разрешения на доступ к своему ресурсу `profile`, или отменил согласие.</span><span class="sxs-lookup"><span data-stu-id="66ec6-158">This also may happen if the user has not granted your service application permissions to their `profile`, or has revoked consent.</span></span> <span data-ttu-id="66ec6-159">Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-159">Your code should fall back to an alternate system of user authentication.</span></span>

<span data-ttu-id="66ec6-160">Другая возможная причина при разработке заключается в том, что ваша надстройка использует Internet Explorer, и вы используете самозаверяющий сертификат.</span><span class="sxs-lookup"><span data-stu-id="66ec6-160">Another possible cause, during development, is that your add-in using Internet Explorer, and you are using a self-signed certificate.</span></span> <span data-ttu-id="66ec6-161">(Сведения об определении браузера, используемого надстройкой, см. в статье [Браузеры, используемые надстройками Office](../concepts/browsers-used-by-office-web-add-ins.md).)</span><span class="sxs-lookup"><span data-stu-id="66ec6-161">(To determine which browser is being used by the add-in, see [Browsers used by Office Add-ins](../concepts/browsers-used-by-office-web-add-ins.md).)</span></span>

### <a name="13006"></a><span data-ttu-id="66ec6-162">13006</span><span class="sxs-lookup"><span data-stu-id="66ec6-162">13006</span></span>

<span data-ttu-id="66ec6-163">Ошибка клиента.</span><span class="sxs-lookup"><span data-stu-id="66ec6-163">Client Error.</span></span> <span data-ttu-id="66ec6-164">Эта ошибка возникает только в **Office в Интернете**.</span><span class="sxs-lookup"><span data-stu-id="66ec6-164">This error is only seen in **Office on the web**.</span></span> <span data-ttu-id="66ec6-165">Код должен предлагать пользователю выйти и затем перезапустить сеанс браузера для Office.</span><span class="sxs-lookup"><span data-stu-id="66ec6-165">Your code should suggest that the user sign out and then restart the Office browser session.</span></span>

### <a name="13007"></a><span data-ttu-id="66ec6-166">13007</span><span class="sxs-lookup"><span data-stu-id="66ec6-166">13007</span></span>

<span data-ttu-id="66ec6-167">Ведущему приложению Office не удалось получить маркер доступа к веб-службе надстройки.</span><span class="sxs-lookup"><span data-stu-id="66ec6-167">The Office host was unable to get an access token to the add-in's web service.</span></span>

- <span data-ttu-id="66ec6-168">Если эта ошибка возникает во время разработки, убедитесь, что в регистрационных данных и манифесте надстройки указаны разрешение `profile` (и разрешение `openid`, если вы используете MSAL.NET).</span><span class="sxs-lookup"><span data-stu-id="66ec6-168">If this error occurs during development, be sure that your add-in registration and add-in manifest specify the `profile` permission (and the `openid` permission, if you are using MSAL.NET).</span></span> <span data-ttu-id="66ec6-169">Дополнительные сведения см. в статье [Регистрация надстройки с помощью конечной точки Azure AD версии 2.0](register-sso-add-in-aad-v2.md).</span><span class="sxs-lookup"><span data-stu-id="66ec6-169">For more information, see [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span>
- <span data-ttu-id="66ec6-170">В рабочей среде эта ошибка может возникать по нескольким причинам.</span><span class="sxs-lookup"><span data-stu-id="66ec6-170">In production, there are several things that can cause this error.</span></span> <span data-ttu-id="66ec6-171">Вот некоторые из них:</span><span class="sxs-lookup"><span data-stu-id="66ec6-171">Some of them are:</span></span>
    - <span data-ttu-id="66ec6-172">У пользователя есть удостоверение учетной записи Майкрософт (MSA).</span><span class="sxs-lookup"><span data-stu-id="66ec6-172">The user has an Microsoft Account (MSA) identity.</span></span>
    - <span data-ttu-id="66ec6-173">В некоторых ситуациях, которые могут привести к одной из других ошибок 13xxx с рабочей или учебной учетной записью, при использовании MSA возникнет ошибка 13007.</span><span class="sxs-lookup"><span data-stu-id="66ec6-173">Some situations that would cause one of the other 13xxx errors with a Work or School account, will cause a 13007 when a MSA is used.</span></span>

  <span data-ttu-id="66ec6-174">Во всех этих случаях ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-174">For all of these cases, your code should fall back to an alternate system of user authentication.</span></span>

### <a name="13008"></a><span data-ttu-id="66ec6-175">13008</span><span class="sxs-lookup"><span data-stu-id="66ec6-175">13008</span></span>

<span data-ttu-id="66ec6-176">Пользователь запустил операцию, которая вызывает метод `getAccessToken`, до завершения предыдущего вызова метода `getAccessToken`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-176">The user triggered an operation that calls `getAccessToken` before a previous call of `getAccessToken` completed.</span></span> <span data-ttu-id="66ec6-177">Эта ошибка возникает только в **Office в Интернете**.</span><span class="sxs-lookup"><span data-stu-id="66ec6-177">This error is only seen on **Office on the web**.</span></span> <span data-ttu-id="66ec6-178">Код должен предлагать пользователю повторить операцию после завершения предыдущей операции.</span><span class="sxs-lookup"><span data-stu-id="66ec6-178">Your code should ask the user to repeat the operation after the previous operation has completed.</span></span>

### <a name="13010"></a><span data-ttu-id="66ec6-179">13010</span><span class="sxs-lookup"><span data-stu-id="66ec6-179">13010</span></span>

<span data-ttu-id="66ec6-180">Пользователь запустил надстройку в Office в Microsoft EDGE или Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="66ec6-180">The user is running the add-in in Office on Microsoft Edge or Internet Explorer.</span></span> <span data-ttu-id="66ec6-181">Домен Office 365 пользователя и домен `login.microsoftonline.com` находятся в разных зонах безопасности в настройках браузера.</span><span class="sxs-lookup"><span data-stu-id="66ec6-181">The user’s Office 365 domain, and the `login.microsoftonline.com` domain, are in a different security zones in the browser settings.</span></span> <span data-ttu-id="66ec6-182">Эта ошибка возникает только в **Office в Интернете**.</span><span class="sxs-lookup"><span data-stu-id="66ec6-182">This error is only seen on **Office on the web**.</span></span> <span data-ttu-id="66ec6-183">Если возвращается эта ошибка, то пользователь уже видел сообщение с соответствующим пояснением и ссылкой на инструкции по изменению конфигурации зон.</span><span class="sxs-lookup"><span data-stu-id="66ec6-183">If this error is returned, the user will have already seen an error explaining this and linking to a page about how to change the zone configuration.</span></span> <span data-ttu-id="66ec6-184">Если ваша надстройка предоставляет функции, не требующие входа пользователя, то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="66ec6-184">If your add-in provides functions that don't require the user to be signed in, then your code should catch this error and allow the add-in to stay running.</span></span>

### <a name="13012"></a><span data-ttu-id="66ec6-185">13012</span><span class="sxs-lookup"><span data-stu-id="66ec6-185">13012</span></span>

<span data-ttu-id="66ec6-186">Существует несколько возможных причин. </span><span class="sxs-lookup"><span data-stu-id="66ec6-186">There are several possible causes:</span></span>

- <span data-ttu-id="66ec6-187">Надстройка выполняется на платформе, которая не поддерживает API `getAccessToken`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-187">The add-in is running on a platform that does not support the `getAccessToken` API.</span></span> <span data-ttu-id="66ec6-188">Например, она не поддерживается на iPad.</span><span class="sxs-lookup"><span data-stu-id="66ec6-188">For example, it is not supported on iPad.</span></span> <span data-ttu-id="66ec6-189">См. также статью [Наборы требований API Identity](/office/dev/add-ins/reference/requirement-sets/identity-api-requirement-sets).</span><span class="sxs-lookup"><span data-stu-id="66ec6-189">See also [Identity API Requirement Sets](/office/dev/add-ins/reference/requirement-sets/identity-api-requirement-sets).</span></span>
- <span data-ttu-id="66ec6-190">Параметр `forMSGraphAccess` был передан в вызов `getAccessToken`, и пользователь получил надстройку через AppSource.</span><span class="sxs-lookup"><span data-stu-id="66ec6-190">The `forMSGraphAccess` option was passed in the call to `getAccessToken` and the user obtained the add-in from AppSource.</span></span> <span data-ttu-id="66ec6-191">В этом сценарии администратор клиента не предоставил надстройке согласие на области Microsoft Graph (разрешения), которые ей нужны.</span><span class="sxs-lookup"><span data-stu-id="66ec6-191">In this scenario, the tenant admin has not granted consent to the add-in for the Microsoft Graph scopes (permissions) that it needs.</span></span> <span data-ttu-id="66ec6-192">При отзыве `getAccessToken` с помощью `allowConsentPrompt` проблема не будет устранена, так как для Office допускается предложить пользователю разрешение только для области `profile` AAD.</span><span class="sxs-lookup"><span data-stu-id="66ec6-192">Recalling `getAccessToken` with the `allowConsentPrompt` will not solve the problem because Office is allowed to prompt the user for consent to only the AAD `profile` scope.</span></span>

<span data-ttu-id="66ec6-193">Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-193">Your code should fall back to an alternate system of user authentication.</span></span>

<span data-ttu-id="66ec6-194">В процессе разработки надстройка является неопубликованной в Outlook, а параметр `forMSGraphAccess` передается в вызов `getAccessToken`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-194">In development, the add-in is sideloaded in Outlook and the `forMSGraphAccess` option was passed in the call to `getAccessToken`.</span></span>

### <a name="13013"></a><span data-ttu-id="66ec6-195">13013</span><span class="sxs-lookup"><span data-stu-id="66ec6-195">13013</span></span>

<span data-ttu-id="66ec6-196">`getAccessToken` Слишком много раз вызвано слишком много раз в течение короткого промежутка времени, поэтому Office регулирует последний вызов.</span><span class="sxs-lookup"><span data-stu-id="66ec6-196">The `getAccessToken` was called too many times in a short amount of time, so Office throttled the most recent call.</span></span> <span data-ttu-id="66ec6-197">Обычно это вызвано бесконечным циклом вызовов метода.</span><span class="sxs-lookup"><span data-stu-id="66ec6-197">This is usually caused by an infinite loop of calls to the method.</span></span> <span data-ttu-id="66ec6-198">В некоторых случаях рекомендуется перезвонить методу.</span><span class="sxs-lookup"><span data-stu-id="66ec6-198">There are scenarios when recalling the method is advisable.</span></span> <span data-ttu-id="66ec6-199">Однако код должен использовать счетчик или переменную флага, чтобы метод не вызывался повторно.</span><span class="sxs-lookup"><span data-stu-id="66ec6-199">However, your code should use a counter or flag variable to ensure that the method is not recalled repeatedly.</span></span> <span data-ttu-id="66ec6-200">Если один и тот же путь к коду повторной попытки выполняется повторно, код должен вернуться в альтернативную систему проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-200">If the same "retry" code path is running again, the code should fall back to an alternate system of user authentication.</span></span> <span data-ttu-id="66ec6-201">В примере кода показано, как использовать `retryGetAccessToken` переменную в файле [HomeES6. js](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js) или [ssoAuthES6. js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js).</span><span class="sxs-lookup"><span data-stu-id="66ec6-201">For a code example, see how the `retryGetAccessToken` variable is used in [HomeES6.js](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js) or [ssoAuthES6.js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js).</span></span>

### <a name="50001"></a><span data-ttu-id="66ec6-202">50001</span><span class="sxs-lookup"><span data-stu-id="66ec6-202">50001</span></span>

<span data-ttu-id="66ec6-203">Эта ошибка (нехарактерная для `getAccessToken`) может указывать, что браузер поместил в кэш старую копию файлов office.js.</span><span class="sxs-lookup"><span data-stu-id="66ec6-203">This error (which is not specific to `getAccessToken`) may indicate that the browser has cached an old copy of the office.js files.</span></span> <span data-ttu-id="66ec6-204">Во время разработки очистите кэш браузера.</span><span class="sxs-lookup"><span data-stu-id="66ec6-204">When you are developing, clear the browser's cache.</span></span> <span data-ttu-id="66ec6-205">Другой возможный вариант — версия Office устарела и не поддерживает единый вход.</span><span class="sxs-lookup"><span data-stu-id="66ec6-205">Another possibility is that the version of Office is not recent enough to support SSO.</span></span> <span data-ttu-id="66ec6-206">В Windows минимальная версия — 16.0.12215.20006.</span><span class="sxs-lookup"><span data-stu-id="66ec6-206">On Windows, the minimum version is 16.0.12215.20006.</span></span> <span data-ttu-id="66ec6-207">На Mac — 16.32.19102902.</span><span class="sxs-lookup"><span data-stu-id="66ec6-207">On Mac, it is 16.32.19102902.</span></span>

<span data-ttu-id="66ec6-208">Если надстройка выполняется в рабочей среде, она должна отреагировать на эту ошибку, переключившись на альтернативную систему проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-208">In a production add-in, the add-in should respond to this error by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="66ec6-209">Дополнительные сведения см. в разделе [Требования и рекомендации](/office/dev/add-ins/develop/sso-in-office-add-ins##requirements-and-best-practices).</span><span class="sxs-lookup"><span data-stu-id="66ec6-209">For more information, see [Requirements and Best Practices](/office/dev/add-ins/develop/sso-in-office-add-ins##requirements-and-best-practices).</span></span>

## <a name="errors-on-the-server-side-from-azure-active-directory"></a><span data-ttu-id="66ec6-210">Ошибки на стороне сервера из Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="66ec6-210">Errors on the server-side from Azure Active Directory</span></span>

<span data-ttu-id="66ec6-211">Примеры обработки ошибок, рассматриваемых в этом разделе:</span><span class="sxs-lookup"><span data-stu-id="66ec6-211">For samples of the error-handling described in this section, see:</span></span>
- [<span data-ttu-id="66ec6-212">Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="66ec6-212">Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)
- [<span data-ttu-id="66ec6-213">Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="66ec6-213">Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)

### <a name="conditional-access--multifactor-authentication-errors"></a><span data-ttu-id="66ec6-214">Ошибки условного доступа и многофакторной проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="66ec6-214">Conditional access / Multifactor authentication errors</span></span>

<span data-ttu-id="66ec6-p125">При использовании некоторых конфигураций удостоверений в AAD и Office 365 некоторым ресурсам, доступным через Microsoft Graph, может потребоваться многофакторная проверка подлинности (MFA), даже если она не требуется клиенту Office 365. Когда служба AAD получает запрос на получение токена для доступа к защищенному с помощью MFA ресурсу, через поток выполнения от имени другого субъекта она возвращает веб-службе надстройки сообщение JSON, содержащее свойство `claims`. Свойство claims содержит сведения о том, какие еще факторы проверки подлинности требуются.</span><span class="sxs-lookup"><span data-stu-id="66ec6-p125">In certain configurations of identity in AAD and Office 365, it is possible for some resources that are accessible with Microsoft Graph to require multifactor authentication (MFA), even when the user's Office 365 tenancy does not. When AAD receives a request for a token to the MFA-protected resource, via the on-behalf-of flow, it returns to your add-in's web service a JSON message that contains a `claims` property. The claims property has information about what further authentication factors are needed.</span></span>

<span data-ttu-id="66ec6-218">Ваш код должен выполнить проверку на это свойство `claims`.</span><span class="sxs-lookup"><span data-stu-id="66ec6-218">Your code should test for this `claims` property.</span></span> <span data-ttu-id="66ec6-219">В зависимости от архитектуры надстройки вы можете протестировать ее на стороне клиента, а также на стороне сервера и ретранслировать ее клиенту.</span><span class="sxs-lookup"><span data-stu-id="66ec6-219">Depending on your add-in's architecture, you may test for it on the client-side, or you may test for it on the server-side and relay it to the client.</span></span> <span data-ttu-id="66ec6-220">Эти сведения необходимы клиенту, так как Office обрабатывает проверку подлинности для надстроек с единым входом. Если вы ретранслируете ее со стороны сервера, сообщение для клиента может быть кодом ошибки (например, `500 Server Error` или `401 Unauthorized`) либо находиться в тексте отклика об успешном выполнении (например, `200 OK`).</span><span class="sxs-lookup"><span data-stu-id="66ec6-220">You need this information in the client because Office handles authentication for SSO add-ins. If you relay it from the server-side, the message to the client can be either an error (such as `500 Server Error` or `401 Unauthorized`) or in the body of a success response (such as `200 OK`).</span></span> <span data-ttu-id="66ec6-221">В обоих случаях функция обратного вызова для клиентского AJAX-вызова веб-API надстройки должна проверять этот отклик.</span><span class="sxs-lookup"><span data-stu-id="66ec6-221">In either case, the (failure or success) callback of your code's client-side AJAX call to your add-in's web API should test for this response.</span></span> 

<span data-ttu-id="66ec6-222">Независимо от архитектуры, если значение утверждения было отправлено из AAD, ваш код должен отозваться `getAccessToken` и передать параметр `authChallenge: CLAIMS-STRING-HERE` в `options` параметре.</span><span class="sxs-lookup"><span data-stu-id="66ec6-222">Regardless of your architecture, if the claims value has been sent from AAD, your code should recall `getAccessToken` and pass the option `authChallenge: CLAIMS-STRING-HERE` in the `options` parameter.</span></span> <span data-ttu-id="66ec6-223">Когда служба AAD обнаруживает эту строку, она предлагает пользователю указать дополнительные факторы, а затем возвращает новый маркер доступа, который будет принят в потоке выполнения от имени другого субъекта.</span><span class="sxs-lookup"><span data-stu-id="66ec6-223">When AAD sees this string, it prompts the user for the additional factor(s) and then returns a new access token which will be accepted in the on-behalf-of flow.</span></span>

### <a name="consent-missing-errors"></a><span data-ttu-id="66ec6-224">Ошибки, вызванные отсутствием согласия</span><span class="sxs-lookup"><span data-stu-id="66ec6-224">Consent missing errors</span></span>

<span data-ttu-id="66ec6-225">Если в службе AAD нет записи о том, что пользователь или администратор клиента согласился предоставить надстройке доступ к ресурсу Microsoft Graph, то AAD отправит вашей веб-службе сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="66ec6-225">If AAD has no record that consent (to the Microsoft Graph resource) was granted to the add-in by the user (or tenant administrator), AAD will send an error message to your web service.</span></span> <span data-ttu-id="66ec6-226">Код должен сообщить клиенту (например, в тексте отклика `403 Forbidden`).</span><span class="sxs-lookup"><span data-stu-id="66ec6-226">Your code must tell the client (in the body of a `403 Forbidden` response, for example).</span></span>

<span data-ttu-id="66ec6-227">Если для надстройки требуются области Microsoft Graph, которые могут предоставляться только администратором, код должен возвращать ошибку.</span><span class="sxs-lookup"><span data-stu-id="66ec6-227">If the add-in needs Microsoft Graph scopes that can only be consented to by an admin, your code should throw an error.</span></span> <span data-ttu-id="66ec6-228">Если пользователь может дать согласие только на те области, которые ему нужны, ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="66ec6-228">If the only scopes that are needed can be consented to by the user, then your code should fall back to an alternate system of user authentication.</span></span>

### <a name="invalid-or-missing-scope-permission-errors"></a><span data-ttu-id="66ec6-229">Ошибки, вызванные недействительными или отсутствующими областями (разрешениями)</span><span class="sxs-lookup"><span data-stu-id="66ec6-229">Invalid or missing scope (permission) errors</span></span>

<span data-ttu-id="66ec6-230">Эта ошибка возникает только в процессе разработки.</span><span class="sxs-lookup"><span data-stu-id="66ec6-230">This kind of error should only be seen in development.</span></span>

- <span data-ttu-id="66ec6-231">Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, который должен записать ошибку в консоли или журнале.</span><span class="sxs-lookup"><span data-stu-id="66ec6-231">Your server-side code should send a `403 Forbidden` response to the client which should log the error to the console or record it in a log.</span></span>
- <span data-ttu-id="66ec6-232">Убедитесь, что в разделе [Scopes](/office/dev/add-ins/reference/manifest/scopes) манифеста надстройки указаны все необходимые разрешения.</span><span class="sxs-lookup"><span data-stu-id="66ec6-232">Be sure your add-in manifest [Scopes](/office/dev/add-ins/reference/manifest/scopes) section specifies all needed permissions.</span></span> <span data-ttu-id="66ec6-233">Кроме того, убедитесь, что в регистрационных данных веб-службы надстройки указаны те же разрешения.</span><span class="sxs-lookup"><span data-stu-id="66ec6-233">And be sure your registration of the add-in's web service specifies the same permissions.</span></span> <span data-ttu-id="66ec6-234">Кроме того, проверьте наличие ошибок правописания.</span><span class="sxs-lookup"><span data-stu-id="66ec6-234">Check for spelling mistakes too.</span></span> <span data-ttu-id="66ec6-235">Дополнительные сведения см. в статье [Регистрация надстройки с помощью конечной точки Azure AD версии 2.0](register-sso-add-in-aad-v2.md).</span><span class="sxs-lookup"><span data-stu-id="66ec6-235">For more information, see [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span>

### <a name="invalid-audience-error-in-the-access-token-not-the-bootstrap-token"></a><span data-ttu-id="66ec6-236">Ошибка, вызванная недействительной аудиторией, в маркере доступа (не маркере начальной загрузки)</span><span class="sxs-lookup"><span data-stu-id="66ec6-236">Invalid audience error in the access token (not the bootstrap token)</span></span>

<span data-ttu-id="66ec6-237">Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, а тот должен показать пользователю понятное сообщение и, возможно, также записать ошибку в консоли или журнале.</span><span class="sxs-lookup"><span data-stu-id="66ec6-237">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user and possibly also log the error to the console or record it in a log.</span></span>
