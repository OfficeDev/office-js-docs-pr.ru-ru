---
title: Устранение ошибок единого входа
description: Рекомендации по устранению неполадок с одним входом (SSO) в Office надстройки и обработке специальных условий или ошибок.
ms.date: 02/12/2021
localization_priority: Normal
ms.openlocfilehash: 3d6f78802c51035664f7d12aa787c89aa62057d9
ms.sourcegitcommit: 0d9fcdc2aeb160ff475fbe817425279267c7ff31
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2021
ms.locfileid: "52590934"
---
# <a name="troubleshoot-error-messages-for-single-sign-on-sso"></a>Устранение ошибок единого входа

В этой статье представлено руководство по обеспечению надежной обработки специальных условий и ошибок в надстройках Office, поддерживающих единый вход, а также устранению связанных с единым входом проблем в таких надстройках.

> [!NOTE]
> API единого входа в настоящее время поддерживается для Word, Excel, Outlook и PowerPoint. Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).
> Если вы работаете с надстройкой Outlook, обязательно включите современную проверку подлинности для клиента Microsoft 365. Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).

## <a name="debugging-tools"></a>Средства отладки

Настоятельно рекомендуем использовать во время разработки средство, которое может перехватывать и отображать HTTP-запросы от веб-службы надстройки и отклики для нее. Из них наиболее популярны следующие средства:

- [Fiddler](https://www.telerik.com/fiddler), предоставляемое бесплатно ([документация](https://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler));
- [Charles](https://www.charlesproxy.com), предоставляемое бесплатно в течение 30 дней ([документация](https://www.charlesproxy.com/documentation/)).

## <a name="causes-and-handling-of-errors-from-getaccesstoken"></a>Причины и обработка ошибок в методе getAccessToken

Примеры обработки ошибок, рассматриваемых в этом разделе:
- [HomeES6.js in Office-Add-in-ASPNET-SSO](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js)
- [ssoAuthES6.js in Office-Add-in-NodeJS-SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js)

### <a name="13000"></a>13000

Надстройка или версия Office не поддерживает API [getAccessToken](../develop/sso-in-office-add-ins.md#sso-api-reference).

- Эта версия Office не поддерживает единый вход. Необходимой версией является Microsoft 365 подписка в любом ежемесячном канале.
- В манифесте надстройки отсутствует подходящий раздел [WebApplicationInfo](../reference/manifest/webapplicationinfo.md).

Ваша надстройка должна отреагировать на эту ошибку, переключившись на альтернативную систему проверки подлинности пользователя. Дополнительные сведения см. в разделе [Требования и рекомендации](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).

### <a name="13001"></a>13001

Пользователь не вошел в Office. В большинстве сценариев эту ошибку следует предотвращать, не допуская ее повторения, путем передачи элемента `allowSignInPrompt: true` в параметре `AuthOptions`.

Но могут быть исключения. Например, вы хотите, чтобы надстройка открывалась с функциями, для которых требуется вход пользователя в систему, но *только в том случае, если* пользователь *уже* вошел в Office. В противном случае надстройку следует открыть с помощью альтернативного набора функций, которые не требуют входа пользователя в систему. В этом случае логика выполняется при запуске надстройкой вызовов `getAccessToken` без `allowSignInPrompt: true`. Используйте ошибку 13001 в качестве пометки, чтобы указать надстройке представить альтернативный набор функций.

Другая возможность — реагирование на ошибку 13001, с переключением на альтернативную систему проверки подлинности пользователя. Это обеспечит вход пользователя в AAD, но не вход пользователя в Office.

Эта ошибка никогда не возникает в **Office в Интернете**. Если срок действия cookie-файла пользователя истек, **Office в Интернете** возвращает ошибку 13006.

### <a name="13002"></a>13002

Пользователь прервал вход или отменил свое согласие (например, выбрав **Отмена** в диалоговом окне согласия).

- Если ваша надстройка предоставляет функции, не требующие входа пользователя (или предоставления согласия), то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.
- Если для надстройки требуется пользователь, который вошел в систему и получил согласие, в вашем коде должна появиться кнопка входа в систему.

### <a name="13003"></a>13003

Тип пользователя не поддерживается. Пользователь не подписывался в Office с действительной учетной записью Майкрософт, Microsoft 365 для образования или учетной записью работы. Например, это может произойти, если Office работает с учетной записью локального домена. Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя. В Outlook эта ошибка также может [](/exchange/clients-and-mobile-in-exchange-online/enable-or-disable-modern-authentication-in-exchange-online) возникнуть, если современная проверка подлинности отключена для клиента пользователя в Exchange Online. Дополнительные сведения см. в разделе [Требования и рекомендации](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).

### <a name="13004"></a>13004

Недопустимый ресурс. (Эта ошибка должна быть замечена только в разработке.) Манифест надстройки не был настроен правильно. Обновите манифест. Дополнительные сведения см. в статье [Проверка манифеста надстройки Office](../testing/troubleshoot-manifest.md). Самая распространенная проблема заключается в том, что в элементе **Resource** (который входит в элемент **WebApplicationInfo**) указан домен, не соответствующий домену надстройки. Хотя часть протокола значения ресурса должна быть "api", а не "https", все остальные части доменного имени (включая порт, если таковой имеется) должны быть такими же, как и для надстройки.

### <a name="13005"></a>13005

Недопустимое разрешение. Как правило, это означает, что приложение Office не получило предварительные разрешения для веб-службы надстройки. Дополнительные сведения см. в разделе [Создание приложения службы](sso-in-office-add-ins.md#create-the-service-application) и статье [Регистрация надстройки в конечной точке Azure AD версии 2.0](register-sso-add-in-aad-v2.md). Это также может произойти, если пользователь не предоставил приложению службы разрешения на доступ к своему ресурсу `profile`, или отменил согласие. Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.

Другая возможная причина при разработке заключается в том, что ваша надстройка использует Internet Explorer, и вы используете самозаверяющий сертификат. (Сведения об определении браузера, используемого надстройкой, см. в статье [Браузеры, используемые надстройками Office](../concepts/browsers-used-by-office-web-add-ins.md).)

### <a name="13006"></a>13006

Ошибка клиента. Эта ошибка возникает только в **Office в Интернете**. Код должен предлагать пользователю выйти и затем перезапустить сеанс браузера для Office.

### <a name="13007"></a>13007

Приложение Office не удалось получить маркер доступа к веб-службе надстройки.

- Если эта ошибка возникает во время разработки, убедитесь, что в регистрационных данных и манифесте надстройки указаны разрешение `profile` (и разрешение `openid`, если вы используете MSAL.NET). Дополнительные сведения см. в статье [Регистрация надстройки с помощью конечной точки Azure AD версии 2.0](register-sso-add-in-aad-v2.md).
- В рабочей среде эта ошибка может возникать по нескольким причинам. Вот некоторые из них:
    - У пользователя есть удостоверение учетной записи Майкрософт.
    - Некоторые ситуации, которые могут привести к одной из других ошибок 13xxx с учетной записью Microsoft 365 для образования или учетной записью работы, могут привести к 13007 при работе MSA.

  Во всех этих случаях ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.

### <a name="13008"></a>13008

Пользователь запустил операцию, которая вызывает метод `getAccessToken`, до завершения предыдущего вызова метода `getAccessToken`. Эта ошибка возникает только в **Office в Интернете**. Код должен предлагать пользователю повторить операцию после завершения предыдущей операции.

### <a name="13010"></a>13010

Пользователь запустил надстройку в Office в Microsoft EDGE или Internet Explorer. Домен пользователя Microsoft 365 и домен находятся в различных зонах безопасности в `login.microsoftonline.com` параметрах браузера. Эта ошибка возникает только в **Office в Интернете**. Если возвращается эта ошибка, то пользователь уже видел сообщение с соответствующим пояснением и ссылкой на инструкции по изменению конфигурации зон. Если ваша надстройка предоставляет функции, не требующие входа пользователя, то в коде следует отслеживать эту ошибку и позволять надстройке продолжать работу.

### <a name="13012"></a>13012

Существует несколько возможных причин. 

- Надстройка выполняется на платформе, которая не поддерживает API `getAccessToken`. Например, она не поддерживается на iPad. См. также [наборы требований к API удостоверений.](../reference/requirement-sets/identity-api-requirement-sets.md)
- Параметр `forMSGraphAccess` был передан в вызов `getAccessToken`, и пользователь получил надстройку через AppSource. В этом сценарии администратор клиента не предоставил надстройке согласие на области Microsoft Graph (разрешения), которые ей нужны. При отзыве `getAccessToken` с помощью `allowConsentPrompt` проблема не будет устранена, так как для Office допускается предложить пользователю разрешение только для области `profile` AAD.

Ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.

В процессе разработки надстройка является неопубликованной в Outlook, а параметр `forMSGraphAccess` передается в вызов `getAccessToken`.

### <a name="13013"></a>13013

Вызов был вызван слишком много раз за короткое время, поэтому Office последний `getAccessToken` вызов. Обычно это вызвано бесконечным циклом звонков к методу. При отзыве метода рекомендуется использовать сценарии. Однако в коде следует использовать переменную счетчика или флага, чтобы убедиться, что метод не отзывается повторно. Если один и тот же путь кода "повторная" снова запущен, код должен вернуться к альтернативной системе проверки подлинности пользователей. Пример кода см. в примере использования переменной вHomeES6.js`retryGetAccessToken` [илиssoAuthES6.js. ](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js) [](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js)

### <a name="50001"></a>50001

Эта ошибка (нехарактерная для `getAccessToken`) может указывать, что браузер поместил в кэш старую копию файлов office.js. Во время разработки очистите кэш браузера. Другой возможный вариант — версия Office устарела и не поддерживает единый вход. В Windows минимальная версия — 16.0.12215.20006. На Mac — 16.32.19102902.

Если надстройка выполняется в рабочей среде, она должна отреагировать на эту ошибку, переключившись на альтернативную систему проверки подлинности пользователя. Дополнительные сведения см. в разделе [Требования и рекомендации](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).

## <a name="errors-on-the-server-side-from-azure-active-directory"></a>Ошибки на стороне сервера из Azure Active Directory

Примеры обработки ошибок, рассматриваемых в этом разделе:
- [Office-Add-in-ASPNET-SSO](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)
- [Office-Add-in-NodeJS-SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)

### <a name="conditional-access--multifactor-authentication-errors"></a>Ошибки условного доступа и многофакторной проверки подлинности

В определенных конфигурациях удостоверений в AAD и Microsoft 365 для некоторых ресурсов, доступных в Microsoft Graph, может потребоваться многофакторная проверка подлинности (MFA), даже если Microsoft 365 аренда пользователя не существует. Когда служба AAD получает запрос на получение токена для доступа к защищенному с помощью MFA ресурсу, через поток выполнения от имени другого субъекта она возвращает веб-службе надстройки сообщение JSON, содержащее свойство `claims`. Свойство claims содержит сведения о том, какие еще факторы проверки подлинности требуются.

Ваш код должен выполнить проверку на это свойство `claims`. В зависимости от архитектуры надстройки вы можете протестировать ее на стороне клиента, а также на стороне сервера и ретранслировать ее клиенту. Эти сведения необходимы клиенту, так как Office обрабатывает проверку подлинности для надстроек с единым входом. Если вы ретранслируете ее со стороны сервера, сообщение для клиента может быть кодом ошибки (например, `500 Server Error` или `401 Unauthorized`) либо находиться в тексте отклика об успешном выполнении (например, `200 OK`). В обоих случаях функция обратного вызова для клиентского AJAX-вызова веб-API надстройки должна проверять этот отклик. 

Независимо от архитектуры, если значение утверждений было отправлено из AAD, код должен отозвать и передать `getAccessToken` `authChallenge: CLAIMS-STRING-HERE` `options` параметр. Когда служба AAD обнаруживает эту строку, она предлагает пользователю указать дополнительные факторы, а затем возвращает новый маркер доступа, который будет принят в потоке выполнения от имени другого субъекта.

### <a name="consent-missing-errors"></a>Ошибки, вызванные отсутствием согласия

Если в службе AAD нет записи о том, что пользователь или администратор клиента согласился предоставить надстройке доступ к ресурсу Microsoft Graph, то AAD отправит вашей веб-службе сообщение об ошибке. Код должен сообщить клиенту (например, в тексте отклика `403 Forbidden`).

Если для надстройки требуются области Microsoft Graph, которые могут предоставляться только администратором, код должен возвращать ошибку. Если пользователь может дать согласие только на те области, которые ему нужны, ваш код должен инициировать возврат к альтернативной системе проверки подлинности пользователя.

### <a name="invalid-or-missing-scope-permission-errors"></a>Ошибки, вызванные недействительными или отсутствующими областями (разрешениями)

Эта ошибка возникает только в процессе разработки.

- Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, который должен записать ошибку в консоли или журнале.
- Убедитесь, что в разделе [Scopes](../reference/manifest/scopes.md) манифеста надстройки указаны все необходимые разрешения. Кроме того, убедитесь, что в регистрационных данных веб-службы надстройки указаны те же разрешения. Кроме того, проверьте наличие ошибок правописания. Дополнительные сведения см. в статье [Регистрация надстройки с помощью конечной точки Azure AD версии 2.0](register-sso-add-in-aad-v2.md).

### <a name="invalid-audience-error-in-the-access-token-not-the-bootstrap-token"></a>Ошибка, вызванная недействительной аудиторией, в маркере доступа (не маркере начальной загрузки)

Код на стороне сервера должен отправить отклик `403 Forbidden` клиенту, а тот должен показать пользователю понятное сообщение и, возможно, также записать ошибку в консоли или журнале.
