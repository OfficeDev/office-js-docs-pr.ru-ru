---
title: Авторизация в Microsoft Graph с помощью единого входа
description: Узнайте, как пользователи Office надстройки могут использовать один вход (SSO) для получения данных из Microsoft Graph.
ms.date: 07/27/2021
localization_priority: Normal
ms.openlocfilehash: e8e2946b6e6bc1cd49d18453065b52758d099a25
ms.sourcegitcommit: e570fa8925204c6ca7c8aea59fbf07f73ef1a803
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/05/2021
ms.locfileid: "53773925"
---
# <a name="authorize-to-microsoft-graph-with-sso"></a>Авторизация в Microsoft Graph с помощью единого входа

Пользователи входят в Office (в Интернете, на мобильных устройствах и настольных компьютерах), используя личную учетную запись Майкрософт, учетную запись Microsoft 365 для образования или рабочую учетную запись. Чтобы надстройка Office могла получить авторизованный доступ к [Microsoft Graph](https://developer.microsoft.com/graph/docs), лучше всего использовать учетные данные для входа пользователя в Office. Это позволяет пользователям получить доступ к своим данным Microsoft Graph без необходимости повторного входа.

> [!NOTE]
> API единого входа в настоящее время поддерживается для Word, Excel, Outlook и PowerPoint. Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).
> Если вы работаете с надстройкой Outlook, обязательно включите современную проверку подлинности для клиента Microsoft 365. Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a>Архитектура надстройки для единого входа и Microsoft Graph

Помимо страниц и кода JavaScript веб-приложения, в надстройке также должны размещаться (с тем же [полным доменном именем](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)) один или несколько веб-API, которые будут получать маркер доступа и отправлять запросы к Microsoft Graph.

Манифест надстройки содержит разметку, которая указывает, как надстройка регистрируется в конечной точке Azure Active Directory (Azure AD) версии 2.0, а также задает необходимые надстройке разрешения для Microsoft Graph.

### <a name="how-it-works-at-runtime"></a>Принцип работы во время выполнения

На приведенной ниже схеме показан процесс входа в систему и получения доступа к Microsoft Graph.

![Схема, показывающая процесс SSO.](../images/sso-access-to-microsoft-graph.png)

1. Код JavaScript надстройки вызывает новый API Office.js — [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getAccessToken_options_). Он указывает клиентскому приложению Office, что необходимо получить маркер доступа к надстройке. (Далее он будет называться **маркером доступа к начальной загрузке**, поскольку в этом процессе он позже будет заменен вторым маркером. Пример раскодированного маркера доступа к начальной загрузке см. в разделе [Пример маркера доступа](sso-in-office-add-ins.md#example-access-token)).
2. Если вход в Office не выполнен, в клиентском приложении открывается всплывающее окно, в котором пользователю предлагается войти.
3. Если пользователь запускает надстройку в первый раз, ему предлагается дать согласие.
4. Клиентская Office запрашивает маркер  загрузки доступа из конечной точки Azure AD v2.0 для текущего пользователя.
5. Azure AD отправляет маркер загрузки в Office клиентского приложения.
6. Клиентская Office отправляет маркер доступа  буттрап в надстройку как часть объекта результатов, возвращаемого `getAccessToken` вызовом.
7. Код JavaScript надстройки отправляет HTTP-запрос к веб-API с тем же полным доменным именем, что и у надстройки. Этот запрос включает **маркер доступа к начальной загрузке** в качестве подтверждения авторизации.
8. Серверный код проверяет входящий **маркер доступа к начальной загрузке**.
9. Серверный код использует поток "от имени" (определенный в [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) и daemon или серверном приложении для сценария Веб-API [Azure)](/azure/active-directory/develop/active-directory-authentication-scenarios)для получения маркера доступа для Microsoft Graph в обмен на маркер доступа bootstrap.
10. Azure AD возвращает надстройке маркер доступа в Microsoft Graph (и маркер обновления, если надстройка запрашивает разрешение *offline_access*).
11. Серверный код кэширует маркер доступа в Microsoft Graph.
12. Серверный код отправляет запросы к Microsoft Graph и включает маркер доступа в Microsoft Graph.
13. Microsoft Graph возвращает данные надстройке, а она может передать их своему пользовательскому интерфейсу.
14. Когда маркер доступа в Microsoft Graph истекает, серверный код может использовать свой маркер обновления, чтобы получить новый маркер доступа в Microsoft Graph.

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a>Разработка надстройки с единым входом для Microsoft Graph

Надстройка с доступом в Microsoft Graph разрабатывается так же, как и любая другая надстройка с единым входом. Подробное описание см. в статье [Включение единого входа для надстроек Office](../develop/sso-in-office-add-ins.md). Разница заключается в том, что у надстройки обязательно должен быть серверный веб-API, а также в использовании термина "маркер доступа к начальной загрузке" вместо термина "маркер доступа" из указанной статьи.

В зависимости от языка и платформы могут быть доступны библиотеки, которые упростят создание серверного кода. Ваш код должен выполнять следующее:

* Инициировать поток "от имени" с вызова конечной точки Azure AD v2.0, которая включает маркер доступа bootstrap, некоторые метаданные о пользователе и учетные данные надстройки (ее ID и секрет).
* создать один или несколько методов веб-API, которые получают данные Microsoft Graph, передавая (возможно кэшированный) маркер доступа в Microsoft Graph.
* при необходимости перед запуском потока проверять маркер доступа к начальной загрузке надстройки, полученный от созданного ранее обработчика маркеров. Дополнительные сведения см. в разделе [Проверка маркера доступа](sso-in-office-add-ins.md#validate-the-access-token); 
* при необходимости после завершения потока поместить в кэш возвращенный маркер доступа к Microsoft Graph. Это рекомендуется делать, если надстройка выполняет несколько вызовов в Microsoft Graph. Дополнительные сведения об этом потоке см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of);

> [!NOTE]
> Примеры раскодированных маркеров доступа в Microsoft Graph, которые были получены потоком "от имени", см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).

Подробные пошаговые инструкции и сценарии см. в следующих статьях:

* [Создание надстройки Office на платформе Node.js с использованием единого входа](create-sso-office-add-ins-nodejs.md)
* [Создание надстройки Office на платформе ASP.NET с использованием единого входа](create-sso-office-add-ins-aspnet.md)
* [Сценарий: реализация единого входа для службы в надстройке Outlook](../outlook/implement-sso-in-outlook-add-in.md)

## <a name="distributing-sso-enabled-add-ins-in-microsoft-appsource"></a>Распространение надстройок с поддержкой SSO в Microsoft AppSource

Когда Microsoft 365 получает надстройку от [AppSource,](https://appsource.microsoft.com)администратор может перераспределить ее через интегрированные приложения и предоставить администратору согласие на надстройку для доступа к microsoft Graph области. [](/microsoft-365/admin/manage/test-and-deploy-microsoft-365-apps) Однако конечному пользователю также возможно приобрести надстройки непосредственно из AppSource, в этом случае пользователь должен предоставить согласие на надстройки. Это может создать потенциальную проблему производительности, для которой мы предоставили решение.

Если код передает параметр в вызове , например , Office может вызвать пользователя на согласие, если Azure AD сообщает Office что согласие еще не было предоставлено `allowConsentPrompt` `getAccessToken` надстройки. `OfficeRuntime.auth.getAccessToken( { allowConsentPrompt: true } );` Однако по соображениям безопасности Office только побудить пользователя дать согласие на область Azure `profile` AD. *Office не может подсказок для согласия* на какие-либо microsoft Graph области, даже `User.Read` не . Это означает, что если пользователь дает согласие на запрос, Office возвращает маркер bootstrap. Но попытка обмена маркера загрузки для маркера доступа в Microsoft Graph не увенчается ошибкой AADSTS65001, что означает, что согласие (для microsoft Graph области) не было предоставлено.

Ваш код может и должен обрабатывать эту ошибку, возвращаясь к альтернативной системе проверки подлинности, которая будет побуждать пользователя к согласию на microsoft Graph области. (В примерах кода см. создание надстройки [Node.js Office,](create-sso-office-add-ins-nodejs.md) использующей [](create-sso-office-add-ins-aspnet.md) один вход и создайте надстройку ASP.NET Office, которая использует один вход и примеры, на которые они ссылались.) Но для всего процесса требуется несколько поездок в Azure AD. Вы можете избежать этого штрафа за производительность, включив параметр в вызов `forMSGraphAccess` `getAccessToken` ; например, `OfficeRuntime.auth.getAccessToken( { forMSGraphAccess: true } )` .  Это сигнализирует Office, что вашей надстройки нужны microsoft Graph области. Office Azure AD, чтобы убедиться, что Graph microsoft Graph области уже предоставлены надстройки. Если он есть, маркер загрузки будет возвращен. Если этого не сделать, вызов будет возвращать `getAccessToken` ошибку 13012. Ваш код может справиться с этой ошибкой, сразу же возвращаясь к альтернативной системе проверки подлинности, не делая обреченной попытки обмена маркерами с Azure AD.

В качестве наилучшей практики всегда передайте, когда надстройка будет распространяться в AppSource и нуждается в `forMSGraphAccess` `getAccessToken` microsoft Graph области.

> [!TIP]
> Если вы разрабатываете надстройку Outlook, которая использует SSO, и вы  ее побок для тестирования, Office всегда возвращает ошибку 13012, когда передается, даже если согласие администратора было `forMSGraphAccess` `getAccessToken` предоставлено. По этой причине при разработке надстройки Outlook `forMSGraphAccess` комментарии.  Не забудьте отостановить параметр при развертывании для производства. Фиктивный 13012 происходит только при загрузке Outlook.
