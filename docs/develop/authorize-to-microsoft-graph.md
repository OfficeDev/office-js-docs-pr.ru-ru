---
title: Авторизация в Microsoft Graph с помощью единого входа
description: Узнайте, как пользователи надстройки Office могут использовать единый вход (SSO) для получения данных из Microsoft Graph.
ms.date: 07/07/2020
localization_priority: Normal
ms.openlocfilehash: 809dc4f07c6d2afba4ea47cdee0eb7466dfb9635
ms.sourcegitcommit: 7ef14753dce598a5804dad8802df7aaafe046da7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2020
ms.locfileid: "45093730"
---
# <a name="authorize-to-microsoft-graph-with-sso-preview"></a><span data-ttu-id="2395b-103">Авторизация в Microsoft Graph с помощью единого входа (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="2395b-103">Authorize to Microsoft Graph with SSO (preview)</span></span>

<span data-ttu-id="2395b-104">Пользователи входят в Office (Интернет-, мобильные и Настольные платформы) с помощью личной учетной записи Майкрософт или учетной записи Microsoft 365 для образовательных или рабочих учетных записей.</span><span class="sxs-lookup"><span data-stu-id="2395b-104">Users sign in to Office (online, mobile, and desktop platforms) using either their personal Microsoft account or their Microsoft 365 Education or work account.</span></span> <span data-ttu-id="2395b-105">Чтобы надстройка Office могла получить авторизованный доступ к [Microsoft Graph](https://developer.microsoft.com/graph/docs), лучше всего использовать учетные данные для входа пользователя в Office.</span><span class="sxs-lookup"><span data-stu-id="2395b-105">The best way for an Office Add-in to get authorized access to [Microsoft Graph](https://developer.microsoft.com/graph/docs) is to use the credentials from the user's Office sign on.</span></span> <span data-ttu-id="2395b-106">Это позволяет пользователям получить доступ к своим данным Microsoft Graph без необходимости повторного входа.</span><span class="sxs-lookup"><span data-stu-id="2395b-106">This enables them to access their Microsoft Graph data without needing to sign in a second time.</span></span>

> [!NOTE]
> <span data-ttu-id="2395b-107">В настоящее время API единого входа поддерживается для Word, Excel, Outlook и PowerPoint в тестовом режиме.</span><span class="sxs-lookup"><span data-stu-id="2395b-107">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="2395b-108">Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).</span><span class="sxs-lookup"><span data-stu-id="2395b-108">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> <span data-ttu-id="2395b-109">Если вы работаете с надстройкой Outlook, обязательно включите современная проверка подлинности для клиента Microsoft 365.</span><span class="sxs-lookup"><span data-stu-id="2395b-109">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Microsoft 365 tenancy.</span></span> <span data-ttu-id="2395b-110">Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span><span class="sxs-lookup"><span data-stu-id="2395b-110">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a><span data-ttu-id="2395b-111">Архитектура надстройки для единого входа и Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="2395b-111">Add-in architecture for SSO and Microsoft Graph</span></span>

<span data-ttu-id="2395b-112">Помимо страниц и кода JavaScript веб-приложения, в надстройке также должны размещаться (с тем же [полным доменном именем](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)) один или несколько веб-API, которые будут получать маркер доступа и отправлять запросы к Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-112">In addition to hosting the pages and JavaScript of the web application, the add-in must also host, at the same [fully qualified domain name](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly), one or more web APIs that will get an access token to Microsoft Graph and make requests to it.</span></span>

<span data-ttu-id="2395b-113">Манифест надстройки содержит разметку, которая указывает, как надстройка регистрируется в конечной точке Azure Active Directory (Azure AD) версии 2.0, а также задает необходимые надстройке разрешения для Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-113">The add-in manifest contains markup that specifies how the add-in is registered in the Azure Active Directory (Azure AD) v2.0 endpoint, and it specifies any permissions to Microsoft Graph that the add-in needs.</span></span>

### <a name="how-it-works-at-runtime"></a><span data-ttu-id="2395b-114">Принцип работы во время выполнения</span><span class="sxs-lookup"><span data-stu-id="2395b-114">How it works at runtime</span></span>

<span data-ttu-id="2395b-115">На приведенной ниже схеме показан процесс входа в систему и получения доступа к Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-115">The following diagram shows how the process of signing in and getting access to Microsoft Graph works.</span></span>

![Схема единого входа](../images/sso-access-to-microsoft-graph.png)

1. <span data-ttu-id="2395b-117">Код JavaScript надстройки вызывает новый API Office.js — [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-).</span><span class="sxs-lookup"><span data-stu-id="2395b-117">In the add-in, JavaScript calls a new Office.js API [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-).</span></span> <span data-ttu-id="2395b-118">Он указывает ведущему приложению Office, что необходимо получить маркер доступа к надстройке.</span><span class="sxs-lookup"><span data-stu-id="2395b-118">This tells the Office host application to obtain an access token to the add-in.</span></span> <span data-ttu-id="2395b-119">(Далее он будет называться **маркером доступа к начальной загрузке**, поскольку в этом процессе он позже будет заменен вторым маркером.</span><span class="sxs-lookup"><span data-stu-id="2395b-119">(Hereafter, this is called the **bootstrap access token** because it is replaced with a second token later in the process.</span></span> <span data-ttu-id="2395b-120">Пример раскодированного маркера доступа к начальной загрузке см. в разделе [Пример маркера доступа](sso-in-office-add-ins.md#example-access-token)).</span><span class="sxs-lookup"><span data-stu-id="2395b-120">For an example of a decoded bootstrap access token, see [Example access token](sso-in-office-add-ins.md#example-access-token).)</span></span>
2. <span data-ttu-id="2395b-121">Если вход в Office не выполнен, в ведущем приложении открывается всплывающее окно, в котором пользователю предлагается войти.</span><span class="sxs-lookup"><span data-stu-id="2395b-121">If the user is not signed in, the Office host application opens a pop-up window for the user to sign in.</span></span>
3. <span data-ttu-id="2395b-122">Если пользователь запускает надстройку в первый раз, ему предлагается дать согласие.</span><span class="sxs-lookup"><span data-stu-id="2395b-122">If this is the first time the current user has used your add-in, he or she is prompted to consent.</span></span>
4. <span data-ttu-id="2395b-123">Ведущее приложение Office запрашивает **маркер доступа к начальной загрузке** у конечной точки Azure AD версии 2.0 для текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="2395b-123">The Office host application requests the **bootstrap access token** from the Azure AD v2.0 endpoint for the current user.</span></span>
5. <span data-ttu-id="2395b-124">Azure AD отправляет маркер начальной загрузки ведущему приложению Office.</span><span class="sxs-lookup"><span data-stu-id="2395b-124">Azure AD sends the bootstrap token to the Office host application.</span></span>
6. <span data-ttu-id="2395b-125">Ведущее приложение Office отправляет надстройке **маркер доступа к начальной загрузке** в составе объекта результата, возвращенного при вызове метода `getAccessToken`.</span><span class="sxs-lookup"><span data-stu-id="2395b-125">The Office host application sends the **bootstrap access token** to the add-in as part of the result object returned by the `getAccessToken` call.</span></span>
7. <span data-ttu-id="2395b-126">Код JavaScript надстройки отправляет HTTP-запрос к веб-API с тем же полным доменным именем, что и у надстройки. Этот запрос включает **маркер доступа к начальной загрузке** в качестве подтверждения авторизации.</span><span class="sxs-lookup"><span data-stu-id="2395b-126">JavaScript in the add-in makes an HTTP request to a web API that is hosted at the same fully-qualified domain as the add-in, and it includes the **bootstrap access token** as authorization proof.</span></span>
8. <span data-ttu-id="2395b-127">Серверный код проверяет входящий **маркер доступа к начальной загрузке**.</span><span class="sxs-lookup"><span data-stu-id="2395b-127">Server-side code validates the incoming **bootstrap access token**.</span></span>
9. <span data-ttu-id="2395b-128">Серверный код использует для получения маркера доступа к начальной загрузке маркер "от имени" (определенный на сервере [OAuth2 Token](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) ), а также [сценарий демона или серверное приложение для веб-API Azure](/azure/active-directory/develop/active-directory-authentication-scenarios)) для получения маркера доступа для Microsoft Graph в Exchange.</span><span class="sxs-lookup"><span data-stu-id="2395b-128">Server-side code uses the "on behalf of" flow (defined at [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) and the [daemon or server application to web API Azure scenario](/azure/active-directory/develop/active-directory-authentication-scenarios)) to obtain an access token for Microsoft Graph in exchange for the bootstrap access token.</span></span>
10. <span data-ttu-id="2395b-129">Azure AD возвращает надстройке маркер доступа в Microsoft Graph (и маркер обновления, если надстройка запрашивает разрешение *offline_access*).</span><span class="sxs-lookup"><span data-stu-id="2395b-129">Azure AD returns the access token to Microsoft Graph (and a refresh token, if the add-in requests *offline_access* permission) to the add-in.</span></span>
11. <span data-ttu-id="2395b-130">Серверный код кэширует маркер доступа в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-130">Server-side code caches the access token to Microsoft Graph.</span></span>
12. <span data-ttu-id="2395b-131">Серверный код отправляет запросы к Microsoft Graph и включает маркер доступа в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-131">Server-side code makes requests to Microsoft Graph and includes the access token to Microsoft Graph.</span></span>
13. <span data-ttu-id="2395b-132">Microsoft Graph возвращает данные в надстройку, которая может передать ее в пользовательский интерфейс надстройки.</span><span class="sxs-lookup"><span data-stu-id="2395b-132">Microsoft Graph returns data to the add-in, which can pass it on to the add-in's UI.</span></span>
14. <span data-ttu-id="2395b-133">Когда маркер доступа в Microsoft Graph истекает, серверный код может использовать свой маркер обновления, чтобы получить новый маркер доступа в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-133">When the access token to Microsoft Graph expires, the server-side code can use its refresh token to get a new access token to Microsoft Graph.</span></span>

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a><span data-ttu-id="2395b-134">Разработка надстройки с единым входом для Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="2395b-134">Develop an SSO add-in that accesses Microsoft Graph</span></span>

<span data-ttu-id="2395b-135">Надстройка с доступом в Microsoft Graph разрабатывается так же, как и любая другая надстройка с единым входом.</span><span class="sxs-lookup"><span data-stu-id="2395b-135">You develop an add-in that accesses Microsoft Graph just as you would any other add-in that uses SSO.</span></span> <span data-ttu-id="2395b-136">Подробное описание см. в статье [Включение единого входа для надстроек Office](../develop/sso-in-office-add-ins.md). Разница заключается в том, что у надстройки обязательно должен быть серверный веб-API, а также в использовании термина "маркер доступа к начальной загрузке" вместо термина "маркер доступа" из указанной статьи.</span><span class="sxs-lookup"><span data-stu-id="2395b-136">For a thorough description, see [Enable single sign-on for Office Add-ins](../develop/sso-in-office-add-ins.md). The difference is that it is mandatory that the add-in have a server-side Web API, and what's called the access token in that article is called the "bootstrap access token."</span></span>

<span data-ttu-id="2395b-137">В зависимости от языка и платформы могут быть доступны библиотеки, которые упростят создание серверного кода.</span><span class="sxs-lookup"><span data-stu-id="2395b-137">Depending on your language and framework, libraries might be available that will simplify the server-side code you have to write.</span></span> <span data-ttu-id="2395b-138">Ваш код должен выполнять следующее:</span><span class="sxs-lookup"><span data-stu-id="2395b-138">Your code should do the following:</span></span>

* <span data-ttu-id="2395b-139">Инициируйте потоки "от имени" с вызовом конечной точки Azure AD версии 2.0, которая включает маркер доступа к начальной загрузке, некоторые метаданные пользователя и учетные данные надстройки (ее идентификатор и секрет).</span><span class="sxs-lookup"><span data-stu-id="2395b-139">Initiate the "on behalf of" flow with a call to the Azure AD v2.0 endpoint that includes the bootstrap access token, some metadata about the user, and the credentials of the add-in (its ID and secret).</span></span>
* <span data-ttu-id="2395b-140">создать один или несколько методов веб-API, которые получают данные Microsoft Graph, передавая (возможно кэшированный) маркер доступа в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-140">Create one or more Web API methods that get Microsoft Graph data by passing the (possibly cached) access token to Microsoft Graph.</span></span>
* <span data-ttu-id="2395b-141">при необходимости перед запуском потока проверять маркер доступа к начальной загрузке надстройки, полученный от созданного ранее обработчика маркеров.</span><span class="sxs-lookup"><span data-stu-id="2395b-141">Optionally, before initiating the flow, validate the add-in bootstrap access token that is received from the token handler you created earlier.</span></span> <span data-ttu-id="2395b-142">Дополнительные сведения см. в разделе [Проверка маркера доступа](sso-in-office-add-ins.md#validate-the-access-token);</span><span class="sxs-lookup"><span data-stu-id="2395b-142">For more information, see [Validate the access token](sso-in-office-add-ins.md#validate-the-access-token).</span></span> 
* <span data-ttu-id="2395b-143">при необходимости после завершения потока поместить в кэш возвращенный маркер доступа к Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-143">Optionally, after the flow completes, cache the returned access token to Microsoft Graph.</span></span> <span data-ttu-id="2395b-144">Это рекомендуется делать, если надстройка выполняет несколько вызовов в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="2395b-144">You'll want to do this if the add-in makes more than one call to Microsoft Graph.</span></span> <span data-ttu-id="2395b-145">Дополнительные сведения об этом потоке см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of);</span><span class="sxs-lookup"><span data-stu-id="2395b-145">For more information about this flow see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

> [!NOTE]
> <span data-ttu-id="2395b-146">Примеры раскодированных маркеров доступа в Microsoft Graph, которые были получены потоком "от имени", см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span><span class="sxs-lookup"><span data-stu-id="2395b-146">For examples of decoded access tokens for Microsoft Graph that have been obtained by the "on-behalf-of" flow, see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

<span data-ttu-id="2395b-147">Подробные пошаговые инструкции и сценарии см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="2395b-147">For examples of detailed walkthroughs and scenarios, see:</span></span>

* [<span data-ttu-id="2395b-148">Создание надстройки Office на платформе Node.js с использованием единого входа</span><span class="sxs-lookup"><span data-stu-id="2395b-148">Create a Node.js Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-nodejs.md)
* [<span data-ttu-id="2395b-149">Создание надстройки Office на платформе ASP.NET с использованием единого входа</span><span class="sxs-lookup"><span data-stu-id="2395b-149">Create an ASP.NET Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-aspnet.md)
* [<span data-ttu-id="2395b-150">Сценарий: реализация единого входа для службы в надстройке Outlook</span><span class="sxs-lookup"><span data-stu-id="2395b-150">Scenario: Implement single sign-on to your service in an Outlook add-in</span></span>](../outlook/implement-sso-in-outlook-add-in.md)
