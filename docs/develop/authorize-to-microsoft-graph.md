---
title: Авторизация в Microsoft Graph с помощью единого входа
description: Узнайте, как пользователи надстройки Office могут использовать единый вход для получения данных из Microsoft Graph.
ms.date: 07/30/2020
localization_priority: Normal
ms.openlocfilehash: d6d06b9d7ff42b72495f513ed2c6b8f6f36df1d0
ms.sourcegitcommit: d28392721958555d6edea48cea000470bd27fcf7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "49839973"
---
# <a name="authorize-to-microsoft-graph-with-sso"></a>Авторизация в Microsoft Graph с помощью единого входа

Пользователи входят в Office (в Интернете, на мобильных устройствах и настольных компьютерах), используя личную учетную запись Майкрософт, учетную запись Microsoft 365 для образования или рабочую учетную запись. Чтобы надстройка Office могла получить авторизованный доступ к [Microsoft Graph](https://developer.microsoft.com/graph/docs), лучше всего использовать учетные данные для входа пользователя в Office. Это позволяет пользователям получить доступ к своим данным Microsoft Graph без необходимости повторного входа.

> [!NOTE]
> API единого входа в настоящее время поддерживается для Word, Excel, Outlook и PowerPoint. Дополнительные сведения о текущей поддержке API единого входа см. в статье [Наборы обязательных элементов API идентификации](../reference/requirement-sets/identity-api-requirement-sets.md).
> Если вы работаете с надстройкой Outlook, обязательно включите современную проверку подлинности для клиента Office 365. Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a>Архитектура надстройки для единого входа и Microsoft Graph

Помимо страниц и кода JavaScript веб-приложения, в надстройке также должны размещаться (с тем же [полным доменном именем](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)) один или несколько веб-API, которые будут получать маркер доступа и отправлять запросы к Microsoft Graph.

Манифест надстройки содержит разметку, которая указывает, как надстройка регистрируется в конечной точке Azure Active Directory (Azure AD) версии 2.0, а также задает необходимые надстройке разрешения для Microsoft Graph.

### <a name="how-it-works-at-runtime"></a>Принцип работы во время выполнения

На приведенной ниже схеме показан процесс входа в систему и получения доступа к Microsoft Graph.

![Схема, показывающая процесс SSO](../images/sso-access-to-microsoft-graph.png)

1. Код JavaScript надстройки вызывает новый API Office.js — [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-). Он указывает клиентскому приложению Office, что необходимо получить маркер доступа к надстройке. (Далее он будет называться **маркером доступа к начальной загрузке**, поскольку в этом процессе он позже будет заменен вторым маркером. Пример раскодированного маркера доступа к начальной загрузке см. в разделе [Пример маркера доступа](sso-in-office-add-ins.md#example-access-token)).
2. Если вход в Office не выполнен, в клиентском приложении открывается всплывающее окно, в котором пользователю предлагается войти.
3. Если пользователь запускает надстройку в первый раз, ему предлагается дать согласие.
4. Клиентские приложения Office запрашивают маркер доступа **к** загрузке из конечной точки Azure AD 2.0 для текущего пользователя.
5. Azure AD отправляет маркер загрузки клиентского приложения Office.
6. Клиентские приложения Office отправляет маркер доступа **к** загрузке надстройке как часть объекта результата, возвращенного `getAccessToken` вызовом.
7. Код JavaScript надстройки отправляет HTTP-запрос к веб-API с тем же полным доменным именем, что и у надстройки. Этот запрос включает **маркер доступа к начальной загрузке** в качестве подтверждения авторизации.
8. Серверный код проверяет входящий **маркер доступа к начальной загрузке**.
9. Серверный код использует поток "от имени" (определенный в exchange маркера [OAuth2](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) и сценарии программы или серверного приложения для [веб-API Azure)](/azure/active-directory/develop/active-directory-authentication-scenarios)для получения маркера доступа для Microsoft Graph в обмен на маркер доступа к первой загрузке.
10. Azure AD возвращает надстройке маркер доступа в Microsoft Graph (и маркер обновления, если надстройка запрашивает разрешение *offline_access*).
11. Серверный код кэширует маркер доступа в Microsoft Graph.
12. Серверный код отправляет запросы к Microsoft Graph и включает маркер доступа в Microsoft Graph.
13. Microsoft Graph возвращает данные надстройки, которые могут передавать их в пользовательский интерфейс надстройки.
14. Когда маркер доступа в Microsoft Graph истекает, серверный код может использовать свой маркер обновления, чтобы получить новый маркер доступа в Microsoft Graph.

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a>Разработка надстройки с единым входом для Microsoft Graph

Надстройка с доступом в Microsoft Graph разрабатывается так же, как и любая другая надстройка с единым входом. Подробное описание см. в статье [Включение единого входа для надстроек Office](../develop/sso-in-office-add-ins.md). Разница заключается в том, что у надстройки обязательно должен быть серверный веб-API, а также в использовании термина "маркер доступа к начальной загрузке" вместо термина "маркер доступа" из указанной статьи.

В зависимости от языка и платформы могут быть доступны библиотеки, которые упростят создание серверного кода. Ваш код должен выполнять следующее:

* Инициировать поток "от имени" с помощью вызова конечной точки Azure AD 2.0, которая включает маркер доступа к началу загрузки, некоторые метаданные о пользователе и учетные данные надстройки (ее ИД и секрет).
* создать один или несколько методов веб-API, которые получают данные Microsoft Graph, передавая (возможно кэшированный) маркер доступа в Microsoft Graph.
* при необходимости перед запуском потока проверять маркер доступа к начальной загрузке надстройки, полученный от созданного ранее обработчика маркеров. Дополнительные сведения см. в разделе [Проверка маркера доступа](sso-in-office-add-ins.md#validate-the-access-token); 
* при необходимости после завершения потока поместить в кэш возвращенный маркер доступа к Microsoft Graph. Это рекомендуется делать, если надстройка выполняет несколько вызовов в Microsoft Graph. Дополнительные сведения об этом потоке см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of);

> [!NOTE]
> Примеры раскодированных маркеров доступа в Microsoft Graph, которые были получены потоком "от имени", см. в статье [Azure Active Directory версии 2.0 и поток "от имени" OAuth 2.0](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).

Подробные пошаговые инструкции и сценарии см. в следующих статьях:

* [Создание надстройки Office на платформе Node.js с использованием единого входа](create-sso-office-add-ins-nodejs.md)
* [Создание надстройки Office на платформе ASP.NET с использованием единого входа](create-sso-office-add-ins-aspnet.md)
* [Сценарий: реализация единого входа для службы в надстройке Outlook](../outlook/implement-sso-in-outlook-add-in.md)

## <a name="distributing-sso-enabled-add-ins-in-microsoft-appsource"></a>Распространение надстройок с поддержкой SSO в Microsoft AppSource

Когда администратор Microsoft 365 приобретает надстройку в [AppSource,](https://appsource.microsoft.com)администратор [](../publish/centralized-deployment.md) может перераспределить ее путем централизованного развертывания и предоставить надстройке согласие администратора на доступ к области Microsoft Graph. Однако конечный пользователь также может приобрести надстройки непосредственно в AppSource, в этом случае пользователь должен предоставить надстройке согласие. Это может создать потенциальную проблему производительности, для которой мы предоставили решение.

Если код передает параметр в вызове , например , Office может запросят у пользователя согласие, если Azure AD сообщает Office, что согласие еще не предоставлено `allowConsentPrompt` `getAccessToken` надстройки. `OfficeRuntime.auth.getAccessToken( { allowConsentPrompt: true } );` Однако из соображений безопасности Office может только побудить пользователя согласиться на использование области Azure `profile` AD. *Office не может запросят согласие на какие-либо области Microsoft Graph,* даже `User.Read` . Это означает, что если пользователь даст согласие на запрос, Office возвратит маркер загрузки. Однако попытка обменять маркер загрузки на маркер доступа в Microsoft Graph не удалась с ошибкой AADSTS65001, что означает, что согласие (для областей Microsoft Graph) не было предоставлено.

Ваш код может и должен обрабатывать эту ошибку, возвращаясь к альтернативной системе проверки подлинности, которая запросит у пользователя согласие на разрешение областей Microsoft Graph. (Примеры кода см. в примерах создания надстройки [Office Node.js,](create-sso-office-add-ins-nodejs.md) использующей единый вход, и надстройки [Office ASP.NET,](create-sso-office-add-ins-aspnet.md) использующей единый вход и примеры, на которые они ссылались.) Но для всего процесса требуется несколько кругов в Azure AD. Это можно избежать, включив параметр в вызов `forMSGraphAccess` `getAccessToken` ; например, `OfficeRuntime.auth.getAccessToken( { forMSGraphAccess: true } )` .  Это сообщает Office, что надстройка нуждается в области Microsoft Graph. Office попросит Azure AD проверить, предоставлено ли надстройка согласие на использование областей Microsoft Graph. Если он есть, возвращается маркер загрузки. Если этого не сделать, вызов возвратит `getAccessToken` ошибку 13012. Код может обработать эту ошибку, сразу же вернувшись к альтернативной системе проверки подлинности без попытки обмена маркерами с Azure AD.

Лучше всего всегда передавать, когда ваша надстройка будет распространяться в AppSource и ей нужны `forMSGraphAccess` `getAccessToken` области Microsoft Graph.

> [!TIP]
> Если вы разрабатываете надстройку Outlook, использующую службу SSO, и добавляете ее для тестирования, Office всегда возвращает ошибку 13012, даже если согласие администратора было  `forMSGraphAccess` `getAccessToken` предоставлено. По этой причине при разработке надстройки Outlook следует закоммент путь `forMSGraphAccess` к этому  параметру. При развертывании в производственной реализации обязательно списайтесь с этого параметра. Неоконка 13012 происходит только при загрузке неогрузки в Outlook.