---
title: Авторизация в Microsoft Graph с помощью единого входа
description: Узнайте, как пользователи надстройки Office могут использовать один вход (SSO) для получения данных из Microsoft Graph.
ms.date: 01/25/2022
ms.localizationpriority: medium
ms.openlocfilehash: 1dbe52d9fb4e223052d92249bb98311e91bd665d
ms.sourcegitcommit: 287a58de82a09deeef794c2aa4f32280efbbe54a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2022
ms.locfileid: "64496770"
---
# <a name="authorize-to-microsoft-graph-with-sso"></a>Авторизация в Microsoft Graph с помощью единого входа

Пользователи входят в Office (в Интернете, на мобильных устройствах и настольных компьютерах), используя личную учетную запись Майкрософт, учетную запись Microsoft 365 для образования или рабочую учетную запись. Чтобы надстройка Office могла получить авторизованный доступ к [Microsoft Graph](https://developer.microsoft.com/graph/docs), лучше всего использовать учетные данные для входа пользователя в Office. Это позволяет пользователям получить доступ к своим данным Microsoft Graph без необходимости повторного входа.

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a>Архитектура надстройки для единого входа и Microsoft Graph

Помимо страниц и кода JavaScript веб-приложения, в надстройке также должны размещаться (с тем же [полным доменном именем](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)) один или несколько веб-API, которые будут получать маркер доступа и отправлять запросы к Microsoft Graph.

Манифест надстройки содержит элемент **WebApplicationInfo**, который предоставляет важные сведения о регистрации приложений Azure для Office, включая разрешения microsoft Graph, которые требуется надстройка.

### <a name="how-it-works-at-runtime"></a>Принцип работы во время выполнения

На следующей схеме показаны действия, связанные с входом и доступом к microsoft Graph. Весь процесс использует маркеры доступа OAuth 2.0 и JWT.

:::image type="content" source="../images/sso-access-to-microsoft-graph.svg" alt-text="Схема, показывающая процесс SSO." border="false":::

1. Клиентский код надстройки вызывает Office.js API [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)). В этом Office для получения маркера доступа для надстройки.

    Если пользователь не подписан, Office вместе с платформа удостоверений Майкрософт предоставляет пользовательский интерфейс для входов и согласия пользователя.

2. В Office хост запрашивает маркер доступа из платформа удостоверений Майкрософт.
3. Этот платформа удостоверений Майкрософт возвращает маркер доступа *A* на Office хост. Маркер доступа *А* предоставляет доступ только к собственным API сервера надстройки. Он не предоставляет доступ к microsoft Graph.
4. Ведущий Office возвращает маркер доступа *A* в клиентский код надстройки. Теперь клиентский код может делать аутентификацию вызовов на API на стороне сервера.
5. Клиентский код делает ЗАПРОС HTTP в веб-API на стороне сервера, который требует проверки подлинности. Он включает маркер доступа *A в* качестве доказательства авторизации. Серверный код проверяет маркер доступа *A*.
6. Серверный код использует поток OAuth 2.0 On-Behalf-Of (OBO) для запроса нового маркера доступа с разрешениями для Microsoft Graph.
7. В платформа удостоверений Майкрософт возвращается новый маркер доступа *B* с разрешениями в Microsoft Graph (и маркером обновления, если запросы *надстройки offline_access* разрешения). Сервер может необязательный кэш маркер доступа *B*.
8. Серверный код делает запрос в API microsoft Graph и включает маркер доступа *B* с разрешениями на microsoft Graph.
9. Корпорация Graph возвращает данные обратно в серверный код.
10. Код на стороне сервера возвращает данные обратно в клиентский код.

При последующих запросах клиентский код всегда передает маркер доступа *A* при проверке подлинности на серверный код. Серверный код может кэшировать маркер *B* , чтобы не было необходимости повторно запрашивать его при будущих вызовах API.

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a>Разработка надстройки с единым входом для Microsoft Graph

Вы разрабатываете надстройка, которая Graph microsoft Graph как и любое другое приложение, использующее SSO. Подробное описание см. в документе [Enable single sign-on for Office надстройки](../develop/sso-in-office-add-ins.md). Разница в том, что надстройка обязательно имеет веб-API на стороне сервера.

В зависимости от языка и платформы могут быть доступны библиотеки, которые упростят создание серверного кода. Ваш код должен выполнять следующее:

* Проверка маркера *доступа A* каждый раз, когда он передается из клиентского кода. Дополнительные сведения см. в разделе [Проверка маркера доступа](sso-in-office-add-ins.md#pass-the-access-token-to-server-side-code);
* Инициировать поток OAuth 2.0 On-Behalf-Of (OBO) с вызовом в платформа удостоверений Майкрософт, который включает маркер доступа, некоторые метаданные о пользователе и учетные данные надстройки (ее ID и секрет). Дополнительные сведения о потоке OBO см. в [платформа удостоверений Майкрософт и OAuth 2.0 On-Behalf-Of flow](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow).
* По желанию после завершения потока кэшировали возвращенный маркер *доступа B* с разрешениями в Microsoft Graph. Это рекомендуется делать, если надстройка выполняет несколько вызовов в Microsoft Graph. Дополнительные сведения см. в том, как приобрести маркеры и кэширование с помощью Библиотеки проверки подлинности Майкрософт [(MSAL)](/azure/active-directory/develop/msal-acquire-cache-tokens)
* Создайте один или несколько методов веб-API, которые Graph данные Microsoft, передав маркер доступа *B* (возможно кэш) Microsoft Graph.

Подробные пошаговые инструкции и сценарии см. в следующих статьях:

* [Создание надстройки Office на платформе Node.js с использованием единого входа](create-sso-office-add-ins-nodejs.md)
* [Создание надстройки Office на платформе ASP.NET с использованием единого входа](create-sso-office-add-ins-aspnet.md)
* [Сценарий: реализация единого входа для службы в надстройке Outlook](../outlook/implement-sso-in-outlook-add-in.md)

## <a name="distributing-sso-enabled-add-ins-in-microsoft-appsource"></a>Распространение надстройок с поддержкой SSO в Microsoft AppSource

Когда Microsoft 365 получает надстройку из [AppSource](https://appsource.microsoft.com), администратор может перераспределить ее через интегрированные приложения и предоставить [](/microsoft-365/admin/manage/test-and-deploy-microsoft-365-apps) администратору согласие на надстройку для доступа к microsoft Graph области. Однако конечному пользователю также возможно приобрести надстройки непосредственно из AppSource, в этом случае пользователь должен предоставить согласие на надстройки. Это может создать потенциальную проблему производительности, для которой мы предоставили решение.

`allowConsentPrompt` `getAccessToken`Если код передает параметр в вызове , `OfficeRuntime.auth.getAccessToken( { allowConsentPrompt: true } );`например , Office может вызвать пользователя на согласие, если платформа удостоверений Майкрософт сообщает Office, что согласие еще не было предоставлено надстройки. Однако по соображениям безопасности Office `profile` только побудить пользователя дать согласие на Graph microsoft. *Office не может подсказить согласие на другие области Microsoft Graph*, даже `User.Read`не . Это означает, что если пользователь дает согласие на запрос, Office возвращает маркер доступа. Но попытка обмена маркера доступа на новый маркер доступа с дополнительными областьми Microsoft Graph не удалась с ошибкой AADSTS65001, что означает, что согласие (для областей Microsoft Graph) не было предоставлено.

> [!NOTE]
> Запрос на согласие с может `{ allowConsentPrompt: true }` по-прежнему не получиться даже для `profile` области, если администратор отключил согласие пользователя. Дополнительные сведения см. в [приложении Configure how end-users consent to applications using Azure Active Directory](/azure/active-directory/manage-apps/configure-user-consent).

Ваш код может и должен обрабатывать эту ошибку, возвращаясь к альтернативной системе проверки подлинности, которая побуждает пользователя к согласию на microsoft Graph области. В примерах кода см. создание [надстройки Node.js Office](create-sso-office-add-ins-nodejs.md), использующей один вход и [создайте](create-sso-office-add-ins-aspnet.md) надстройку ASP.NET Office, которая использует один вход и примеры, к которые они ссылались. Весь процесс требует нескольких поездок в платформа удостоверений Майкрософт. Чтобы избежать этого штрафа за производительность, включи `forMSGraphAccess` параметр в вызов `getAccessToken`; например, `OfficeRuntime.auth.getAccessToken( { forMSGraphAccess: true } )`. Это сигнализирует Office, что надстройка нуждается в microsoft Graph области. Office запросит платформа удостоверений Майкрософт, чтобы убедиться, что Graph microsoft Graph области уже предоставлены надстройки. Если он есть, маркер доступа возвращается. Если этого не сделать, то вызов `getAccessToken` ошибки 13012 возвращает. Код может обрабатывать эту ошибку, возвращаясь к альтернативной системе проверки подлинности немедленно, не делая обреченной попытки обмена маркерами с помощью платформа удостоверений Майкрософт.

В качестве наилучшей практики `forMSGraphAccess` `getAccessToken` всегда передайте, когда надстройка будет распространяться в AppSource и нуждается в microsoft Graph области.

## <a name="details-on-sso-with-an-outlook-add-in"></a>Сведения о SSO с Outlook надстройки

Если вы разрабатываете надстройку Outlook, которая использует SSO, и вы ее перегружаетесь для тестирования, Office всегда возвращает  ошибку 13012 `forMSGraphAccess` `getAccessToken`, когда передается, даже если согласие администратора было предоставлено. По этой причине при разработке надстройки `forMSGraphAccess` необходимо  Outlook параметр. Не забудьте отостановить параметр при развертывании для производства. Фиктивный 13012 происходит только при загрузке Outlook.

Чтобы Outlook надстройки, не забудьте включить современную проверку подлинности для Microsoft 365 аренды. Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).

## <a name="see-also"></a>См. также

* [Маркер OAuth2 Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02)
* [Платформа удостоверений Майкрософт и поток OBO OAuth 2.0](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow)
* [Наборы требований IdentityAPI](/javascript/api/requirement-sets/common/identity-api-requirement-sets)
