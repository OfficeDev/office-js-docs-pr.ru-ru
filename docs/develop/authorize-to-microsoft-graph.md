---
title: Авторизация в Microsoft Graph с помощью единого входа
description: Узнайте, как пользователи надстройки Office могут использовать единый вход (SSO) для получения данных из Microsoft Graph.
ms.date: 06/10/2022
ms.localizationpriority: medium
ms.openlocfilehash: 4ecb945dcd99400065fde3e80e8b60d67266e0b1
ms.sourcegitcommit: 4ba5f750358c139c93eb2170ff2c97322dfb50df
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2022
ms.locfileid: "66659649"
---
# <a name="authorize-to-microsoft-graph-with-sso"></a>Авторизация в Microsoft Graph с помощью единого входа

Войдите в Office с помощью личной учетной записи Майкрософт или своей Microsoft 365 для образования или рабочей учетной записи. Чтобы надстройка Office могла получить авторизованный доступ к [Microsoft Graph](https://developer.microsoft.com/graph/docs), лучше всего использовать учетные данные для входа пользователя в Office. Это позволяет пользователям получить доступ к своим данным Microsoft Graph без необходимости повторного входа.

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a>Архитектура надстройки для единого входа и Microsoft Graph

Помимо страниц и кода JavaScript веб-приложения, в надстройке также должны размещаться (с тем же [полным доменном именем](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)) один или несколько веб-API, которые будут получать маркер доступа и отправлять запросы к Microsoft Graph.

Манифест надстройки **\<WebApplicationInfo\>** содержит элемент, предоставляющий важные сведения о регистрации приложений Azure для Office, включая разрешения для Microsoft Graph, необходимые надстройке.

### <a name="how-it-works-at-runtime"></a>Принцип работы во время выполнения

На следующей схеме показаны шаги, необходимые для входа и доступа к Microsoft Graph. Весь процесс использует маркеры доступа OAuth 2.0 и JWT.

:::image type="content" source="../images/sso-access-to-microsoft-graph.svg" alt-text="Схема, показывающая процесс единого входа." border="false":::

1. Клиентский код надстройки вызывает Office.js API [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#office-runtime-officeruntime-auth-getaccesstoken-member(1)). Это указывает узлу Office получить маркер доступа для надстройки.

    Если пользователь не выполнил вход, хост Office в сочетании с платформа удостоверений Майкрософт предоставляет пользовательский интерфейс для входа и согласия пользователя.

2. Хост-сервер Office запрашивает маркер доступа от платформа удостоверений Майкрософт.
3. Объект платформа удостоверений Майкрософт возвращает маркер доступа *A* узлу Office. Маркер доступа *A* предоставляет доступ только к собственным интерфейсам API на стороне сервера надстройки. Он не предоставляет доступ к Microsoft Graph.
4. Хост Office возвращает маркер *доступа A* в клиентский код надстройки. Теперь клиентский код может выполнять вызовы, прошедшие проверку подлинности, к интерфейсам API на стороне сервера.
5. Клиентский код выполняет HTTP-запрос к веб-API на стороне сервера, который требует проверки подлинности. Он включает маркер доступа *A в* качестве подтверждения авторизации. Серверный код проверяет маркер доступа *A*.
6. Серверный код использует поток on-Behalf-Of (OBO) OAuth 2.0 для запроса нового маркера доступа с разрешениями для Microsoft Graph.
7. Этот платформа удостоверений Майкрософт возвращает новый маркер доступа *Б* с *разрешениями* на доступ к Microsoft Graph (и маркер обновления, если надстройка запрашивает offline_access разрешения). При необходимости сервер может кэшировать маркер доступа *B*.
8. Серверный код выполняет запрос к microsoft API Graph и включает маркер доступа *B* с разрешениями на Microsoft Graph.
9. Microsoft Graph возвращает данные обратно в серверный код.
10. Серверный код возвращает данные обратно в код на стороне клиента.

При последующих запросах клиентский код всегда передает маркер доступа *A* при выполнении вызовов, прошедших проверку подлинности, в серверный код. Серверный код может кэшировать маркер *Б* , чтобы не запрашивать его повторно при последующих вызовах API.

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a>Разработка надстройки с единым входом для Microsoft Graph

Вы разрабатываете надстройку, которая будет получать доступ к Microsoft Graph так же, как и любое другое приложение, использующее единый вход. Подробное описание см. в статье ["Включение единого входа для надстроек Office"](../develop/sso-in-office-add-ins.md). Разница заключается в том, что надстройка должна иметь веб-API на стороне сервера.

В зависимости от языка и платформы могут быть доступны библиотеки, которые упростят создание серверного кода. Ваш код должен выполнять следующее:

* Проверяйте маркер доступа *A* каждый раз, когда он передается из клиентского кода. Дополнительные сведения см. в разделе [Проверка маркера доступа](sso-in-office-add-ins.md#pass-the-access-token-to-server-side-code);
* Запустите поток OAuth 2.0 On-Behalf-Of (OBO) с вызовом платформа удостоверений Майкрософт, который включает маркер доступа, некоторые метаданные о пользователе и учетные данные надстройки (ее идентификатор и секрет). Дополнительные сведения о потоке OBO см. в платформа удостоверений Майкрософт [и потоке on-Behalf-Of oAuth 2.0](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow).
* При необходимости после завершения потока кэшируйте возвращенный маркер *доступа B* с разрешениями для Microsoft Graph. Это рекомендуется делать, если надстройка выполняет несколько вызовов в Microsoft Graph. Дополнительные сведения см. в [статье "Получение и кэширование маркеров с помощью библиотеки проверки подлинности Майкрософт (MSAL)".](/azure/active-directory/develop/msal-acquire-cache-tokens)
* Создайте один или несколько методов веб-API, которые получают данные Microsoft Graph, передав (возможно, кэшированный) маркер *доступа B* в Microsoft Graph.

Подробные пошаговые инструкции и сценарии см. в следующих статьях:

* [Создание надстройки Office на платформе Node.js с использованием единого входа](create-sso-office-add-ins-nodejs.md)
* [Создание надстройки Office на платформе ASP.NET с использованием единого входа](create-sso-office-add-ins-aspnet.md)
* [Сценарий: реализация единого входа для службы в надстройке Outlook](../outlook/implement-sso-in-outlook-add-in.md)

## <a name="distributing-sso-enabled-add-ins-in-microsoft-appsource"></a>Распространение надстроек с поддержкой единого входа в Microsoft AppSource

Когда администратор Microsoft 365 получает надстройку из [AppSource](https://appsource.microsoft.com), он может повторно распространить ее через интегрированные приложения и [](/microsoft-365/admin/manage/test-and-deploy-microsoft-365-apps) предоставить согласие администратора надстройке для доступа к областям Microsoft Graph. Однако конечный пользователь также может получить надстройку непосредственно из AppSource. В этом случае пользователь должен предоставить согласие на надстройку. Это может создать потенциальную проблему с производительностью, для которой мы предоставили решение.

Если код `allowConsentPrompt` `getAccessToken``OfficeRuntime.auth.getAccessToken( { allowConsentPrompt: true } );`передает параметр в вызове , например, Office может предложить пользователю предоставить согласие, если платформа удостоверений Майкрософт сообщает Office, что согласие еще не было предоставлено надстройке. Однако из соображений безопасности Office может запрашивать у пользователя только согласие на область Microsoft Graph `profile` . *Office не может запрашивать согласие на другие области Microsoft Graph*, даже `User.Read`. Это означает, что если пользователь предоставляет согласие на запрос, Office возвращает маркер доступа. Однако попытка обмена маркера доступа на новый маркер доступа с дополнительными областями Microsoft Graph завершается ошибкой AADSTS65001. Это означает, что согласие (для областей Microsoft Graph) не было предоставлено.

> [!NOTE]
> Запрос на предоставление согласия по-прежнему `{ allowConsentPrompt: true }` может завершиться ошибкой даже `profile` для области, если администратор отключил согласие конечного пользователя. Дополнительные сведения см. в разделе ["Настройка согласия конечных пользователей на приложения с помощью Azure Active Directory"](/azure/active-directory/manage-apps/configure-user-consent).

Код может и должен обрабатывать эту ошибку путем возврата к альтернативной системе проверки подлинности, которая запрашивает у пользователя согласие на использование областей Microsoft Graph. Примеры кода см. в статье ["Создание](create-sso-office-add-ins-nodejs.md) надстройки Office Node.js, использующей единый вход", и создание надстройки [Office ASP.NET](create-sso-office-add-ins-aspnet.md) , использующей единый вход, и примеры, на которые они ссылались. Для всего процесса требуется несколько круговых путей к платформа удостоверений Майкрософт. Чтобы избежать этого штрафа за производительность, включите `forMSGraphAccess` параметр в вызов , `OfficeRuntime.auth.getAccessToken( { forMSGraphAccess: true } )`например `getAccessToken`. Это сигнализирует Office о том, что надстройке требуются области Microsoft Graph. Office предложит платформа удостоверений Майкрософт убедиться, что надстройке уже предоставлено согласие на доступ к областям Microsoft Graph. Если он есть, возвращается маркер доступа. Если это не так, `getAccessToken` вызов возвращает ошибку 13012. Код может обработать эту ошибку, немедленно вернувшись к альтернативной системе проверки подлинности без попытки обмена маркерами с платформа удостоверений Майкрософт.

Рекомендуется всегда передавать сведения о том, `forMSGraphAccess` `getAccessToken` когда надстройка будет распространяться в AppSource и для нее требуются области Microsoft Graph.

## <a name="details-on-sso-with-an-outlook-add-in"></a>Сведения о едином входе в надстройке Outlook

Если вы разрабатываете надстройку Outlook, которая использует единый вход и загружена неопубликованно  для тестирования, Office всегда возвращает ошибку 13012 `forMSGraphAccess` `getAccessToken` при передаче, даже если предоставлено согласие администратора. По этой причине следует закомментировать `forMSGraphAccess` параметр **при** разработке надстройки Outlook. Не забудьте раскомментировать параметр при развертывании в рабочей области. Ошибка 13012 возникает только при загрузке неопубликованных приложений в Outlook.

Для надстроек Outlook включите современную проверку подлинности для клиента Microsoft 365. Сведения о том, как это сделать, см. в статье [Exchange Online: как включить в клиенте современную проверку подлинности](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).

## <a name="see-also"></a>См. также

* [Обмен маркерами OAuth2](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02)
* [Платформа удостоверений Майкрософт и поток OBO OAuth 2.0](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow)
* [Наборы обязательных элементов IdentityAPI](/javascript/api/requirement-sets/common/identity-api-requirement-sets)
