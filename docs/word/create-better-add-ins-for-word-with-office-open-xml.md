---
title: Создание надстроек Word с помощью Office Open XML
description: ''
ms.date: 03/19/2019
localization_priority: Priority
ms.openlocfilehash: e13911da0dbdb9fdb0215d433a9559bf1b747eb9
ms.sourcegitcommit: a2950492a2337de3180b713f5693fe82dbdd6a17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2019
ms.locfileid: "30872146"
---
# <a name="create-better-add-ins-for-word-with-office-open-xml"></a>Создание надстроек Word с помощью Office Open XML

**Источник:** Стефани Кригер, корпорация Майкрософт | Хуан Балмори Лабра, корпорация Майкрософт

Если вы разрабатываете надстройки Office для Word, возможно, вы уже знаете, что API JavaScript для Office (Office.js) предлагает несколько форматов для чтения и записи содержимого документов. Они называются типами приведения, и к ним относятся обычный текст, таблицы, HTML и Office Open XML.

Итак, что вы можете сделать, если вам нужно добавить в документ форматированный контент, например изображения, форматированные таблицы, диаграммы или просто форматированный текст? Вы можете использовать код HTML для вставки форматированного содержимого некоторых типов, например изображений. В некоторых случаях вам может быть недостаточно возможностей форматирования и размещения содержимого, предоставляемых HTML. Так как Office Open XML — это язык документов Word (например, DOCX и DOTX), вы можете вставить практически любое содержимое, которое пользователь может добавить в документ Word, с практически любым форматированием. Определить необходимую разметку Office Open XML проще, чем кажется.

> [!NOTE]
> Office Open XML — это также язык документов PowerPoint и Excel (а начиная с Office 2013 — и документов Visio). Однако сейчас приводить содержимое в формат Office Open XML можно только в надстройках Office, созданных для Word. Дополнительные сведения об Office Open XML, в том числе полную справочную документацию о языке, см. в разделе [Дополнительные ресурсы](#see-also).

Для начала ознакомьтесь с некоторыми типами содержимого, которые можно вставить с помощью приведения Office Open XML. Скачайте пример кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML), который содержит разметку Office Open XML и код Office.js, необходимые для вставки любого из приведенных ниже примеров в Word.

> [!NOTE]
> В этой статье термины **типы контента** и **форматированный контент** относятся к типам форматированного контента, которые можно вставить в документ Word.


*Рис. 1. Текст с прямым форматированием*


![Текст с применением прямого форматирования.](../images/office15-app-create-wd-app-using-ooxml-fig01.png)

С помощью прямого форматирования вы можете определить, как будет выглядеть текст, независимо от существующего форматирования в документе пользователя.

*Рис. 2. Текст, отформатированный с помощью стиля*


![Текст, отформатированный под стиль абзаца.](../images/office15-app-create-wd-app-using-ooxml-fig02.png)

Вы можете использовать стиль, чтобы автоматически настраивать внешний вид текста, вставляемого в документ пользователя.

*Рис. 3. Пример изображения.*


![Изображение логотипа.](../images/office15-app-create-wd-app-using-ooxml-fig03.png)

Тот же метод можно использовать для вставки изображений в любом формате, поддерживаемом приложениями Office.

*Рис. 4. Изображение, форматированное с помощью стилей и эффектов изображений*


![Изображение, отформатированное в Word.](../images/office15-app-create-wd-app-using-ooxml-fig04.png)


Для добавления высококачественного форматирования и эффектов к изображениям требуется намного меньше разметки, чем можно было бы ожидать.

*Рис. 5. Элемент управления содержимым*


![Текст в элементе управления содержимым.](../images/office15-app-create-wd-app-using-ooxml-fig05.png)

С помощью элементов управления содержимым в надстройке содержимое можно добавлять в указанное, а не выделенное расположение.

*Рис. 6. Текстовое поле с форматированием WordArt*


![Текст, отформатированный с помощью эффектов WordArt.](../images/office15-app-create-wd-app-using-ooxml-fig06.png)

В Word доступны эффекты для текста в текстовых полях (как показано здесь) и обычного текста документа.

*Рис. 7. Фигура*


![Нарисованная фигура Microsoft Office в Word.](../images/office15-app-create-wd-app-using-ooxml-fig07.png)

Вы можете вставлять встроенные или собственные фигуры, применяя к ним текстовые эффекты и форматирование.

*Рис. 8. Таблица с прямым форматированием*


![Отформатированная таблица в Word.](../images/office15-app-create-wd-app-using-ooxml-fig08.png)

К любой таблице можно применить форматирование текста, границы, тени, а также заданные размеры ячеек.

*Рис. 9. Таблица, отформатированная с помощью стиля таблицы*


![Отформатированная таблица в Word.](../images/office15-app-create-wd-app-using-ooxml-fig09.png)

Вы можете использовать встроенные или настраиваемые стили таблиц так же легко, как стили абзаца для текста.

*Рис. 10. Диаграмма SmartArt*


![Динамичная диаграмма SmartArt в Word.](../images/office15-app-create-wd-app-using-ooxml-fig10.png)

Microsoft Office предоставляет большой выбор макетов диаграмм SmartArt (а с помощью Office Open XML вы можете создать собственный макет).

*Рис. 11. Диаграмма*


![Диаграмма в Word.](../images/office15-app-create-wd-app-using-ooxml-fig11.png)

Вы можете вставлять диаграммы Excel в документы Word как динамические диаграммы. Это также означает, что их можно использовать в надстройке для Word. Как видно из предыдущих примеров, с помощью приведения Office Open XML можно вставлять содержимое практически любого типа, доступного пользователям для вставки в документы. Получить нужную разметку Office Open XML можно двумя простыми способами. Добавьте форматированное содержимое в пустой документ Word и сохраните файл в формате XML-документа Word или используйте тестовую надстройку с методом [getSelectedDataAsync](/javascript/api/office/office.document#getselecteddataasync-coerciontype--options--callback-), чтобы захватить разметку. Оба способа, по сути, обеспечивают одинаковый результат.


> [!NOTE]
> Документ в формате Office Open XML — это сжатый пакет файлов, представляющих содержимое документа. Сохраняя файл в формате XML-документа Word, вы получаете весь пакет Office Open XML в одном XML-файле. Такой же результат вы получите при использовании метода **getSelectedDataAsync** для извлечения разметки Office Open XML.

Обратите внимание, что в списке "Тип файла" из диалогового окна "Сохранение документа" в Word есть два варианта формата XML. Выберите вариант **XML-документ Word**, а не "XML-документ Word 2003". Скачайте пример кода под названием [Word-Add-in-Get-Set-EditOpen-XML](https://github.com/OfficeDev/Word-Add-in-Get-Set-EditOpen-XML), с помощью которого можно получить и проверить разметку. Итак, это все? Не совсем. Да, в большинстве случаев можно успешно использовать полный плоский результат Office Open XML, обеспечиваемый любым из вышеописанных способов. Скорее всего, вам не понадобится большая часть этой разметки. На первый взгляд объем разметки Office Open XML даже для простого содержимого может показаться огромным, но не стоит переживать. В этой статье мы покажем, как упростить работу с Office Open XML, используя некоторые стандартные сценарии, предоставленные сообществом разработчиков надстроек Office. Мы рассмотрим разметку для некоторых типов содержимого, показанных выше, а также сведения, необходимые для минимизации полезных данных Office Open XML. Мы также рассмотрим код, необходимый для вставки мультимедиа в документ в выделенном месте, и использование Office Open XML с объектом bindings для добавления или замены содержимого в указанных местах.

## <a name="exploring-the-office-open-xml-document-package"></a>Изучение пакета документа Office Open XML


Когда вы используете метод [getSelectedDataAsync](/javascript/api/office/office.document#getselecteddataasync-coerciontype--options--callback-) для получения разметки Office Open XML для выделенного содержимого (или сохраняете документ в формате XML-документа Word), вы получаете не только разметку, описывающую выделенное содержимое, а весь документ со множеством параметров и настроек, которые вам в большинстве случаев не пригодятся. Если вы используете этот метод из документа, содержащего надстройку области задач, полученная разметка будет включать даже область задач.

Даже простой пакет документа Word, помимо основного содержимого, включает свойства, стили, тему (параметры форматирования), веб-параметры, шрифты документа и другие части.

Предположим, вам нужно вставить всего лишь абзац текста с прямым форматированием, как показано на рисунке 1. Когда вы захватите Office Open XML для форматированного текста с помощью метода **getSelectedDataAsync**, то увидите большой объем разметки. Она включает элемент package, который представляет весь документ и содержит несколько частей (обычно называемые частями документа или, в Office Open XML, частями пакета), как показано на рисунке 13. Каждая часть представляет отдельный файл в пакете.


> [!TIP]
> Разметку Office Open XML можно редактировать в текстовом редакторе, например Блокноте. Если разметка открыта в Visual Studio, можно упростить редактирование, отформатировав пакет с помощью команды **Правка > Дополнительно > Форматировать документ** (CTRL+K, CTRL+D). После этого вы сможете сворачивать и разворачивать части документа и их разделы, как показано на рисунке 12. Это поможет упростить просмотр и редактирование содержимого пакета Office Open XML. Каждая часть документа начинается с тега **pkg:part**.


*Рис. 12. Свертывание и развертывание частей пакета для редактирования в Visual Studio*

![Фрагмент кода Office Open XML для части пакета.](../images/office15-app-create-wd-app-using-ooxml-fig12.png)

*Рис. 13. Части в базовом пакете документа Word Office Open XML*

![Фрагмент кода Office Open XML для части пакета.](../images/office15-app-create-wd-app-using-ooxml-fig13.png)

Вы удивитесь, но единственные элементы, которые необходимо вставить для добавления примера форматированного текста, во всей этой разметке — это элементы RELS-частей и document.xml.


> [!NOTE]
> Две строки разметки над тегом пакета (объявления XML для версии и кода программы Office) применяются автоматически при использовании приведения Open XML, поэтому их не нужно добавлять. Оставьте их, если хотите открыть измененную разметку как документ Word для тестирования.

Для некоторых других типов содержимого, показанных в начале этой статьи, требуются дополнительные части (помимо показанных на рисунке 13), мы рассмотрим их далее в этой статье. Сейчас же, так как вы увидите большинство частей, показанных на рисунке 13, в разметке любого пакета документа Word, кратко рассмотрим каждую часть и ее функции:


- В теге пакета первой частью является RELS-файл, в котором определяются связи между частями верхнего уровня пакета (обычно это свойства документа, эскиз (если он существует) и тело документа). Определенное содержимое этой части всегда должно быть в разметке, так как необходимо определить связь основной части документа (где хранится контент) с пакетом документа.

- Часть document.xml.rels определяет связи с дополнительными частями, необходимыми части document.xml (основной текст документа), если такие имеются.


   > [!IMPORTANT]
   > RELS-файлы в пакете (такие как RELS-файлы верхнего уровня, document.xml.rels и другие файлы, которые можно увидеть для различных типов контента) — это очень важный инструмент, который можно использовать для быстрого редактирования пакета Office Open XML. Дополнительные сведения об этом см. в разделе [Рекомендации по созданию собственной разметки](#creating-your-own-markup-best-practices) далее в этой статье.



- Часть document.xml — это содержимое в теле документа. Элементы этой части, конечно, необходимы, так как здесь представлены все данные документа. Но все содержимое этой части вам не нужно, о чем мы подробно поговорим позднее.

- Многие части автоматически игнорируются методами Set при вставке содержимого в документ с помощью приведения Office Open XML, поэтому их можно удалить. К ним относятся файл theme1.xml (тема форматирования документа), части свойств документа (core, add-in и thumbnail) и файлы параметров (в том числе settings, webSettings и fontTable).

- В примере на рис. 1 форматирование применяется напрямую к тексту (т. е. каждый параметр форматирования шрифтов и абзацев применяется отдельно). Но если вы используете стиль (например, чтобы к тексту автоматически применялся стиль "Заголовок 1" в целевом документе), как показано ранее на рис. 2, то вам потребуется часть styles.xml, а также определение связей для нее. Дополнительные сведения см. в разделе [Добавление объектов, использующих дополнительные части Office Open XML](#adding-objects-that-use-additional-office-open-xml-parts).


## <a name="inserting-document-content-at-the-selection"></a>Вставка контента документа в выделение


Рассмотрим минимальную разметку Office Open XML, необходимую для примера форматированного текста на рисунке 1, и код JavaScript, необходимый для вставки разметки в выделенном месте в документе.


### <a name="simplified-office-open-xml-markup"></a>Упрощенная разметка Office Open XML

Мы изменили пример Office Open XML, показанный здесь, как описано в предыдущем разделе, оставив только требуемые части документа и необходимые элементы в каждой части. Мы рассмотрим, как изменить разметку самостоятельно (и подробно опишем части, оставшиеся здесь) в следующем разделе.


```XML
<pkg:package xmlns:pkg="http://schemas.microsoft.com/office/2006/xmlPackage">
  <pkg:part pkg:name="/_rels/.rels" pkg:contentType="application/vnd.openxmlformats-package.relationships+xml" pkg:padding="512">
    <pkg:xmlData>
      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
        <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
      </Relationships>
    </pkg:xmlData>
  </pkg:part>
  <pkg:part pkg:name="/word/document.xml" pkg:contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml">
    <pkg:xmlData>
      <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" >
        <w:body>
          <w:p>
            <w:pPr>
              <w:spacing w:before="360" w:after="0" w:line="480" w:lineRule="auto"/>
              <w:rPr>
                <w:color w:val="70AD47" w:themeColor="accent6"/>
                <w:sz w:val="28"/>
              </w:rPr>
            </w:pPr>
            <w:r>
              <w:rPr>
                <w:color w:val="70AD47" w:themeColor="accent6"/>
                <w:sz w:val="28"/>
              </w:rPr>
              <w:t>This text has formatting directly applied to achieve its font size, color, line spacing, and paragraph spacing.</w:t>
            </w:r>
          </w:p>
        </w:body>
      </w:document>
    </pkg:xmlData>
  </pkg:part>
</pkg:package>
```


> [!NOTE]
> Если добавить показанную разметку в XML-файл вместе с тегами объявления XML version и mso-application в начало файла (см. рис. 13), вы сможете открыть его в приложении Word как документ Word. Без этих тегов вы также сможете открыть файл, используя команду меню **Файл> Открыть** в Word. В заголовке приложения Word вы увидите **Режим совместимости**, потому что мы удалили настройки, сообщающие Word о том, что это документ Word. Так как мы добавили эту разметку в существующий документ Word, это совсем не повлияет на содержимое.


### <a name="javascript-for-using-setselecteddataasync"></a>Код JavaScript для использования метода setSelectedDataAsync


После сохранения предыдущей разметки Office Open XML в XML-файле, доступном из вашего решения, вы можете использовать следующую функцию, чтобы задать форматированный текст в документе с помощью приведения Office Open XML. 

В этой функции все строки, кроме последней, используются для получения сохраненной разметки и ее использования в методе [setSelectedDataAsync](/javascript/api/office/office.document#setselecteddataasync-data--options--callback-) в конце функции. Для метода **setSelectedDataASync** требуется только указать содержимое, которое необходимо вставить, и тип приведения.


> [!NOTE]
> Замените _yourXMLfilename_ на имя XML-файла, сохраненного в решении, и путь к нему. Примеры добавления XML-файлов в решение и указания их в коде, а также рабочий пример разметки и кода JavaScript, показанных здесь, см. в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML).




```js
function writeContent() {
    var myOOXMLRequest = new XMLHttpRequest();
    var myXML;
    myOOXMLRequest.open('GET', 'yourXMLfilename', false);
    myOOXMLRequest.send();
    if (myOOXMLRequest.status === 200) {
        myXML = myOOXMLRequest.responseText;
    }
    Office.context.document.setSelectedDataAsync(myXML, { coercionType: 'ooxml' });
}
```


## <a name="creating-your-own-markup-best-practices"></a>Рекомендации по созданию собственной разметки


Рассмотрим разметку, необходимую для вставки предыдущего примера форматированного текста, более подробно.

Для начала просто удалим из пакета все части документа, кроме RELS-файла и document.xml. Затем мы изменим эти две части, чтобы сделать все еще проще.


> [!IMPORTANT]
> Используйте RELS-части как карту, чтобы быстро понять, что входит в пакет, и определить, какие части можно полностью удалить (все части, не связанные с контентом и не указанные в нем). Помните, что для каждой части документа в пакете должны существовать связи, которые указываются в RELS-файлах. Все эти связи можно увидеть в RELS-файле, файле document.xml.rels или RELS-файле, связанном с контентом.

В следующей разметке показана необходимая RELS-часть перед редактированием. Так как мы удаляем части add-in и core со свойствами документа, а также часть thumbnail, нам нужно удалить соответствующие связи из RELS-файла. Обратите внимание, что после этого останется только связь для document.xml (с кодом rID1 в следующем примере).




```XML
<pkg:part pkg:name="/_rels/.rels" pkg:contentType="application/vnd.openxmlformats-package.relationships+xml" pkg:padding="512">
  <pkg:xmlData>
    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
      <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
      <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/thumbnail" Target="docProps/thumbnail.emf"/>
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
      <Relationship Id="rId4" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
    </Relationships>
  </pkg:xmlData>
</pkg:part>
```


> [!IMPORTANT]
> Удалите связи (т. е. тег **Relationship**) для всех частей, которые вы удалили из пакета. Если добавить часть без соответствующей связи или удалить часть, оставив ее связь в пакете, возникнет ошибка.

В следующей разметке показана часть document.xml, содержащая пример форматированного текста, перед редактированием.

```XML
<pkg:part pkg:name="/word/document.xml" pkg:contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml">
    <pkg:xmlData>
      <w:document mc:Ignorable="w14 w15 wp14" xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:w15="http://schemas.microsoft.com/office/word/2012/wordml" xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup" xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk" xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml" xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape">
        <w:body>
          <w:p>
            <w:pPr>
              <w:spacing w:before="360" w:after="0" w:line="480" w:lineRule="auto"/>
              <w:rPr>
                <w:color w:val="70AD47" w:themeColor="accent6"/>
                <w:sz w:val="28"/>
              </w:rPr>
            </w:pPr>
            <w:r>
              <w:rPr>
                <w:color w:val="70AD47" w:themeColor="accent6"/>
                <w:sz w:val="28"/>
              </w:rPr>
              <w:t>This text has formatting directly applied to achieve its font size, color, line spacing, and paragraph spacing.</w:t>
            </w:r>
            <w:bookmarkStart w:id="0" w:name="_GoBack"/>
            <w:bookmarkEnd w:id="0"/>
          </w:p>
          <w:p/>
          <w:sectPr>
            <w:pgSz w:w="12240" w:h="15840"/>
            <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/>
            <w:cols w:space="720"/>
          </w:sectPr>
        </w:body>
      </w:document>
    </pkg:xmlData>
</pkg:part>
```

Так как document.xml — это основная часть документа, в которой размещается содержимое, быстро рассмотрим ее. (На рисунке 14, который идет после этого списка, показано, как некоторые базовые теги содержимого и теги форматирования связаны с тем, что вы видите в документе Word.)


- Открывающий тег **w:document** включает несколько пространств имен (**xmlns**). Многие из них связаны с определенными типами содержимого и необходимы, только если относятся к вашему содержимому.

    Обратите внимание, что префикс для тегов в части документа относится к пространствам имен. В этом примере единственный префикс, используемый в тегах части документа document.xml, — **w:**, поэтому единственное пространство имен, которое следует оставить в открывающем теге **w:document**, — **xmlns:w**.


> [!TIP]
> Если вы редактируете разметку в Visual Studio, после удаления пространств имен в любой части просмотрите все теги этой части. Если вы удалили пространство имен, необходимое для разметки, соответствующий префикс тегов будет подчеркнут красной волнистой линией. Кроме того, удаляя пространство имен **xmlns:mc**, также нужно удалить атрибут **mc:Ignorable**, предоставляющий список пространств имен.


- В открывающем теге тела документа вы увидите тег абзаца (**w:p**), который включает содержимое для нашего примера.

- Тег **w:pPr** включает свойства для прямого форматирования абзаца, например интервал до и после абзаца, выравнивание абзаца и отступы. (Прямое форматирование относится к атрибутам, которые применяются к содержимому отдельно, а не как часть стиля.) Этот тег также включает прямое форматирование, применяемое ко всему абзацу, во вложенном теге **w:rPr** (свойства прогона). В нашем примере этот тег содержит цвет и размер шрифта.


   > [!NOTE]
   > Вы можете заметить, что размеры шрифтов и некоторые другие параметры форматирования в разметке Word Office Open XML выглядят в два раза больше. Это вызвано тем, интервалы между абзацами и между строками, а также некоторые свойства форматирования разделов, показанные в предыдущей разметке, указаны в твипах (одна двадцатая точки). В зависимости от типов содержимого, с которыми вы работаете в Office Open XML, вы можете увидеть несколько дополнительных единиц измерения, в том числе английские метрические единицы (914 400 английских метрических единиц на дюйм), которые используются для некоторых значений Office Art (drawingML), и значение в 100 000 раз больше действительного, которое используется в разметке drawingML и PowerPoint. В PowerPoint некоторые значения также в 100 раз больше действительных, а в Excel обычно используются действительные значения.


- Любое содержимое со схожими свойствами в абзаце включается в прогон (**w:r**), как и пример текста. При каждом изменении форматирования или типа содержимого начинается новый прогон. (Например, если одно слово в примере текста было выделено полужирным шрифтом, оно будет выделено в собственный прогон.) В этом примере содержимое включает всего один прогон текста.

    Обратите внимание, что в этом примере используется форматирование шрифта, которое можно применять только к одному символу. Поэтому такое форматирование также указано в свойствах для отдельного запуска.

- Также обратите внимание на теги скрытой закладки _GoBack (**w:bookmarkStart** и **w:bookmarkEnd**), которые по умолчанию отображаются в документах Word. Начальный и конечный теги закладки GoBack всегда можно удалить из разметки.

- Последняя часть тела документа — это тег **w:sectPr** или свойства раздела. Этот тег включает такие параметры, как поля и ориентация страницы. Содержимое, вставляемое с помощью метода **setSelectedDataAsync**, по умолчанию будет использовать свойства активного раздела в целевом документе. Поэтому если в содержимом нет разрыва раздела (в противном случае тегов **w:sectPr** будет несколько), этот тег можно удалить.


*Рис. 14. Связь общих тегов в document.xml с содержимым и структурой документа Word*

![Элементы Office Open XML в документе Word.](../images/office15-app-create-wd-app-using-ooxml-fig14.png)

> [!TIP]
> В нескольких тегах созданной разметки может встречаться другой атрибут, включающий символы **w:rsid**, которых нет в примерах из этой статьи. Это идентификаторы исправлений. Они используются в Word для функции объединения документов и включены по умолчанию. В разметке, вставляемой с помощью надстройки, они не нужны, и их отключение делает разметку намного яснее. Вы можете с легкостью удалить существующие теги RSID или отключить функцию (как описано в приведенной ниже процедуре), чтобы они не добавлялись в разметку для нового содержимого.

Помните, что если вы используете возможности совместного редактирования документов в Word, следует опять включить функцию после создания разметки для вашей надстройки.

Чтобы отключить атрибуты RSID в Word для последующих создаваемых документов, выполните следующие действия: 

1. В Word откройте меню **Файл** и выберите пункт **Параметры**.
2. В диалоговом окне "Параметры Word" выберите пункт **Центр управления безопасностью** и нажмите кнопку **Параметры центра управления безопасностью**.
3. В диалоговом окне "Центр управления безопасностью" выберите пункт **Параметры конфиденциальности** и снимите флажок **Сохранять случайное число для улучшения точности объединения**.

Чтобы удалить теги RSID из существующего документа, используйте указанные ниже сочетания клавиш, открыв документ в формате Office Open XML.


1. Указав точку вставки в тексте документа, нажмите клавиши **CTRL+HOME**, чтобы перейти в начало документа.
2. Нажмите клавиши **ПРОБЕЛ**, **DELETE**, **ПРОБЕЛ**. Затем сохраните документ.

Удалив основную часть разметки из этого пакета, мы получили минимальную разметку, которую нужно вставить для примера, как показано в предыдущем разделе.


## <a name="using-the-same-office-open-xml-structure-for-different-content-types"></a>Использование одной структуры Office Open XML для различных типов контента


Для некоторых типов мультимедиа требуются только части RELS и document.xml, показанные в предыдущем примере, в том числе для элементов управления содержимым, фигур и текстовых полей Office, а также таблиц (если к ним не применяется стиль). Вы можете повторно использовать одни и те же измененные части пакета, меняя только содержимое **body** в файле document.xml для разметки содержимого.

Разметку Office Open XML для каждого из этих типов содержимого, показанных выше на рисунках 5–8, см. в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML), упоминаемом в разделе с обзором.

Прежде чем продолжить, рассмотрим отличия некоторых типов содержимого и способы замены нужных частей.


### <a name="understanding-drawingml-markup-office-graphics-in-word-what-are-fallbacks"></a>Сведения о разметке drawingML (графика Office) в Word: запасные варианты

Если разметка фигуры или текстового поля выглядит намного сложнее, чем вы ожидали, этому есть причина. После выхода Office 2007 появились форматы Office Open XML, а также новый графический модуль Office, который был полностью интегрирован в PowerPoint и Excel. В Word 2007 поддерживается только часть этого модуля, обновленный модуль диаграмм Excel, графические объекты SmartArt и расширенные средства работы с рисунками. Для фигур и текстовых полей Word 2007 продолжает использовать старые объекты рисунков (VML). Только в Word 2010 были реализованы дополнительные возможности для поддержки обновленных средств работы с фигурами и рисунками.

Поэтому для поддержки фигур и текстовых полей в документах Word в формате Office Open XML, открываемых в Word 2007, для фигур (в том числе и текстовых полей) требуется резервная разметка VML.

Обычно, как видно для фигуры и текстового поля в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML), резервную разметку можно удалить. Word автоматически добавляет отсутствующую резервную разметку в фигуры при сохранении документа. Но если вы хотите сохранить резервную разметку для поддержки всех пользовательских сценариев, никто не помешает вам это сделать.

После группировки объектов-рисунков в содержимом вы увидите дополнительную разметку (очевидно, повторяющуюся), но ее нужно сохранить. Части разметки для отображения фигур дублируются, если объект добавляется в группу.


> [!IMPORTANT]
> При работе с текстовыми полями и фигурами тщательно проверяйте пространства имен перед их удалением из document.xml. Если вы используете разметку из другого типа объекта, добавьте все необходимые пространства имен, которые вы могли удалить из document.xml. Значительная часть пространств имен, по умолчанию включенных в document.xml, представлена для отображения объектов рисунков.


#### <a name="about-graphic-positioning"></a>О размещении рисунков

В примерах кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML) и [Word-Add-in-Get-Set-EditOpen-XML](https://github.com/OfficeDev/Word-Add-in-Get-Set-EditOpen-XML) текстовое поле и фигура настроены с помощью различных параметров обтекания текстом и размещения. (Кроме того, помните, что для изображений в этих примерах кода используется форматирование "в тексте", которое размещает графический объект на опорной линии текста.)

Фигура в этих примерах кода размещается относительно правого и нижнего полей страницы. Относительное расположение упрощает согласование с неизвестной конфигурацией пользователя, так как оно адаптируется к полям пользователя, а риск неудачно расположить содержимое из-за неизвестного размера, ориентации или полей страницы значительно уменьшается. Чтобы сохранить параметры относительного размещения при вставке графического объекта, необходимо сохранить знак абзаца (w:p), в котором хранятся данные о расположении (в приложении Word это называется привязкой). Если вставить содержимое в существующий знак абзаца, а не добавить собственный знак абзаца, вы сможете сохранить исходный внешний вид документа, но многие типы относительных ссылок, позволяющие автоматически адаптировать размещение содержимого в соответствии с пользовательской структурой, могут быть потеряны.


### <a name="working-with-content-controls"></a>Работа с элементами управления содержимым

Элементы управления содержимым — это полезный компонент Word, который может значительно расширить возможности надстройки для Word различными способами, в том числе позволить ей вставлять содержимое в указанном, а не только в выделенном месте.

В Word элементы управления содержимым можно найти на вкладке "Разработчик" на ленте, как показано на рисунке 15.


*Рис. 15. Группа "Элементы управления" на вкладке "Разработчик" в Word*

![Группа элементов управления содержимым на ленте Word.](../images/office15-app-create-wd-app-using-ooxml-fig15.png)

В Word доступны такие элементы управления содержимым, как форматированный текст, простой текст, изображение, коллекция стандартных блоков, флажок, раскрывающийся список, поле со списком, компонент выбора даты и повторяющийся раздел.



- Используйте команду **Свойства**, как показано на рисунке 15, чтобы изменить заголовок элемента управления и задать настройки, например чтобы скрыть контейнер элемента управления.

- Включите **режим конструктора**, чтобы изменить содержимое заполнителя в элементе управления.

Если ваша надстройка работает с шаблоном Word, вы можете добавить элементы управления в этот шаблон, чтобы улучшить поведение содержимого. Вы также можете использовать привязку данных XML в документе Word, чтобы связать элементы управления содержимым с данными, например свойствами документа, и упростить заполнение форм и выполнение аналогичных задач. (Элементы управления, которые уже привязаны к встроенным свойствам документа в Word, можно найти на вкладке **Вставка** в разделе **Экспресс-блоки**.)

При использовании элементов управления содержимым в надстройке вы можете расширить ее возможности с помощью другого типа привязки. Вы можете создать привязку к элементу управления содержимым из надстройки, а затем записывать содержимое в привязку, а не выделенное место.



> [!NOTE]
> Не путайте привязку к данным XML в Word с возможностью привязки к элементу управления через надстройку. Это совершенно разные функции. Однако вы можете добавить именованные элементы управления содержимым во вставляемое содержимое через надстройку, используя приведение OOXML, а затем с помощью кода в надстройке создать привязку к этим элементам управления.

Помните, что привязки к данным XML и Office.js могут взаимодействовать с настраиваемыми частями XML в вашем приложении, поэтому вы можете интегрировать эти мощные инструменты. Сведения о работе с настраиваемыми частями XML в Office JavaScript API см. в разделе [Дополнительные ресурсы](#see-also) далее в этой статье.

Работа с привязками в надстройке Word описывается в следующем разделе. Сначала рассмотрим пример разметки Office Open XML, необходимой для вставки элемента управления форматированным текстом, к которому можно привязаться с помощью надстройки.



> [!IMPORTANT]
> Элементы управления форматированным текстом — это единственный тип элементов управления содержимым, которые можно использовать для привязки к элементу управления содержимым в надстройке.




```XML
<pkg:package xmlns:pkg="http://schemas.microsoft.com/office/2006/xmlPackage">
  <pkg:part pkg:name="/_rels/.rels" pkg:contentType="application/vnd.openxmlformats-package.relationships+xml" pkg:padding="512">
    <pkg:xmlData>
      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
        <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
      </Relationships>
    </pkg:xmlData>
  </pkg:part>
  <pkg:part pkg:name="/word/document.xml" pkg:contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml">
    <pkg:xmlData>
      <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w15="http://schemas.microsoft.com/office/word/2012/wordml" >
        <w:body>
          <w:p/>
          <w:sdt>
              <w:sdtPr>
                <w:alias w:val="MyContentControlTitle"/>
                <w:id w:val="1382295294"/>
                <w15:appearance w15:val="hidden"/>
                <w:showingPlcHdr/>
              </w:sdtPr>
              <w:sdtContent>
                <w:p>
                  <w:r>
                  <w:t>[This text is inside a content control that has its container hidden. You can bind to a content control to add or interact with content at a specified location in the document.]</w:t>
                </w:r>
                </w:p>
              </w:sdtContent>
            </w:sdt>
          </w:body>
      </w:document>
    </pkg:xmlData>
  </pkg:part>
 </pkg:package>
```

Как уже было сказано, элементам управления содержимым, как и форматированному тексту, не требуются дополнительные части документа, поэтому здесь указаны только измененные части, RELS и document.xml.

Тег **w:sdt**, который вы видите в document.xml, представляет элемент управления содержимым. Если создать разметку Office Open XML для элемента управления содержимым, вы увидите, что несколько атрибутов удалены из этого примера, в том числе данный тег и свойства части документа. Сохранились только необходимые элементы (и пара рекомендуемых), включая следующие:



- **alias** — это свойство заголовка из диалогового окна "Свойства элемента управления содержимым" в Word. Данное свойство (представляющее имя элемента) является обязательным, если вы планируете привязать элемент управления в надстройке.

- **id** — это уникальное свойство. Если привязать элемент управления в надстройке, ID будет свойством, которое привязка использует, чтобы определить соответствующий именованный элемент управления.

- Атрибут **appearance** используется, чтобы скрыть контейнер элемента управления и упростить структуру. Эта возможность была добавлена в Word 2013, как видно по пространству имен w15. Так как это свойство используется, пространство имен w15 сохраняется в начале части document.xml.

- Атрибут **showingPlcHdr** — это необязательный параметр, задающий содержимое по умолчанию, которое вы добавляете в элемент управления (в этом примере это текст) как содержимое заполнителя. Поэтому если пользователь щелкнет область элемента управления, будет выбрано все содержимое, что отличается от редактируемого содержимого.

- Хотя пустой знак абзаца (**w:p/**) перед тегом **sdt** не требуется для добавления элемента управления содержимым (и добавляет интервал по вертикали над элементом управления в документе Word), но он позволяет разместить элемент управления в нужном абзаце. Это может быть важно в зависимости от типа и форматирования содержимого, которое будет добавлено в элемент управления.

- Для привязки к элементу управления содержимое по умолчанию (в теге **sdtContent**) должно включать по крайней мере один полный абзац (как в этом абзаце), чтобы ваша привязка принимала мультимедиа из нескольких абзацев.



> [!NOTE]
> Атрибут части документа, удаленный из тега **w:sdt** этого примера, может быть указан в элементе управления содержимым для указания ссылки на отдельную часть в пакете, где может храниться содержимое заполнителя (части, расположенные в каталоге глоссария пакета Office Open XML). Хотя термин "часть документа" используется для обозначения частей XML (т. е. файлов) в пакете Office Open XML, "часть документа" с точки зрения свойства sdt означает тот же термин в Word, используемый для описания некоторых типов содержимого, в том числе стандартных блоков и экспресс-блоков свойства документа (например, встроенных элементов управления XML с привязкой к данным). Если в пакете Office Open XML в каталоге глоссария вы видите части, возможно, их потребуется сохранить, если вставляемое содержимое включает эти функции. Для типичного элемента управления, который вы собираетесь использовать для привязки в надстройке, они не требуются. Но помните, что если вы удалите части глоссария из пакета, также нужно удалить атрибут части документа из тега w:sdt.

В следующем разделе мы расскажем, как создавать и использовать привязки в надстройке Word.


## <a name="inserting-content-at-a-designated-location"></a>Вставка контента в указанное расположение


Мы уже рассмотрели, как вставить содержимое в выделенное место в документе Word. Если создать привязку к именованному элементу управления содержимым в документе, вы сможете вставлять такие же типы содержимого в этот элемент управления. 

Итак, когда этот подход может потребоваться?


- Если вам нужно добавить или заменить контент в указанном расположении в шаблоне, например заполнить части документа из базы данных

- Если вы хотите, чтобы содержимое, вставляемое в выделенное место, можно было заменить, например чтобы пользователь мог выбрать элементы оформления

- Если вы хотите, чтобы пользователь мог добавить в документ данные, доступные в вашей надстройке, например для заполнения полей в области задач на основе информации, добавленной пользователем в документ

Скачайте пример кода [Word-Add-in-JavaScript-AddPopulateBindings](https://github.com/OfficeDev/Word-Add-in-JavaScript-AddPopulateBindings)— это рабочий пример вставки элемента управления содержимым и привязки к нему, а также заполнения привязки.


### <a name="add-and-bind-to-a-named-content-control"></a>Добавление именованного элемента управления содержимым и привязка к нему


При изучении представленного ниже кода JavaScript учитывайте следующие требования:


- Как отмечалось ранее, для привязки к элементу управления в надстройке Word необходимо использовать элемент управления форматированным текстом.

- У элемента управления должно быть имя (это поле **Заголовок** в диалоговом окне "Свойства элемента управления содержимым", соответствующее тегу **Alias** в разметке Office Open XML). Так код определяет, где следует разместить привязку.

- Можно использовать и привязать несколько именованных элементов управления. Укажите уникальное имя элемента управления содержимым, уникальный код элемента управления и уникальный код привязки.


```js
function addAndBindControl() {
    Office.context.document.bindings.addFromNamedItemAsync("MyContentControlTitle", "text", { id: 'myBinding' }, function (result) {
        if (result.status == "failed") {
            if (result.error.message == "The named item does not exist.")
                var myOOXMLRequest = new XMLHttpRequest();
                var myXML;
                myOOXMLRequest.open('GET', '../../Snippets_BindAndPopulate/ContentControl.xml', false);
                myOOXMLRequest.send();
                if (myOOXMLRequest.status === 200) {
                    myXML = myOOXMLRequest.responseText;
                }
                Office.context.document.setSelectedDataAsync(myXML, { coercionType: 'ooxml' }, function (result) {
                    Office.context.document.bindings.addFromNamedItemAsync("MyContentControlTitle", "text", { id: 'myBinding' });
                });
        }
    });
}
```

Показанный код выполняет следующие действия:


- Пытается создать привязку к именованному элементу управления содержимым с помощью метода [addFromNamedItemAsync](/javascript/api/office/office.bindings#addfromnameditemasync-itemname--bindingtype--options--callback-).

  Выполните этот шаг сначала, если есть вероятность того, что именованный элемент управления уже существует в документе при запуске кода надстройки. Например, вам понадобится выполнить это действие, если надстройка вставлена в шаблон с последующим сохранением, при этом шаблон создан для работы с надстройкой, содержащей предварительно размещенный элемент управления. Вам также понадобится выполнить это действие, если требуется связать элемент управления, размещенный надстройкой ранее.

- Обратный вызов при первом вызове метода **addFromNamedItemAsync** проверяет, не завершилась ли привязка ошибкой, так как именованного элемента нет в документе (в этом примере — элемента управления MyContentControlTitle). Если это так, код добавляет элемент управления в выделенное место (используя метод **setSelectedDataAsync**) и привязывается к нему.


> [!NOTE]
> Как было сказано ранее и показано в предыдущем примере кода, имя элемента управления содержимым используется для определения места, где будет создана привязка. Однако в разметке Office Open XML код добавляет привязку к документу, используя имя и атрибут ID элемента управления содержимым.

Если вы посмотрите на разметку документа, в котором надстройка создала привязки, после выполнения кода, то увидите две части для каждой привязки. В разметке элемента управления содержимым, где была добавлена привязка (в document.xml), вы увидите атрибут **w15:webExtensionLinked/**.

В части документа webExtensions1.xml вы увидите список созданных привязок. Каждая из них идентифицируется по коду привязки и атрибуту ИД соответствующего элемента управления, как в следующем примере, где атрибут **appref** — это код элемента управления содержимым: ** **we:binding id="myBinding" type="text" appref="1382295294"/**.


> [!IMPORTANT]
> Привязку нужно добавить тогда, когда вы собираетесь использовать ее. Не добавляйте разметку привязки в разметку Office Open XML для вставки элемента управления, так как этот процесс приведет к удалению привязки.


### <a name="populate-a-binding"></a>Заполнение привязки


Код для записи контента в привязку похож на код для записи контента в выделение.


```js
function populateBinding(filename) {
  var myOOXMLRequest = new XMLHttpRequest();
  var myXML;
  myOOXMLRequest.open('GET', filename, false);
  myOOXMLRequest.send();
  if (myOOXMLRequest.status === 200) {
      myXML = myOOXMLRequest.responseText;
  }
  Office.select("bindings#myBinding").setDataAsync(myXML, { coercionType: 'ooxml' });
}
```

Как и для метода **setSelectedDataAsync**, вы указываете содержимое, которое необходимо вставить, и тип приведения. Единственное дополнительное требование для записи в привязку — определение привязки по идентификатору. Обратите внимание, что идентификатор привязки, используемый в этом примере (bindings#myBinding), соответствует идентификатору (myBinding), заданному при создании в предыдущей функции.


> [!NOTE]
> Предыдущий пример кода — все, что вам нужно при первом заполнении или замене содержимого в привязке. При вставке в привязку новое содержимого автоматически заменяет существующее. Изучите пример [Word-Add-in-JavaScript-AddPopulateBindings](https://github.com/OfficeDev/Word-Add-in-JavaScript-AddPopulateBindings), где представлено два отдельных примера содержимого, которые можно использовать для заполнения одной привязки.


## <a name="adding-objects-that-use-additional-office-open-xml-parts"></a>Добавление объектов, использующих дополнительные части Office Open XML


Для многих типов контента требуются дополнительные части документа пакета Office Open XML. Это значит, что они ссылаются на информацию в другой части или сам контент хранится в одной или нескольких частях и указывается в document.xml.

Так, например, необходимо учитывать следующее:


- Для контента, использующего стили для форматирования (например, текст, показанный ранее на рис. 2, или таблица на рис. 9), требуется часть styles.xml.

- Изображения (например, на рис. 3 и 4) содержат двоичные данные изображений в одной, а иногда двух дополнительных частях.

- Для диаграмм SmartArt (например, на рис. 10) требуется несколько дополнительных частей для описания структуры и контента.

- Для диаграмм (как на рис. 11) требуется несколько дополнительных частей, в том числе собственная часть связей (RELS).

Вы также можете просмотреть измененные примеры разметки всех этих типов содержимого в ранее указанном примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML). Эти типы содержимого можно вставить, используя код JavaScript, показанный ранее (и представленный в примерах кода) для вставки содержимого в выделенное место и записи содержимого в указанное расположение с помощью привязок.

Перед изучением примеров рассмотрим несколько советов по работе с каждым из этих типов содержимого.


> [!IMPORTANT]
> Помните, что если вы сохраняете дополнительные части, указанные в document.xml, вам потребуется сохранить document.xml.rels и определения связей для сохраняемых частей, например styles.xml или файл изображения.


### <a name="working-with-styles"></a>Работа со стилями

Подход к редактированию разметки, рассмотренный нами для предыдущего примера с текстом с прямым форматированием, применяется и при использовании стилей абзацев и таблиц для форматирования контента. Однако разметка для работы со стилями абзацев намного проще, как и пример, описанный далее.


#### <a name="editing-the-markup-for-content-using-paragraph-styles"></a>Редактирование разметки для контента с использованием стилей абзацев

Приведенная ниже разметка представляет содержимое для примера текста со стилем, показанного на рис. 2.


```XML
<w:body>
  <w:p>
    <w:pPr>
      <w:pStyle w:val="Heading1"/>
    </w:pPr>
    <w:r>
      <w:t>This text is formatted using the Heading 1 paragraph style.</w:t>
    </w:r>
  </w:p>
</w:body>
```


> [!NOTE]
> Как видите, разметка для форматированного текста в document.xml намного проще при использовании стиля, так как стиль содержит все параметры форматирования абзаца и шрифтов, которые в противном случае потребовалось бы указывать отдельно. Но, как упоминалось ранее, стили или прямое форматирование можно использовать для разных целей: прямое форматирование для определения внешнего вида независимо от форматирования в документе пользователя, а стиль абзаца (в частности, встроенный стиль абзаца, например "Заголовок 1", как показано здесь) для автоматического согласования форматирования текста с документом пользователя.

Использование стиля — хороший пример того, как важно прочитать и понять разметку вставляемого содержимого, так как не сразу становится очевидно, что здесь указывается другая часть документа. Если в разметку добавить определение стиля и не добавлять styles.xml, информация о стиле в document.xml будет игнорироваться независимо от того, используется ли этот стиль в документе пользователя.

Но если внимательно посмотреть на часть styles.xml, вы заметите, что только небольшая часть этой объемной разметки необходима при редактировании разметки, которая будет использоваться в надстройке:


- Часть styles.xml по умолчанию содержит несколько пространств имен. Если вы сохраняете только сведения о стиле, требуемые для вашего контента, в большинстве случаев вам понадобится сохранить только пространство имен **xmlns:w**.

- Содержимое тега **w:docDefaults** в начале части стилей будет игнорироваться, когда ваша разметка вставляется с помощью надстройки, и его можно удалить.

- Наибольшая доля разметки в части styles.xml предназначена для тега **w:latentStyles**, который идет после части docDefaults, содержащего сведения для каждого доступного стиля (например, атрибуты внешнего вида области стилей и коллекция стилей). Эти сведения также игнорируются при вставке содержимого с помощью надстройки, и их можно удалить.

- После сведений о стилях можно увидеть определение каждого стиля, используемого документом, на основе которого была создана разметка. В эти данные входят некоторые стили по умолчанию, используемые при создании нового документа, и они могут не относиться к вашему документу. Вы можете удалить определения стилей, которые не используются содержимым.


   > [!NOTE]
   > С каждым встроенным стилем заголовка связан стиль Char, версия стиля знака одного формата заголовков. Если вы не применили стиль заголовка как стиль знака, его можно удалить. Если стиль используется как стиль знака, он отображается в document.xml в теге свойств прогона (**w:rPr**), а не в теге свойств абзаца (**w:pPr**). Последнее происходит, только если вы применили стиль только к части абзаца, но также может произойти, если стиль был применен неправильно.


- Если вы используете встроенный стиль для содержимого, добавлять полное определение не требуется. Необходимо только указать имя стиля, код стиля и по крайней мере один атрибут форматирования для приведенного Office Open XML, чтобы применить стиль к содержимому после вставки.

    Но лучше включать полное определение стилей, даже если это предусмотрено по умолчанию для встроенных стилей. Если стиль уже используется в конечном документе, содержимое будет применять резидентное определение для стиля, независимо от того, что включено в styles.xml. Если стиль еще не используется в конечном документе, содержимое будет использовать определение стилей, предоставленное в разметке.

Итак, единственный контент, который нам нужно сохранить из части styles.xml для примера текста на рис. 2, форматируемого с помощью стиля "Заголовок 1", представлен далее.


> [!NOTE]
> В этом примере сохранено полное определение Word для стиля "Заголовок 1".




```XML
<pkg:part pkg:name="/word/styles.xml" pkg:contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml">
  <pkg:xmlData>
    <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" >
      <w:style w:type="paragraph" w:styleId="Heading1">
        <w:name w:val="heading 1"/>
        <w:basedOn w:val="Normal"/>
        <w:next w:val="Normal"/>
        <w:link w:val="Heading1Char"/>
        <w:uiPriority w:val="9"/>
        <w:qFormat/>
        <w:pPr>
          <w:keepNext/>
          <w:keepLines/>
          <w:spacing w:before="240" w:after="0" w:line="259" w:lineRule="auto"/>
          <w:outlineLvl w:val="0"/>
        </w:pPr>
        <w:rPr>
          <w:rFonts w:asciiTheme="majorHAnsi" w:eastAsiaTheme="majorEastAsia" w:hAnsiTheme="majorHAnsi" w:cstheme="majorBidi"/>
          <w:color w:val="2E74B5" w:themeColor="accent1" w:themeShade="BF"/>
          <w:sz w:val="32"/>
          <w:szCs w:val="32"/>
        </w:rPr>
      </w:style>
    </w:styles>
  </pkg:xmlData>
</pkg:part>
```


#### <a name="editing-the-markup-for-content-using-table-styles"></a>Редактирование разметки для контента с использованием стилей таблиц


Если содержимое использует стиль таблицы, вам нужна та же относительная часть styles.xml, которая была описана в разделе, посвященном работе со стилями абзацев. Т. е. вам требуется сохранить только сведения для стиля, который используется в содержимом (при этом необходимо указать имя, код и по крайней мере один атрибут форматирования), но лучше всего включить полное определение стиля для поддержки всех возможных сценариев.

Но если посмотреть на разметку для таблицы в document.xml и определения стиля таблицы в styles.xml, вы увидите намного больше разметки, чем при работе со стилями абзацев.


- В document.xml форматирование применяется ячейкой, даже если оно включено в стиль. Использование стиля таблицы не уменьшит размер разметки. Преимущество применения стилей таблиц для содержимого состоит в простоте обновления и согласования внешнего вида нескольких таблиц.

- В файле styles.xml вы также увидите разметку большого размера, так как стили таблиц включают несколько типов возможных атрибутов форматирования для всех областей таблицы, таких как вся таблица, строки заголовков, четные и нечетные строки и столбцы (отдельно), первый столбец и т. д.


### <a name="working-with-images"></a>Работа с изображениями


Разметка изображения включает ссылку по крайней мере на одну часть, которая содержит двоичные данные изображения. Для сложного изображения разметка может состоять из сотен страниц, при этом изменить ее нельзя. Так как двоичные части изменять не надо, вы можете просто свернуть ее, если вы используете структурированный редактор, такой как Visual Studio, чтобы упростить просмотр и редактирование остального пакета.

Если вы посмотрите на пример разметки для изображения, показанного на рисунке 3 ранее, из примера кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML), вы увидите, что разметка для изображения в document.xml включает сведения о размере и положении, а также ссылку на часть, которая содержит двоичные данные изображения. Эта ссылка входит в тег **a:blip** следующим образом:




```XML
<a:blip r:embed="rId4" cstate="print">
```

Обратите внимание, что ссылка на связь используется явно (**r:embed="rID4"**) и связанная часть необходима для отрисовки изображения, поэтому если не включить двоичные данные в пакет Office Open XML, возникнет ошибка. Файл styles.xml, описанный ранее, не вызовет ошибки, если его опустить, так как связь не указана явно и ссылается на часть, предоставляющую атрибуты содержимого (форматирование), а не входящую в само содержимое.


> [!NOTE]
> При изучении разметки обратите внимание на дополнительные пространства имен, используемые в теге a:blip. В document.xml вы увидите, что пространство имен **xlmns:a** (основное пространство имен drawingML) динамически размещается в начале ссылок drawingML, а не в начале части document.xml. Однако пространство имен связей (r) необходимо сохранить в начале части document.xml. Проверьте разметку изображения на наличие дополнительных пространств имен. Помните, что вам не нужно запоминать, каким типам содержимого требуются те или иные пространства имен — вы легко можете это определить по префиксам тегов в файле document.xml.


### <a name="understanding-additional-image-parts-and-formatting"></a>Сведения о дополнительных частях и форматировании изображений


Если вы используете эффекты форматирования изображений Office, например как для изображения на рисунке 4, где применяются параметры яркости и контрастности (помимо стиля рисунка), может потребоваться вторая часть двоичных данных для копии изображения в формате высокой четкости. Это необходимо для форматирования с эффектом наложения, ссылка на эту копию содержится в document.xml и выглядит следующим образом:


```XML
<a14:imgLayer r:embed="rId5">
```

Разметку для отформатированного изображения, показанного на рисунке 4 (где, среди прочего, используются эффекты наслоения), см. в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML).


### <a name="working-with-smartart-diagrams"></a>Работа с диаграммами SmartArt


Со схемой SmartArt связано четыре части, но только две из них являются обязательными. Вы можете изучить пример разметки SmartArt в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML). Для начала рассмотрим краткое описание каждой части и причины, по которой они являются обязательными или необязательными:


> [!NOTE]
> Если в содержимом есть несколько диаграмм, они будут нумероваться последовательно (1 в именах файлах, показанных здесь, будет заменяться соответствующим номером).


- layout1.xml: это обязательная часть. Она содержит определение разметки для внешнего вида и функциональности структуры.

- data1.xml: это обязательная часть. Она содержит данные, используемые вашим экземпляром диаграммы.

- drawing1.xml: это часть не всегда требуется, но если применить настраиваемое форматирование к элементам вашего экземпляра диаграммы, например прямое форматирование отдельных фигур, возможно, ее придется сохранить.

- colors1.xml: это необязательная часть. Она содержит сведения о цвете стиля, но цвета диаграммы по умолчанию будут соответствовать цветам активной темы форматирования в целевом документе в зависимости от стиля цвета SmartArt, применяемого на вкладке "Работа с рисунками SmartArt" в Word перед сохранением разметки Office Open XML.

- quickStyles1.xml: это необязательная часть. Как и часть colors1.xml, ее можно удалить, так как ваша диаграмма будет использовать определение примененного стиля SmartArt, доступное в целевом документе (т. е. автоматически адаптирует тему форматирования в целевом документе).


> [!TIP]
> Файл layout1.xml SmartArt — это хороший пример ресурса, где можно сократить разметку, но это не будет стоить потраченного времени (так как объем удаленной разметки будет очень мал по сравнению со всем пакетом). Если вы хотите избавиться от всей возможной разметки, можно удалить тег **dgm:sampData** и его содержимое. Следующий пример определяет, как эскиз диаграммы отображается в коллекциях стилей SmartArt. Но если его опустить, будут использоваться данные по умолчанию.

Помните, что разметка схемы SmartArt в файле document.xml содержит ссылки на коды связей с частями структуры, данных, цветов и экспресс-стилей. Вы можете удалить ссылки на части цветов и стилей в файле document.xml, если вы удаляете данные части и определения их связей (и это совершенно точно рекомендуемый подход, так как вы удаляете эти связи), но если их сохранить, ошибки не будет, так как они не требуются для вставки диаграммы в документ. Эти ссылки можно найти в document.xml в теге **dgm:relIds**. Независимо от того, выполняете ли вы это действие, сохраните ссылки на коды связи для обязательных частей структуры и данных.


### <a name="working-with-charts"></a>Работа с диаграммами


Как и диаграммы SmartArt, обычные диаграммы содержат несколько дополнительных частей. Но настройка для них немного отличается от SmartArt, так как у диаграммы есть собственный файл связей. Далее представлено описание обязательных и необязательных частей документа для диаграммы:


> [!NOTE]
> Как и для диаграмм SmartArt, если ваш контент содержит несколько диаграмм, они будут нумероваться последовательно (1 в именах файлах, показанных здесь, будет заменяться соответствующим номером).


- В файле document.xml.rels вы увидите ссылку на обязательную часть, который содержат данные, описывающие диаграмму (chart1.xml).

- Вы также увидите отдельный файл связей для каждой диаграммы в пакете Office Open XML, например chart1.xml.rels.

    chart1.xml.rels ссылается на три файла, но требуется только один из них. Эти файлы включают двоичные данные книги Excel (обязательны), а также цвета и стили (colors1.xml и styles1.xml), которые можно удалить.

Диаграммы, которые можно создавать и редактировать непосредственно в Word — это диаграммы Excel. Их данные хранятся на листе Excel, который в виде двоичных данных встроен в пакет Office Open XML. Как и части двоичных данных для изображений, эти данные Excel также обязательны, но в этой части редактировать нечего. Поэтому вы можете просто свернуть часть в редакторе, чтобы не прокручивать ее вручную для просмотра оставшейся части пакета Office Open XML.

Но, как и в случае со SmartArt, вы можете удалить части цветов и стилей. Если вы использовали стили диаграмм и цветов для форматирования диаграммы, она будет применять соответствующее форматирование автоматически после вставки в целевой документ.

Измененную разметку для диаграммы, показанной на рисунке 11, см. в примере кода [Word-Add-in-Load-and-write-Open-XML](https://github.com/OfficeDev/Word-Add-in-Load-and-write-Open-XML).


## <a name="editing-the-office-open-xml-for-use-in-your-task-pane-add-in"></a>Редактирование Office Open XML для использования в надстройке области задач


Вы уже знаете, как определить и изменить содержимое в разметке. Если задача все равно кажется трудновыполнимой, когда вы смотрите на объемный пакет Office Open XML, созданный для вашего документа, описанные далее рекомендации помогут вам быстро отредактировать этот пакет:


> [!NOTE]
> Помните, что вы можете использовать все RELS-части в пакете как карту, чтобы быстро узнать, какие части документа можно удалить.


1. Откройте неструктурированный XML-файл в Visual Studio и нажмите клавиши CTRL+K, CTRL+D, чтобы отформатировать файл. Затем с помощью кнопок свертывания и развертывания в левой части сверните части, которые нужно удалить. Вы также можете свернуть длинные части, которые нужно сохранить, но которые не требуется изменять (например, двоичные данные в формате Base64 для файла изображения), чтобы упростить и ускорить чтение разметки.

2. При подготовке кода Office Open XML для использования в надстройке вы почти всегда можете удалить несколько частей пакета документов. Вы можете сначала удалить их и связанные определения связей, что сразу значительно уменьшит пакет. Они включают theme1, fontTable, параметры, webSettings, эскиз, основной файл свойств и файл свойств надстройки, части `taskpane` или `webExtension`.

3. Удалите все части, не связанные с содержимым, такие как сноски, верхние и нижние колонтитулы, которые вам не требуются. Опять же, не забудьте удалить соответствующие связи.

4. Изучите часть document.xml.rels, чтобы узнать, требуются ли какие-либо файлы, указанный в ней, для содержимого, например файл изображения, часть стилей или части схемы SmartArt. Удалите связи для всех частей, которые не требуются для содержимого, и удалите связанную часть. Если для содержимого не нужны части документа, указанные в document.xml.rels, вы можете удалить и этот файл.

5. Если у вашего контента есть дополнительная RELS-часть (например, chart#.xml.rels), изучите ее, чтобы узнать, существуют ли другие части, которые можно удалить (например, экспресс-стили для диаграмм), и удалите связь из файла и соответствующую часть.

6. Удалите из document.xml пространства имен, не указанные в части, свойства раздела, если содержимое не включает разрыв раздела, и всю разметку, которая не связана с вставляемым содержимым. При вставке фигур или текстовых полей вы также можете удалить резервную разметку.

7. Измените все другие обязательные части, разметку которых можно удалить без влияния на ваш контент, например часть стилей.

После выполнения предыдущих семи шагов вы удалите около 90–100 % разметки, которую можно удалить, в зависимости от содержимого. В большинстве случаев далее удалять разметку не требуется.

Независимо от того, остановитесь ли вы на этом или решите удалить все возможные строки разметки, помните, что вы можете использовать пример кода [Word-Add-in-Get-Set-EditOpen-XML](https://github.com/OfficeDev/Word-Add-in-Get-Set-EditOpen-XML) для быстрой проверки измененной разметки.


> [!TIP]
> Если вы обновляете фрагмент Office Open XML в существующем решении во время разработки, удалите временные файлы Интернета перед повторным запуском решения, чтобы обновить Office Open XML, используемый кодом. Разметка, которая входит в состав решения в XML-файлах, кэшируется на компьютере. Вы можете удалить временные файлы Интернета в веб-браузере по умолчанию. Чтобы открыть свойства браузера и удалить эти параметры в Visual Studio 2017, в меню **Отладка** выберите пункт **Параметры**. Затем в разделе **Среда** выберите пункт **Веб-браузер**, а затем пункт **Параметры Internet Explorer**.


## <a name="creating-an-add-in-for-both-template-and-stand-alone-use"></a>Создание надстройки для шаблона и автономного применения


В этой статье вы рассмотрели несколько примеров применения Office Open XML в надстройках для Word. Мы рассмотрели множество примеров мультимедиа, которые можно вставлять в документы, используя приведение Office Open XML вместе с методами JavaScript для вставки этого содержимого в выделенное или указанное расположение (привязку).

Итак, что еще нужно знать при создании надстройки для автономного использования (вставляемого из Магазина или собственного сервера) и применения в предварительно созданном шаблоне, который предназначен для работы с надстройкой? Возможно, вы уже знаете все, что нужно.

Разметка для определенного типа содержимого и методы его вставки для автономных надстроек и шаблонов одинаковы. Если вы используете шаблоны, созданные для работы с надстройкой, убедитесь, что код JavaScript включает обратные вызовы, учитывающие ситуации, в которых содержимое уже существует в документе (как показано в примере привязки в разделе [Добавление именованного элемента управления содержимым и привязка к нему](#add-and-bind-to-a-named-content-control)).

При использовании шаблонов в надстройке (она может храниться в шаблоне, когда пользователь создал приложение, или она может вставлять шаблон) вам также может потребоваться использовать другие элементы API, чтобы создать более надежное и интерактивное решение. Например, вы можете добавить идентифицирующие данные в пользовательскую XML-часть, которые будут использоваться для определения типа шаблона и предоставления пользователю связанных с шаблоном параметров. Дополнительные сведения о работе с пользовательским XML в надстройках см. в следующих дополнительных ресурсах.


## <a name="see-also"></a>См. также

- [API JavaScript для Office](/office/dev/add-ins/reference/javascript-api-for-office)
- [Стандарт ECMA-376: форматы файлов Office Open XML](https://www.ecma-international.org/publications/standards/Ecma-376.htm) (здесь вы найдете полный справочник по языку и сопутствующую документацию по Open XML)
- [API JavaScript для Office: привязка данных и пользовательские XML-части](https://msdn.microsoft.com/magazine/dn166930.aspx)
