# <a name="tutorial-create-custom-functions-in-excel"></a>Урок: создание настраиваемых функций в Excel

## <a name="introduction"></a>Введение

Настраиваемые функции позволяют добавлять новые функции в Excel, определяя эти функции в JavaScript как часть надстройки.  Пользователи в Excel могут получать доступ к настраиваемым функциям так же, как к любой собственной функции в Excel, например  `SUM()`. Можно создавать настраиваемые функции, которые будут выполнять простые задачи, такие как настраиваемые вычисления, или более сложные задачи, например потоковая передача данных в режиме реального времени из Интернета в лист таблицы.

В этом руководстве вы:
> [!div class="checklist"]
> * Создадите проект с настраиваемыми функциями, используя генератор Yo Office.
> * Используете готовую настраиваемую функцию для выполнения простых вычислений.
> * Создадите настраиваемую функцию, которая будет запрашивать данные с веб-сайта.
> * Создадите настраиваемую функцию, которая будет передавать данные в реальном времени с веб-сайта.

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

## <a name="prerequisites"></a>Необходимые компоненты

* [Node.js и npm.](https://nodejs.org/en/)

* [Git Bash](https://git-scm.com/downloads) (или другой клиент Git)

* Последняя версия [Yeoman](http://yeoman.io/) и [Генератор Yo Office](https://www.npmjs.com/package/generator-office). Чтобы установить эти средства глобально, выполните следующую команду из командной строки:

    ```bash
    npm install -g yo generator-office
    ```

* Excel для Windows (сборка 10827 или более поздняя версия) или Excel Online.

* Присоединяйтесь к [программе предварительной оценки Office](https://products.office.com/office-insider) (уровень**Insider** ранее именовался «Insider Fast»)

## <a name="create-a-custom-functions-project"></a>Создание проекта настраиваемых функций

Вы начнете этот урок с использования генератора Yo Office для создания файлов, необходимых для проекта настраиваемых функций.

1. Выполните приведенную ниже команду и ответьте на запросы, как показано ниже.

    ```bash
    yo office
    ```

    * Выберите тип проекта: `Excel Custom Functions Add-in project (...)`
    * Выберите тип сценария: `JavaScript`
    * Как вы хотите назвать надстройку? `stock-ticker`

    ![Yo Office выводит запросы, касающиеся настраиваемых функций.](../images/yo-office-cfs-stock-ticker-3.png)

    После завершения работы мастера генератор создает файлы проекта и устанавливает вспомогательные компоненты Node. Файлы проекта поступают из репозитория GitHub [Настраиваемые функции Excel](https://github.com/OfficeDev/Excel-Custom-Functions).

2. Перейдите в папку проекта.

    ```bash
    cd stock-ticker
    ```

3. Запустите локальный веб-сервер.

    * При использовании Excel для Windows для тестирования настраиваемых функций выполните следующую команду для запуска локального веб-сервера, запустите Excel и загрузите надстройку:

        ```bash
        npm start
        ```

    * При использовании Excel Online для тестирования настраиваемых функций выполните следующую команду для запуска локального веб-сервера: 

        ```bash
        npm run start-web
        ```

## <a name="try-out-a-prebuilt-custom-function"></a>Тестирование стандартной настраиваемой функции

Проект настраиваемых функций, созданный с помощью генератора Yo Office, содержит несколько стандартных настраиваемых функций, которые определены в файле **src/customfunction.js**. Файл **manifest.xml** в корневом каталоге проекта указывает на то, что все настраиваемые функции принадлежат к пространству имен `CONTOSO`.

Перед началом использования любых стандартных настраиваемых функций надстройки настраиваемых функций необходимо зарегистрировать в Excel. Для этого следует выполнить действия, указанные в настоящем руководстве для используемой вами платформы.

* Если для тестирования настраиваемых функций используется Excel для Windows:

    1. В Excel перейдите на вкладку **Вставка** и нажмите на стрелку вниз, расположенную справа от секции **Мои надстройки**.  ![Вставьте ленту в Excel для Windows с помощью выделенной стрелки «Мои надстройки».](../images/excel-cf-register-add-in-1b.png)

    2. В списке доступных надстроек найдите секцию ** Надстройки разработчика**  и выберите надстройку **Настраиваемые функции Excel**, чтобы зарегистрировать ее. ![Вставьте ленту в Excel для Windows с помощью выделенной в списке «Мои надстройки» надстройки «Настраиваемые функции Excel»](../images/excel-cf-register-add-in-2.png)

* Если для тестирования настраиваемых функций используется Excel Online: 

    1. В Excel Online перейдите на вкладку **Вставка** и выберите **Надстройки**.  ![Вставьте ленту в Excel Online, используя выделенный значок "Мои надстройки".](../images/excel-cf-online-register-add-in-1.png)

    2. Выберите **Управление моими надстройками** и **Отправить мою надстройку**. 

    3. Нажмите кнопку **Обзор...** и перейдите в корневой каталог проекта, созданный генератором Yo Office. 

    4. Выберите файл **manifest.xml** и нажмите на кнопку **Открыть**, а затем — на кнопку **Загрузить**.

На этом этапе стандартные настраиваемые функции, имеющиеся в вашем проекте, оказываются загруженными и доступными для использования в Excel. Проверьте `ADD` настраиваемую функцию, выполнив в Excel следующие действия:

1. В ячейке введите **= CONTOSO**. Обратите внимание на то, что в меню автозаполнения отображается список всех функций, принадлежащих пространству имен `CONTOSO`.

2. Выполните функцию `CONTOSO.ADD` с числами `10` и `200` в качестве входных параметров, указав в ячейке следующее значение и нажав на клавишу ВВОД:

    ```
    =CONTOSO.ADD(10,200)
    ```

Настраиваемая функция `ADD` вычисляет сумму двух чисел, указанных в качестве входных параметров. При вводе `=CONTOSO.ADD(10,200)` результирующим значением в ячейке после нажатия на клавишу ВВОД должно стать **210**.

## <a name="create-a-custom-function-that-requests-data-from-the-web"></a>Создание настраиваемой функции, запрашивающей данные с веб-сервера

Что делать, если требуется создать функцию, которая может запросить у API цену акции и отобразить результат в ячейке листа? Настраиваемые функции позволяют пользователю без труда запрашивать данные с веб-сервера при работе в асинхронном режиме.

Чтобы создать настраиваемую функцию с именем `stockPrice`, которая принимает код акции (например, **MSFT**) и возвращает цену этой акции, выполните следующие действия. Эта настраиваемая функция использует API для трейдинга IEX, который является бесплатным и не требует проверки подлинности.

1. В созданном генератором Yo Office проекте **stock-ticker** найдите файл **src/customfunctions.js** и откройте его в редакторе кода.

2. Добавьте приведенный ниже код в файл **customfunctions.js** и выполните сохранение файла.

    ```js
    function stockPrice(ticker) {
        var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
        return fetch(url)
            .then(function(response) {
                return response.text();
            })
            .then(function(text) {
                return parseFloat(text);
            });

        // Note: in case of an error, the returned rejected Promise
        //    will be bubbled up to Excel to indicate an error.
    }

    CustomFunctionMappings.STOCKPRICE = stockPrice;
    ```

3. Перед тем, как Excel сможет сделать эту функцию доступной для конечных пользователей, необходимо указать описывающие ее метаданные. В созданном генератором Yo Office проекте **stock-ticker** найдите файл **config/customfunctions.json** и откройте его в редакторе кода. Добавьте следующий объект в массив `functions`, имеющийся в файле **config/customfunctions.json**, и сохраните файл.

    Этот файл JSON описывает функцию `stockPrice`.

    ```json
    {
        "id": "STOCKPRICE",
        "name": "STOCKPRICE",
        "description": "Fetches current stock price",
        "helpUrl": "http://www.contoso.com/help",
        "result": {
            "type": "number",
            "dimensionality": "scalar"
        },  
        "parameters": [
            {
                "name": "ticker",
                "description": "stock ticker name",
                "type": "string",
                "dimensionality": "scalar"
            }
        ]
    }
    ```

4. Чтобы новая функция стала доступна для конечных пользователей, надстройку необходимо повторно зарегистрировать в Excel. Выполните дальнейшие действия, указанные в настоящем руководстве для используемой вами платформы.

    * В случае использования Excel для Windows:

        1. Закройте Excel и снова его откройте.

        2. В Excel перейдите на вкладку **Вставка** и нажмите на стрелку вниз, расположенную справа от секции **Мои надстройки**.  ![Вставьте ленту в Excel для Windows с помощью выделенной стрелки «Мои надстройки».](../images/excel-cf-register-add-in-1b.png)

        1. В списке доступных надстроек найдите секцию ** Надстройки разработчика**  и выберите надстройку **Настраиваемые функции Excel**, чтобы зарегистрировать ее. ![Вставьте ленту в Excel для Windows с помощью выделенной в списке «Мои надстройки» надстройки «Настраиваемые функции Excel»](../images/excel-cf-register-add-in-2.png)

    * В случае использования Excel Online: 

        1. В Excel Online перейдите на вкладку **Вставка** и выберите **Надстройки**.  ![Вставьте ленту в Excel Online, используя выделенный значок "Мои надстройки".](../images/excel-cf-online-register-add-in-1.png)

        2. Выберите **Управление моими надстройками** и **Отправить мою надстройку**. 

        3. Нажмите кнопку **Обзор...** и перейдите в корневой каталог проекта, созданный генератором Yo Office. 

        4. Выберите файл **manifest.xml** и нажмите на кнопку **Открыть**, а затем — на кнопку **Загрузить**.

5. Теперь можно опробовать новую функцию. В ячейке **B1** введите текст `=CONTOSO.STOCKPRICE("MSFT")` и нажмите на клавишу ВВОД. В ячейке **B1** должен отобразиться результат, представляющий собой текущую стоимость одной акции корпорации Майкрософт.

## <a name="create-a-streaming-asynchronous-custom-function"></a>Создание асинхронной настраиваемой функции для потоковой передачи

Только что созданная функция `stockPrice` возвращает цену акции в определенный момент времени, но стоимость акций постоянно меняется. Попробуем создать настраиваемую функцию для поточной передачи данных от API, чтобы обновлять сведения о цене акции в реальном времени.

Чтобы создать настраиваемую функцию с именем `stockPriceStream`, которая запрашивает цену указанной акции через каждые 1000 миллисекунд (при условии завершения предыдущего запроса), выполните следующие действия. Во время выполнения начального запроса в ячейке, из которой вызывается функция, можно видеть значение заполнителя **#GETTING_DATA**. При возврате функцией значения оно будет отображаться в ячейке вместо **#GETTING_DATA**.

1. В созданном генератором Yo Office проекте **stock-ticker** добавьте следующий код в файл **src/customfunctions.js** и сохраните его.

    ```js
    function stockPriceStream(ticker, handler) {
        var updateFrequency = 1000 /* milliseconds*/;
        var isPending = false;

        var timer = setInterval(function() {
            // If there is already a pending request, skip this iteration:
            if (isPending) {
                return;
            }

            var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
            isPending = true;

            fetch(url)
                .then(function(response) {
                    return response.text();
                })
                .then(function(text) {
                    handler.setResult(parseFloat(text));
                })
                .catch(function(error) {
                    handler.setResult(error);
                })
                .then(function() {
                    isPending = false;
                });
        }, updateFrequency);

        handler.onCanceled = () => {
            clearInterval(timer);
        };
    }

    CustomFunctionMappings.STOCKPRICESTREAM = stockPriceStream;
    ```

2. Перед тем, как Excel сможет сделать эту функцию доступной для конечных пользователей, необходимо указать описывающие ее метаданные. В созданном генератором Yo Office проекте **stock-ticker** добавьте следующий объект в массив `functions`, имеющийся в файле **config/customfunctions.json**, после чего произведите сохранение файла.

    Этот файл JSON описывает функцию `stockPriceStream`. Для любой функции потоковой передачи данных свойству `stream` и свойству `cancelable` следует присвоить значение `true` внутри объекта `options`, как показано в приведенном далее примере кода.

    ```json
    { 
        "id": "STOCKPRICESTREAM",
        "name": "STOCKPRICESTREAM",
        "description": "Streams real time stock price",
        "helpUrl": "http://www.contoso.com/help",
        "result": {
            "type": "number",
            "dimensionality": "scalar"
        },  
        "parameters": [
            {
                "name": "ticker",
                "description": "stock ticker name",
                "type": "string",
                "dimensionality": "scalar"
            }
        ],
        "options": {
            "stream": true,
            "cancelable": true
        }
    }
    ```

3. Чтобы новая функция стала доступна для конечных пользователей, надстройку необходимо повторно зарегистрировать в Excel. Выполните дальнейшие действия, указанные в настоящем руководстве для используемой вами платформы.

    * В случае использования Excel для Windows:

        1. Закройте Excel и снова его откройте.
        
        2. В Excel перейдите на вкладку **Вставка** и нажмите на стрелку вниз, расположенную справа от секции **Мои надстройки**.  ![Вставьте ленту в Excel для Windows с помощью выделенной стрелки «Мои надстройки».](../images/excel-cf-register-add-in-1b.png)

        3. В списке доступных надстроек найдите секцию ** Надстройки разработчика**  и выберите надстройку **Настраиваемые функции Excel**, чтобы зарегистрировать ее. ![Вставьте ленту в Excel для Windows с помощью выделенной в списке «Мои надстройки» надстройки «Настраиваемые функции Excel»](../images/excel-cf-register-add-in-2.png)

    * В случае использования Excel Online: 

        1. В Excel Online перейдите на вкладку **Вставка** и выберите **Надстройки**.  ![Вставьте ленту в Excel Online, используя выделенный значок "Мои надстройки".](../images/excel-cf-online-register-add-in-1.png)

        2. Выберите **Управление моими надстройками** и **Отправить мою надстройку**. 

        3. Нажмите кнопку **Обзор...** и перейдите в корневой каталог проекта, созданный генератором Yo Office. 

        4. Выберите файл **manifest.xml** и нажмите на кнопку **Открыть**, а затем — на кнопку **Загрузить**.

4. Теперь можно опробовать новую функцию. В ячейке **C1** введите текст `=CONTOSO.STOCKPRICESTREAM("MSFT")` и нажмите на клавишу ВВОД. Если фондовая биржа открыта, то результирующее значение в ячейке **C1** будет постоянно обновляться для отображения в реальном времени стоимости одной акции корпорации Майкрософт.

## <a name="next-steps"></a>Дальнейшие шаги

В этом руководстве рассматривается создание нового проекта настраиваемых функций, создание настраиваемой функции, которая запрашивает данные от веб-сервера, и создание настраиваемой функции, осуществляющей поточную передачу данных с веб-сервера в режиме реального времени. Чтобы больше узнать о настраиваемых функциях в Excel, ознакомьтесь со следующей статьей: 

> [!div class="nextstepaction"]
> [Создание настраиваемых функций в Excel](../excel/custom-functions-overview.md)

## <a name="legal-information"></a>Юридическая информация

Данные бесплатно предоставляются [IEX](https://iextrading.com/developer/). Ознакомьтесь с [Условиями использования IEX](https://iextrading.com/api-exhibit-a/). Содержащееся в данном руководстве описание использования API IEX корпорацией Майкрософт приводится только для обучения.
