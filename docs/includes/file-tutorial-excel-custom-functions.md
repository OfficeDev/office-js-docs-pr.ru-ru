# <a name="tutorial-create-custom-functions-in-excel"></a>Руководство: создание пользовательских функций в Excel

## <a name="introduction"></a>Введение

Пользовательские функции позволяют добавлять новые функции в Excel путем определения этих функций в JavaScript как части надстройки. Пользователи в Excel могут получить доступ к пользовательским функциям так же, как и к любой встроенной функции в Excel, например `SUM()`. Вы можете создавать пользовательские функции, которые будут выполнять простые задачи, такие как настраиваемые вычисления, или более сложные задачи, такие как потоковая передача данных в режиме реального времени из Интернета на лист.

В этом руководстве описан порядок выполнения перечисленных ниже задач.
> [!div class="checklist"]
> * Создание проекта пользовательских функций с помощью генератора Yo Office
> * Использование готовой пользовательской функции для выполнения простых вычислений
> * Создание пользовательской функции, которая запрашивает данные из Интернета
> * Создание пользовательской функции, которая осуществляет потоковую передачу данных в реальном времени из Интернета

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

## <a name="prerequisites"></a>Необходимые компоненты

* [Node.js](https://nodejs.org/en/) (версия 8.0.0 или более поздняя)

* [Git Bash](https://git-scm.com/downloads) (или другой клиент Git)

* Последняя версия [Yeoman](https://yeoman.io/) и [генератора Yeoman для надстроек Office](https://www.npmjs.com/package/generator-office). Выполните в командной строке указанную ниже команду, чтобы установить эти инструменты глобально.

    ```
    npm install -g yo generator-office
    ```

    > [!NOTE]
    > Даже если у вас установлен генератор Yeoman, рекомендуется обновить пакет до последней версии из npm.

* Excel для Windows (64-разрядная версия 1810 или более поздняя) или Excel Online

* Присоединитесь к [Программе предварительной оценки Office](https://products.office.com/office-insider) (уровень **Участник**; ранее "Предварительная оценка — ранний доступ")

## <a name="create-a-custom-functions-project"></a>Создание проекта пользовательских функций

 Чтобы начать работу, создайте проект пользовательских функций с помощью генератора Yeoman. Это позволит настроить для проекта правильную структуру папок, исходные файлы и зависимости, чтобы начать написание кода пользовательских функций.

1. Выполните указанную ниже команду и ответьте на вопросы, как показано ниже.

    ```
    yo office
    ```

    * Выберите тип проекта: `Excel Custom Functions Add-in project (...)`

    * Выберите тип сценария: `JavaScript`

    * Как вы хотите назвать свою надстройку? `stock-ticker`

    ![Генератор Yeoman для надстройки Office, приглашающий к созданию пользовательских функций](../images/12-10-fork-cf-pic.jpg)

    Генератор Yeoman создаст файлы проекта и установит вспомогательные компоненты Node. Файлы проекта взяты из репозитория [Excel-Custom-Functions](https://github.com/OfficeDev/Excel-Custom-Functions) GitHub.

2. Перейдите в папку проекта.

    ```
    cd stock-ticker
    ```

3. Сделайте доверенным самозаверяющий сертификат, необходимый для выполнения этого проекта. Подробные инструкции для Windows или Mac см. в статье [Добавление самозаверяющих сертификатов в качестве доверенных корневых сертификатов](https://github.com/OfficeDev/generator-office/blob/master/src/docs/ssl.md).  

4. Выполните сборку проекта.

    ```
    npm run build
    ```

5. Запустите локальный веб-сервер, работающий на Node.js.

    * Если вы будете использовать Excel для Windows для тестирования ваших пользовательских функций, выполните следующую команду, чтобы запустить локальный веб-сервер, запустить программу Excel и загрузить неопубликованную надстройку:

        ```
         npm run start
        ```
        После выполнения этой команды, в командной строке отобразятся сведения о выполненных действиях, откроется другое окно npm со сведениями о сборке, и запустится Excel с загруженной надстройкой. Если надстройка не загружается, проверьте правильность выполнения шага 3.

    * Если вы будете использовать Excel Online для тестирования ваших пользовательских функций, выполните следующую команду, чтобы запустить локальный веб-сервер:

        ```
        npm run start-web
        ```

         После выполнения этой команды откроется другое окно со сведениями о сборке. Чтобы использовать свои функции, откройте новую книгу в Office Online.

## <a name="try-out-a-prebuilt-custom-function"></a>Проверка работы готовой пользовательской функции

Проект пользовательских функций, созданный с помощью генератора Yeoman, содержит некоторые готовые пользовательские функции, определенные в файле **src/customfunctions.js**. Файл **manifest.xml** в корневом каталоге проекта указывает, что все пользовательские функции принадлежат пространству имен `CONTOSO`.

В книге Excel попробуйте, как работает пользовательская функция `ADD`, выполнив описанные ниже действия.

1. Введите в ячейке **=CONTOSO**. Обратите внимание на то, что в меню автозаполнения содержится список всех функций в пространстве имен `CONTOSO`.

2. Выполните запуск функции `CONTOSO.ADD` с числами `10` и `200` в качестве входных параметров, введя значение `=CONTOSO.ADD(10,200)` в ячейке и нажав клавишу ВВОД.

Пользовательская функция `ADD` вычисляет сумму двух чисел, которые вы указываете в качестве входных параметров. При вводе `=CONTOSO.ADD(10,200)` в ячейке должен отобразиться результат **210** после нажатия клавиши ВВОД.

## <a name="create-a-custom-function-that-requests-data-from-the-web"></a>Создание пользовательской функции, которая запрашивает данные из Интернета

Что делать, если требуется функция, которая сможет запросить цену на акцию из API и отобразить результат в ячейке на листе? Пользовательские функции разрабатываются таким образом, что вы можете легко асинхронно запросить данные из Интернета.

Выполните указанные ниже действия, чтобы создать пользовательскую функцию с именем `stockPrice`, которая принимает код акции (например, **MSFT**) и возвращает цену этой акции. Такая пользовательская функция использует API IEX Trading, который предоставляется бесплатно и не требует проверки подлинности.

1. В проекте **stock-ticker**, созданном генератором Yeoman, найдите файл **src/customfunctions.js** и откройте его в редакторе кода.

2. В файле **customfunctions.js** найдите функцию `increment` и добавьте приведенный ниже код сразу после этой функции.

    ```js
    function stockPrice(ticker) {
        var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
        return fetch(url)
            .then(function(response) {
                return response.text();
            })
            .then(function(text) {
                return parseFloat(text);
            });

        // Note: in case of an error, the returned rejected Promise
        //    will be bubbled up to Excel to indicate an error.
    }

3. In **customfunctions.js**, locate the line`CustomFunctionMappings.INCREMENT = increment;`, add the following line of code immediately after that line, and save the file.

    ```js
    CustomFunctionMappings.STOCKPRICE = stockPrice;
    ```

4. Прежде чем можно будет сделать в Excel такую функцию доступной, необходимо указать метаданные, чтобы описать функцию для Excel. Откройте файл **config/customfunctions.json**. Добавьте указанный ниже объект JSON в массив 'functions' и сохраните файл.

    Объект JSON описывает функцию `stockPrice`.

    ```JSON
    {
        "id": "STOCKPRICE",
        "name": "STOCKPRICE",
        "description": "Fetches current stock price",
        "helpUrl": "http://www.contoso.com/help",
        "result": {
            "type": "number",
            "dimensionality": "scalar"
        },  
        "parameters": [
            {
                "name": "ticker",
                "description": "stock ticker name",
                "type": "string",
                "dimensionality": "scalar"
            }
        ]
    }
    ```

5. Необходимо повторно зарегистрировать надстройку в Excel, чтобы новая функция стала доступной конечным пользователям. Выполните указанные ниже действия для платформы, которую вы используете в этом руководстве.

    * Если вы используете Excel для Windows, выполните указанные ниже действия.

        1. Закройте Excel, а затем откройте Excel повторно.

        2. В Excel выберите вкладку **Вставка**, а затем нажмите стрелку вниз, которая находится справа от пункта **Мои надстройки**. ![Вставьте ленту в Excel для Windows с выделенной стрелкой "Мои надстройки"](../images/excel-cf-register-add-in-1b.png).

        3. В списке доступных надстроек найдите раздел **Надстройки разработчика** и выберите надстройку **stock-ticker**, чтобы зарегистрировать ее.
            ![Вставьте ленту в Excel для Windows с выделенной надстройкой "Пользовательские функции Excel" в списке "Мои надстройки"](../images/excel-cf-register-add-in-2.png).

    * Если вы используете Excel Online, выполните указанные ниже действия.

        1. В Excel Online выберите вкладку **Вставка**, а затем выберите **Надстройки**. ![Вставьте ленту в Excel Online с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

        2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**. 

        3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman. 

        4. Выберите файл **manifest.xml** и нажмите кнопку **Открыть**, затем нажмите кнопку **Отправить**.

6. Теперь давайте попробуем, как работает новая функция. В ячейке **B1** введите текст `=CONTOSO.STOCKPRICE("MSFT")` и нажмите клавишу ВВОД. Вы увидите, что результат в ячейке **B1** является текущей ценой одной акции корпорации Майкрософт.

## <a name="create-a-streaming-asynchronous-custom-function"></a>Создание потоковой асинхронной пользовательской функции

Функция `stockPrice`, которую вы только что создали, возвращает цену акции в конкретный момент времени, однако цены на акции всегда меняются. Давайте создадим пользовательскую функцию, которая осуществляет потоковую передачу данных из API, чтобы получать обновления цен на акции в реальном времени.

Выполните указанные ниже действия, чтобы создать функцию с именем `stockPriceStream`, которая будет запрашивать цену указанной акции каждые 1000 миллисекунд (при условии, что предыдущий запрос был выполнен). Во время выполнения первоначального запроса в ячейке, где вызывается функция, может появиться значение-заполнитель **#GETTING_DATA**. Когда значение будет возвращено функцией, оно заменит значение-заполнитель **#GETTING_DATA** в ячейке.

1. В проекте **stock-ticker**, созданном генератором Yeoman, добавьте указанный ниже код в файл **src/customfunctions.js** и сохраните его.

    ```js
    function stockPriceStream(ticker, handler) {
        var updateFrequency = 1000 /* milliseconds*/;
        var isPending = false;

        var timer = setInterval(function() {
            // If there is already a pending request, skip this iteration:
            if (isPending) {
                return;
            }

            var url = "https://api.iextrading.com/1.0/stock/" + ticker + "/price";
            isPending = true;

            fetch(url)
                .then(function(response) {
                    return response.text();
                })
                .then(function(text) {
                    handler.setResult(parseFloat(text));
                })
                .catch(function(error) {
                    handler.setResult(error);
                })
                .then(function() {
                    isPending = false;
                });
        }, updateFrequency);

        handler.onCanceled = () => {
            clearInterval(timer);
        };
    }

    CustomFunctionMappings.STOCKPRICESTREAM = stockPriceStream;
    ```

2. Прежде чем можно будет сделать в Excel такую функцию доступной пользователям, укажите метаданные, описывающие эту функцию. В проекте **stock-ticker**, созданном генератором Yeoman, добавьте указанный ниже объект в массив `functions` в файле **config/customfunctions.json** и сохраните файл.

    Объект JSON описывает функцию `stockPriceStream`. Для любой функции потоковой передачи свойство `stream` и свойство `cancelable` должны быть заданы как `true` в объекте `options`, как показано в этом примере кода.

    ```json
    { 
        "id": "STOCKPRICESTREAM",
        "name": "STOCKPRICESTREAM",
        "description": "Streams real time stock price",
        "helpUrl": "http://www.contoso.com/help",
        "result": {
            "type": "number",
            "dimensionality": "scalar"
        },  
        "parameters": [
            {
                "name": "ticker",
                "description": "stock ticker name",
                "type": "string",
                "dimensionality": "scalar"
            }
        ],
        "options": {
            "stream": true,
            "cancelable": true
        }
    }
    ```

3. Необходимо повторно зарегистрировать надстройку в Excel, чтобы новая функция стала доступной конечным пользователям. Выполните указанные ниже действия для платформы, которую вы используете в этом руководстве.

    * Если вы используете Excel для Windows, выполните указанные ниже действия.

        1. Закройте Excel, а затем откройте Excel повторно.
        
        2. В Excel выберите вкладку **Вставка**, а затем нажмите стрелку вниз, которая находится справа от пункта **Мои надстройки**. ![Вставьте ленту в Excel для Windows с выделенной стрелкой "Мои надстройки"](../images/excel-cf-register-add-in-1b.png).

        3. В списке доступных надстроек найдите раздел **Надстройки разработчика** и выберите надстройку **stock-ticker**, чтобы зарегистрировать ее.
            ![Вставьте ленту в Excel для Windows с выделенной надстройкой "Пользовательские функции Excel" в списке "Мои надстройки"](../images/excel-cf-register-add-in-2.png).

    * Если вы используете Excel Online, выполните указанные ниже действия.

        1. В Excel Online выберите вкладку **Вставка**, а затем выберите **Надстройки**. ![Вставьте ленту в Excel Online с выделенным значком "Мои надстройки"](../images/excel-cf-online-register-add-in-1.png)

        2. Выберите пункт **Управление моими надстройками**, а затем выберите **Отправить мою надстройку**.

        3. Выберите **Обзор... ** и откройте корневой каталог проекта, созданный генератором Yeoman.

        4. Выберите файл **manifest.xml** и нажмите кнопку **Открыть**, затем нажмите кнопку **Отправить**.

4. Теперь давайте попробуем, как работает новая функция. В ячейке **C1** введите текст `=CONTOSO.STOCKPRICESTREAM("MSFT")` и нажмите клавишу ВВОД. Если рынок ценных бумаг открыт, вы увидите, что результат в ячейке **C1** постоянно обновляется, отражая в режиме реального времени цену одной акции корпорации Майкрософт.

## <a name="next-steps"></a>Дальнейшие действия

В ходе работы с данным руководством вы создали новый проект пользовательских функций, попробовали, как работает готовая функция, создали пользовательскую функцию, которая запрашивает данные из Интернета, а также создали пользовательскую функцию, которая осуществляет потоковую передачу данных в реальном времени из Интернета. Чтобы узнать больше о пользовательских функции в Excel, перейдите к следующей статье:

> [!div class="nextstepaction"]
> [Создание пользовательских функций в Excel](../excel/custom-functions-overview.md)

## <a name="legal-information"></a>Юридические сведения

Данные предоставлены бесплатно компанией [IEX](https://iextrading.com/developer/). Ознакомьтесь с [Условиями использования IEX](https://iextrading.com/api-exhibit-a/). Корпорация Майкрософт использует API компании IEX в этом руководстве исключительно в ознакомительных целях.
