## <a name="register-the-add-in-with-microsoft-identity-platform"></a>Регистрация надстройки с помощью платформа удостоверений Майкрософт

Необходимо создать регистрацию приложения в Azure, представляющего веб-сервер. Это обеспечивает поддержку проверки подлинности, чтобы в коде клиента в JavaScript можно было выдавать правильные маркеры доступа. Эта регистрация поддерживает как единый вход в клиенте, так и резервную проверку подлинности с помощью библиотеки проверки подлинности Майкрософт (MSAL).


1. Войдите в [портал Azure](https://portal.azure.com/) с учетными данными ***admin** _ для клиента Microsoft 365. Например, _*MyName@contoso.onmicrosoft.com**.
1. Выберите **Регистрация приложений**. Если значок не отображается, найдите "регистрация приложения" в строке поиска.

    :::image type="content" source="../images/azure-portal-select-app-registration.png" alt-text="Домашняя страница портал Azure.":::

    Появится страница **регистрации приложений**.

1. Выберите **Новая регистрация**.

    :::image type="content" source="../images/azure-portal-select-new-registration.png" alt-text="Новая регистрация на панели Регистрация приложений.":::

    Откроется **панель Регистрация приложения** .

1. В разделе **Управление** выберите **Регистрация приложений** >  **Новая регистрация**. На панели **Регистрация приложения** задайте следующие значения.

    * Введите **имя** `<add-in-name>`.
    * Задайте **для значения Поддерживаемые типы учетных записей** **значение Учетные записи в любом каталоге организации (любой каталог Azure AD — мультитенантный) и личных учетных записей Майкрософт (например, Skype, Xbox).**
    * Задайте **URI перенаправления** , чтобы использовать платформу `<redirect-platform>` , а URI — `<redirect-uri>`.

    :::image type="content" source="../images/azure-portal-register-an-application.png" alt-text="Регистрация области приложения с именем и поддерживаемой учетной записью.":::

1. Нажмите **Зарегистрировать**. Появится сообщение о том, что регистрация приложения создана.

    :::image type="content" source="../images/azure-portal-application-created-message.png" alt-text="Сообщение о том, что регистрация приложения создана.":::

1. Скопируйте и сохраните значения идентификатора **приложения (клиента)** и **каталога (клиента).** Они понадобятся вам позже.

    :::image type="content" source="../images/azure-portal-copy-client-directory-ids.png" alt-text="Область регистрации приложений для Contoso с идентификатором клиента и идентификатором каталога.":::

## <a name="add-a-client-secret"></a>Добавление секрета клиента

Секрет клиента, который иногда называется _паролем приложения_, — это строковое значение, которое приложение может использовать вместо сертификата для идентификации себя.

1. Выберите **Сертификаты & секреты**. Затем на вкладке **Секреты клиента** выберите **Новый секрет клиента**.

    :::image type="content" source="../images/azure-portal-create-new-client-secret.png" alt-text="Область &quot;Сертификаты & секреты&quot;.":::

    Откроется панель **Добавление секрета клиента** .

1. Добавьте описание секрета клиента.
1. Выберите срок действия секрета или укажите пользовательское время существования.
    * Время существования секрета клиента ограничено двумя годами (24 месяцами) или менее. Нельзя указать пользовательское время существования, превышающее 24 месяца.
    * Корпорация Майкрософт рекомендует установить срок действия менее 12 месяцев.

    :::image type="content" source="../images/azure-portal-client-secret-description.png" alt-text="Добавьте область секретов клиента с описанием и истекает срок действия.":::

1. Нажмите **Добавить**. Создается новый секрет, значение временно отображается.

> [!IMPORTANT]
> _Запишите значение секрета_ для использования в коде клиентского приложения. Это значение _секрета больше не отображается_ после выхода из этой области.

## <a name="expose-a-web-api"></a>Предоставление веб-API

1. Выберите **Предоставить API**.

    Откроется панель **Предоставление API** .

    :::image type="content" source="../images/azure-portal-expose-an-api.png" alt-text="Область Предоставления API для регистрации приложения.":::

1. Выберите **Задать** , чтобы создать универсальный код ресурса (URI) идентификатора приложения.

    :::image type="content" source="../images/azure-portal-set-api-uri.png" alt-text="Кнопка &quot;Задать&quot; в области &quot;Предоставление API&quot; для регистрации приложения.":::

    Раздел для задания URI идентификатора приложения отображается с созданным URI идентификатора приложения в формате `api://<app-id>`.

1. Обновите URI идентификатора приложения на `api://localhost:44355/<app-id>`.

    :::image type="content" source="../images/azure-portal-app-id-uri-details.png" alt-text="Измените область URI идентификатора приложения, указав для порта localhost значение 44355.":::

    * **URI идентификатора приложения** предварительно заполняется идентификатором приложения (GUID) в формате`api://<app-id>`.
    * Формат URI идентификатора приложения должен быть следующим: `api://<fully-qualified-domain-name>/<app-id>`
    * Вставьте между `fully-qualified-domain-name` `api://` и `<app-id>` (который является GUID). Например, `api://contoso.com/<app-id>`.
    * Если вы используете localhost, формат должен иметь формат `api://localhost:<port>/<app-id>`. Например, `api://localhost:44355/c6c1f32b-5e55-4997-881a-753cc1d563b7`.

    Дополнительные сведения о URI идентификатора приложения см. в разделе [Идентификатор манифеста приложения.](/azure/active-directory/develop/reference-app-manifest#identifieruris-attribute)

    > [!NOTE]
    > Если возникает ошибка с сообщением о том, что домен уже занят, но при этом вы являетесь его владельцем, следуйте процедуре в статье [Краткое руководство. Добавление имени личного домена в Azure Active Directory](/azure/active-directory/add-custom-domain), чтобы зарегистрировать его, а затем повторите этот шаг. (Эта ошибка также может возникнуть, если вы не выполнили вход с учетными данными администратора в клиенте Microsoft 365. См. шаг 2. Выйдите и снова войдите с помощью учетных данных администратора и повторите процесс на шаге 3.)

## <a name="add-a-scope"></a>Добавление области

1. Нажмите **Добавить область**.

    :::image type="content" source="../images/azure-portal-add-a-scope.png" alt-text="Нажмите кнопку Добавить область.":::

    Откроется панель **Добавление области** .

1. На панели **Добавление области** укажите атрибуты области .

    :::image type="content" source="../images/azure-portal-add-a-scope-details.png" alt-text="Добавьте область области с примерами значений.":::

    | Поле | Описание | Значения |
    |-------|-------------|---------|
    | **Имя области** | Имя области. Общее соглашение об именовании области — .`resource.operation.constraint` | Для единого входа необходимо задать значение `access_as_user`. |
    | **Кто может дать согласие** |  Определяет, требуется ли согласие администратора или пользователи могут предоставить согласие без одобрения администратора. | Для изучения единого входа и примеров рекомендуется задать для этого параметра **значение Администраторы и пользователи**. <br><br>Выберите **Администраторы только** для более привилегированных разрешений.|
    | **отображаемое имя согласия Администратор** | Краткое описание цели области, видимой только администраторам. | `Read-only access to user files and profiles.` |
    | **описание согласия Администратор** | Более подробное описание разрешения, предоставляемого областью, которую видят только администраторы. | `Allow Office to have read-only access to all user files and profiles. Office can call the app's web APIs as the current user.` |
    | **Отображаемое имя согласия пользователя** | Краткое описание назначения области. Отображается для пользователей только в том случае, если для **администраторов и пользователей** задан параметр **Кто может предоставить согласие**. | `Read-only access to your files and profile.` |
    | **Описание согласия пользователя** | Более подробное описание разрешения, предоставляемого областью. Отображается для пользователей только в том случае, если для **администраторов и пользователей** задан параметр **Кто может предоставить согласие**. | `Allow Office to have read-only access to your files and user profile.` |

1. Задайте **для параметра Состояние** **значение Включено**, а затем выберите **Добавить область**.

    :::image type="content" source="../images/azure-portal-enable-state-add-scope-button.png" alt-text="Задайте для параметра Состояние включено и нажмите кнопку Добавить область.":::

    Новая область, определенная вами, отображается на панели.

    :::image type="content" source="../images/azure-portal-scope-added-successfully.png" alt-text="Новая область, отображаемая на панели Предоставление API.":::

    > [!NOTE]
    > Доменная часть **имени области**, отображаемая непосредственно под текстовым полем, должна автоматически соответствовать **URI идентификатора приложения**, заданного на предыдущем шаге, с добавлением `/access_as_user` в конце, например: `api://localhost:6789/c6c1f32b-5e55-4997-881a-753cc1d563b7/access_as_user`.

1. Выберите **Добавить клиентское приложение.**

    :::image type="content" source="../images/azure-portal-add-a-client-application.png" alt-text="Выберите Добавить клиентское приложение.":::

    Откроется панель **Добавление клиентского приложения** .

1. В поле **Идентификатор клиента** введите `ea5a67f6-b6f3-4338-b240-c655ddc3cc8e`. Это значение предварительно разрешает все конечные точки приложений Microsoft Office.

    > [!NOTE]
    > Идентификатор `ea5a67f6-b6f3-4338-b240-c655ddc3cc8e` предварительно авторизует Office на всех следующих платформах. Кроме того, можно ввести соответствующее подмножество следующих идентификаторов, если по какой-либо причине вы хотите запретить авторизацию Office на некоторых платформах. Просто оставьте идентификаторы платформ, с которых вы хотите удержать авторизацию. Пользователи надстройки на этих платформах не смогут вызывать веб-API, но другие функции надстройки по-прежнему будут работать.
    >
    > - `d3590ed6-52b3-4102-aeff-aad2292ab01c` (Microsoft Office).
    > - `93d53678-613d-4013-afc1-62e9e444a0a5` (Office в Интернете).
    > - `bc59ab01-8403-45c6-8796-ac3ef710b3e3` (Outlook в Интернете).

1. В **разделе Авторизованные области** установите `api://localhost:44355/<app-id>/access_as_user` флажок.

1. Нажмите кнопку **Добавить приложение**.

    :::image type="content" source="../images/azure-portal-add-application.png" alt-text="Панель Добавление клиентского приложения.":::

## <a name="add-microsoft-graph-permissions"></a>Добавление разрешений Microsoft Graph

1. Выберите **Разрешения API**.

    :::image type="content" source="../images/azure-portal-api-permissions.png" alt-text="Область разрешений API.":::

    Откроется область **разрешений API** .

1. Выберите **Добавить разрешение**.

    :::image type="content" source="../images/azure-portal-add-a-permission.png" alt-text="Добавление разрешения на область разрешений API.":::

    Откроется область **Запрашивать разрешения API** .

1. Выберите **Microsoft Graph**.

    :::image type="content" source="../images/azure-portal-request-api-permissions-graph.png" alt-text="Панель Запрашивать разрешения API с помощью кнопки Microsoft Graph.":::

1. Выберите **Делегированные разрешения**.

    :::image type="content" source="../images/azure-portal-request-api-permissions-delegated.png" alt-text="Панель Запрашивать разрешения API с делегированными разрешениями.":::

1. В поле поиска **Выберите разрешения** найдите разрешения, необходимые надстройке. Ниже приведены типичные значения, используемые в примерах.

    * Files.Read
    * openid
    * profile

    > [!NOTE]
    > Разрешение `User.Read` может быть уже указано по умолчанию. Рекомендуется запрашивать только необходимые разрешения, поэтому рекомендуется снять флажок для этого разрешения, если надстройка на самом деле не нужна.

1. Установите флажки для каждого разрешения, как оно отображается. Обратите внимание, что разрешения не будут отображаться в списке при выборе каждого из них. Выбрав разрешения, необходимые надстройке, выберите **Добавить разрешения**.

    :::image type="content" source="../images/azure-portal-request-api-permissions-add-permissions.png" alt-text="Область Запрашивать разрешения API с выбранными разрешениями.":::

## <a name="configure-access-token-version"></a>Настройка версии маркера доступа

Необходимо определить версию маркера доступа, приемлемую для вашего приложения. Эта конфигурация выполняется в манифесте приложения Azure Active Directory.

### <a name="define-the-access-token-version"></a>Определение версии маркера доступа

Версия маркера доступа может измениться, если вы выбрали тип учетной записи, отличной от **Учетные записи в любом каталоге организации (любой каталог Azure AD — мультитенантный), и личные учетные записи Майкрософт (например, Skype, Xbox).** Выполните следующие действия, чтобы убедиться, что версия маркера доступа правильна для использования единого входа Office.

1. Выберите **Управление** > **Манифест** на панели слева.

    :::image type="content" source="../images/azure-portal-manifest.png" alt-text="Выберите Манифест Azure.":::

    Откроется манифест приложения Azure Active Directory.

1. Введите **2** в качестве значения свойства `accessTokenAcceptedVersion`.

    :::image type="content" source="../images/azure-portal-manifest-token-version.png" alt-text="Значение для принятой версии маркера доступа.":::

1. Нажмите кнопку **Сохранить**.

    В браузере появится сообщение об успешном обновлении манифеста.

    :::image type="content" source="../images/azure-portal-manifest-updated-message.png" alt-text="Сообщение об обновлении манифеста.":::

Поздравляем! Вы завершили регистрацию приложения, чтобы включить единый вход для надстройки Office.
