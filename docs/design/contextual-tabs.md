---
title: Создание настраиваемых контекстных вкладок в надстройках Office
description: Узнайте, как добавить настраиваемые контекстные вкладки в надстройку Office.
ms.date: 11/20/2020
localization_priority: Normal
ms.openlocfilehash: d8617c7dd8748d15393c0e38c527062e5894e791
ms.sourcegitcommit: cba180ae712d88d8d9ec417b4d1c7112cd8fdd17
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/09/2020
ms.locfileid: "49612738"
---
# <a name="create-custom-contextual-tabs-in-office-add-ins-preview"></a>Создание настраиваемых контекстных вкладок в надстройках Office (Предварительная версия)

Контекстная вкладка — это скрытый элемент управления "Вкладка" на ленте Office, который отображается в строке вкладок при возникновении указанного события в документе Office. Например, вкладка **конструктор таблицы** , которая отображается на ленте Excel при выборе таблицы. Вы можете включить настраиваемые контекстные вкладки в надстройку Office и указать, когда они видимы или скрыты, создавая обработчики событий, которые изменяют видимость. (Однако настраиваемые контекстные вкладки не отвечают на изменения фокуса.)

> [!NOTE]
> В этой статье предполагается, что вы уже ознакомились с приведенной ниже документацией. Просмотрите ее, если вы работали с командами надстроек (настраиваемыми элементами меню и кнопками ленты) некоторое время назад.
>
> - [Основные концепции команд надстроек](add-in-commands.md)

> [!IMPORTANT]
> Настраиваемые контекстные вкладки доступны в предварительной версии. Поэкспериментируйте с ними в среде разработки или тестирования, но не добавляйте их в производственную надстройку.
>
> В настоящее время Настраиваемые контекстные вкладки поддерживаются только в Excel и только на этих платформах и построениях:
>
> - Excel в Windows (только для Microsoft 365, а не Бессрочная лицензия): версия 2011 (сборка 13426,20274). Возможно, ваша подписка на Microsoft 365 должна быть включена в [текущий канал (Предварительная версия)](https://insider.office.com/join/windows) , ранее называемый "Monthly Channel (targeted)" или "Предварительная оценка".

> [!NOTE]
> Настраиваемые контекстные вкладки работают только на платформах, поддерживающих следующие наборы требований. Дополнительные сведения о наборах требований и способах работы с ними можно узнать в статье [Указание приложений Office и требований к API](../develop/specify-office-hosts-and-api-requirements.md).
>
> - [Шаредрунтиме 1,1](../reference/requirement-sets/shared-runtime-requirement-sets.md)

## <a name="behavior-of-custom-contextual-tabs"></a>Поведение настраиваемых контекстных вкладок

Пользовательский интерфейс для настраиваемых контекстных вкладок соответствует шаблону встроенных контекстных вкладок Office. Ниже приведены основные принципы для настраиваемых контекстных вкладок размещения.

- Если пользовательская контекстная вкладка отображается, она отображается в правой части ленты.
- Если одновременно отображаются одна или несколько встроенных контекстных вкладок и одна или несколько настраиваемых контекстных вкладок из надстроек, пользовательские контекстные вкладки всегда расположены справа от всех встроенных контекстных вкладок.
- Если у надстройки есть несколько контекстных вкладок и есть контексты, в которых отображаются несколько контекстов, они отображаются в том порядке, в котором они определены в надстройке. (Направление — это то же направление, что и язык Office; то есть слева направо для языков с письмом слева направо, но справа налево для языков с письмом справа налево.) [В разделе Определение групп и элементов управления, которые отображаются на вкладке,](#define-the-groups-and-controls-that-appear-on-the-tab) для получения сведений о том, как они определены.
- Если в нескольких надстройках есть контекстная вкладка, видимая в определенном контексте, они отображаются в том порядке, в котором были запущены надстройки.
- Настраиваемые *Контекстные* вкладки, в отличие от пользовательских основных вкладок, не добавляются в ленту приложения Office без возможности восстановления. Они существуют только в документах Office, в которых работает ваша надстройка.

## <a name="major-steps-for-including-a-contextual-tab-in-an-add-in"></a>Основные действия по добавлению контекстной вкладки в надстройке

Ниже приведены основные действия по добавлению настраиваемой контекстной вкладки в надстройке.

1. Настройка надстройки для использования общей среды выполнения.
1. Определите вкладки, а также группы и элементы управления, которые отображаются на ней.
1. Зарегистрируйте контекстную вкладку в Office.
1. Укажите обстоятельства, когда вкладка станет видимой.

## <a name="configure-the-add-in-to-use-a-shared-runtime"></a>Настройка надстройки для использования общей среды выполнения

Для добавления настраиваемых контекстных вкладок необходимо, чтобы ваша надстройка использовала общую среду выполнения. Дополнительные сведения см. в статье [Настройка надстройки для использования общей среды выполнения](../excel/configure-your-add-in-to-use-a-shared-runtime.md).

## <a name="define-the-groups-and-controls-that-appear-on-the-tab"></a>Определение групп и элементов управления, которые отображаются на вкладке

В отличие от пользовательских основных вкладок, которые определены с помощью XML в манифесте, Настраиваемые контекстные вкладки определяются во время выполнения с помощью большого двоичного объекта JSON. Ваш код анализирует большой двоичный объект в объект JavaScript, а затем передает объект в метод [Office. Ribbon. рекуесткреатеконтролс](/javascript/api/office/office.ribbon?view=common-js&preserve-view=true#requestCreateControls-tabDefinition-) . Настраиваемые контекстные вкладки присутствуют только в документах, в которых в данный момент запущена надстройка. Это отличается от настраиваемых основных вкладок, которые добавляются на ленту приложений Office при установке и оставлении презентации при открытии другого документа. Кроме того, `requestCreateControls` метод можно выполнить только один раз в сеансе надстройки. Если он вызывается повторно, возникает ошибка.

> [!NOTE]
> Структура свойств и вложенных объектов объекта BLOB в JSON (и имена ключей) приблизительно параллельна структуре элемента [CustomTab](../reference/manifest/customtab.md) и его потомков в XML-файле манифеста.

Мы создадим пример пошагового двоичного объекта JSON для контекстных вкладок. (Полная схема для контекстной вкладки JSON [dynamic-ribbon.schema.jsвключена](https://developer.microsoft.com/json-schemas/office-js/dynamic-ribbon.schema.json). Эта ссылка может не работать в течение раннего периода предварительной версии для контекстных вкладок. Если ссылка не работает, вы можете найти последний черновик схемы в [dynamic-ribbon.schema.jsчерновиков](https://github.com/OfficeDev/testing-assets/tree/master/jsonschema/dynamic-ribbon.schema.json).) Если вы работаете в Visual Studio Code, вы можете использовать этот файл для получения IntelliSense и проверки JSON. Дополнительные сведения см в статье [Редактирование JSON с помощью схем и параметров Visual Studio Code: JSON](https://code.visualstudio.com/docs/languages/json#_json-schemas-and-settings).


1. Сначала создайте строку JSON с двумя свойствами массива Names `actions` и `tabs` . `actions`Массив — это спецификация всех функций, которые могут быть выполнены элементами управления на контекстной вкладке. `tabs`Массив определяет одну или несколько контекстных вкладок, *максимум до 10*.

    ```json
    '{
      "actions": [

      ],
      "tabs": [

      ]
    }'
    ```

1. Этот простой пример контекстной вкладки будет содержать только одну кнопку и, таким образом, только одно действие. Добавьте следующий элемент в качестве единственного элемента `actions` массива. Об этой разметке Обратите внимание на следующее:

    - `id`Свойства и `type` являются обязательными.
    - `type`Возможные значения: "ExecuteFunction" или "ShowTaskpane".
    - `functionName`Свойство используется только в том случае, если значение `type` равно `ExecuteFunction` . Это имя функции, определенной в элементе FunctionFile. Более подробную информацию о FunctionFile можно узнать в статье [Основные понятия для команд надстроек](add-in-commands.md).
    - На следующем этапе вы добавите это действие к кнопке на контекстной вкладке.

    ```json
    {
      "id": "executeWriteData",
      "type": "ExecuteFunction",
      "functionName": "writeData"
    }
   ```

1. Добавьте следующий элемент в качестве единственного элемента `tabs` массива. Об этой разметке Обратите внимание на следующее:

    - Свойство `id` является обязательным. Используйте краткий описательный идентификатор, который является уникальным среди всех контекстных вкладок в надстройке.
    - Свойство `label` является обязательным. Это понятная для пользователя строка, которая выступает в качестве метки контекстной вкладки.
    - Свойство `groups` является обязательным. Он определяет группы элементов управления, которые будут отображаться на вкладке. У нее должен быть по крайней мере один участник *и не более 20*. (Существуют также ограничения на количество элементов управления, которые можно использовать на настраиваемой контекстной вкладке, и это также ограничит количество групп, которые у вас есть. Для получения дополнительных сведений просмотрите следующий шаг.

    > [!NOTE]
    > Объект Tab также может иметь необязательное `visible` свойство, которое указывает, будет ли вкладка отображаться немедленно при запуске надстройки. Так как контекстные вкладки обычно скрываются до тех пор, пока пользователь не назначит их видимость (например, пользователь выбирает сущность некоторого типа в документе), `visible` свойство по умолчанию имеет значение, `false` если оно не задано. В более позднем разделе мы покажем, как установить свойство `true` в ответ на событие.

    ```json
    {
      "id": "CtxTab1",
      "label": "Data",
      "groups": [

      ]
    }
    ```

1. В простом примере контекстная вкладка содержит только одну группу. Добавьте следующий элемент в качестве единственного элемента `groups` массива. Об этой разметке Обратите внимание на следующее:

    - Все свойства являются обязательными.
    - `id`Свойство должно быть уникальным среди всех групп на вкладке. Используйте краткий описательный идентификатор.
    - `label`Представляет собой удобную для пользователя строку, которая выступает в качестве метки группы.
    - `icon`Значение свойства — это массив объектов, указывающий значки, которые будут находиться на ленте в зависимости от размера ленты и окна приложения Office.
    - `controls`Значение свойства это массив объектов, указывающих кнопки и меню в группе. В группе должно быть по крайней мере один и *не более 6*.

    > [!IMPORTANT]
    > *Общее количество элементов управления на вкладке целиком не может превышать 20.* Например, у вас есть 3 группы с 6 элементами управления и четвертая группа с 2 элементами управления, но у вас не может быть 4 группы с 6 элементами управления.  

    ```json
    {
        "id": "CustomGroup111",
        "label": "Insertion",
        "icon": [

        ],
        "controls": [

        ]
    }
    ```

1. У каждой группы должен быть по крайней мере два размера: 32x32 px и 80x80 px. Кроме того, можно использовать значки размеров 16x16 точек, 20x20 px, 24x24 px, 40x40 px, 48x48 px и 64x64 px. Office определяет, какой значок следует использовать в зависимости от размера ленты и окна приложения Office. Добавьте следующие объекты в массив значков. (Если размер окна и ленты достаточно велик для отображения по крайней мере одного из *элементов управления* в группе, значок группы не отображается. В качестве примера просмотрите группу **styles** на ленте Word, когда вы сжимаете и разворачиваете окно Word. Об этой разметке Обратите внимание на следующее:

    - Оба свойства являются обязательными.
    - `size`Единицей измерения свойства является точка. Значки всегда квадратны, поэтому число будет равно высоте и ширине.
    - `sourceLocation`Свойство указывает полный URL-адрес значка.

    > [!IMPORTANT]
    > Как правило, необходимо изменить URL-адреса в манифесте надстройки при переходе от разработки к рабочей среде (например, при изменении домена с localhost на contoso.com), необходимо также изменить URL-адреса в контекстных вкладках JSON.

    ```json
    {
        "size": 32,
        "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/Group32x32.png"
    },
    {
        "size": 80,
        "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/Group80x80.png"
    }
    ```

1. В нашем простом примере группа содержит только одну кнопку. Добавьте указанный ниже объект в качестве единственного элемента `controls` массива. Об этой разметке Обратите внимание на следующее:

    - Все свойства, кроме `enabled` , обязательны.
    - `type` Указывает тип элемента управления. Возможные значения: "Button", "Menu" или "Мобилебуттон".
    - `id` может содержать до 125 символов. 
    - `actionId` должен быть ИДЕНТИФИКАТОРом действия, определенным в `actions` массиве. (См. шаг 1 этого раздела).
    - `label` — Это понятная для пользователя строка, которая выступает в качестве метки кнопки.
    - `superTip` представляет полнофункциональную форму подсказки. `title`Требуются и свойства, и `description` .
    - `icon` задает значки для кнопки. Приведенные выше примечания относительно значка группы также применимы.
    - `enabled` (необязательно) указывает, включена ли кнопка при появлении контекстной вкладки. Если значение не указано, используется значение по умолчанию `true` . 

    ```json
    {
        "type": "Button",
        "id": "CtxBt112",
        "actionId": "executeWriteData",
        "enabled": false,
        "label": "Write Data",
        "superTip": {
            "title": "Data Insertion",
            "description": "Use this button to insert data into the document."
        },
        "icon": [
            {
                "size": 32,
                "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/WriteDataButton32x32.png"
            },
            {
                "size": 80,
                "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/WriteDataButton80x80.png"
            }
        ]
    }
    ```
 
Ниже приведен полный пример большого двоичного объекта JSON:

```json
`{
  "actions": [
    {
      "id": "executeWriteData",
      "type": "ExecuteFunction",
      "functionName": "writeData"
    }
  ],
  "tabs": [
    {
      "id": "CtxTab1",
      "label": "Data",
      "groups": [
        {
          "id": "CustomGroup111",
          "label": "Insertion",
          "icon": [
            {
                "size": 32,
                "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/Group32x32.png"
            },
            {
                "size": 80,
                "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/Group80x80.png"
            }
          ],
          "controls": [
            {
                "type": "Button",
                "id": "CtxBt112",
                "actionId": "executeWriteData",
                "enabled": false,
                "label": "Write Data",
                "superTip": {
                    "title": "Data Insertion",
                    "description": "Use this button to insert data into the document."
                },
                "icon": [
                    {
                        "size": 32,
                        "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/WriteDataButton32x32.png"
                    },
                    {
                        "size": 80,
                        "sourceLocation": "https://cdn.contoso.com/addins/datainsertion/Images/WriteDataButton80x80.png"
                    }
                ]
            }
          ]
        }
      ]
    }
  ]
}`
```

## <a name="register-the-contextual-tab-with-office-with-requestcreatecontrols"></a>Регистрация контекстной вкладки с Office с помощью Рекуесткреатеконтролс

Контекстная вкладка регистрируется в Office, вызывая метод [Office. Ribbon. рекуесткреатеконтролс](/javascript/api/office/office.ribbon?view=common-js&preserve-view=true#requestCreateControls_tabDefinition_) . Обычно это выполняется в функции, которая назначена `Office.initialize` или `Office.onReady` методу. Дополнительные сведения об этих методах и инициализации надстройки приведены в статье [Initialize The Office Your Your](../develop/initialize-add-in.md)надстройка. Тем не менее, вы можете вызвать метод в любое время после инициализации.

> [!IMPORTANT]
> `requestCreateControls`Метод можно вызвать только один раз в данном сеансе надстройки. При повторном вызове возникает ошибка.

Ниже приведен пример. Обратите внимание, что строку JSON необходимо преобразовать в объект JavaScript с `JSON.parse` методом, прежде чем его можно будет передать в функцию JavaScript.

```javascript
Office.onReady(async () => {
    const contextualTabJSON = ` ... `; // Assign the JSON string such as the one at the end of the preceding section.
    const contextualTab = JSON.parse(contextualTabJSON);
    await Office.ribbon.requestCreateControls(contextualTab);
});
```

## <a name="specify-the-contexts-when-the-tab-will-be-visible-with-requestupdate"></a>Указание контекстов, когда вкладка будет отображаться в Рекуеступдате

Как правило, пользовательская контекстная вкладка отображается при изменении контекста надстройки событием, инициированным пользователем. Рассмотрим сценарий, в котором эта вкладка должна быть видна, и только при условии, что в случае активации диаграммы (на листе книги Excel по умолчанию).

Начните с назначения обработчиков. Это обычно делается в `Office.onReady` методе, как в следующем примере, в котором обработчики (созданные на последующих шагах) назначаются `onActivated` `onDeactivated` событиям и событиям всех диаграмм на листе.

```javascript
Office.onReady(async () => {
    const contextualTabJSON = ' ... '; // Assign the JSON string.
    const contextualTab = JSON.parse(contextualTabJSON);
    await Office.ribbon.requestCreateControls(contextualTab);

    await Excel.run(context => {
        var charts = context.workbook.worksheets
            .getActiveWorksheet()
            .charts;
        charts.onActivated.add(showDataTab);
        charts.onDeactivated.add(hideDataTab);
        return context.sync();
    });
});
```

Затем определите обработчики. Ниже приведен простой пример `showDataTab` , но в этой статье описывается [обработка ошибки хострестартнидед](#handling-the-hostrestartneeded-error) далее в этой статье, чтобы получить более надежную версию функции. Вот что нужно знать об этом коде:

- Office определяет время обновления состояния ленты. Метод  [Office. Ribbon. рекуеступдате](/javascript/api/office/office.ribbon?view=common-js&preserve-view=true#requestupdate-input-) ставит в очередь запрос на обновление. Метод будет разрешать `Promise` объект, как только он помещается в очередь запроса, а не при фактическом обновлении ленты.
- Параметр для `requestUpdate` метода — это объект [риббонупдатердата](/javascript/api/office/office.ribbonupdaterdata) , который (1) указывает на вкладку по ее идентификатору точно так же, *как указано в JSON* , а (2) указывает на видимость вкладки.
- При наличии нескольких настраиваемых контекстных вкладок, которые должны быть видны в одном контексте, просто добавьте в массив дополнительные объекты Tab `tabs` .

```javascript
async function showDataTab() {
    await Office.ribbon.requestUpdate({
        tabs: [
            {
                id: "CtxTab1",
                visible: true
            }
        ]});
}
```

Обработчик для скрытия вкладки почти идентичен, за исключением того, что свойство возвращает значение `visible` `false` .

Библиотека JavaScript для Office также предоставляет несколько интерфейсов (типов) для упрощения создания `RibbonUpdateData` объекта. Ниже приведена `showDataTab` функция TypeScript, которая использует эти типы.

```typescript
const showDataTab = async () => {
    const myContextualTab: Tab = {id: "CtxTab1", visible: true};
    const ribbonUpdater: RibbonUpdaterData = { tabs: [ myContextualTab ]};
    await Office.ribbon.requestUpdate(ribbonUpdater);
}
```

### <a name="toggle-tab-visibility-and-the-enabled-status-of-a-button-at-the-same-time"></a>Переключать видимость вкладок и включенное состояние кнопки одновременно

Этот `requestUpdate` метод также используется для переключения состояния включенного или отключенного настраиваемой кнопки на настраиваемой контекстной вкладке или на пользовательской вкладке "основной". Подробнее об этом можно узнать в статье [Включение и отключение команд надстроек](disable-add-in-commands.md). Возможны сценарии, в которых необходимо одновременно изменить видимость вкладки и включенное состояние кнопки. Это можно сделать с помощью одного вызова `requestUpdate` . Ниже приведен пример, в котором одновременно становится доступна кнопка на основной вкладке, в которой отображается контекстная вкладка.

```javascript
function myContextChanges() {
    Office.ribbon.requestUpdate({
        tabs: [
            {
                id: "CtxTab1",
                visible: true
            },
            {
                id: "OfficeAppTab1",
                controls: [
                {
                    id: "MyButton",
                    enabled: true
                }
            ]}
        ]});
}
```

В следующем примере кнопка включена на той же контекстной вкладке, которая становится видимой.

```javascript
function myContextChanges() {
    Office.ribbon.requestUpdate({
        tabs: [
            {
                id: "CtxTab1",
                visible: true,
                controls: [
                    {
                        id: "MyButton",
                        enabled: true
                    }
                ]
            }
        ]});
}
```

## <a name="localizing-the-json-blob"></a>Локализация большого двоичного объекта JSON

Передаваемый большой двоичный объект JSON `requestCreateControls` не локализуется точно так же, как разметка манифеста для настраиваемых основных вкладок (описывается в разделе [Локализация из манифеста](../develop/localization.md#control-localization-from-the-manifest)). Вместо этого локализация должна выполняться во время выполнения с использованием различных больших двоичных объектов JSON для каждого языкового стандарта. Мы рекомендуем использовать `switch` оператор, который проверяет свойство [Office. Context. displayLanguage](/javascript/api/office/office.context#displayLanguage) . Ниже приведен пример.

```javascript
function GetContextualTabsJsonSupportedLocale () {
    var displayLanguage = Office.context.displayLanguage;

        switch (displayLanguage) {
            case 'en-US':
                return `{
                    "actions": [
                        // actions omitted
                     ],
                    "tabs": [
                        {
                          "id": "CtxTab1",
                          "label": "Data",
                          "groups": [
                              // groups omitted
                          ]
                        }
                    ]
                }`;

            case 'fr-FR':
                return `{
                    "actions": [
                        // actions omitted 
                    ],
                    "tabs": [
                        {
                          "id": "CtxTab1",
                          "label": "Données",
                          "groups": [
                              // groups omitted
                          ]
                       }
                    ]
               }`;

            // Other cases omitted
       }
}
```

Затем код вызывает функцию для получения локализованного объекта BLOB, который передается `requestCreateControls` , как показано в следующем примере:

```javascript
var contextualTabJSON = GetContextualTabsJsonSupportedLocale();
```

## <a name="handling-the-hostrestartneeded-error"></a>Обработка ошибки Хострестартнидед

В некоторых случаях Office не может обновить ленту и возвращает ошибку. Например, если после обновления у надстройки другой набор настраиваемых команд, приложение Office необходимо закрыть и снова открыть. Пока это действие не будет выполнено, метод `requestUpdate` будет возвращать ошибку `HostRestartNeeded`. Ниже приведен пример обработки этой ошибки. В этом случае метод `reportError` выводит сообщение об ошибке для пользователя.

```javascript
function showDataTab() {
    try {
        await Office.ribbon.requestUpdate({
            tabs: [
                {
                    id: "CtxTab1",
                    visible: true
                }
            ]});
    }
    catch(error) {
        if (error.code == "HostRestartNeeded"){
            reportError("Contoso Awesome Add-in has been upgraded. Please save your work, then close and reopen the Office application.");
        }
    }
}
```
