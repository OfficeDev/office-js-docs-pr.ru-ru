# <a name="create-custom-functions-in-excel-preview"></a>Создание настраиваемых функций в Excel (ознакомительная версия)

Настраиваемые функции (как и пользовательские функции, или UDF) позволяют разработчикам добавлять любую функцию JavaScript в Excel с помощью надстройки. После этого пользователи смогут получать доступ к настраиваемым функциям, как к любой другой встроенной функции Excel (например, `=SUM()`). В этой статье описано создание настраиваемых функций в Excel.

Ниже показано, как конечный пользователь вставляет настраиваемую функцию в ячейку. Функция, которая добавляет 42 к паре чисел.

<img alt="custom functions" src="../images/custom-function.gif" width="579" height="383" />

Ниже представлен пример кода такой настраиваемой функции.

```js
function ADD42(a, b) {
    return a + b + 42;
}
```

Настраиваемые функции теперь доступны в предварительной версии для разработчиков на Windows, Mac, а также в Excel Online. Чтобы опробовать их, выполните указанные ниже действия.

1.  Установите Office (сборка 9325 на Windows или 13.329 на Mac) и присоединитесь к программе [предварительной оценки Office](https://products.office.com/en-us/office-insider) . (Обратите внимание, что недостаточно просто установить последнюю сборку: функция будет отключена в любой сборке, пока вы не присоединитесь к программе предварительной оценки.)
2.  Клонируйте репозиторий [Excel-Custom-Functions](https://github.com/OfficeDev/Excel-Custom-Functions) и следуйте инструкциям в файле README.md, чтобы запустить надстройку в Excel, внести изменения в код и выполнить отладку.
3.  Введите `=CONTOSO.ADD42(1,2)` в любую ячейку и нажмите клавишу **Ввод**, чтобы выполнить настраиваемую функцию.

В разделе **Известные проблемы**  в конце этой статьи указаны текущие ограничения на настраиваемые функции, которые со временем будут обновляться.

## <a name="learn-the-basics"></a>Основы

В клонированном примере репозитория вы увидите перечисленные ниже файлы.

- **customfunctions.js**, который содержит код настраиваемой функции (см. пример простого кода выше для функции `ADD42`).
- **customfunctions.json**, который содержит данные о регистрации в JSON, которые сообщают Excel о вашей настраиваемой функции. После регистрации ваши настраиваемые функции появятся в списке доступных функций, отображаемых при выполнении пользователем ввода в ячейку.
- **customfunctions.html**, который предоставляет ссылку &lt;Script&gt; на файл JS. Этот файл не отображается в пользовательском интерфейсе Excel.
- **customfunctions.xml**, который сообщает Excel о местонахождении файлов HTML, JavaScript и JSON, а также определяет пространство имен для всех настраиваемых функций, которые установлены с надстройкой.

### <a name="json-file-customfunctionsjson"></a>Файл JSON (customfunctions.json)

Следующий код в файле customfunctions.json указывает метаданные для той же функции `ADD42`.

> [!NOTE]
> Подробные сведения о файле JSON, включая параметры, которые не использовались в этом примере, находится в статье [JSON-файл регистрации настраиваемой функции](https://dev.office.com/reference/add-ins/custom-functions-json).

Обратите внимание, что для этого примера:

- В нем присутствует только одна настраиваемая функция, поэтому элемент массива `functions` только один.
- Свойство  `name` определяет имя функции. Как можно видеть на анимационном GIF, расположенном ранее, пространство имен (`CONTOSO`) добавляется к имени функции в меню автозаполнения Excel. Этот префикс определен в манифесте надстройки, описанном ниже. Префикс и имя функции разделяются точкой, и, согласно принятой форме записи, префиксы и имена функций указываются прописными буквами. Для использования настраиваемой функции пользователь вводит в ячейку пространство имен, за которым следует имя функции (`ADD42`), в нашем случае — `=CONTOSO.ADD42`. Префикс служит в качестве идентификатора вашей компании или надстройки. 
- `description` отображается в меню автозаполнения в Excel.
- Когда пользователь запрашивает справку по функции, Excel открывает область задач, в которой отображается веб-страница, расположенная по URL-адресу, который указан в `helpUrl`.
- Свойство  `result` задает тип данных, возвращаемых функцией в Excel. Дочернее свойство `type` может быть типа `"string"`, `"number"` или `"boolean"`. Свойство `dimensionality` может быть `scalar` или `matrix` (двумерный массив значений указанного типа `type`.)
- Массив `parameters` указывает *по порядку* тип данных в каждом параметре, который передается функции. Дочерние свойства `name` и `description` используются в Excel intellisense. Дочерние свойства `type` и `dimensionality`  идентичны дочерним свойствам родительского `result`, описанного выше.
- Свойство  `options` позволяет настраивать некоторые аспекты того, как и когда Excel выполняет эту функцию. Более подробные сведения об этих параметрах приведены далее в этой статье.

 ```js
{
    "$schema": "https://developer.microsoft.com/en-us/json-schemas/office-js/custom-functions.schema.json",
    "functions": [
        {
            "name": "ADD42", 
            "description":  "adds 42 to the input numbers",
            "helpUrl": "http://dev.office.com",
            "result": {
                "type": "number",
                "dimensionality": "scalar"
            },
            "parameters": [
                {
                    "name": "number 1",
                    "description": "the first number to be added",
                    "type": "number",
                    "dimensionality": "scalar"
                },
                {
                    "name": "number 2",
                    "description": "the second number to be added",
                    "type": "number",
                    "dimensionality": "scalar"
                }
            ],
            "options": {
                "sync": true
            }
        }
    ]
}
```

> [!NOTE]
> Настраиваемые функции регистрируются тогда, когда пользователь запускает надстройку впервые. После этого они доступны для этого же пользователя во всех книгах (а не только в той, в которой надстройка запускалась первоначально).

Чтобы настраиваемая функция работала корректно в Excel Online, в параметрах сервера для файла JSON должен быть включен [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).


### <a name="manifest-file-customfunctionsxml"></a>Файл манифеста (customfunctions.xml)


Ниже приведен пример элементов разметки `<ExtensionPoint>` и `<Resources>`, которые необходимо включить в манифест надстройки, чтобы позволить Excel выполнять функции. Обратите внимание на следующие особенности этой разметки:

- Элемент `<Script>` и его соответствующий идентификатор ресурса определяет расположение файла JavaScript с вашими функциями.
- Элемент`<Page>` и его соответствующий ИД ресурса определяет расположение HTML-страницы вашей надстройки. HTML-страница содержит тег `<Script>`, который загружает файл JavaScript (customfunctions.js). HTML-страница скрыта и никогда не отображается в пользовательском интерфейсе.
- Элемент `<Metadata>` и его соответствующий идентификатор ресурса определяет расположение JSON-файла.
- Элемент`<Namespace>` и его соответствующий ИД ресурса определяет префикс для настраиваемой функции в надстройке.


```xml
<VersionOverrides xmlns="http://schemas.microsoft.com/office/taskpaneappversionoverrides" xsi:type="VersionOverridesV1\_0">
    <Hosts>
        <Host xsi:type="Workbook">
            <AllFormFactors>
                <ExtensionPoint xsi:type="CustomFunctions">
                    <Script>
                        <SourceLocation resid="residjs" />
                    </Script>
                    <Page>
                        <SourceLocation resid="residhtml"/>
                    </Page>
                    <Metadata>
                        <SourceLocation resid="residjson" />
                    </Metadata>
                    <Namespace resid="residNS" />
                </ExtensionPoint>
            </AllFormFactors>
        </Host>
    </Hosts>
    <Resources>
        <bt:Urls>
            <bt:Url id="residjson" DefaultValue="http://127.0.0.1:8080/customfunctions.json" />
            <bt:Url id="residjs" DefaultValue="http://127.0.0.1:8080/customfunctions.js" />
            <bt:Url id="residhtml" DefaultValue="http://127.0.0.1:8080/customfunctions.html" />
        </bt:Urls>
        <bt:ShortStrings>
            <bt:String id="residNS" DefaultValue="CONTOSO" />
        </bt:ShortStrings>
    </Resources>
</VersionOverrides>

```

## <a name="initializing-custom-functions"></a>Инициализация настраиваемых функций

Ваш код должен инициализировать настраиваемые функции перед их использованием. Вы можете сделать это либо в теге &lt;Script&gt; в файле HTML (customfunctions.html), либо в начале файла JavaScript (customfunctions.js). При использовании предварительной версии настраиваемых функций у вас есть выбор из двух вариантов синтаксиса инициализации. HTML-файл в репозитории использует следующий синтаксис:

```js
Office.initialize = function (reason) {
    return Excel.CustomFunctions.initialize();
};
```

Также можно использовать следующий синтаксис:

```js
Office.Preview.StartCustomFunctions();
```

## <a name="synchronous-and-asynchronous-functions"></a>Синхронные и асинхронные функции

Функция `ADD42`, представленная выше, является синхронной относительно Excel (обозначается установкой параметра `"sync": true` в JSON-файле). Синхронные функции обеспечивают высокую производительность, поскольку запускаются в том же процессе, что и Excel, и работают параллельно при многопоточном вычислении.   

С другой стороны, если ваша настраиваемая функция извлекает данные из Интернета, она должна быть асинхронной относительно Excel. Асинхронные функции должны:

1. Возвращать JavaScript Promise в Excel.
3. Разрешать Promise окончательным значением, используя функцию обратного вызова.

В приведенном ниже коде показан пример асинхронной настраиваемой функции, получающей температуру термометра. Обратите внимание, что функция `sendWebRequest` является гипотетической, не указанной здесь, и использует XHR для вызова веб-службы температуры.

```js
function getTemperature(thermometerID){
    return new OfficeExtension.Promise(function(setResult){
        sendWebRequest(thermometerID, function(data){
            setResult(data.temperature);
        });
    });
}
```

Асинхронные функции отображают временную ошибку `GETTING_DATA`  в ячейке, пока Excel ждет окончательный результат. Во время ожидания результата пользователи могут нормально взаимодействовать с остальной частью электронной таблицы.

> [!NOTE]
> По умолчанию настраиваемые функции асинхронны. Чтобы сделать функции синхронными, установите параметр `"sync": true` для свойства `options` для настраиваемой функции в JSON-файле регистрации.

## <a name="streamed-functions"></a>Потоковые функции

Асинхронная функция может быть потоковой. С помощью потоковых настраиваемых функций вы можете многократно выводить данные в ячейки, не дожидаясь, пока Excel или пользователь запросят повторное вычисление. Следующий пример - это настраиваемая функция, которая добавляет число к результату каждую секунду. Обратите внимание на особенности этого кода:

- Excel автоматически отображает каждое новое значение при помощи `setResult` обратного вызова.
- Последний параметр, `caller`, никогда не указывается в коде регистрации и не отображается в меню автозаполнения, когда пользователи Excel вводят функцию. Это объект, который содержит функцию обратного вызова `setResult`, используемую для передачи данных из функции в Excel и обновления значения ячейки.
- Чтобы Excel передал функцию `setResult` объекту `caller`, необходимо объявить поддержку потоковой передачи при регистрации функции, установив параметр `"stream": true` для свойства `options` для настраиваемой функции в JSON-файле регистрации.

```js
function incrementValue(increment, caller){
    var result = 0;
    setInterval(function(){
         result += increment;
         caller.setResult(result);
    }, 1000);
}
```

## <a name="cancellation"></a>Отмена

Вы можете отменять вызовы потоковых и асинхронных функций. Отмена вызова функций позволяет снизить потребление пропускной способности, использование рабочей памяти и нагрузку на ЦП. Excel отменяет вызовы функций в следующих случаях:

- Пользователь редактирует или удаляет ячейку, ссылающуюся на функцию.
- Изменился один из аргументов (входных параметров) функции. В этом случае помимо отмены выполняется новый вызов функции.
- Пользователь активирует пересчет вручную. Как и в вышеописанном случае, помимо отмены выполняется новый вызов функции.

Вы *должны* реализовать обработчик отмены для каждой функции потоковой передачи. Асинхронные, непотоковые функции могут подлежать или не подлежать отмене по вашему усмотрению. Синхронные функции отмене не подлежат.

Чтобы сделать функцию отменяемой, установите параметр `"cancelable": true` для свойства `options` для настраиваемой функции в JSON-файле регистрации.

Ниже показан код из предыдущего примера с реализованной отменой. Объект `caller` в коде содержит функцию `onCanceled`, которую необходимо определить для каждой отменяемой настраиваемой функции.

```js
function incrementValue(increment, caller){ 
    var result = 0;
    var timer = setInterval(function(){
         result += increment;
         caller.setResult(result);
    }, 1000);

    caller.onCanceled = function(){
        clearInterval(timer);
    }
}
```

## <a name="saving-and-sharing-state"></a>Сохранение и передача состояния

Асинхронные функции могут сохранять данные в глобальных переменных JavaScript. В последующих вызовах настраиваемая функция может использовать значения, сохраненные в этих переменных. Сохранение состояния может быть полезно, когда пользователи добавляют одну настраиваемую функцию к нескольким ячейкам, потому что все экземпляры функции могут совместно использовать ее состояние. Например, вы можете сохранить данные, возвращенные при вызове веб-ресурса, чтобы не пришлось обеспечивать выполнение дополнительных вызовов.

В приведенном ниже коде показана реализация вышеописанной функции передачи температуры, глобально сохраняющей состояние. Обратите внимание на особенности этого кода:

- `refreshTemperature` это потоковая функция, ежесекундно считывающая температуру определенного термометра. Новые температуры сохраняются в переменную `savedTemperatures`, но не обновляют значение ячейки напрямую. Она не должен вызываться непосредственно из ячейки листа, *поэтому она не регистрируется в файле JSON*.
- `streamTemperature` обновляет значения температуры, которые отображаются в ячейке каждую секунду, а в качестве источника данных использует переменную `savedTemperatures`. Она должна быть зарегистрирована в файле JSON и записана прописными буквами: `STREAMTEMPERATURE`.
- Пользователи могут вызывать функцию `streamTemperature` из нескольких ячеек в пользовательском интерфейсе Excel. Каждый вызов считывает данные из той же переменной `savedTemperatures`.

```js
var savedTemperatures;

function streamTemperature(thermometerID, caller){ 
     if(!savedTemperatures[thermometerID]){
         refreshTemperatures(thermometerID); // starts fetching temperatures if the thermometer hasn't been read yet
     }

     function getNextTemperature(){
         caller.setResult(savedTemperatures[thermometerID]); // setResult sends the saved temperature value to Excel.
         setTimeout(getNextTemperature, 1000); // Wait 1 second before updating Excel again.
     }
     getNextTemperature();
}

function refreshTemperature(thermometerID){
     sendWebRequest(thermometerID, function(data){
         savedTemperatures[thermometerID] = data.temperature;
     });
     setTimeout(function(){
         refreshTemperature(thermometerID);
     }, 1000); // Wait 1 second before reading the thermometer again, and then update the saved temperature of thermometerID.
}
```

> [!NOTE]
> Синхронные функции (назначаются путем установки параметра `"sync": true` в файле JSON) не могут передавать состояние, потому что Excel распараллеливает их во время многопоточного вычисления. Только асинхронные функции могут передавать состояние, поскольку синхронные функции надстройки используют один контекст JavaScript в каждом сеансе.

## <a name="working-with-ranges-of-data"></a>Работа с диапазонами данных

Настраиваемая функция может принимать диапазон данных в качестве параметра или возвращать диапазон данных.

Например, предположим, что ваша функция возвращает второе наивысшее значение из диапазона чисел, хранящихся в Excel. Приведенная ниже функция принимает параметр `values`, относящийся к типу `Excel.CustomFunctionDimensionality.matrix`. Обратите внимание, что в JSON-регистрации для этой функции необходимо для параметра `type` установить значение `matrix`.

```js
function secondHighest(values){ 
     var highest = values[0][0], secondHighest = values[0][0];
     for(var i = 0; i < values.length; i++){
         for(var j = 1; j < values[i].length; j++){
             if(values[i][j] >= highest){
                 secondHighest = highest;
                 highest = values[i][j];
             }
             else if(values[i][j] >= secondHighest){
                 secondHighest = values[i][j];
             }
         }
     }
     return secondHighest;
 }
```

Можно заметить, что диапазоны обрабатываются в JavaScript как массивы строк (двумерный массив).

## <a name="known-issues"></a>Известные проблемы

- URL-адреса справки и описания параметров пока не используются в Excel.
- Настраиваемые функции в настоящее время недоступны в Excel для мобильных клиентов.
- В настоящее время надстройки используют скрытый процесс веб-обозревателя для выполнения асинхронных настраиваемых функций. В будущем JavaScript будет работать на некоторых платформах напрямую, чтобы настраиваемые функции выполнялись быстрее и использовали меньше памяти. Кроме того, HTML-страница, на которую ссылается элемент `<Page>` манифеста, не будет необходима для большинства платформ, так как Excel будет выполнять код JavaScript напрямую. Чтобы подготовиться к этому изменению, убедитесь, что в ваших настраиваемых функциях не используется модель DOM для веб-страниц. Поддерживаемые основные API приложения для доступа к Интернету будут [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API) и [XHR](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) с использованием GET или POST.
- Изменяемые функции (которые пересчитываются автоматически, когда в электронной таблице изменяются несвязанные данных) еще не поддерживаются.
- Отладка включена только для асинхронных функций в Excel для Windows.
- Развертывание через Портал администрирования Office 365 и AppSource еще не включены.
- Настраиваемые функции в Excel Online могут перестать работать во время сеанса после периода бездействия. Для восстановления работы обновите страницу браузера (F5) и повторно введите настраиваемую функцию.

## <a name="changelog"></a>Журнал изменений

- **7 ноября 2017 г.** Выпущена ознакомительная версия пользовательских функций с примерами.
- **20 ноября 2017 г.** Исправлена ошибка совместимости для пользователей, использующих сборки 8801 и выше.
- **28 ноября 2017 г.** Добавлена поддержка отмены вызова асинхронных функций (необходимо изменение для потоковых функций).
- **7 мая 2018 г.** Добавлена ​​поддержка Mac, Excel Online и синхронных функций, выполняемых в процессе
