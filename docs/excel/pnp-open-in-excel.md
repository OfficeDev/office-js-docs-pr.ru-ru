---
title: Откройте Excel с веб-страницы и внедрите надстройку Office
description: Откройте Excel с веб-страницы и внедрите надстройку Office.
ms.date: 09/15/2020
localization_priority: Normal
ms.openlocfilehash: 00846ca5ca05e65fd75629f5aad0e4fb3d947ab1
ms.sourcegitcommit: 42202d7e2ac24dffa77cf937f5697a1cd79ee790
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/30/2020
ms.locfileid: "48308546"
---
# <a name="open-excel-from-your-web-page-and-embed-your-office-add-in"></a>Откройте Excel с веб-страницы и внедрите надстройку Office

:::image type="content" source="../images/pnp-open-in-excel.png" alt-text="Изображение кнопки Excel на веб-странице Открытие нового документа Excel с внедренным и автоматическим открытием надстройки.":::

Расширьте веб-приложение SaaS таким образом, чтобы пользователи могли открывать свои данные из веб-страницы непосредственно в Microsoft Excel. Распространенным сценарием является то, что клиенты будут работать с данными в веб-приложении. Затем они захотите скопировать данные в документ Excel. Например, может потребоваться выполнить дополнительный анализ с помощью Excel. Как правило, клиент должен экспортировать данные в файл, например CSV-файл, а затем импортировать эти данные в Excel. Кроме того, необходимо вручную добавить надстройку Office в документ.

Уменьшите число шагов на одну нажатую кнопку на веб-странице, которая создает и открывает документ Excel. Вы также можете внедрить надстройку Office в документ и отображать ее при открытии документа. Это гарантирует, что у клиента по-прежнему есть доступ к функциям приложений. Когда откроется документ, данные, выбранные клиентом, и надстройка Office уже доступны для продолжения работы.

В этой статье показаны код и методы реализации этого сценария в собственном веб-приложении SaaS.

## <a name="create-a-new-excel-document-and-embed-an-office-add-in"></a>Создание нового документа Excel и внедрение надстройки Office

Для начала рассмотрим создание документа Excel на веб-странице и внедрение надстройки в документ. В [примере кода надстройки Office OOXML embed](https://github.com/OfficeDev/Office-OOXML-EmbedAddin) показано, как внедрить [надстройку "Лаборатория скриптов](https://appsource.microsoft.com/product/office/wa104380862) " в новый документ Office. Несмотря на то, что пример работает с любым документом Office, в этой статье мы будем сосредоточиться на таблицах Excel. Выполните указанные ниже действия, чтобы создать и запустить пример.

1. Извлеките пример кода из  https://github.com/OfficeDev/Office-OOXML-EmbedAddin/archive/master.zip папки на вашем компьютере.
2. Чтобы создать и запустить пример, выполните действия, описанные в разделе " **использование проекта** " файла readme.
3. При запуске примера отображается веб-страница, подобная показанной на следующем снимке экрана. С помощью веб-страницы создайте новый документ Excel, содержащий Lab script при открытии.
:::image type="content" source="../images/embed-script-lab-sample-ui.png" alt-text="Изображение кнопки Excel на веб-странице Открытие нового документа Excel с внедренным и автоматическим открытием надстройки.":::

### <a name="how-the-sample-works"></a>Принцип работы примера

В примере кода используется пакет SDK OOXML для внедрения надстройки Script Lab в документ Excel, который вы выбираете. Приведенные ниже сведения берутся из [раздела " **код** ](https://github.com/OfficeDev/Office-OOXML-EmbedAddin/blob/master/README.md) " в файле readme.

**Home.aspx.CS**файла:

- Предоставляет обработчики событий кнопки и базовую обработку пользовательского интерфейса.
- Использует стандартные методы ASP.NET для отправки и загрузки файла.
- Использует расширение файла загруженного файла (XLSX, DOCX или PPTX) для определения типа файла. Это необходимо сделать с самого начала работы, так как в пакет SDK Open XML обычно есть разные интерфейсы API для каждого типа файлов.
- Вызывает **уксмлхелпер** для проверки файла и вызовов в **Аддинембеддер** для внедрения лаборатории скриптов в файл и установки автоматического открытия.

**AddInEmbedder.CS**файла:

- Предоставляет основную бизнес-логику, в данном примере, способ внедрения лаборатории скриптов.
- Выполняет вызовы в модуль поддержки OOXML на основе типа файла.

**OOXMLHelper.CS**файла:

- Предоставляет все подробные операции OOXML.
- Использует стандартную методику для проверки файла Office, который просто вызывает метод **Document. Open** для него. Если файл является недопустимым, метод выдает исключение.
- Содержит код, который был создан с помощью средств повышения производительности SDK Open XML 2,5, которые доступны по ссылке для [Open xml 2,5 SDK](/office/open-xml/open-xml-sdk).

Метод **GenerateWebExtensionPart1Content** в файле **OOXMLHelper.CS** задает ссылку на идентификатор лаборатории скриптов в Microsoft AppSource:

```csharp
We.WebExtensionStoreReference webExtensionStoreReference1 = new We.WebExtensionStoreReference() { Id = "wa104380862", Version = "1.1.0.0", Store = "en-US", StoreType = "OMEX" };
```

- Значение **флажок** — "ОМЕКС", псевдоним для Microsoft AppSource.
- Значение **Store** — "en-US" в разделе Microsoft AppSource Culture для сценария Lab.
- Значение **ID** — это идентификатор ресурса Microsoft AppSource для лаборатории сценариев.

Если вы настраиваете надстройку из каталога общих папок для автоматического открытия, будут использоваться разные значения:

Значение **флажок** — "FileSystem".

- Значение **Store** — это URL-адрес сетевой папки; Например, " \\ \\ MyComputer \\ мишаредфолдер". Это должен быть точный URL-адрес, который отображается в качестве адреса доверенного каталога общего доступа в центре управления безопасностью Office.
- Значение **ID** — идентификатор приложения в манифесте надстроек.
> [!NOTE]
> Дополнительные сведения о альтернативных значениях для этих атрибутов: [автоматически открывать область задач с документом](../develop/automatically-open-a-task-pane-with-a-document.md).

## <a name="use-the-fluent-ui"></a>Использование пользовательского интерфейса Fluent

:::image type="content" source="../images/fluent-ui-wxp.png" alt-text="Изображение кнопки Excel на веб-странице Открытие нового документа Excel с внедренным и автоматическим открытием надстройки.":::

Рекомендуется использовать пользовательский интерфейс Fluent, чтобы пользователи могли переходить между продуктами корпорации Майкрософт. Следует всегда использовать значок Office, чтобы указать, какое приложение Office будет запущено на веб-странице. Давайте изменим пример кода, чтобы использовать значок Excel, чтобы указать, что приложение Excel запускается.

1. Откройте пример в Visual Studio.
1. Откройте страницу **Home. aspx** .
1. Найдите следующий код, который является кнопкой загрузки в форме:
    ```html
    <asp:Button ID="btnDownload" runat="server" Text="Download" OnClick="btnDownload_Click" /> 
    ```
1. Замените код кнопки следующим тегом изображения.
    ```html
    <asp:Image  src="https://static2.sharepointonline.com/files/fabric/assets/brand-icons/product/svg/excel_48x1.svg" width="48" height="48" ID="btnDownload" runat="server" OnClick="btnDownload_Click" AlternateText="Open in Microsoft Excel" role="button" ImageUrl=""/>  
    ```
1. Нажмите клавишу **F5** (или **Отладка > начать отладку**). Вы увидите значок, который появится при загрузке домашней страницы.

Для получения дополнительных сведений просмотрите [значки фирменной символики Office](https://developer.microsoft.com/fluentui#/styles/web/office-brand-icons) на портале разработчика Fluent в Fluent в пользовательском интерфейсе.  

## <a name="upload-the-excel-document-to-microsoft-onedrive"></a>Отправка документа Excel в Microsoft OneDrive

Мы рекомендуем отправлять новые документы в OneDrive, если ваш клиент использует OneDrive. Это упрощает поиск и работу с документами. Давайте создадим новый пример кода и посмотрим, как можно использовать пакет SDK Microsoft Graph для отправки нового документа Excel в OneDrive.

### <a name="use-a-quick-start-to-build-a-new-microsoft-graph-web-application"></a>Использование быстрого запуска для создания нового веб-приложения Microsoft Graph

1. Перейдите к разделу [https://developer.microsoft.com/graph/quick-start](https://developer.microsoft.com/graph/quick-start) и следуйте инструкциям, чтобы создать и открыть краткий пример кода, взаимодействующего со службами Office 365.
1. На **шаге 1: выберите язык или платформу**, выберите **ASP.NET MVC**. Несмотря на то, что действия, описанные в этой процедуре, используют параметр MVC ASP.NET, шаги следуют шаблону, который применяется к любому языку или платформе.
1. В **шаге 2: получение идентификатора и секрета приложения**выберите пункт **Получение идентификатора и секрета приложения**.
1. Войдите в свою учетную запись Microsoft 365.  
1. **Сохраните секрет приложения на веб-** странице, чтобы сохранить секрет приложения в файл, в котором его можно извлечь и использовать позже.
1. Выберите все **Готово, вернитесь на краткий старт**.
1. В **шаге 2: регистрация выполнена успешно!** Введите созданный секрет приложения.
1. На **шаге 3: начните программировать**, а затем **Скачайте пример кода на основе SDK**.
1. Извлеките папку ZIP для скачивания в локальную папку.  
1. Откройте файл граф-туториал. sln в Visual Studio 2019.
1. Создайте и запустите решение и убедитесь, что оно работает правильно. Вы можете просматривать календарь Microsoft 365 с помощью веб-страницы календаря.

### <a name="upload-a-file-to-onedrive"></a>Отправка файла в OneDrive

1. Откройте решение **граф-туториал. sln** в Visual Studio 2019 и откройте файл **PrivateSettings.config** .
1. Добавьте новый файл scope **. ReadWrite**   в раздел **Ida: аппскопес** , чтобы он выглядел следующим образом:
    ```xml
    <add key="ida:AppScopes" value="User.Read Calendars.Read Files.ReadWrite " />
    ```
1. Откройте файл **index. cshtml** .
1. Вставьте следующий код ActionLink, чтобы создать кнопку для отправки файла в OneDrive.
    ```razor
    @if (Request.IsAuthenticated)
    {
        <h4>Welcome @ViewBag.User.DisplayName!</h4>
        <p>Use the navigation bar at the top of the page to get started.</p>
        @Html.ActionLink("Click here to create a new file on OneDrive", "CreateOneDriveFile", "Home", new { area = "" }, new { @class = "btn btn-primary btn-large" })
    }
    ```
1. Откройте файл **HomeController.CS** .
1. Вставьте следующий код, чтобы обработать запрос из ссылки Action (действие).
    ```csharp
    public void CreateOneDriveFile()
        {
            using (var stream = new System.IO.MemoryStream(System.Text.Encoding.UTF8.GetBytes("The contents of the file goes here.")))
            {
                var client = graph_tutorial.Helpers.GraphHelper.UploadFile("/test.txt", stream);
            }
        }
    ```
1. Откройте файл **GraphHelper.CS** .
1. Вставьте следующий код, чтобы вызвать API Microsoft Graph, чтобы создать новый файл в OneDrive.
    ```csharp
    public static async Task UploadFile(string fileName, System.IO.MemoryStream stream)
        {
           var graphClient = GetAuthenticatedClient();
            await graphClient.Me
                .Drive
                .Root
                .ItemWithPath(fileName)
                .Content
                .Request()
                .PutAsync<DriveItem>(stream);
            return;
        }
    ```
1. Нажмите клавишу **F5** (или **Отладка > начать отладку**). Запустится веб-приложение.
1. Выберите **щелкните здесь, чтобы выполнить вход**, и войдите.
1. Выберите **ссылку Щелкните здесь, чтобы создать файл в OneDrive**.
1. Откройте новую вкладку браузера и войдите в свою учетную запись OneDrive. Вы увидите файл test.txt в корневой папке.

Теперь, когда вы узнали, как отправить файл в OneDrive, вы можете повторно использовать этот код для загрузки созданного документа Excel.

## <a name="additional-considerations-for-your-solution"></a>Дополнительные рекомендации по решению

В терминах технологий и подходов для всех решений используется разный подход. Ниже приведены рекомендации по планированию изменения решения для открытия документов и внедрения надстройки Office.

### <a name="create-a-new-excel-spreadsheet-from-the-web-page"></a>Создание новой таблицы Excel на веб-странице

В этом примере изменяется существующий документ Excel. Более распространенный сценарий состоит в том, что вы создадите новую электронную таблицу Excel на веб-странице. Дополнительные сведения о том, как создать новую электронную таблицу для **создания электронной таблицы** , можно найти, указав имя файла. В этой статье показано, как создать файл локально, но вы также можете создать файл в потоке с помощью перегрузки метода SpreadsheetDocument. Create.

### <a name="read-custom-properties-when-your-add-in-starts"></a>Чтение настраиваемых свойств при запуске надстройки

В примере кода показано, как сохранить идентификатор фрагмента в новом документе Excel с помощью пакета SDK для OOXML. В лабораториях сценария считывается идентификатор фрагмента из документа Excel, после чего он отображается в коде фрагмента кода при его открытии. Может потребоваться отправить настраиваемые свойства собственной надстройке (например, строке запроса или временному маркеру проверки подлинности). В статье **Сохранение состояния и параметров надстройки** приведены подробные сведения о том, как считывать настраиваемые свойства при запуске надстройки.

### <a name="initialize-the-excel-document-with-data"></a>Инициализация документа Excel с помощью данных

Как правило, когда клиент открывает документ Excel с веб-сайта, он ожидает, что документ содержит какие-либо данные из веб-сайта. Существует несколько способов записи данных в документ.

- **Используйте пакет SDK OOXML для записи данных**. Вы можете использовать пакет SDK для непосредственной записи данных в документ. Этот подход полезен, если вы хотите, чтобы данные были доступны для мгновенного открытия документа.
- **Передайте настраиваемое свойство запроса в надстройку Office**. При создании документа вы внедряет настраиваемое свойство для надстройки Office, содержащее строку запроса, которая извлекает все необходимые данные. Когда откроется надстройка, она получает запрос, запускает запрос и использует API Office JS для вставки результата запроса в документ.

### <a name="working-with-the-ooxml-sdk"></a>Работа с пакетом SDK для OOXML

Пакет SDK для OOXML основан на .NET. Если ваше веб-приложение не является .NET, вам необходимо найти альтернативный способ работы с OOXML.

Пакет SDK OOXML для JavaScript доступен на странице [Open XML SDK для JavaScript](https://archive.codeplex.com/?p=openxmlsdkjs).

Вы можете поместить код OOXML в функцию Azure, чтобы отделить код .NET от остальной части веб-приложения. Затем вызовите функцию Azure (для создания документа Excel) из веб-приложения. Дополнительные сведения о функциях Azure приведены [в статье Введение в функции Azure](https://docs.microsoft.com/azure/azure-functions/functions-overview).

### <a name="use-single-sign-on"></a>Использование единого входа

Чтобы упростить проверку подлинности, мы рекомендуем надстройке реализовать единый вход. Дополнительные сведения см в статье [Включение единого входа для надстроек Office](../develop/sso-in-office-add-ins.md)

## <a name="see-also"></a>См. также

- [Добро пожаловать на страницу пакета SDK 2.5 Open XML для Office](/office/open-xml/open-xml-sdk)
- [Автоматическое открытие области задач с документом](../develop/automatically-open-a-task-pane-with-a-document.md)
- [Persisting add-in state and settings](../develop/persisting-add-in-state-and-settings.md)
- [Создайте документ электронной таблицы, указав имя файла](/office/open-xml/how-to-create-a-spreadsheet-document-by-providing-a-file-name)
