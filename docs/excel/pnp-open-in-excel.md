---
title: Откройте Excel с веб-страницы и внедрите надстройку Office
description: Откройте Excel с веб-страницы и внедрите надстройку Office.
ms.date: 11/01/2021
ms.localizationpriority: medium
ms.openlocfilehash: 835518fb822602d6ca1af633f96d2be1e2697f44
ms.sourcegitcommit: 3abcf7046446e7b02679c79d9054843088312200
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/02/2022
ms.locfileid: "68810346"
---
# <a name="open-excel-from-your-web-page-and-embed-your-office-add-in"></a>Откройте Excel с веб-страницы и внедрите надстройку Office

:::image type="content" source="../images/pnp-open-in-excel.png" alt-text="Изображение кнопки Excel на веб-странице, открывающей новый документ Excel с внедренной и автоматически открывающейся надстройкой.":::

Расширьте веб-приложение SaaS, чтобы клиенты могли открывать свои данные с веб-страницы непосредственно в Microsoft Excel. Распространенный сценарий заключается в том, что клиенты будут работать с данными в веб-приложении. Затем они захотят скопировать данные в документ Excel. Например, им может потребоваться выполнить дополнительный анализ с помощью Excel. Как правило, клиент должен экспортировать данные в файл, например файл .csv, а затем импортировать эти данные в Excel. Кроме того, необходимо вручную добавить надстройку Office в документ.

Уменьшите количество шагов до одной кнопки на веб-странице, которая создает и открывает документ Excel. Вы также можете внедрить надстройку Office в документ и отобразить ее при открытии документа. Это гарантирует, что клиент по-прежнему имеет доступ к функциям приложения. Когда откроется документ, данные, выбранные клиентом, и ваша надстройка Office уже доступна для продолжения работы.

В этой статье описаны код и методы реализации этого сценария в собственном веб-приложении SaaS.

## <a name="create-a-new-excel-document-and-embed-an-office-add-in"></a>Создание документа Excel и внедрение надстройки Office

Сначала давайте узнаем, как создать документ Excel на веб-странице и внедрить надстройку в документ. В [примере кода надстройки office OOXML Embed](https://github.com/OfficeDev/Office-OOXML-EmbedAddin) показано, как внедрить [надстройку Script Lab в](https://appsource.microsoft.com/product/office/wa104380862) новый документ Office. Хотя этот пример работает с любым документом Office, в этой статье мы сосредоточимся только на электронных таблицах Excel. Выполните следующие действия, чтобы создать и запустить пример.

1. Извлеките пример кода из  https://github.com/OfficeDev/Office-OOXML-EmbedAddin/archive/master.zip в папку на компьютере.
2. Чтобы создать и запустить пример, выполните действия, описанные в разделе **Использование проекта** в файле сведений.
3. При запуске примера отобразится веб-страница, аналогичная приведенному ниже снимку экрана. Используйте веб-страницу, чтобы создать документ Excel, содержащий Script Lab при его открытии.
:::image type="content" source="../images/embed-script-lab-sample-ui.png" alt-text="Снимок экрана: веб-страница, на которую отображается пример лаборатории сценариев внедрения для выбора файла Excel и внедрения в него надстройки лаборатории скриптов.":::

### <a name="how-the-sample-works"></a>Принцип работы примера

В примере кода используется пакет SDK OOXML для внедрения надстройки Script Lab в выбранный документ Excel. Следующие сведения взяты из [раздела **Сведения о коде**](https://github.com/OfficeDev/Office-OOXML-EmbedAddin/blob/master/README.md) в файле сведений.

Файл **Home.aspx.cs**:

- Предоставляет обработчики событий кнопки и основные операции с пользовательским интерфейсом.
- Использует стандартные методы ASP.NET для отправки и скачивания файла.
- Использует расширение имени отправленного файла (xlsx, docx или pptx) для определения типа файла. Это необходимо сделать с самого начала, так как пакет SDK Open XML обычно имеет отдельные API для каждого типа файлов.
- Вызовы в **OOXMLHelper** для проверки файла и вызовы **в AddInEmbedder** для внедрения Script Lab в файл и автоматического открытия.

Файл **AddInEmbedder.cs**:

- Предоставляет основную бизнес-логику, которая в этом примере является методом, который внедряет Script Lab.
- Вызывает вспомогатель OOXML в зависимости от типа файла.

Файл **OOXMLHelper.cs**:

- Предоставляет все подробные операции OOXML.
- Использует стандартный метод проверки файла Office, который просто вызывает в нем метод **Document.Open** . Если файл недопустим, метод создает исключение.
- Содержит в основном код, созданный с помощью средств повышения производительности open XML 2.5, доступных по ссылке для [пакета SDK Open XML 2.5](/office/open-xml/open-xml-sdk).

Метод **GenerateWebExtensionPart1Content** в файле **OOXMLHelper.cs** задает ссылку на идентификатор Script Lab в Microsoft AppSource:

```csharp
We.WebExtensionStoreReference webExtensionStoreReference1 = new We.WebExtensionStoreReference() { Id = "wa104380862", Version = "1.1.0.0", Store = "en-US", StoreType = "OMEX" };
```

- Значение **StoreType** — "OMEX", псевдоним microsoft AppSource.
- Значение **Store** — "en-US" в разделе Язык и региональные параметры Microsoft AppSource для Script Lab.
- Значение **id** — это идентификатор ресурса Microsoft AppSource для Script Lab.

При настройке надстройки из каталога общей папки для автоматического открытия используются другие значения:

Значение **StoreType** — FileSystem.

- Значение **Store** — это URL-адрес сетевого ресурса; например MyComputer\\\\\\ MySharedFolder. Это должен быть точный URL-адрес, который отображается в качестве адреса доверенного каталога общей папки в Центре управления безопасностью Office.
- Значение **Id** — это идентификатор приложения в манифесте надстроек.
> [!NOTE]
> Дополнительные сведения об альтернативных значениях для этих атрибутов см. в статье [Автоматическое открытие области задач с документом](../develop/automatically-open-a-task-pane-with-a-document.md).

## <a name="use-the-fluent-ui"></a>Использование пользовательского интерфейса Fluent

:::image type="content" source="../images/fluent-ui-wxp.png" alt-text="Значки пользовательского интерфейса Fluent для Word, Excel и PowerPoint.":::

Рекомендуется использовать пользовательский интерфейс Fluent, чтобы помочь пользователям переходить между продуктами Майкрософт. Всегда следует использовать значок Office, чтобы указать, какое приложение Office будет запущено с веб-страницы. Давайте изменим пример кода, чтобы использовать значок Excel, чтобы указать, что он запускает приложение Excel.

1. Откройте пример в Visual Studio.
1. Откройте страницу **Home.aspx** .
1. Найдите следующий код, который является кнопкой скачивания в форме.

    ```html
    <asp:Button ID="btnDownload" runat="server" Text="Download" OnClick="btnDownload_Click" /> 
    ```

1. Замените код кнопки следующим тегом изображения.

    ```html
    <asp:Image  src="https://static2.sharepointonline.com/files/fabric/assets/brand-icons/product/svg/excel_48x1.svg" width="48" height="48" ID="btnDownload" runat="server" OnClick="btnDownload_Click" AlternateText="Open in Microsoft Excel" role="button" ImageUrl=""/>  
    ```

1. Нажмите клавишу **F5** (или **Начать** > **отладку**). При загрузке домашней страницы появится значок.

Дополнительные сведения см. в разделе [Значки фирменной символики Office](https://developer.microsoft.com/fluentui#/styles/web/office-brand-icons) на портале разработчика fluent UI.  

## <a name="upload-the-excel-document-to-microsoft-onedrive"></a>Отправка документа Excel в Microsoft OneDrive

Если клиент использует OneDrive, рекомендуется отправлять новые документы в OneDrive. Это упрощает поиск документов и работу с ними. Давайте создадим новый пример кода и посмотрим, как с помощью пакета SDK для Microsoft Graph можно отправить новый документ Excel в OneDrive.

### <a name="use-a-quick-start-to-build-a-new-microsoft-graph-web-application"></a>Краткое руководство по созданию нового веб-приложения Microsoft Graph

1. Перейдите к [https://developer.microsoft.com/graph/quick-start](https://developer.microsoft.com/graph/quick-start) и выполните действия, чтобы создать и открыть пример кода быстрого запуска, который взаимодействует со службами Office.
1. На **шаге 1. Выберите язык или платформу**, выберите **ASP.NET MVC**. Хотя в шагах в этой процедуре используется параметр ASP.NET MVC, шаги соответствуют шаблону, который применяется к любому языку или платформе.
1. На **шаге 2. Получение идентификатора и секрета приложения** выберите **Получить идентификатор и секрет приложения**.
1. Войдите в учетную запись Microsoft 365.  
1. На веб-странице **Сохранение секрета приложения** сохраните секрет приложения в расположении файла, где его можно будет получить и использовать позже.
1. Выберите **Пункт Получил, вернитесь к краткому началу**.
1. **На шаге 2. Регистрация прошла успешно!** Введите созданный секрет приложения.
1. На **шаге 3. Начало написания кода** выберите **Скачать пример кода на основе пакета SDK**.
1. Извлеките zip-папку для скачивания в локальную папку.  
1. Откройте файл graph-tutorial.sln в Visual Studio 2019.
1. Выполните сборку и запуск решения и убедитесь, что оно работает правильно. Вы можете использовать веб-страницу календаря для просмотра календаря Microsoft 365.

### <a name="upload-a-file-to-onedrive"></a>Отправка файла в OneDrive

1. Откройте решение **graph-tutorial.sln** в Visual Studio 2019 и откройте **файлPrivateSettings.config** .

1. Добавьте новую область **files.ReadWrite** в ключ **ida:AppScopes** , чтобы она выглядела так, как показано в следующем коде.

    ```xml
    <add key="ida:AppScopes" value="User.Read Calendars.Read Files.ReadWrite " />
    ```

1. Откройте файл **Index.cshtml** .
1. Вставьте следующий код ActionLink, чтобы создать кнопку для отправки файла в OneDrive.

    ```razor
    @if (Request.IsAuthenticated)
    {
        <h4>Welcome @ViewBag.User.DisplayName!</h4>
        <p>Use the navigation bar at the top of the page to get started.</p>
        @Html.ActionLink("Click here to create a new file on OneDrive", "CreateOneDriveFile", "Home", new { area = "" }, new { @class = "btn btn-primary btn-large" })
    }
    ```

1. Откройте файл **HomeController.cs** .
1. Вставьте следующий код для обработки запроса из ссылки на действие.

    ```csharp
    public void CreateOneDriveFile()
        {
            using (var stream = new System.IO.MemoryStream(System.Text.Encoding.UTF8.GetBytes("The contents of the file goes here.")))
            {
                var client = graph_tutorial.Helpers.GraphHelper.UploadFile("/test.txt", stream);
            }
        }
    ```

1. Откройте файл **GraphHelper.cs** .
1. Вставьте следующий код, чтобы вызвать microsoft API Graph для создания файла в OneDrive.

    ```csharp
    public static async Task UploadFile(string fileName, System.IO.MemoryStream stream)
        {
           var graphClient = GetAuthenticatedClient();
            await graphClient.Me
                .Drive
                .Root
                .ItemWithPath(fileName)
                .Content
                .Request()
                .PutAsync<DriveItem>(stream);
            return;
        }
    ```

1. Нажмите клавишу **F5** (или **Начать** > **отладку**). Запустится веб-приложение.
1. Нажмите **кнопку Щелкните здесь, чтобы войти и** войти в систему.
1. Нажмите **кнопку Щелкните здесь, чтобы создать новый файл в OneDrive**.
1. Откройте новую вкладку браузера и войдите в учетную запись OneDrive. Вы увидите файл test.txt в корневой папке.

Теперь, когда вы узнали, как отправить файл в OneDrive, вы можете повторно использовать этот код для отправки любого создаваемого документа Excel.

## <a name="additional-considerations-for-your-solution"></a>Дополнительные рекомендации по решению

Решение каждого человека отличается с точки зрения технологий и подходов. Следующие рекомендации помогут вам спланировать изменение решения для открытия документов и внедрения надстройки Office.

### <a name="create-a-new-excel-spreadsheet-from-the-web-page"></a>Создание электронной таблицы Excel на веб-странице

Пример изменяет существующий документ Excel. Более распространенный сценарий заключается в том, что вы создаете новую электронную таблицу Excel на веб-странице. Дополнительные сведения о создании новой электронной таблицы см. в статье **Создание документа электронной таблицы** , указав имя файла. В этой статье показано, как создать файл локально, но вы также можете создать файл в потоке с помощью перегрузки в методе SpreadsheetDocument.Create.

### <a name="read-custom-properties-when-your-add-in-starts"></a>Чтение пользовательских свойств при запуске надстройки

Пример кода сохраняет идентификатор фрагмента кода в новом документе Excel с помощью пакета SDK OOXML. Script Lab считывает идентификатор фрагмента из документа Excel, а затем отображает его код при открытии. Может потребоваться отправить пользовательские свойства в собственную надстройку (например, строку запроса или временный маркер проверки подлинности). Подробные сведения о том, как считывать пользовательские свойства при запуске надстройки, см. в разделе **Сохранение состояния и параметров** надстройки.

### <a name="initialize-the-excel-document-with-data"></a>Инициализация документа Excel с данными

Как правило, когда клиент открывает документ Excel с веб-сайта, он ожидает, что документ будет содержать некоторые данные с веб-сайта. Существует несколько способов записи данных в документ.

- **Используйте пакет SDK OOXML для записи данных**. Пакет SDK можно использовать для непосредственной записи любых данных в документ. Этот подход полезен, если требуется, чтобы данные были доступны в момент открытия документа.
- **Передайте пользовательское свойство запроса в надстройку Office**. При создании документа вы внедряете пользовательское свойство для надстройки Office, содержащее строку запроса, которая извлекает все необходимые данные. Когда надстройка откроется, она извлекает запрос, выполняет запрос и использует API Office JS для вставки результата запроса в документ.

### <a name="working-with-the-ooxml-sdk"></a>Работа с пакетом SDK OOXML

Пакет SDK OOXML основан на .NET. Если веб-приложение не использует .NET, вам потребуется найти альтернативный способ работы с OOXML.

Код OOXML можно поместить в функцию Azure, чтобы отделить код .NET от остальной части веб-приложения. Затем вызовите функцию Azure (для создания документа Excel) из веб-приложения. Дополнительные сведения о функциях Azure см. в статье [Введение в Функции Azure](/azure/azure-functions/functions-overview).

### <a name="use-single-sign-on"></a>Использование единого входа

Чтобы упростить проверку подлинности, рекомендуется реализовать единый вход в надстройку. Дополнительные сведения см[. в статье Включение единого входа для надстроек Office](../develop/sso-in-office-add-ins.md).

## <a name="see-also"></a>См. также

- [Добро пожаловать на страницу пакета SDK 2.5 Open XML для Office](/office/open-xml/open-xml-sdk)
- [Автоматическое открытие области задач с документом](../develop/automatically-open-a-task-pane-with-a-document.md)
- [Persisting add-in state and settings](../develop/persisting-add-in-state-and-settings.md)
- [Создайте документ электронной таблицы, указав имя файла](/office/open-xml/how-to-create-a-spreadsheet-document-by-providing-a-file-name)