---
ms.date: 03/06/2019
description: Проверка поДлинности пользователей с помощью пользовательских функций в Excel.
title: Проверка поДлинности для пользовательских функций
ms.openlocfilehash: 4358d9f570ef8b31db98b1886c01ff4a89a6b1be
ms.sourcegitcommit: 8e7b7b0cfb68b91a3a95585d094cf5f5ffd00178
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2019
ms.locfileid: "30512855"
---
# <a name="authentication"></a>Проверка подлинности

В некоторых сценариях пользовательская функция должна проверить подлинность пользователя, чтобы получить доступ к защищенным ресурсам. В то время как для пользовательских функций не требуется определенный способ проверки подлинности, следует учитывать, что пользовательские функции выполняются в отдельной среде выполнения из области задач и других элементов ПОЛЬЗОВАТЕЛЬСКОГО интерфейса надстройки. Поэтому необходимо передавать данные между двумя средами выполнения с помощью `AsyncStorage` объекта и API диалоговых окон.
  
## <a name="asyncstorage-object"></a>Объект Асинкстораже

В среде выполнения пользовательских функций отсутствует `localStorage` объект, доступный в глобальном окне, где обычно могут храниться данные. Вместо этого следует обмениваться данными между пользовательскими функциями и областями задач с помощью [оффицерунтиме. асинкстораже](https://docs.microsoft.com/javascript/api/office-runtime/officeruntime.asyncstorage) для задания и получения данных.

Кроме того, существует преимущество использования `AsyncStorage`; Она использует безопасную изолированную среду, чтобы получить доступ к данным другими надстройками.

### <a name="suggested-usage"></a>Предлагаемое использование

Если вам нужно выполнить проверку подлинности из области задач или настраиваемой функции, `AsyncStorage` проверьте, был ли уже получен маркер доступа. В противном случае используйте API диалоговых окон для проверки подлинности пользователя, получения маркера доступа и сохранения маркера в `AsyncStorage` для дальнейшего использования.

## <a name="dialog-api"></a>API диалоговых окон

Если маркер не существует, следует использовать API диалоговых окон, чтобы попросить пользователя выполнить вход. После того как пользователь введет свои учетные данные, получившийся маркер доступа можно `AsyncStorage`будет хранить в файле.

> [!NOTE]
> В среде выполнения пользовательских функций используется объект Dialog, который немного отличается от объекта Dialog в среде выполнения модуля браузера, используемого панелями задач. Они обе называются "диалоговым API", но используются `Officeruntime.Dialog` для проверки подлинности пользователей в среде выполнения пользовательских функций.

Сведения о том `OfficeRuntime.Dialog`, как использовать, можно найти в разделе [Среда выполнения пользовательских функций](https://docs.microsoft.com/en-us/office/dev/add-ins/excel/custom-functions-runtime?view=office-js#displaying-a-dialog-box).

Выполняя весь процесс проверки подлинности в целом, можно представить себе область задач и элементы ПОЛЬЗОВАТЕЛЬСКОГО интерфейса надстройки, а также компонент Custom functions в надстройке как отдельные объекты, которые могут общаться друг с другом с помощью `AsyncStorage`.

Ниже приведена схема, в которой описан этот базовый процесс. Обратите внимание, что пунктирная линия указывает на то, что при выполнении отдельных действий пользовательские функции и область задач надстройки являются частью надстройки в целом.

1. Вы выДаете вызов пользовательской функции из ячейки книги Excel.
2. Пользовательская функция использует `Officeruntime.Dialog` для передачи учетных данных пользователя на веб-сайт.
3. Затем этот веб-сайт возвращает маркер доступа к пользовательской функции.
4. Затем пользовательская функция устанавливает для маркера доступа значение `AsyncStorage`.
5. Область задач надстройки получает доступ к маркеру из `AsyncStorage`.

![Схема пользовательских функций, оффицерунтиме и областей задач, работающих вместе.] (../images/Authdiagram.png "Схема проверки подлинности.")

## <a name="storing-the-token"></a>Сохранение маркера

Приведенные ниже примеры относятся к [использованию примера использования асинкстораже в коде пользовательских функций](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Excel-custom-functions/AsyncStorage) . В этом примере кода приведен полный пример совместного использования данных пользовательскими функциями и областью задач.

Если пользовательская функция выполняет проверку подлинности, она получает маркер доступа и должна храниться в `AsyncStorage`. В приведенном ниже примере кода показано, как `AsyncStorage.setItem` вызвать метод для хранения значения. `StoreValue` Функция — это пользовательская функция, в которой пример содержит значение от пользователя. Вы можете изменить его, чтобы сохранить все необходимые значения маркера.

```javascript
function StoreValue(key, value) {
  return OfficeRuntime.AsyncStorage.setItem(key, value).then(function (result) {
      return "Success: Item with key '" + key + "' saved to AsyncStorage.";
  }, function (error) {
      return "Error: Unable to save item with key '" + key + "' to AsyncStorage. " + error;
  });
}
```

Когда область задач нуждается в маркере доступа, она может получить маркер из `AsyncStorage`. В приведенном ниже примере кода показано, как `AsyncStorage.getItem` использовать метод для получения маркера.

```javascript
function ReceiveTokenFromCustomFunction() {
   var key = "token";
   var tokenSendStatus = document.getElementById('tokenSendStatus');
   OfficeRuntime.AsyncStorage.getItem(key).then(function (result) {
      tokenSendStatus.value = "Success: Item with key '" + key + "' read from AsyncStorage.";
      document.getElementById('tokenTextBox2').value = result;
   }, function (error) {
      tokenSendStatus.value = "Error: Unable to read item with key '" + key + "' from AsyncStorage. " + error;
   });
}
```

## <a name="general-guidance"></a>Общие рекомендации

Надстройки Office основаны на веб-интерфейсе, и вы можете использовать любой способ проверки подлинности веб-сайта. Для реализации собственной проверки подлинности с настраиваемыми функциями не нужно выполнять определенные шаблоны или методы. Вы можете ознакомиться с документацией по различным шаблонам проверки подлинности, начиная с [этой статьи, посвященной авторизации через внешние службы](https://docs.microsoft.com/en-us/office/dev/add-ins/develop/auth-external-add-ins?view=office-js).  

Избегайте использования следующих расположений для хранения данных при разработке пользовательских функций:  

- `localStorage`: Пользовательские функции не имеют доступа к глобальному `window` объекту и поэтому не имеют доступа к данным, хранящимся `localStorage`в.
- `Office.context.document.settings`: Это расположение не является безопасным, и его данные могут извлекаться кем угодно с помощью надстройки.

## <a name="see-also"></a>См. также

* [Метаданные пользовательских функций](custom-functions-json.md)
* [Среда выполнения для пользовательских функций Excel](custom-functions-runtime.md)
* [Рекомендации по настраиваемым функциям](custom-functions-best-practices.md)
* [Руководство по настраиваемым функциям в Excel](excel-tutorial-custom-functions.md)
