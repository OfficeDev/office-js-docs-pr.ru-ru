---
ms.date: 07/09/2019
description: Проверка подлинности пользователей с использованием пользовательских функций в Excel.
title: Проверка подлинности для пользовательских функций
localization_priority: Normal
ms.openlocfilehash: 872553986ebb74a97fd30afa0516ae6a72cf77bf
ms.sourcegitcommit: 4079903c3cc45b7d8c041509a44e9fc38da399b1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2020
ms.locfileid: "42596504"
---
# <a name="authentication-for-custom-functions"></a>Проверка подлинности для пользовательских функций

В некоторых случаях пользовательским функциям требуется проверить подлинность пользователя, чтобы получить доступ к защищенным ресурсам. Хотя пользовательские функции не требуют определенного метода проверки подлинности, следует учитывать, что они выполняются в отдельной среде из области задач и других элементов пользовательского интерфейса надстройки. Поэтому между двумя средами выполнения требуется осуществлять обмен данными с помощью объекта `OfficeRuntime.storage` и API диалоговых окон.

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

## <a name="officeruntimestorage-object"></a>Объект OfficeRuntime.storage

В среде выполнения пользовательских функций отсутствует объект `localStorage`, доступный в глобальном окне, где обычно хранятся данные. Вместо этого следует обмениваться данными между пользовательскими функциями и областями задач, используя объект [OfficeRuntime.storage](/javascript/api/office-runtime/officeruntime.storage) для настройки и получения данных.

Кроме того, использование объекта `storage` дает преимущество; он использует безопасную изолированную среду, чтобы ваши данные были недоступны другим надстройкам.

### <a name="suggested-usage"></a>Рекомендуемое использование

Если вам нужно проверить подлинность из области задач или пользовательской функции, проверьте объект `storage`, чтобы узнать, был ли уже получен маркер доступа. Если нет, используйте API диалоговых окон, чтобы проверить подлинность пользователя, извлечь маркер доступа и сохранить его в объекте `storage` для дальнейшего использования.

## <a name="dialog-api"></a>API диалоговых окон

Если маркер не существует, следует использовать API диалоговых окон, чтобы попросить пользователя войти в систему. После ввода пользователем своих учетных данных итоговый маркер доступа можно сохранить в объекте `storage`.

> [!NOTE]
> В среде выполнения пользовательских функций используется объект Dialog, немного отличающийся от объекта Dialog среды выполнения модуля браузера, применяемого областями задач. Они оба называются "API диалоговых окон", но для проверки подлинности пользователей в среде выполнения пользовательских функций используется интерфейс `OfficeRuntime.Dialog`.

Сведения об использовании объекта `Dialog` см. в статье [Диалоговое окно пользовательских функций](../excel/custom-functions-dialog.md).

При формировании всего процесса проверки подлинности рекомендуется рассматривать область задач, элементы пользовательского интерфейса надстройки и часть надстройки, включающую пользовательские функции, как отдельные объекты, которые могут взаимодействовать друг с другом с помощью интерфейса `OfficeRuntime.storage`.

На следующей схеме показан этот основной процесс. Обратите внимание на пунктирную линию, которая указывает, что хотя пользовательские функции выполняют отдельные действия, они и область задач надстройки входят в состав надстройки.

1. Вы выполняете вызов пользовательской функции из ячейки книги Excel.
2. Пользовательская функция использует `Dialog` для передачи учетных данных пользователя на веб-сайт.
3. Этот веб-сайт возвращает маркер доступа для пользовательской функции.
4. После этого пользовательская функция устанавливает этот маркер доступа в объекте `storage`.
5. Область задач надстройки получает доступ к маркеру из объекта `storage`.

![Схема пользовательской функции с помощью API диалога для получения маркера доступа, а затем совместного использования маркера с областью задач с помощью API Оффицерунтиме. Storage.](../images/authentication-diagram.png "Схема проверки подлинности.")

## <a name="storing-the-token"></a>Хранение маркера

Следующие примеры взяты из примера кода [Использование OfficeRuntime.storage в пользовательских функциях](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Excel-custom-functions/AsyncStorage). Этот пример кода представляет полный пример обмена данными между пользовательскими функциями и областью задач.

При проверке подлинности пользовательской функцией она получает маркер доступа, который должен храниться в объекте `storage`. В следующем примере кода показано, как вызвать метод `storage.setItem` чтобы сохранить значение. Функция `storeValue` — это пользовательская функция, которая в данном примере сохраняет значение, полученное от пользователя. Можно внести изменение, чтобы сохранять любые нужные значения маркеров.

```js
/**
 * Stores a key-value pair into OfficeRuntime.storage.
 * @customfunction
 * @param {string} key Key of item to put into storage.
 * @param {*} value Value of item to put into storage.
 */
function storeValue(key, value) {
  return OfficeRuntime.storage.setItem(key, value).then(function (result) {
      return "Success: Item with key '" + key + "' saved to storage.";
  }, function (error) {
      return "Error: Unable to save item with key '" + key + "' to storage. " + error;
  });
}
```

Когда области задач требуется маркер доступа, она может извлечь его из объекта `storage`. В следующем примере кода показано, как использовать метод `storage.getItem` чтобы извлечь маркер.

```js
/**
 * Read a token from storage.
 * @customfunction GETTOKEN
 */
function receiveTokenFromCustomFunction() {
  var key = "token";
  var tokenSendStatus = document.getElementById('tokenSendStatus');
  OfficeRuntime.storage.getItem(key).then(function (result) {
     tokenSendStatus.value = "Success: Item with key '" + key + "' read from storage.";
     document.getElementById('tokenTextBox2').value = result;
  }, function (error) {
     tokenSendStatus.value = "Error: Unable to read item with key '" + key + "' from storage. " + error;
  });
}
```

## <a name="general-guidance"></a>Общие рекомендации

Надстройки Office являются веб-надстройками, и вы можете использовать любой способ веб-проверки подлинности. При реализации своей собственной проверки подлинности с использованием пользовательских функций отсутствует определенный шаблон или метод. Рекомендуется ознакомиться с документацией по различным шаблонам проверки подлинности, начиная с [этой статьи об авторизации через внешние службы](../develop/auth-external-add-ins.md).  

Избегайте использования следующих расположений для хранения данных при разработке пользовательских функций.  

- `localStorage`: у пользовательских функций нет доступа к глобальному объекту `window`, поэтому им недоступны данные, хранящиеся в объекте `localStorage`.
- `Office.context.document.settings`: это расположение не защищено, и сведения могут быть извлечены любым пользователем с помощью надстройки.

## <a name="next-steps"></a>Дальнейшие действия
Сведения об [API диалоговых окон для пользовательских функций](custom-functions-dialog.md).

## <a name="see-also"></a>См. также

* [Архитектура пользовательских функций](custom-functions-architecture.md)
* [Получение и обработка данных с помощью пользовательских функций](custom-functions-web-reqs.md)
* [Среда выполнения для пользовательских функций Excel](custom-functions-runtime.md)
* [Руководство по пользовательским функциям в Excel](excel-tutorial-custom-functions.md)
