---
ms.date: 05/17/2020
title: Настройка надстройки Excel для предоставления общего доступа к среде выполнения браузера
ms.prod: excel
description: Настройте надстройку Excel, чтобы предоставить общий доступ к среде выполнения браузера и запускать код ленты, области задач и пользовательских функций в одной и той же среде выполнения.
localization_priority: Priority
ms.openlocfilehash: 8c16642f5a945e6156fcfd93c8b4cc088b616102
ms.sourcegitcommit: be23b68eb661015508797333915b44381dd29bdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/08/2020
ms.locfileid: "44609347"
---
# <a name="configure-your-excel-add-in-to-use-a-shared-javascript-runtime"></a>Настройка надстройки Excel для использования общей среды выполнения JavaScript

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

При работе с Excel для Windows или Mac OS в надстройке будет запускаться код для кнопок ленты, пользовательских функций и области задач в отдельных средах выполнения JavaScript. Это создает ограничения, такие как отсутствие возможности совместного использования глобальных данных, без доступа ко всем функциям CORS из настраиваемой функции.

Но вы можете настроить вашу надстройку Excel, предоставив общий доступ к коду в общей среде выполнения JavaScript. Это позволяет повысить слаженность работы всей вашей надстройки и обеспечить доступ к DOM и CORS из всех ее частей. Кроме того, это позволяет запускать код при открытии документа и после закрытия области задач. Чтобы настроить надстройку для использования общей среды выполнения, следуйте инструкциям, приведенным в этой статье.

## <a name="create-the-add-in-project"></a>Создание проекта надстройки

Если вы начинаете новый проект, выполните указанные ниже действия, чтобы с помощью генератора Yeoman создать проект надстройки Excel. Выполните приведенную ниже команду и ответьте на вопросы, как показано ниже.

```command line
yo office
```

- Выберите тип проекта: **проект надстройки пользовательских функций Excel**
- Выберите тип сценария: **JavaScript**
- Как вы хотите назвать надстройку? **Моя надстройка Office**

![Снимок экрана: ответы на вопросы Office о создании проекта надстройки.](../images/yo-office-excel-project.png)

После завершения работы мастера генератор создаст проект и установит вспомогательные компоненты Node.

## <a name="configure-the-manifest"></a>Настройка манифеста

Выполните указанные ниже действия для нового или существующего проекта, чтобы настроить его для использования общей среды выполнения.

1. Запустите Visual Studio Code и откройте проект **Моя надстройка Office**.
2. Откройте файл **manifest.xml**.
3. Найдите раздел `<VersionOverrides>` и добавьте следующий раздел `<Runtimes>`. Время существования должно быть **длительным**, чтобы пользовательские функции могли работать даже после закрытия области задач. Атрибут resid равен `ContosoAddin.Url` и ссылается на строку в разделе ресурсов далее. Можно использовать любое значение resid, но оно должно соответствовать resid других элементов в элементах вашей надстройки.

   ```xml
   <VersionOverrides xmlns="http://schemas.microsoft.com/office/taskpaneappversionoverrides" xsi:type="VersionOverridesV1_0">
     <Hosts>
       <Host xsi:type="Workbook">
       <Runtimes>
         <Runtime resid="ContosoAddin.Url" lifetime="long" />
       </Runtimes>
       <AllFormFactors>
   ```

4. В элементе `<Page>` замените расположение источника с **Functions.Page.Url** на **ContosoAddin.Url**. Этот resid соответствует элементу resid `<Runtime>`. Обратите внимание: если у вас нет пользовательских функций, то у вас не будет элемента **Page**, и этот шаг можно пропустить.

   ```xml
   <AllFormFactors>
   ...
   <Page>
   <SourceLocation resid="ContosoAddin.Url"/>
   </Page>
   ...
   ```

5. В разделе `<DesktopFormFactor>` замените **FunctionFile** с **Commands.Url** на **ContosoAddin.Url**. Обратите внимание: если у вас нет команд действий, то у вас не будет элемента **FunctionFile**, и этот шаг можно пропустить.

   ```xml
   <DesktopFormFactor>
   <GetStarted>
   ...
   </GetStarted>
   <FunctionFile resid="ContosoAddin.Url"/>
   ```

6. В разделе `<Action>` измените расположение источника с **Taskpane.Url** на **ContosoAddin.Url**. Обратите внимание: если у вас нет области задач, то у вас не будет действия **ShowTaskpane**, и этот шаг можно пропустить.

   ```xml
   <Action xsi:type="ShowTaskpane">
   <TaskpaneId>ButtonId1</TaskpaneId>
   <SourceLocation resid="ContosoAddin.Url"/>
   </Action>
   ```

7. Добавьте новый **Url-идентификатор** для **ContosoAddin.Url**, указывающий на **taskpane.html**.

   ```xml
   <bt:Urls>
   <bt:Url id="Functions.Script.Url" DefaultValue="https://localhost:3000/dist/functions.js"/>
   ...
   <bt:Url id="ContosoAddin.Url" DefaultValue="https://localhost:3000/taskpane.html"/>
   ...
   ```

8. Сохраните изменения и перестройте проект.

   ```command line
   npm run build
   ```

## <a name="runtime-lifetime"></a>Срок существования среды выполнения

Добавляя элемент `Runtime`, вы также задаете срок существования со значением `long` или `short`. Установите значение `long`, чтобы воспользоваться такими функциями, как запуск надстройки при открытии документа, продолжение выполнения кода после закрытия области задач или использование CORS и DOM из пользовательских функций.

>! НОТЕ По умолчанию используется значение времени жизни `short` , но мы рекомендуем использовать надстройки `long` Excel. Если для среды выполнения задано значение `short` в этом примере, надстройка Excel будет запускаться при нажатии одной из кнопок ленты, но может завершить работу после выполнения обработчика ленты. Точно так же, надстройка запустится при открытии области задач, но может завершить работу после закрытия области задач.

```xml
<Runtimes>
  <Runtime resid="ContosoAddin.Url" lifetime="long" />
</Runtimes>
```

## <a name="multiple-task-panes"></a>Несколько областей задач

Не создавайте надстройку, чтобы использовать несколько областей задач, если вы планируете использовать общую среду выполнения. Общая среда выполнения поддерживает использование только одной области задач. Обратите внимание: любая область задач без `<TaskpaneID>` считается другой областью задач.

## <a name="next-steps"></a>Дальнейшие действия

- Подробные сведения об использовании API JavaScript для Excel и пользовательских функций Excel в общей среде выполнения см. в статье [Вызов API Excel из пользовательской функции](call-excel-apis-from-custom-function.md).
- Изучите пример PnP [Управление интерфейсом ленты и области задач, а также запуск кода при открытии документа](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/excel-shared-runtime-scenario), чтобы ознакомиться с масштабным примером работы общей среды выполнения JavaScript.

## <a name="see-also"></a>См. также

- [Обзор: выполнение кода надстройки в общей среде выполнения JavaScript](custom-functions-shared-overview.md)
