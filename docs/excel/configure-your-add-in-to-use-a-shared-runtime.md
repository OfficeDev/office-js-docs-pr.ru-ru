---
ms.date: 04/16/2020
title: Настройте надстройку Excel, чтобы предоставить общий доступ к среде выполнения браузера (ознакомительная версия)
ms.prod: excel
description: Настройте надстройку Excel, чтобы предоставить общий доступ к среде выполнения браузера и запускать код ленты, области задач и пользовательских функций в одной и той же среде выполнения.
localization_priority: Priority
ms.openlocfilehash: f84de010787921eeb13205935b733ec36b2c3d37
ms.sourcegitcommit: 803587b324fc8038721709d7db5664025cf03c6b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "43547250"
---
# <a name="configure-your-excel-add-in-to-use-a-shared-javascript-runtime-preview"></a>Настройте свою надстройку Excel, чтобы использовать общую среду выполнения JavaScript (ознакомительная версия)

[!include[Running custom functions in a shared runtime note](../includes/excel-shared-runtime-preview-note.md)]

При работе с Excel для Windows или Mac OS в надстройке будет запускаться код для кнопок ленты, пользовательских функций и области задач в отдельных средах выполнения JavaScript. Это создает такие ограничения, как отсутствие удобной возможности предоставлять общий доступ к глобальным данным и отсутствие доступа ко всем функциональным возможностям CORS из пользовательской функции.

Но вы можете настроить вашу надстройку Excel, предоставив общий доступ к коду в общей среде выполнения JavaScript. Это позволяет повысить слаженность работы всей вашей надстройки и обеспечить доступ к DOM и CORS из всех ее частей. Кроме того, это позволяет запускать код при открытии документа и после закрытия области задач. Чтобы настроить надстройку для использования общей среды выполнения, следуйте инструкциям, приведенным в этой статье.

## <a name="create-the-add-in-project"></a>Создание проекта надстройки

Если вы начинаете новый проект, выполните указанные ниже действия, чтобы с помощью генератора Yeoman создать проект надстройки Excel. Выполните приведенную ниже команду и ответьте на вопросы, как показано ниже.

```command line
yo office
```

- Выберите тип проекта: **проект надстройки пользовательских функций Excel**
- Выберите тип сценария: **JavaScript**
- Как вы хотите назвать надстройку? **Моя надстройка Office**

![Снимок экрана: ответы на вопросы Office о создании проекта надстройки.](../images/yo-office-excel-project.png)

После завершения работы мастера генератор создаст проект и установит вспомогательные компоненты Node.

## <a name="configure-the-manifest"></a>Настройка манифеста

Выполните указанные ниже действия для нового или существующего проекта, чтобы настроить его для использования общей среды выполнения.

1. Запустите Visual Studio Code и откройте проект **Моя надстройка Office**.
2. Откройте файл **manifest.xml**.
3. Найдите раздел `<VersionOverrides>` и добавьте следующий раздел `<Runtimes>`. Время существования должно быть **длительным**, чтобы пользовательские функции могли работать даже после закрытия области задач. Атрибут resid равен `ContosoAddin.Url` и ссылается на строку в разделе ресурсов далее. Можно использовать любое значение resid, но оно должно соответствовать resid других элементов в элементах вашей надстройки.

   ```xml
   <VersionOverrides xmlns="http://schemas.microsoft.com/office/taskpaneappversionoverrides" xsi:type="VersionOverridesV1_0">
     <Hosts>
       <Host xsi:type="Workbook">
       <Runtimes>
         <Runtime resid="ContosoAddin.Url" lifetime="long" />
       </Runtimes>
       <AllFormFactors>
   ```

4. В элементе `<Page>` замените расположение источника с **Functions.Page.Url** на **ContosoAddin.Url**. Этот resid соответствует элементу resid `<Runtime>`. Обратите внимание: если у вас нет пользовательских функций, то у вас не будет элемента **Page**, и этот шаг можно пропустить.

   ```xml
   <AllFormFactors>
   ...
   <Page>
   <SourceLocation resid="ContosoAddin.Url"/>
   </Page>
   ...
   ```

5. В разделе `<DesktopFormFactor>` замените **FunctionFile** с **Commands.Url** на **ContosoAddin.Url**. Обратите внимание: если у вас нет команд действий, то у вас не будет элемента **FunctionFile**, и этот шаг можно пропустить.

   ```xml
   <DesktopFormFactor>
   <GetStarted>
   ...
   </GetStarted>
   <FunctionFile resid="ContosoAddin.Url"/>
   ```

6. В разделе `<Action>` измените расположение источника с **Taskpane.Url** на **ContosoAddin.Url**. Обратите внимание: если у вас нет области задач, то у вас не будет действия **ShowTaskpane**, и этот шаг можно пропустить.

   ```xml
   <Action xsi:type="ShowTaskpane">
   <TaskpaneId>ButtonId1</TaskpaneId>
   <SourceLocation resid="ContosoAddin.Url"/>
   </Action>
   ```

7. Добавьте новый **Url-идентификатор** для **ContosoAddin.Url**, указывающий на **taskpane.html**.

   ```xml
   <bt:Urls>
   <bt:Url id="Functions.Script.Url" DefaultValue="https://localhost:3000/dist/functions.js"/>
   ...
   <bt:Url id="ContosoAddin.Url" DefaultValue="https://localhost:3000/taskpane.html"/>
   ...
   ```

8. Сохраните изменения и перестройте проект.

   ```command line
   npm run build
   ```

## <a name="runtime-lifetime"></a>Срок существования среды выполнения

Добавляя элемент `Runtime`, вы также задаете срок существования со значением `long` или `short`. Установите значение `long`, чтобы воспользоваться такими функциями, как запуск надстройки при открытии документа, продолжение выполнения кода после закрытия области задач или использование CORS и DOM из пользовательских функций.

Если установить значение `short`, то надстройка будет работать в режиме, аналогичном заданному по умолчанию. Надстройка запустится при нажатии одной из кнопок на ленте, но может завершить работу после окончания функционирования обработчика ленты. Точно так же, надстройка запустится при открытии области задач, но может завершить работу после закрытия области задач.

```xml
<Runtimes>
  <Runtime resid="ContosoAddin.Url" lifetime="long" />
</Runtimes>
```

## <a name="multiple-task-panes"></a>Несколько областей задач

Не планируйте использовать в своей надстройке несколько областей задач, если предполагается использование общей среды выполнения. Общая среда выполнения поддерживает только одну область задач. Обратите внимание: любая область задач без `<TaskpaneID>` считается другой областью задач.

## <a name="next-steps"></a>Дальнейшие действия

- Подробные сведения об использовании API JavaScript для Excel и пользовательских функций Excel в общей среде выполнения см. в статье [Вызов API Excel из пользовательской функции](call-excel-apis-from-custom-function.md).
- Изучите пример PnP [Управление интерфейсом ленты и области задач, а также запуск кода при открытии документа](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/excel-shared-runtime-scenario), чтобы ознакомиться с масштабным примером работы общей среды выполнения JavaScript.

## <a name="see-also"></a>См. также

- [Обзор: запуск кода надстройки в общей среде выполнения JavaScript (ознакомительная версия)](custom-functions-shared-overview.md)
