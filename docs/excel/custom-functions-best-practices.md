---
ms.date: 10/24/2018
description: Ознакомьтесь с советами и рекомендованными шаблонами в отношении пользовательских функций Excel.
title: Рекомендации в отношении пользовательских функций
ms.openlocfilehash: 0408318227e1f89726ed7c0e4dfbb8e6340abef4
ms.sourcegitcommit: 52d18dd8a60e0cec1938394669d577570700e61e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/26/2018
ms.locfileid: "25797401"
---
# <a name="custom-functions-best-practices-preview"></a>Рекомендации в отношении пользовательских функций (предварительная версия)

В этой статье описаны рекомендации по разработке пользовательских функций в Excel.

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

## <a name="error-handling"></a>Обработка ошибок

При создании надстройки, определяющей пользовательские функции, не забудьте включить логику для обработки ошибок, возникающих в среде выполнения. Обработка ошибок для пользовательских функций в значительной степени совпадает с [обработкой ошибок для API JavaScript в Excel](excel-add-ins-error-handling.md). В приведенном ниже примере кода `.catch` обрабатывает любые ошибки, возникающие в коде ранее.

```js
function getComment(x) {
  let url = "https://www.contoso.com/comments/" + x;
  return fetch(url)
    .then(function (data) {
      return data.json();
    })
    .then((json) => {
      return json.body;
    })
    .catch(function (error) {
      throw error;
    })
}
```

## <a name="troubleshooting"></a>Устранение неполадок

Если вы проверяете надстройку в Office для Windows, нужно включить **[ведение журнала в среде выполнения](../testing/troubleshoot-manifest.md#use-runtime-logging-to-debug-your-add-in)**, чтобы устранять проблемы с XML-файлом манифеста надстройки, а также с некоторыми условиями установки и среды выполнения. В файл журнала в среде выполнения записываются операторы `console.log`, что облегчает выявление проблем.

Чтобы поделиться своим мнением об этом методе устранения неполадок с группой, отвечающей за пользовательские функции Excel, отправьте отзыв группе. Для этого выберите **Файл | Отзыв | Отправить нахмуренный смайлик**. Отправка нахмуренного смайлика предоставит необходимые журналы для понимания проблемы, на которую вы указываете. 

## <a name="debugging"></a>Отладка

В настоящее время наилучшим способом отладки пользовательских функций Excel является [загрузка неопубликованной](../testing/sideload-office-add-ins-for-testing.md) надстройки в **Excel Online**. Затем вы сможете выполнить отладку пользовательских функций с помощью [собственного средства отладки вашего браузера, вызываемого клавишей F12,](../testing/debug-add-ins-in-office-online.md) в сочетании с указанными ниже методами.

- Используйте операторы `console.log` в коде пользовательских функций, чтобы отправлять результаты в консоль в режиме реального времени.

- Используйте операторы `debugger;` в коде пользовательских функций, чтобы указать точки останова для приостановки выполнения при открытом окне, вызываемом клавишей F12. Например, если выполняется следующая функция при открытом окне F12, выполнение приостанавливается на операторе `debugger;`, что позволяет вручную проверить значения параметров перед возвратом функции. Оператор `debugger;` не выполняет никаких действий в Excel Online, если не открыто окно F12. В настоящее время оператор `debugger;` не выполняет никаких действий в Excel для Windows.

    ```js
    function add(first, second){
      debugger;
      return first + second;
    }
    ```

Если не удается зарегистрировать надстройку, [проверьте, что SSL-сертификаты правильно настроены](https://github.com/OfficeDev/generator-office/blob/master/src/docs/ssl.md) для веб-сервера, на котором размещается ваше приложение надстройки.

## <a name="mapping-function-names-to-json-metadata"></a>Сопоставление имен функций с метаданными JSON

Как указано в статье [Обзор пользовательских функций](custom-functions-overview.md), проект пользовательских функций должен содержать файл метаданных JSON, который предоставляет сведения, необходимые Excel для регистрации пользовательских функций и обеспечения их доступности для конечных пользователей. Кроме того, в файле JavaScript, определяющем пользовательские функции, необходимо предоставить сведения, которые указывают, какой объект функции в файле метаданных JSON соответствует каждой пользовательской функции в файле JavaScript.

Например, в приведенном ниже примера кода определяется пользовательская функция `add` и указывается, что функция `add` соответствует объекту в файле метаданных JSON, при этом свойству `id` присваивается значение **ADD**.

```js
function add(first, second){
  return first + second;
}

CustomFunctionMappings.ADD = add;
```

Имейте в виду приведенные ниже рекомендации при создании пользовательских функций в файле JavaScript и указании соответствующих сведений в файле метаданных JSON.

* В файле JavaScript укажите имена функций в стиле camelCase. Например, имя функции `addTenToInput` записано в стиле camelCase: первое слово имени начинается со строчной буквы, а каждое последующее слово начинается с прописной буквы.

* В файле метаданных JSON укажите значение каждого свойства `name` прописными буквами. Свойство `name` определяет имя функции, которое отображается для конечных пользователей в Excel. Использование прописных букв для имени каждой пользовательской функции обеспечивает единый интерфейс для конечных пользователей в Excel, где все имена встроенных функций записаны прописными буквами.

* В файле метаданных JSON укажите значение каждого свойства `id` прописными буквами. Благодаря этому становится понятно, какая часть оператора `CustomFunctionMappings` в коде JavaScript соответствует свойству `id` в файле метаданных JSON (при условии, что для имени функции используется стиль camelCase, как рекомендуется выше).

* Убедитесь, что в файле метаданных JSON значение каждого свойства `id` содержит только буквы, цифры и точки. 

* Убедитесь, что в файле метаданных JSON значение каждого свойства `id` уникально в пределах файла. То есть никакие два объекта функций в файле метаданных не должны иметь одинаковое значение `id`. Кроме того, не указывайте два значения `id` в файле метаданных, которые отличаются только регистром. Например, не определяйте один объект функции со значением `id` равным **add**, а другой объект функции со значением `id` равным **ADD**.

* Не изменяйте значение свойства `id` в файле метаданных JSON после его сопоставления с соответствующим именем функции JavaScript. Вы можете изменить имя функции, которое отображается для конечных пользователей в Excel, путем обновления свойства `name` в файле метаданных JSON, но никогда не следует изменять значение свойства `id` после его установления.

* В файле JavaScript указывайте все сопоставления пользовательских функций в одном расположении. Например, в приведенном ниже примере кода определяются две пользовательские функции и указываются сведения о сопоставлении для обеих функций.

    ```js
    function add(first, second){
      return first + second;
    }

    function increment(incrementBy, callback) {
      var result = 0;
      var timer = setInterval(function() {
        result += incrementBy;
        callback.setResult(result);
      }, 1000);

      callback.onCanceled = function() {
        clearInterval(timer);
      };
    }

    // map `id` values in the JSON metadata file to JavaScript function names
    CustomFunctionMappings.ADD = add;
    CustomFunctionMappings.INCREMENT = increment;
    ```

    В приведенном ниже примере показаны метаданные JSON, соответствующие функциям, определенным в этом примере кода JavaScript.

    ```json
    {
      "$schema": "https://developer.microsoft.com/en-us/json-schemas/office-js/custom-functions.schema.json",
      "functions": [
        {
          "id": "ADD",
          "name": "ADD",
          ...
        },
        {
          "id": "INCREMENT",
          "name": "INCREMENT",
          ...
        }
      ]
    }
    ```

## <a name="additional-considerations"></a>Дополнительные рекомендации

Чтобы создать надстройку, которая будет работать на различных платформах (один из основных клиентов надстроек Office), вам не следует выполнять доступ к модели DOM в пользовательских функциях или использовать библиотеки, такие как jQuery, которые используют DOM. В Excel для Windows, где пользовательские функции используют [среду выполнения JavaScript](custom-functions-runtime.md), пользовательские функции не могут выполнять доступ к DOM.

## <a name="see-also"></a>См. также

* [Создание пользовательских функций в Excel](custom-functions-overview.md)
* [Метаданные пользовательских функций](custom-functions-json.md)
* [Среда выполнения для пользовательских функций Excel](custom-functions-runtime.md)
* [Руководство по пользовательским функциям в Excel](excel-tutorial-custom-functions.md)
