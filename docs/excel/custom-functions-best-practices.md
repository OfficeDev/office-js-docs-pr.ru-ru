---
ms.date: 01/08/2019
description: Ознакомьтесь с рекомендациями по разработке пользовательских функций в Excel.
title: Рекомендации в отношении пользовательских функций (предварительная версия)
localization_priority: Normal
ms.openlocfilehash: 4efcd0ba5efb0dc7450192694e8f0750de43b8a8
ms.sourcegitcommit: 14ceac067e0e130869b861d289edb438b5e3eff9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/04/2019
ms.locfileid: "31477546"
---
# <a name="custom-functions-best-practices-preview"></a>Рекомендации в отношении пользовательских функций (предварительная версия)

В этой статье описаны рекомендации по разработке пользовательских функций в Excel.

[!include[Excel custom functions note](../includes/excel-custom-functions-note.md)]

## <a name="troubleshooting"></a>Устранение неполадок

1. Если вы проверяете надстройку в Office для Windows, нужно включить **[ведение журнала в среде выполнения](../testing/troubleshoot-manifest.md#use-runtime-logging-to-debug-your-add-in)**, чтобы устранять проблемы с XML-файлом манифеста надстройки, а также с некоторыми условиями установки и среды выполнения. В файл журнала в среде выполнения записываются операторы `console.log`, что облегчает выявление проблем.

2. Ваша надстройка не будет загружена, если одна или несколько пользовательских функций конфликтуют с пользовательскими функциями, зарегистрированными в ранее зарегистрированной надстройке. В этом случае вы можете удалить существующую надстройку или при возникновении этой ошибки при разработке надстройки, в манифесте можно указать другое имя пространства имен.

3. Чтобы поделиться своим мнением об этом методе устранения неполадок с группой, отвечающей за пользовательские функции Excel, отправьте отзыв группе. Для этого выберите **Файл | Отзыв | Отправить нахмуренный смайлик**. Отправка нахмуренного смайлика предоставит необходимые журналы для понимания проблемы, на которую вы указываете.

## <a name="associating-function-names-with-json-metadata"></a>Сопоставление имен функций с метаданными JSON

Как описано в статье [Обзор пользовательских функций](custom-functions-overview.md) проект пользовательских функций должен содержать как файл метаданных JSON, так и файл сценария (JavaScript или TypeScript) для образования готовой функции. Чтобы функция работала должным образом, необходимо связать идентификатор с реализацией JavaScript. Убедитесь, что существует связь, иначе функция не будет вызываться.

В следующем примере показано, как выполнить данное сопоставление. Пример определяет пользовательскую функцию `add` и связывает ее с объектом в файле метаданных JSON, где для свойства `id` установлено значение **ADD**.

```js
function add(first, second){
  return first + second;
}

CustomFunctions.associate("ADD", add);
```

Имейте в виду приведенные ниже рекомендации при создании пользовательских функций в файле JavaScript и указании соответствующих сведений в файле метаданных JSON.

* Используйте только заглавные буквы для `name` и `id` функции в файле метаданных JSON. Не используйте буквы разного регистра или только строчные буквы. Если вы сделаете это, вы можете в итоге получить два значения, которые отличаются только регистром, что будет приводить к непреднамеренной перезаписи функции. Например, объект функции со значением `id` **add** может быть перезаписан в объявлении позже в файле объекта функция со значением `id` **ADD**. Кроме того, свойство `name` определяет имя функции, которое отображается для конечных пользователей в Excel. Использование прописных букв для имени каждой пользовательской функции обеспечивает единый интерфейс Excel, где все имена встроенных функций записаны прописными буквами.

* Убедитесь, что в файле метаданных JSON значение каждого свойства `id` содержит только буквы, цифры и точки.

* Убедитесь, что в файле метаданных JSON значение каждого свойства `id` уникально в пределах файла. То есть никакие два объекта функций в файле метаданных не должны иметь одинаковое значение `id`. 

* Не изменяйте значение свойства `id` в файле метаданных JSON после его сопоставления с соответствующим именем функции JavaScript. Вы можете изменить имя функции, которое отображается для конечных пользователей в Excel, путем обновления свойства `name` в файле метаданных JSON, но никогда не следует изменять значение свойства `id` после его установления.

* В файле JavaScript указывайте все сопоставления пользовательских функций в одном расположении. Например, в приведенном ниже примере кода определяются две пользовательские функции и указываются сведения о сопоставлении для обеих функций.

    ```js
    function add(first, second){
      return first + second;
    }

    function increment(incrementBy, callback) {
      var result = 0;
      var timer = setInterval(function() {
        result += incrementBy;
        callback.setResult(result);
      }, 1000);

      callback.onCanceled = function() {
        clearInterval(timer);
      };
    }

    // associate `id` values in the JSON metadata file to JavaScript function names
    CustomFunctions.associate("ADD", add);
    CustomFunctions.associate("INCREMENT", increment);
    ```

    В приведенном ниже примере показаны метаданные JSON, соответствующие функциям, определенным в этом примере кода JavaScript. Обратите внимание, что свойства `id` и `name` содержат заглавные буквы в этом файле. 

    ```json
    {
      "$schema": "https://developer.microsoft.com/en-us/json-schemas/office-js/custom-functions.schema.json",
      "functions": [
        {
          "id": "ADD",
          "name": "ADD",
          ...
        },
        {
          "id": "INCREMENT",
          "name": "INCREMENT",
          ...
        }
      ]
    }
    ```

## <a name="declaring-optional-parameters"></a>Объявление необязательных параметров 

В Excel для Windows (версии 1812 или более поздней) можно объявлять необязательные параметры для пользовательских функций. Если пользователь вызывает функцию в Excel, необязательные параметры отображаются в квадратных скобках. Например, функция `FOO` с одним обязательным параметром `parameter1` и одним необязательным параметром `parameter2` будет отображаться в Excel как `=FOO(parameter1, [parameter2])`.

Чтобы сделать параметр необязательным, добавьте `"optional": true` к параметру в файле метаданных JSON, определяющем функцию. В приведенном ниже примере показано, как это может выглядеть для функции `=ADD(first, second, [third])`. Обратите внимание, что необязательный параметр `[third]` расположен после двух обязательных параметров. Обязательные параметры отображаются первыми в интерфейсе формулы Excel.

```json
{
    "id": "ADD",
    "name": "ADD",
    "description": "Add two numbers",
    "helpUrl": "http://www.contoso.com",
    "result": {
        "type": "number",
        "dimensionality": "scalar"
        },
    "parameters": [
        {
            "name": "first",
            "description": "first number to add",
            "type": "number",
            "dimensionality": "scalar"
        },
        {
            "name": "second",
            "description": "second number to add",
            "type": "number",
            "dimensionality": "scalar",
        },
        {
            "name": "third",
            "description": "third optional number to add",
            "type": "number",
            "dimensionality": "scalar",
            "optional": true
        }
    ],
    "options": {
        "sync": false
    }
}
```

Если вы определяете функцию, содержащую один или несколько необязательных параметров, нужно указать, что происходит, когда необязательный параметр не задан. В приведенном ниже примере `zipCode` и `dayOfWeek` являются необязательными параметрами для функции `getWeatherReport`. Если параметр `zipCode` не определен, значение по умолчанию устанавливается равным 98052. Если параметр `dayOfWeek` не определен, ему присваивается значение Wednesday (Среда).

```js
function getWeatherReport(zipCode, dayOfWeek)
{
  if (zipCode === undefined) {
      zipCode = "98052";
  }

  if (dayOfWeek === undefined) {
    dayOfWeek = "Wednesday";
  }

  // Get weather report for specified zipCode and dayOfWeek
  // ...
}
```

## <a name="additional-considerations"></a>Дополнительные рекомендации

Чтобы создать надстройку, которая будет работать на различных платформах (один из основных клиентов надстроек Office), вам не следует выполнять доступ к модели DOM в пользовательских функциях или использовать библиотеки, такие как jQuery, которые используют DOM. В Excel для Windows, где пользовательские функции используют [среду выполнения JavaScript](custom-functions-runtime.md), пользовательские функции не могут выполнять доступ к DOM.

## <a name="see-also"></a>См. также

* [Создание пользовательских функций в Excel](custom-functions-overview.md)
* [Метаданные пользовательских функций](custom-functions-json.md)
* [Среда выполнения для пользовательских функций Excel](custom-functions-runtime.md)
* [Журнал изменений пользовательских функций](custom-functions-changelog.md)
* [Руководство по пользовательским функциям в Excel](../tutorials/excel-tutorial-create-custom-functions.md)
